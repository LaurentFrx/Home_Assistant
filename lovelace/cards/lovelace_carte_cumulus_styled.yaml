###############################################################################
# CARTE CUMULUS STYLED ‚Äî Design moderne professionnel optimis√©
# Version: 2025-10-21 ‚Äî Cr√©√©e par Claude Code
# Corrections: voyant d'√©tat, suppression cartes inutiles, mutualisation styles
###############################################################################

type: vertical-stack
card_mod:
  style: |
    ha-card {
      background: transparent !important;
      box-shadow: none !important;
    }
    :host {
      --card-radius: 12px;
      --card-shadow: 0 1px 6px rgba(0,0,0,.10);
      --card-shadow-light: 0 1px 5px rgba(0,0,0,.10);
      --card-padding: 8px;
      --gradient-cyan-light: linear-gradient(135deg, rgba(6,182,212,.10), rgba(6,182,212,.05));
      --gradient-cyan-lighter: linear-gradient(135deg, rgba(6,182,212,.08), rgba(6,182,212,.04));
      --gradient-cyan-subtle: linear-gradient(135deg, rgba(6,182,212,.06), rgba(6,182,212,.03));
      --gradient-amber: linear-gradient(135deg, rgba(251,191,36,.10), rgba(6,182,212,.05));
      --gradient-amber-light: linear-gradient(135deg, rgba(251,191,36,.08), rgba(6,182,212,.04));
      --gradient-gray: linear-gradient(135deg, rgba(148,163,184,.10), rgba(6,182,212,.05));
      --color-cyan: #06b6d4;
      --color-amber: #fbbf24;
      --color-red: #ef4444;
      --color-green: #22c55e;
      --color-blue: #3b82f6;
      --color-gray: #94a3b8;
    }
cards:
  # ==================== EN-T√äTE AVEC STATUT PRINCIPAL ==================== #
  - type: horizontal-stack
    cards:
      - type: custom:mushroom-title-card
        title: üíß Cumulus Intelligent
        subtitle: >-
          Ballon {{ states('input_number.cumulus_capacite_litres') | int }}L ‚Ä¢
          {{ states('input_number.cumulus_nb_personnes') | int }} personne(s)
        card_mod:
          style: |
            ha-card {
              border-radius: var(--card-radius) !important;
              background: var(--gradient-cyan-light) !important;
              box-shadow: var(--card-shadow) !important;
              padding: var(--card-padding) !important;
            }

      # INDICATEURS PRINCIPAUX √Ä DROITE
      - type: custom:mushroom-chips-card
        alignment: end
        chips:
          # VOYANT INTERRUPTEUR SHELLY (ON/OFF)
          - type: template
            entity: switch.shellypro1_ece334ee1b64
            icon: mdi:power
            icon_color: >-
              {% if is_state('switch.shellypro1_ece334ee1b64', 'on') %}
                red
              {% else %}
                grey
              {% endif %}
            content: >-
              {% if is_state('switch.shellypro1_ece334ee1b64', 'on') %}
                ON
              {% else %}
                OFF
              {% endif %}
            tap_action:
              action: toggle

          # VOYANT √âTAT PHYSIQUE CUMULUS (d√©tection temps r√©el fiable)
          - type: template
            entity: switch.shellypro1_ece334ee1b64
            icon: mdi:water-boiler
            icon_color: >-
              {% set switch_on = is_state('switch.shellypro1_ece334ee1b64', 'on') %}
              {% if not switch_on %}
                grey
              {% else %}
                {% set switch_last_changed = as_timestamp(states.switch.shellypro1_ece334ee1b64.last_changed) %}
                {% set now = as_timestamp(now()) %}
                {% set seconds_since_on = now - switch_last_changed %}
                {% if seconds_since_on < 10 %}
                  red
                {% else %}
                  {% set import_w = states('sensor.smart_meter_grid_import') | float(0) %}
                  {% set pv_w = states('sensor.cumulus_pv_power_w') | float(0) %}
                  {% set talon = states('input_number.cumulus_talon_maison_w') | float(300) %}
                  {% set conso_estimee = (import_w + pv_w) - talon %}
                  {% if conso_estimee >= 2000 %}
                    red
                  {% else %}
                    green
                  {% endif %}
                {% endif %}
              {% endif %}
            content: >-
              {% set switch_on = is_state('switch.shellypro1_ece334ee1b64', 'on') %}
              {% if not switch_on %}
                OFF
              {% else %}
                {% set switch_last_changed = as_timestamp(states.switch.shellypro1_ece334ee1b64.last_changed) %}
                {% set now = as_timestamp(now()) %}
                {% set seconds_since_on = now - switch_last_changed %}
                {% if seconds_since_on < 10 %}
                  CHAUFFE
                {% else %}
                  {% set import_w = states('sensor.smart_meter_grid_import') | float(0) %}
                  {% set pv_w = states('sensor.cumulus_pv_power_w') | float(0) %}
                  {% set talon = states('input_number.cumulus_talon_maison_w') | float(300) %}
                  {% set conso_estimee = (import_w + pv_w) - talon %}
                  {% if conso_estimee >= 2000 %}
                    CHAUFFE
                  {% else %}
                    STANDBY
                  {% endif %}
                {% endif %}
              {% endif %}
            tap_action:
              action: call-service
              service: homeassistant.update_entity
              service_data:
                entity_id: sensor.smart_meter_grid_import
            hold_action:
              action: more-info
        card_mod:
          style: |
            ha-card {
              border-radius: var(--card-radius) !important;
              background: var(--gradient-cyan-lighter) !important;
              box-shadow: var(--card-shadow-light) !important;
            }

  # ==================== INDICATEUR CL√â: BESOIN URGENT ==================== #
  - type: custom:button-card
    entity: binary_sensor.cumulus_besoin_chauffe_urgente
    name: Besoin urgent
    show_state: false
    show_icon: true
    icon: mdi:alert-circle
    custom_fields:
      info: >
        [[[
          return entity.state === 'on'
            ? '<span>‚ö†Ô∏è Urgent</span>'
            : '<span>‚úÖ Normal</span>';
        ]]]
    styles:
      card:
        - min-height: 80px
        - border-radius: var(--card-radius)
        - padding: var(--card-padding)
        - background: >
            [[[
              return entity.state === 'on'
                ? 'linear-gradient(135deg, rgba(239,68,68,.12), rgba(6,182,212,.06))'
                : 'linear-gradient(135deg, rgba(34,197,94,.12), rgba(6,182,212,.06))';
            ]]]
        - box-shadow: var(--card-shadow)
      grid:
        - grid-template-areas: '"i" "n" "info"'
        - grid-template-columns: 1fr
        - grid-template-rows: auto auto auto
        - row-gap: 4px
      name:
        - font-weight: 600
        - font-size: 0.90rem
        - color: var(--primary-text-color)
      icon:
        - width: 24px
        - color: >
            [[[
              return entity.state === 'on' ? '#ef4444' : '#22c55e';
            ]]]
      custom_fields:
        info:
          - font-size: 0.85rem
          - color: var(--secondary-text-color)
    tap_action:
      action: none

  # ==================== INFORMATIONS COMPL√âMENTAIRES ==================== #
  - type: custom:layout-card
    layout_type: grid
    layout:
      grid-template-columns: 1fr 1fr
      column-gap: 8px
    cards:
      # Production solaire
      - type: custom:button-card
        entity: sensor.cumulus_pv_power_w
        name: Production PV
        show_state: false
        show_icon: true
        icon: mdi:solar-power-variant
        custom_fields:
          info: >
            [[[
              const pv = parseFloat(entity.state) || 0;
              return `<span>${Math.round(pv)} W</span>`;
            ]]]
        styles:
          card:
            - min-height: 70px
            - border-radius: var(--card-radius)
            - padding: var(--card-padding)
            - background: var(--gradient-amber)
            - box-shadow: var(--card-shadow)
          grid:
            - grid-template-areas: '"i" "n" "info"'
            - grid-template-columns: 1fr
            - grid-template-rows: auto auto auto
            - row-gap: 4px
          name:
            - font-weight: 600
            - font-size: 0.90rem
            - color: var(--primary-text-color)
          icon:
            - width: 24px
            - color: var(--color-amber)
          custom_fields:
            info:
              - font-size: 0.85rem
              - color: var(--secondary-text-color)
        tap_action:
          action: none

      # Fen√™tre de temps
      - type: custom:button-card
        entity: sensor.cumulus_temps_restant_fenetre_pv_h
        name: Temps restant PV
        show_state: false
        show_icon: true
        icon: mdi:timer-sand
        custom_fields:
          info: >
            [[[
              const temps = parseFloat(entity.state) || 0;
              return `<span>${temps.toFixed(1)} h</span>`;
            ]]]
        styles:
          card:
            - min-height: 70px
            - border-radius: var(--card-radius)
            - padding: var(--card-padding)
            - background: >
                [[[
                  const temps = parseFloat(entity.state) || 0;
                  if (temps > 3) return 'linear-gradient(135deg, rgba(34,197,94,.12), rgba(6,182,212,.06))';
                  if (temps > 1) return 'linear-gradient(135deg, rgba(251,191,36,.12), rgba(6,182,212,.06))';
                  if (temps > 0) return 'linear-gradient(135deg, rgba(239,68,68,.12), rgba(6,182,212,.06))';
                  return 'linear-gradient(135deg, rgba(148,163,184,.10), rgba(6,182,212,.05))';
                ]]]
            - box-shadow: var(--card-shadow)
          grid:
            - grid-template-areas: '"i" "n" "info"'
            - grid-template-columns: 1fr
            - grid-template-rows: auto auto auto
            - row-gap: 4px
          name:
            - font-weight: 600
            - font-size: 0.90rem
            - color: var(--primary-text-color)
          icon:
            - width: 24px
            - color: >
                [[[
                  const temps = parseFloat(entity.state) || 0;
                  if (temps > 3) return '#22c55e';
                  if (temps > 1) return '#fbbf24';
                  if (temps > 0) return '#ef4444';
                  return '#94a3b8';
                ]]]
          custom_fields:
            info:
              - font-size: 0.85rem
              - color: var(--secondary-text-color)
        tap_action:
          action: none

  # ==================== CONTR√îLES RAPIDES ==================== #
  - type: custom:mushroom-title-card
    title: üéõÔ∏è Contr√¥les
    subtitle: null
    card_mod:
      style: |
        ha-card {
          border-radius: var(--card-radius) !important;
          background: var(--gradient-cyan-lighter) !important;
          box-shadow: var(--card-shadow-light) !important;
          padding: 6px !important;
        }

  - type: custom:layout-card
    layout_type: grid
    layout:
      grid-template-columns: 1fr 1fr 1fr
      column-gap: 8px
      row-gap: 8px
    cards:
      # Override (Forcer)
      - type: custom:button-card
        entity: input_boolean.cumulus_override
        name: Forcer
        show_state: false
        show_icon: true
        icon: mdi:hand-pointing-up
        styles:
          card:
            - min-height: 70px
            - border-radius: var(--card-radius)
            - padding: var(--card-padding)
            - background: >
                [[[
                  return entity.state === 'on'
                    ? 'linear-gradient(135deg, rgba(239,68,68,.14), rgba(6,182,212,.08))'
                    : 'linear-gradient(135deg, rgba(148,163,184,.10), rgba(6,182,212,.05))';
                ]]]
            - box-shadow: var(--card-shadow)
          grid:
            - grid-template-areas: '"i" "n"'
            - grid-template-columns: 1fr
            - grid-template-rows: auto auto
            - row-gap: 6px
          name:
            - font-weight: 600
            - font-size: 0.90rem
            - color: var(--primary-text-color)
          icon:
            - width: 24px
            - color: >
                [[[
                  return entity.state === 'on' ? '#ef4444' : '#94a3b8';
                ]]]
        tap_action:
          action: toggle
          confirmation:
            text: Forcer la chauffe imm√©diate ?

      # Interdit
      - type: custom:button-card
        entity: input_boolean.cumulus_interdit
        name: Interdit
        show_state: false
        show_icon: true
        icon: mdi:cancel
        styles:
          card:
            - min-height: 70px
            - border-radius: var(--card-radius)
            - padding: var(--card-padding)
            - background: >
                [[[
                  return entity.state === 'on'
                    ? 'linear-gradient(135deg, rgba(239,68,68,.14), rgba(6,182,212,.08))'
                    : 'linear-gradient(135deg, rgba(148,163,184,.10), rgba(6,182,212,.05))';
                ]]]
            - box-shadow: var(--card-shadow)
          grid:
            - grid-template-areas: '"i" "n"'
            - grid-template-columns: 1fr
            - grid-template-rows: auto auto
            - row-gap: 6px
          name:
            - font-weight: 600
            - font-size: 0.90rem
            - color: var(--primary-text-color)
          icon:
            - width: 24px
            - color: >
                [[[
                  return entity.state === 'on' ? '#ef4444' : '#94a3b8';
                ]]]
        tap_action:
          action: toggle

      # Vacances
      - type: custom:button-card
        entity: input_boolean.cumulus_vacances
        name: Vacances
        show_state: false
        show_icon: true
        icon: mdi:beach
        styles:
          card:
            - min-height: 70px
            - border-radius: var(--card-radius)
            - padding: var(--card-padding)
            - background: >
                [[[
                  return entity.state === 'on'
                    ? 'linear-gradient(135deg, rgba(251,191,36,.14), rgba(6,182,212,.08))'
                    : 'linear-gradient(135deg, rgba(148,163,184,.10), rgba(6,182,212,.05))';
                ]]]
            - box-shadow: var(--card-shadow)
          grid:
            - grid-template-areas: '"i" "n"'
            - grid-template-columns: 1fr
            - grid-template-rows: auto auto
            - row-gap: 6px
          name:
            - font-weight: 600
            - font-size: 0.90rem
            - color: var(--primary-text-color)
          icon:
            - width: 24px
            - color: >
                [[[
                  return entity.state === 'on' ? '#fbbf24' : '#94a3b8';
                ]]]
        tap_action:
          action: toggle

      # Heures creuses
      - type: custom:button-card
        entity: input_boolean.cumulus_autoriser_hc
        name: HC autoris√©es
        show_state: false
        show_icon: true
        icon: mdi:clock-time-eight
        styles:
          card:
            - min-height: 70px
            - border-radius: var(--card-radius)
            - padding: var(--card-padding)
            - background: >
                [[[
                  return entity.state === 'on'
                    ? 'linear-gradient(135deg, rgba(59,130,246,.14), rgba(6,182,212,.08))'
                    : 'linear-gradient(135deg, rgba(148,163,184,.10), rgba(6,182,212,.05))';
                ]]]
            - box-shadow: var(--card-shadow)
          grid:
            - grid-template-areas: '"i" "n"'
            - grid-template-columns: 1fr
            - grid-template-rows: auto auto
            - row-gap: 6px
          name:
            - font-weight: 600
            - font-size: 0.90rem
            - color: var(--primary-text-color)
          icon:
            - width: 24px
            - color: >
                [[[
                  return entity.state === 'on' ? '#3b82f6' : '#94a3b8';
                ]]]
        tap_action:
          action: toggle

      # Verrou jour (lecture seule)
      - type: custom:button-card
        entity: input_boolean.cumulus_verrou_jour
        name: Verrou jour
        show_state: false
        show_icon: true
        icon: mdi:lock-check
        styles:
          card:
            - min-height: 70px
            - border-radius: var(--card-radius)
            - padding: var(--card-padding)
            - background: >
                [[[
                  return entity.state === 'on'
                    ? 'linear-gradient(135deg, rgba(251,191,36,.12), rgba(6,182,212,.06))'
                    : 'linear-gradient(135deg, rgba(34,197,94,.12), rgba(6,182,212,.06))';
                ]]]
            - box-shadow: var(--card-shadow)
          grid:
            - grid-template-areas: '"i" "n"'
            - grid-template-columns: 1fr
            - grid-template-rows: auto auto
            - row-gap: 6px
          name:
            - font-weight: 600
            - font-size: 0.90rem
            - color: var(--primary-text-color)
          icon:
            - width: 24px
            - color: >
                [[[
                  return entity.state === 'on' ? '#fbbf24' : '#22c55e';
                ]]]
        tap_action:
          action: none

      # Temp atteinte (lecture seule)
      - type: custom:button-card
        entity: input_boolean.temp_atteinte_aujourdhui
        name: Temp. OK
        show_state: false
        show_icon: true
        icon: mdi:thermometer-check
        styles:
          card:
            - min-height: 70px
            - border-radius: var(--card-radius)
            - padding: var(--card-padding)
            - background: >
                [[[
                  return entity.state === 'on'
                    ? 'linear-gradient(135deg, rgba(34,197,94,.14), rgba(6,182,212,.08))'
                    : 'linear-gradient(135deg, rgba(148,163,184,.10), rgba(6,182,212,.05))';
                ]]]
            - box-shadow: var(--card-shadow)
          grid:
            - grid-template-areas: '"i" "n"'
            - grid-template-columns: 1fr
            - grid-template-rows: auto auto
            - row-gap: 6px
          name:
            - font-weight: 600
            - font-size: 0.90rem
            - color: var(--primary-text-color)
          icon:
            - width: 24px
            - color: >
                [[[
                  return entity.state === 'on' ? '#22c55e' : '#94a3b8';
                ]]]
        tap_action:
          action: none

  # ==================== DIAGNOSTIC INTELLIGENT ==================== #
  - type: custom:mushroom-title-card
    title: üö¶ Diagnostic
    subtitle: null
    card_mod:
      style: |
        ha-card {
          border-radius: var(--card-radius) !important;
          background: var(--gradient-cyan-lighter) !important;
          box-shadow: var(--card-shadow-light) !important;
          padding: 6px !important;
        }

  - type: markdown
    content: |
      {% set interdit = is_state('input_boolean.cumulus_interdit', 'on') %}
      {% set vacances = is_state('input_boolean.cumulus_vacances', 'on') %}
      {% set verrou = is_state('input_boolean.cumulus_verrou_jour', 'on') %}
      {% set temp_ok = is_state('input_boolean.temp_atteinte_aujourdhui', 'on') %}
      {% set deadband = is_state('binary_sensor.cumulus_deadband_actif', 'on') %}
      {% set appareil = is_state('binary_sensor.cumulus_appareil_prioritaire_actif', 'on') %}
      {% set override = is_state('input_boolean.cumulus_override', 'on') %}
      {% set cumulus_on = is_state('switch.shellypro1_ece334ee1b64', 'on') %}
      {% set fenetre_pv = is_state('binary_sensor.cumulus_fenetre_pv', 'on') %}
      {% set en_hc = is_state('binary_sensor.cumulus_en_hc', 'on') %}
      {% set pv = states('sensor.cumulus_pv_power_w') | float(0) %}
      {% set seuil_pv = states('sensor.cumulus_seuil_pv_dynamique_w') | float(100) %}
      {% set besoin_urgent = is_state('binary_sensor.cumulus_besoin_chauffe_urgente', 'on') %}
      {% set import_w = states('sensor.smart_meter_grid_import') | float(0) %}
      {% set pv_w = states('sensor.cumulus_pv_power_w') | float(0) %}
      {% set talon = states('input_number.cumulus_talon_maison_w') | float(300) %}
      {% set conso = (import_w + pv_w) - talon %}

      ### √âtat actuel
      {% if cumulus_on and conso >= 2000 %}
      ## üî• **EN CHAUFFE**
      R√©sistances actives ({{ conso | int }} W)
      {% elif cumulus_on %}
      ## üü¢ **ALIMENT√â - STANDBY**
      Temp√©rature maintenue
      {% elif override %}
      ## üöÄ **OVERRIDE ACTIF**
      D√©marrage forc√© en attente
      {% else %}
      ## üí§ **AU REPOS**
      En attente des conditions
      {% endif %}

      ---

      ### Blocages actifs
      {% if interdit %}‚ùå **Interdit** : Mode maintenance actif{% endif %}
      {% if vacances %}üèñÔ∏è **Vacances** : Mode √©conomie activ√©{% endif %}
      {% if verrou %}üìÖ **Verrou journalier** : D√©j√† chauff√© aujourd'hui{% endif %}
      {% if temp_ok %}üå°Ô∏è **Temp√©rature OK** : Objectif atteint{% endif %}
      {% if deadband %}‚è±Ô∏è **Deadband** : Temporisation s√©curit√©{% endif %}
      {% if appareil %}‚ö° **Appareil prioritaire** : Lave-linge/vaisselle en cours{% endif %}

      {% if not interdit and not vacances and not verrou and not temp_ok and not deadband and not appareil %}
      ‚úÖ **Aucun blocage** ‚Äî Pr√™t √† d√©marrer
      {% endif %}

      ---

      ### Conditions de d√©marrage

      **Mode Solaire (PV)**
      {% if fenetre_pv %}‚úÖ Dans fen√™tre PV{% else %}‚è∞ Hors fen√™tre PV{% endif %}
      {% if pv >= seuil_pv %}‚úÖ PV suffisant ({{ pv | int }}W){% else %}‚ö†Ô∏è PV insuffisant ({{ pv | int }}W < {{ seuil_pv | int }}W){% endif %}

      **Mode Heures Creuses**
      {% if en_hc %}‚úÖ En heures creuses{% else %}‚è∞ Hors heures creuses{% endif %}
      {% if besoin_urgent %}üî¥ Besoin urgent d√©tect√©{% else %}‚úÖ Pas d'urgence{% endif %}

      ---

      ### Prochaine action pr√©vue
      {% if temp_ok %}
      ‚òÄÔ∏è **Demain** ‚Äî Chauffe solaire si m√©t√©o favorable
      {% elif fenetre_pv and not verrou %}
      ‚òÄÔ∏è **Aujourd'hui** ‚Äî Attente production solaire suffisante
      {% elif is_state('binary_sensor.cumulus_meteo_favorable_demain', 'on') %}
      ‚òÄÔ∏è **Demain** ‚Äî M√©t√©o favorable pr√©vue ({{ states('sensor.cumulus_solcast_forecast_tomorrow') }} kWh)
      {% else %}
      üåô **Cette nuit** ‚Äî Heures creuses ({{ states('input_datetime.cumulus_heures_creuses_debut')[0:5] }}-{{ states('input_datetime.cumulus_heures_creuses_fin')[0:5] }})
      {% endif %}
    card_mod:
      style: |
        ha-card {
          border-radius: var(--card-radius) !important;
          background: var(--gradient-cyan-lighter) !important;
          box-shadow: var(--card-shadow) !important;
          padding: 12px !important;
        }

  # ==================== M√âT√âO ET PR√âVISIONS ==================== #
  - type: custom:mushroom-title-card
    title: ‚òÄÔ∏è Pr√©visions solaires
    subtitle: null
    card_mod:
      style: |
        ha-card {
          border-radius: var(--card-radius) !important;
          background: var(--gradient-amber-light) !important;
          box-shadow: var(--card-shadow-light) !important;
          padding: 6px !important;
        }

  - type: custom:layout-card
    layout_type: grid
    layout:
      grid-template-columns: 1fr 1fr
      column-gap: 8px
    cards:
      # Aujourd'hui
      - type: custom:button-card
        entity: sensor.cumulus_solcast_forecast_today
        name: Aujourd'hui
        show_state: false
        show_icon: true
        icon: mdi:weather-sunny
        custom_fields:
          info: >
            [[[
              return `<span>${entity.state} kWh</span>`;
            ]]]
        styles:
          card:
            - min-height: 70px
            - border-radius: var(--card-radius)
            - padding: var(--card-padding)
            - background: >
                [[[
                  return states['binary_sensor.cumulus_meteo_favorable_aujourdhui'].state === 'on'
                    ? 'linear-gradient(135deg, rgba(251,191,36,.14), rgba(6,182,212,.08))'
                    : 'linear-gradient(135deg, rgba(148,163,184,.10), rgba(6,182,212,.05))';
                ]]]
            - box-shadow: var(--card-shadow)
          grid:
            - grid-template-areas: '"i" "n" "info"'
            - grid-template-columns: 1fr
            - grid-template-rows: auto auto auto
            - row-gap: 4px
          name:
            - font-weight: 600
            - font-size: 0.90rem
            - color: var(--primary-text-color)
          icon:
            - width: 24px
            - color: >
                [[[
                  return states['binary_sensor.cumulus_meteo_favorable_aujourdhui'].state === 'on'
                    ? '#fbbf24' : '#94a3b8';
                ]]]
          custom_fields:
            info:
              - font-size: 0.85rem
              - color: var(--secondary-text-color)
        tap_action:
          action: none

      # Demain
      - type: custom:button-card
        entity: sensor.cumulus_solcast_forecast_tomorrow
        name: Demain
        show_state: false
        show_icon: true
        icon: mdi:weather-sunny-alert
        custom_fields:
          info: >
            [[[
              return `<span>${entity.state} kWh</span>`;
            ]]]
        styles:
          card:
            - min-height: 70px
            - border-radius: var(--card-radius)
            - padding: var(--card-padding)
            - background: >
                [[[
                  return states['binary_sensor.cumulus_meteo_favorable_demain'].state === 'on'
                    ? 'linear-gradient(135deg, rgba(251,191,36,.14), rgba(6,182,212,.08))'
                    : 'linear-gradient(135deg, rgba(148,163,184,.10), rgba(6,182,212,.05))';
                ]]]
            - box-shadow: var(--card-shadow)
          grid:
            - grid-template-areas: '"i" "n" "info"'
            - grid-template-columns: 1fr
            - grid-template-rows: auto auto auto
            - row-gap: 4px
          name:
            - font-weight: 600
            - font-size: 0.90rem
            - color: var(--primary-text-color)
          icon:
            - width: 24px
            - color: >
                [[[
                  return states['binary_sensor.cumulus_meteo_favorable_demain'].state === 'on'
                    ? '#fbbf24' : '#94a3b8';
                ]]]
          custom_fields:
            info:
              - font-size: 0.85rem
              - color: var(--secondary-text-color)
        tap_action:
          action: none

  # ==================== APPAREILS PRIORITAIRES ==================== #
  - type: custom:mushroom-title-card
    title: ‚ö° Appareils prioritaires
    subtitle: D√©tection automatique
    card_mod:
      style: |
        ha-card {
          border-radius: var(--card-radius) !important;
          background: linear-gradient(135deg, rgba(59,130,246,.08), rgba(6,182,212,.04)) !important;
          box-shadow: var(--card-shadow-light) !important;
          padding: 6px !important;
        }

  - type: custom:layout-card
    layout_type: grid
    layout:
      grid-template-columns: 1fr 1fr 1fr
      column-gap: 8px
    cards:
      # Lave-linge
      - type: custom:button-card
        entity: binary_sensor.cumulus_lave_linge_actif
        name: Lave-linge
        show_state: false
        show_icon: true
        icon: mdi:washing-machine
        styles:
          card:
            - min-height: 70px
            - border-radius: var(--card-radius)
            - padding: var(--card-padding)
            - background: >
                [[[
                  return entity.state === 'on'
                    ? 'linear-gradient(135deg, rgba(59,130,246,.14), rgba(6,182,212,.08))'
                    : 'linear-gradient(135deg, rgba(148,163,184,.10), rgba(6,182,212,.05))';
                ]]]
            - box-shadow: var(--card-shadow)
          grid:
            - grid-template-areas: '"i" "n"'
            - grid-template-columns: 1fr
            - grid-template-rows: auto auto
            - row-gap: 6px
          name:
            - font-weight: 600
            - font-size: 0.90rem
            - color: var(--primary-text-color)
          icon:
            - width: 24px
            - color: >
                [[[
                  return entity.state === 'on' ? '#3b82f6' : '#94a3b8';
                ]]]
        tap_action:
          action: none

      # Lave-vaisselle
      - type: custom:button-card
        entity: binary_sensor.cumulus_lave_vaisselle_actif
        name: Lave-vaisselle
        show_state: false
        show_icon: true
        icon: mdi:dishwasher
        styles:
          card:
            - min-height: 70px
            - border-radius: var(--card-radius)
            - padding: var(--card-padding)
            - background: >
                [[[
                  return entity.state === 'on'
                    ? 'linear-gradient(135deg, rgba(59,130,246,.14), rgba(6,182,212,.08))'
                    : 'linear-gradient(135deg, rgba(148,163,184,.10), rgba(6,182,212,.05))';
                ]]]
            - box-shadow: var(--card-shadow)
          grid:
            - grid-template-areas: '"i" "n"'
            - grid-template-columns: 1fr
            - grid-template-rows: auto auto
            - row-gap: 6px
          name:
            - font-weight: 600
            - font-size: 0.90rem
            - color: var(--primary-text-color)
          icon:
            - width: 24px
            - color: >
                [[[
                  return entity.state === 'on' ? '#3b82f6' : '#94a3b8';
                ]]]
        tap_action:
          action: none

      # Statut global
      - type: custom:button-card
        entity: binary_sensor.cumulus_appareil_prioritaire_actif
        name: Statut
        show_state: false
        show_icon: true
        icon: mdi:home-lightning-bolt-outline
        custom_fields:
          info: >
            [[[
              return entity.state === 'on'
                ? '<span>Cumulus bloqu√©</span>'
                : '<span>Aucun actif</span>';
            ]]]
        styles:
          card:
            - min-height: 70px
            - border-radius: var(--card-radius)
            - padding: var(--card-padding)
            - background: >
                [[[
                  return entity.state === 'on'
                    ? 'linear-gradient(135deg, rgba(239,68,68,.12), rgba(6,182,212,.06))'
                    : 'linear-gradient(135deg, rgba(34,197,94,.12), rgba(6,182,212,.06))';
                ]]]
            - box-shadow: var(--card-shadow)
          grid:
            - grid-template-areas: '"i" "n" "info"'
            - grid-template-columns: 1fr
            - grid-template-rows: auto auto auto
            - row-gap: 4px
          name:
            - font-weight: 600
            - font-size: 0.90rem
            - color: var(--primary-text-color)
          icon:
            - width: 24px
            - color: >
                [[[
                  return entity.state === 'on' ? '#ef4444' : '#22c55e';
                ]]]
          custom_fields:
            info:
              - font-size: 0.85rem
              - color: var(--secondary-text-color)
        tap_action:
          action: none

  # ==================== DONN√âES TECHNIQUES ==================== #
  - type: entities
    title: üìä Donn√©es techniques
    show_header_toggle: false
    state_color: true
    entities:
      - entity: sensor.cumulus_temperature_physique_c
        name: Temp√©rature estim√©e
        icon: mdi:thermometer
      - entity: sensor.cumulus_eau_chaude_disponible_40c_litres
        name: Litres disponibles (40¬∞C)
        icon: mdi:water
      - entity: sensor.cumulus_besoin_journalier_litres
        name: Besoin journalier
        icon: mdi:account-water
      - type: divider
      - entity: sensor.cumulus_pv_power_w
        name: Production PV
        icon: mdi:solar-power
      - entity: sensor.cumulus_capacity_factor
        name: Facteur de charge
        icon: mdi:percent-outline
      - type: divider
      - entity: sensor.cumulus_seuil_pv_dynamique_w
        name: Seuil PV dynamique
        icon: mdi:solar-power-variant-outline
      - entity: sensor.cumulus_import_reseau_w
        name: Import r√©seau
        icon: mdi:transmission-tower-import
      - entity: sensor.cumulus_soc_solarbank_pct
        name: Charge batterie
        icon: mdi:battery
      - type: divider
      - entity: sensor.cumulus_heures_depuis_derniere_chauffe
        name: Heures depuis derni√®re chauffe
        icon: mdi:clock-outline
      - entity: input_datetime.cumulus_derniere_chauffe_complete
        name: Derni√®re chauffe compl√®te
        icon: mdi:calendar-clock
    card_mod:
      style: |
        ha-card {
          border-radius: var(--card-radius) !important;
          background: var(--gradient-cyan-subtle) !important;
          box-shadow: var(--card-shadow) !important;
        }

  # ==================== FEN√äTRES HORAIRES ==================== #
  - type: entities
    title: üïê Fen√™tres horaires
    show_header_toggle: false
    state_color: true
    entities:
      - entity: input_datetime.cumulus_plage_pv_debut
        name: Fen√™tre PV - D√©but
        icon: mdi:weather-sunny
      - entity: input_datetime.cumulus_plage_pv_fin
        name: Fen√™tre PV - Fin
        icon: mdi:weather-sunset
      - entity: binary_sensor.cumulus_fenetre_pv
        name: Dans fen√™tre PV
        icon: mdi:sun-clock
      - type: divider
      - entity: input_datetime.cumulus_heures_creuses_debut
        name: HC - D√©but
        icon: mdi:clock-start
      - entity: input_datetime.cumulus_heures_creuses_fin
        name: HC - Fin
        icon: mdi:clock-end
      - entity: binary_sensor.cumulus_en_hc
        name: En heures creuses
        icon: mdi:clock-time-eight-outline
    card_mod:
      style: |
        ha-card {
          border-radius: var(--card-radius) !important;
          background: var(--gradient-cyan-subtle) !important;
          box-shadow: var(--card-shadow) !important;
        }

  # ==================== FOOTER ==================== #
  - type: markdown
    content: |
      <div style="text-align: center; color: var(--secondary-text-color); font-size: 10px; padding: 8px;">
      üíß Carte Cumulus Styled v2025-10-21 | Optimis√©e et corrig√©e
      </div>
    card_mod:
      style: |
        ha-card {
          border-radius: var(--card-radius) !important;
          background: var(--gradient-cyan-subtle) !important;
          box-shadow: 0 1px 4px rgba(0,0,0,.08) !important;
        }
