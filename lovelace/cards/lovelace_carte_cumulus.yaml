###############################################################################
# CARTE LOVELACE CUMULUS â€” Design moderne et complet
# Ã€ intÃ©grer dans votre dashboard Lovelace
# Version: 2025-10-10d â€” Ajout section diagnostic conditions bloquantes
###############################################################################

type: vertical-stack
cards:
  # ==================== EN-TÃŠTE PRINCIPAL ==================== #
  - type: custom:mushroom-title-card
    title: "ğŸ’§ Gestion Intelligente du Cumulus"
    subtitle: "Ballon {{ states('input_number.cumulus_capacite_litres') | int }}L â€¢ {{ states('input_number.cumulus_nb_personnes') | int }} personne(s)"

  # ==================== STATUT EN TEMPS RÃ‰EL ==================== #
  - type: custom:mushroom-chips-card
    chips:
      - type: template
        entity: binary_sensor.cumulus_chauffe_reelle
        icon: mdi:fire
        icon_color: >
          {% if is_state('binary_sensor.cumulus_chauffe_reelle', 'on') %}
            red
          {% else %}
            grey
          {% endif %}
        content: >
          {% if is_state('binary_sensor.cumulus_chauffe_reelle', 'on') %}
            ğŸ”¥ Chauffe en cours
          {% else %}
            ğŸ’¤ Repos
          {% endif %}

      - type: template
        entity: sensor.cumulus_temperature_estimee
        icon: mdi:thermometer-water
        icon_color: >
          {% set temp = states('sensor.cumulus_temperature_estimee') | float(0) %}
          {% if temp >= 50 %}
            red
          {% elif temp >= 35 %}
            orange
          {% else %}
            blue
          {% endif %}
        content: "{{ states('sensor.cumulus_temperature_estimee') }}Â°C"

      - type: template
        entity: sensor.cumulus_litres_disponibles_estimes
        icon: mdi:water
        icon_color: >
          {% set litres = states('sensor.cumulus_litres_disponibles_estimes') | float(0) %}
          {% set capacite = states('input_number.cumulus_capacite_litres') | float(300) %}
          {% set ratio = (litres / capacite * 100) | int %}
          {% if ratio >= 70 %}
            green
          {% elif ratio >= 40 %}
            orange
          {% else %}
            red
          {% endif %}
        content: "{{ states('sensor.cumulus_litres_disponibles_estimes') }}L"

      - type: template
        entity: sensor.cumulus_heures_depuis_derniere_chauffe
        icon: mdi:clock-outline
        icon_color: >
          {% set heures = states('sensor.cumulus_heures_depuis_derniere_chauffe') | float(0) %}
          {% if heures >= 50 %}
            red
          {% elif heures >= 36 %}
            orange
          {% else %}
            green
          {% endif %}
        content: "{{ states('sensor.cumulus_heures_depuis_derniere_chauffe') }}h"

      - type: template
        entity: sensor.cumulus_temps_restant_fenetre_pv_h
        icon: mdi:timer-sand
        icon_color: >
          {% set temps = states('sensor.cumulus_temps_restant_fenetre_pv_h') | float(0) %}
          {% if temps > 3 %}
            green
          {% elif temps > 1 %}
            orange
          {% elif temps > 0 %}
            red
          {% else %}
            grey
          {% endif %}
        content: "â±ï¸ {{ states('sensor.cumulus_temps_restant_fenetre_pv_h') }}h PV"

      - type: template
        entity: binary_sensor.cumulus_capacite_suffisante
        icon: mdi:check-circle
        icon_color: >
          {% if is_state('binary_sensor.cumulus_capacite_suffisante', 'on') %}
            green
          {% else %}
            red
          {% endif %}
        content: >
          {% if is_state('binary_sensor.cumulus_capacite_suffisante', 'on') %}
            âœ… Suffisant
          {% else %}
            âš ï¸ Insuffisant
          {% endif %}

  # ==================== JAUGE TEMPÃ‰RATURE ==================== #
  - type: gauge
    entity: sensor.cumulus_temperature_estimee
    name: TempÃ©rature estimÃ©e de l'eau
    min: 20
    max: 60
    severity:
      green: 50
      yellow: 35
      red: 20
    needle: true

  # ==================== GRAPHIQUE HISTORIQUE ==================== #
  - type: custom:mini-graph-card
    name: Historique tempÃ©rature et production
    hours_to_show: 48
    points_per_hour: 2
    line_width: 3
    animate: true
    entities:
      - entity: sensor.cumulus_temperature_estimee
        name: TempÃ©rature eau
        color: "#FF5733"
        show_state: true
        show_indicator: true
      - entity: sensor.cumulus_pv_power_w
        name: Production PV brute
        color: "#FFC300"
        show_state: true
        y_axis: secondary
      - entity: sensor.cumulus_pv_effectif_w
        name: Production PV effective
        color: "#F39C12"
        show_state: true
        y_axis: secondary
      - entity: sensor.cumulus_import_reseau_w
        name: Import rÃ©seau
        color: "#3498DB"
        show_state: true
        y_axis: secondary

  # ==================== MÃ‰TÃ‰O & PRÃ‰VISIONS ==================== #
  - type: horizontal-stack
    cards:
      - type: custom:mushroom-entity-card
        entity: sensor.cumulus_solcast_forecast_today
        name: PrÃ©vision Aujourd'hui
        icon: mdi:weather-sunny
        icon_color: >
          {% if is_state('binary_sensor.cumulus_meteo_favorable_aujourdhui', 'on') %}
            amber
          {% else %}
            grey
          {% endif %}
        primary_info: name
        secondary_info: state

      - type: custom:mushroom-entity-card
        entity: sensor.cumulus_solcast_forecast_tomorrow
        name: PrÃ©vision Demain
        icon: mdi:weather-sunny-alert
        icon_color: >
          {% if is_state('binary_sensor.cumulus_meteo_favorable_demain', 'on') %}
            amber
          {% else %}
            grey
          {% endif %}
        primary_info: name
        secondary_info: state

  # ==================== CONTRÃ”LES RAPIDES ==================== #
  - type: custom:mushroom-title-card
    title: "ğŸ›ï¸ ContrÃ´les"
    subtitle: ""

  - type: horizontal-stack
    cards:
      - type: custom:mushroom-entity-card
        entity: input_boolean.cumulus_override
        name: Override Manuel
        icon: mdi:hand-pointing-up
        tap_action:
          action: toggle
        fill_container: false

      - type: custom:mushroom-entity-card
        entity: input_boolean.cumulus_interdit
        name: Interdit
        icon: mdi:cancel
        tap_action:
          action: toggle
        fill_container: false

      - type: custom:mushroom-entity-card
        entity: input_boolean.cumulus_vacances
        name: Vacances
        icon: mdi:beach
        tap_action:
          action: toggle
        fill_container: false

  - type: horizontal-stack
    cards:
      - type: custom:mushroom-entity-card
        entity: input_boolean.cumulus_autoriser_hc
        name: Autoriser HC
        icon: mdi:clock-time-eight
        tap_action:
          action: toggle
        fill_container: false

      - type: custom:mushroom-entity-card
        entity: binary_sensor.cumulus_besoin_chauffe_urgente
        name: Besoin urgent
        icon: mdi:alert-circle
        icon_color: >
          {% if is_state('binary_sensor.cumulus_besoin_chauffe_urgente', 'on') %}
            red
          {% else %}
            green
          {% endif %}
        tap_action:
          action: none
        fill_container: false

      - type: custom:mushroom-entity-card
        entity: input_boolean.temp_atteinte_aujourdhui
        name: Temp. atteinte
        icon: mdi:thermometer-check
        icon_color: >
          {% if is_state('input_boolean.temp_atteinte_aujourdhui', 'on') %}
            green
          {% else %}
            grey
          {% endif %}
        tap_action:
          action: none
        fill_container: false

  - type: horizontal-stack
    cards:
      - type: custom:mushroom-entity-card
        entity: input_boolean.cumulus_verrou_jour
        name: Verrou journalier
        icon: mdi:calendar-remove
        icon_color: >
          {% if is_state('input_boolean.cumulus_verrou_jour', 'on') %}
            red
          {% else %}
            green
          {% endif %}
        tap_action:
          action: none
        fill_container: false

      - type: custom:mushroom-entity-card
        entity: binary_sensor.cumulus_deadband_actif
        name: Deadband
        icon: mdi:timer-sand
        icon_color: >
          {% if is_state('binary_sensor.cumulus_deadband_actif', 'on') %}
            orange
          {% else %}
            grey
          {% endif %}
        tap_action:
          action: none
        fill_container: false

  # ==================== APPAREILS PRIORITAIRES ==================== #
  - type: custom:mushroom-title-card
    title: "âš¡ Appareils Prioritaires"
    subtitle: "DÃ©tection automatique des appareils en cours"

  - type: horizontal-stack
    cards:
      - type: custom:mushroom-entity-card
        entity: binary_sensor.cumulus_lave_linge_actif
        name: Lave-linge
        icon: mdi:washing-machine
        icon_color: >
          {% if is_state('binary_sensor.cumulus_lave_linge_actif', 'on') %}
            blue
          {% else %}
            grey
          {% endif %}
        tap_action:
          action: none
        fill_container: false

      - type: custom:mushroom-entity-card
        entity: binary_sensor.cumulus_lave_vaisselle_actif
        name: Lave-vaisselle
        icon: mdi:dishwasher
        icon_color: >
          {% if is_state('binary_sensor.cumulus_lave_vaisselle_actif', 'on') %}
            blue
          {% else %}
            grey
          {% endif %}
        tap_action:
          action: none
        fill_container: false

      - type: custom:mushroom-entity-card
        entity: binary_sensor.cumulus_appareil_en_cours
        name: Appareil actif
        icon: mdi:home-lightning-bolt-outline
        icon_color: >
          {% if is_state('binary_sensor.cumulus_appareil_en_cours', 'on') %}
            red
          {% else %}
            green
          {% endif %}
        tap_action:
          action: none
        fill_container: false

  - type: markdown
    content: |
      ### ğŸ”Œ Gestion des prioritÃ©s

      Le cumulus **ne dÃ©marrera pas** ou **s'arrÃªtera automatiquement** si :
      - ğŸ”µ Lave-linge en cours (> {{ states('input_number.cumulus_seuil_appareil_actif_w') | int }}W)
      - ğŸ”µ Lave-vaisselle en cours (> {{ states('input_number.cumulus_seuil_appareil_actif_w') | int }}W)

      {% if is_state('binary_sensor.cumulus_appareil_en_cours', 'on') %}
      âš ï¸ **APPAREIL ACTIF DÃ‰TECTÃ‰** : Le cumulus est bloquÃ©
      {% else %}
      âœ… **Aucun appareil actif** : Le cumulus peut fonctionner normalement
      {% endif %}

      ---

      #### ğŸ”„ RedÃ©marrage automatique
      Si un appareil s'arrÃªte et que :
      - âœ… FenÃªtre PV active
      - âœ… TempÃ©rature non atteinte
      - âœ… Pas d'interdiction

      â†’ Le cumulus redÃ©marrera **automatiquement aprÃ¨s 30 secondes**

  # ==================== PLANNING JOURNALIER ==================== #
  - type: custom:mushroom-title-card
    title: "ğŸ“… Planning Journalier"
    subtitle: "Plages horaires de chauffe et Ã©vÃ©nements quotidiens"

  - type: markdown
    content: |
      ### ğŸ• Plages horaires actives

      | PÃ©riode | Horaire | Type | Conditions |
      |---------|---------|------|------------|
      | **ğŸŒ™ Heures Creuses** | {{ states('input_datetime.cumulus_heures_creuses_debut') }} - {{ states('input_datetime.cumulus_heures_creuses_fin') }} | HC RÃ©seau | Logique intelligente |
      | **ğŸ”„ Reset quotidien** | 08:10 | Auto | Verrou + Temp. atteinte |
      | **â˜€ï¸ FenÃªtre PV** | {{ states('input_datetime.cumulus_plage_pv_debut') }} - {{ states('input_datetime.cumulus_plage_pv_fin') }} | Surplus PV | Si PV > seuil |

      ---

      #### Logique HC intelligente active si :
      - âœ… Autorisation HC activÃ©e **ET**
      - ğŸ”´ Besoin urgent (> {{ states('input_number.cumulus_espacement_max_h') }}h) **OU**
      - ğŸŒ§ï¸ MÃ©tÃ©o dÃ©favorable demain (< {{ states('input_number.cumulus_seuil_solcast_bon_kwh') }} kWh)

      ---

      #### Ã‰tat actuel :
      {% if is_state('binary_sensor.cumulus_en_hc', 'on') %}
      ğŸŒ™ **EN HEURES CREUSES** ({{ states('input_datetime.cumulus_heures_creuses_debut') }} - {{ states('input_datetime.cumulus_heures_creuses_fin') }})
      {% elif is_state('binary_sensor.cumulus_fenetre_pv', 'on') %}
      â˜€ï¸ **DANS FENÃŠTRE PV** ({{ states('input_datetime.cumulus_plage_pv_debut') }} - {{ states('input_datetime.cumulus_plage_pv_fin') }})
      {% else %}
      ğŸ’¤ **HORS PÃ‰RIODE DE CHAUFFE**
      {% endif %}

  # ==================== TIMELINE 24H ==================== #
  - type: markdown
    content: |
      ### â° Timeline 24h

      ```
      00:00 â”â”â”â”â”â”â”â”â”â”“
                     â”ƒ ğŸ’¤ Nuit
      03:30 â”â”â”â”â”â”â”â”â”â”«
                     â”ƒ ğŸŒ™ HEURES CREUSES
      08:05 â”â”â”â”â”â”â”â”â”â”«    (si logique intelligente)
                     â”ƒ
      08:10 â”â”â”â”â”â”â”â”â”â•‹â”â” ğŸ”„ RESET QUOTIDIEN
                     â”ƒ    (verrou + temp.atteinte)
      10:20 â”â”â”â”â”â”â”â”â”â”«
                     â”ƒ â˜€ï¸ FENÃŠTRE PV
                     â”ƒ    (si PV > {{ states('input_number.cumulus_seuil_pv_on_w') | int }}W)
      17:50 â”â”â”â”â”â”â”â”â”â”«
                     â”ƒ ğŸ’¤ SoirÃ©e
      00:00 â”â”â”â”â”â”â”â”â”â”›
      ```

      **LÃ©gende** :
      - ğŸŒ™ HC : chauffe rÃ©seau (conditions intelligentes)
      - ğŸ”„ Reset : rÃ©initialisation verrou journalier
      - â˜€ï¸ PV : chauffe sur surplus solaire
      - ğŸ’¤ : aucune chauffe possible

  # ==================== SENSORS SUPPLÃ‰MENTAIRES ==================== #
  - type: custom:mushroom-title-card
    title: "ğŸ“ˆ DonnÃ©es Additionnelles"
    subtitle: "Capteurs et indicateurs intelligents"

  - type: entities
    title: "ğŸ’§ Eau & Besoins"
    entities:
      - entity: sensor.cumulus_litres_disponibles_estimes
        name: Litres disponibles
        icon: mdi:water
      - entity: sensor.cumulus_besoin_journalier_litres
        name: Besoin journalier
        icon: mdi:account-water
      - entity: binary_sensor.cumulus_capacite_suffisante
        name: CapacitÃ© suffisante
        icon: mdi:check-circle

  - type: entities
    title: "âš¡ Production PV & EfficacitÃ©"
    entities:
      - entity: sensor.cumulus_pv_power_w
        name: Production PV brute
        icon: mdi:solar-power
      - entity: sensor.cumulus_pv_effectif_w
        name: Production PV effective
        icon: mdi:solar-power-variant
      - entity: sensor.cumulus_capacity_factor
        name: Facteur de charge PV
        icon: mdi:percent-outline
      - entity: sensor.cumulus_sb_dispo_w
        name: SolarBank disponible
        icon: mdi:battery-arrow-up
      - type: divider
      - entity: input_number.cumulus_alpha_aps
        name: Coefficient Î± APS
        icon: mdi:alpha

  - type: entities
    title: "â±ï¸ Temps & FenÃªtres"
    entities:
      - entity: sensor.cumulus_temps_restant_fenetre_pv_h
        name: Temps restant fenÃªtre PV
        icon: mdi:timer-sand
      - entity: sensor.cumulus_seuil_pv_dynamique_w
        name: Seuil PV dynamique
        icon: mdi:solar-power-variant-outline
      - entity: binary_sensor.cumulus_temps_suffisant_fenetre_pv
        name: Temps suffisant pour chauffe
        icon: mdi:clock-check-outline
      - entity: sensor.cumulus_heures_depuis_derniere_chauffe
        name: Heures depuis derniÃ¨re chauffe
        icon: mdi:clock-outline

  # ==================== DONNÃ‰ES TECHNIQUES ==================== #
  - type: custom:mushroom-title-card
    title: "ğŸ“Š DonnÃ©es Techniques"
    subtitle: ""

  - type: entities
    entities:
      - entity: sensor.cumulus_import_reseau_w
        name: Import rÃ©seau actuel
        icon: mdi:transmission-tower-import
      - entity: sensor.cumulus_pv_power_w
        name: Production PV brute
        icon: mdi:solar-power
      - entity: sensor.cumulus_pv_effectif_w
        name: Production PV effective
        icon: mdi:solar-power-variant
      - entity: sensor.cumulus_soc_solarbank_pct
        name: Charge batterie
        icon: mdi:battery
      - entity: input_number.cumulus_puissance_w
        name: Puissance cumulus
        icon: mdi:lightning-bolt
      - type: divider
      - entity: sensor.cumulus_seuil_pv_dynamique_w
        name: Seuil PV dynamique
        icon: mdi:solar-power-variant-outline
      - entity: sensor.cumulus_seuil_import_limiteur_w
        name: Seuil limiteur import
        icon: mdi:flash-alert
      - entity: sensor.cumulus_seuil_fin_chauffe_w
        name: Seuil fin de chauffe
        icon: mdi:flash-triangle-outline
      - type: divider
      - entity: input_datetime.cumulus_derniere_chauffe_complete
        name: DerniÃ¨re chauffe complÃ¨te
        icon: mdi:calendar-clock

  # ==================== CONFIGURATION ==================== #
  - type: custom:mushroom-title-card
    title: "âš™ï¸ Configuration"
    subtitle: ""

  - type: entities
    title: "ğŸ  ParamÃ¨tres gÃ©nÃ©raux"
    entities:
      - entity: input_number.cumulus_nb_personnes
        name: Nombre de personnes
        icon: mdi:account-multiple
      - entity: input_number.cumulus_capacite_litres
        name: CapacitÃ© du ballon
        icon: mdi:water-boiler
      - entity: input_number.cumulus_puissance_w
        name: Puissance cumulus
        icon: mdi:lightning-bolt
      - entity: input_number.cumulus_espacement_max_h
        name: Espacement maxi
        icon: mdi:timer-sand

  - type: entities
    title: "âš¡ ParamÃ¨tres PV et dÃ©marrage"
    entities:
      - entity: input_number.cumulus_seuil_pv_on_w
        name: Seuil PV dÃ©marrage
        icon: mdi:white-balance-sunny
      - entity: input_number.cumulus_on_delay_s
        name: DÃ©lai confirmation ON
        icon: mdi:timer-play
      - entity: input_number.cumulus_deadband_s
        name: Deadband global
        icon: mdi:progress-clock
      - entity: input_number.cumulus_mini_deadband_no_delay_s
        name: Mini-deadband no_delay
        icon: mdi:timer-outline
      - entity: input_number.cumulus_seuil_solcast_bon_kwh
        name: Seuil "bonne journÃ©e"
        icon: mdi:weather-sunny

  - type: entities
    title: "ğŸ”‹ ParamÃ¨tres batterie (SOC)"
    entities:
      - entity: input_number.cumulus_soc_start_pct
        name: SOC mini dÃ©marrage
        icon: mdi:battery-70
      - entity: input_number.cumulus_soc_stop_pct
        name: SOC arrÃªt sÃ©curitÃ©
        icon: mdi:battery-alert
      - entity: input_number.cumulus_solarbank_max_w
        name: Puissance max Solarbank
        icon: mdi:battery-charging-100
      - entity: input_number.cumulus_aps_max_w
        name: Puissance max APS
        icon: mdi:solar-power

  - type: entities
    title: "ğŸ“Š ParamÃ¨tres import rÃ©seau"
    entities:
      - entity: input_number.cumulus_talon_maison_w
        name: Talon maison
        icon: mdi:home-lightning-bolt
      - entity: input_number.cumulus_marge_import_w
        name: Marge import (limiteur)
        icon: mdi:flash-alert
      - entity: input_number.cumulus_marge_fin_import_w
        name: Marge fin import
        icon: mdi:flash-triangle-outline

  - type: entities
    title: "ğŸ”Œ ParamÃ¨tres appareils prioritaires"
    entities:
      - entity: input_number.cumulus_seuil_appareil_actif_w
        name: Seuil dÃ©tection appareil
        icon: mdi:flash-outline
      - type: divider
      - entity: input_text.cumulus_entity_lave_linge_power
        name: EntitÃ© lave-linge
        icon: mdi:washing-machine
      - entity: input_text.cumulus_entity_lave_vaisselle_power
        name: EntitÃ© lave-vaisselle
        icon: mdi:dishwasher

  # ==================== FENÃŠTRES HORAIRES ==================== #
  - type: custom:mushroom-title-card
    title: "ğŸ• FenÃªtres Horaires"
    subtitle: ""

  - type: entities
    entities:
      - entity: input_datetime.cumulus_plage_pv_debut
        name: FenÃªtre PV - DÃ©but
        icon: mdi:weather-sunny
      - entity: input_datetime.cumulus_plage_pv_fin
        name: FenÃªtre PV - Fin
        icon: mdi:weather-sunset
      - type: divider
      - entity: input_datetime.cumulus_heures_creuses_debut
        name: Heures creuses - DÃ©but
        icon: mdi:clock-start
      - entity: input_datetime.cumulus_heures_creuses_fin
        name: Heures creuses - Fin
        icon: mdi:clock-end
      - type: divider
      - entity: binary_sensor.cumulus_fenetre_pv
        name: Dans fenÃªtre PV
        icon: mdi:sun-clock
      - entity: binary_sensor.cumulus_en_hc
        name: En heures creuses
        icon: mdi:clock-time-eight-outline

  # ==================== CONDITIONS BLOQUANTES ==================== #
  - type: custom:mushroom-title-card
    title: "ğŸš¦ Diagnostic Conditions Bloquantes"
    subtitle: "Vue d'ensemble de toutes les conditions et blocages actifs"

  - type: markdown
    content: |
      {% set interdit = is_state('input_boolean.cumulus_interdit', 'on') %}
      {% set vacances = is_state('input_boolean.cumulus_vacances', 'on') %}
      {% set verrou = is_state('input_boolean.cumulus_verrou_jour', 'on') %}
      {% set temp_atteinte = is_state('input_boolean.temp_atteinte_aujourdhui', 'on') %}
      {% set deadband = is_state('binary_sensor.cumulus_deadband_actif', 'on') %}
      {% set appareil = is_state('binary_sensor.cumulus_appareil_en_cours', 'on') %}
      {% set override = is_state('input_boolean.cumulus_override', 'on') %}
      {% set cumulus_on = is_state('binary_sensor.cumulus_chauffe_reelle', 'on') %}
      {% set lave_linge = is_state('binary_sensor.cumulus_lave_linge_actif', 'on') %}
      {% set lave_vaisselle = is_state('binary_sensor.cumulus_lave_vaisselle_actif', 'on') %}
      {% set fenetre_pv = is_state('binary_sensor.cumulus_fenetre_pv', 'on') %}
      {% set en_hc = is_state('binary_sensor.cumulus_en_hc', 'on') %}
      {% set pv = states('sensor.cumulus_pv_effectif_w') | float(0) %}
      {% set seuil_pv = states('sensor.cumulus_seuil_pv_dynamique_w') | float(100) %}
      {% set soc = states('sensor.cumulus_soc_solarbank_pct') | float(0) %}
      {% set seuil_soc = states('input_number.cumulus_soc_start_pct') | float(25) %}
      {% set logique_hc = is_state('binary_sensor.cumulus_autoriser_chauffe_hc_intelligente', 'on') %}
      {% set autoriser_hc = is_state('input_boolean.cumulus_autoriser_hc', 'on') %}

      {% set nb_blocages = 0 %}
      {% if interdit %}{% set nb_blocages = nb_blocages + 1 %}{% endif %}
      {% if vacances %}{% set nb_blocages = nb_blocages + 1 %}{% endif %}
      {% if verrou %}{% set nb_blocages = nb_blocages + 1 %}{% endif %}
      {% if temp_atteinte %}{% set nb_blocages = nb_blocages + 1 %}{% endif %}
      {% if deadband %}{% set nb_blocages = nb_blocages + 1 %}{% endif %}
      {% if appareil %}{% set nb_blocages = nb_blocages + 1 %}{% endif %}

      ### ğŸ“Š Ã‰tat Global

      {% if cumulus_on %}
      ## ğŸ”¥ **CUMULUS EN CHAUFFE**
      Le cumulus fonctionne actuellement.
      {% elif override %}
      ## ğŸš€ **MODE OVERRIDE ACTIF**
      DÃ©marrage forcÃ© - court-circuite les conditions normales.
      {% elif nb_blocages > 0 %}
      ## âŒ **{{ nb_blocages }} BLOCAGE(S) ACTIF(S)**
      Le cumulus ne peut pas dÃ©marrer Ã  cause des conditions ci-dessous.
      {% else %}
      ## ğŸ’¤ **EN ATTENTE**
      Aucun blocage mais conditions de dÃ©marrage non rÃ©unies.
      {% endif %}

      ---

      ### ğŸš« CONDITIONS BLOQUANTES CRITIQUES

      {% if interdit %}
      ### ğŸ”’ **INTERDIT** âŒ
      - **Ã‰tat** : Mode maintenance/arrÃªt forcÃ© **ACTIF**
      - **Action** : DÃ©sactiver le mode "Interdit" dans les contrÃ´les
      - **Impact** : EmpÃªche tout dÃ©marrage
      {% else %}
      âœ… **Interdit** : DÃ©sactivÃ© (OK)
      {% endif %}

      {% if vacances %}
      ### ğŸ–ï¸ **VACANCES** âŒ
      - **Ã‰tat** : Mode vacances **ACTIF**
      - **Action** : DÃ©sactiver le mode "Vacances" dans les contrÃ´les
      - **Impact** : EmpÃªche tout dÃ©marrage
      {% else %}
      âœ… **Vacances** : DÃ©sactivÃ© (OK)
      {% endif %}

      {% if verrou %}
      ### ğŸ“… **VERROU JOURNALIER** âŒ
      - **Ã‰tat** : Chauffe dÃ©jÃ  effectuÃ©e aujourd'hui
      - **Action** : Attendre le reset automatique Ã  08:10 demain
      - **Impact** : EmpÃªche une 2Ã¨me chauffe le mÃªme jour
      {% else %}
      âœ… **Verrou jour** : Pas de verrou (OK)
      {% endif %}

      {% if temp_atteinte %}
      ### ğŸŒ¡ï¸ **TEMPÃ‰RATURE ATTEINTE** âŒ
      - **Ã‰tat** : TempÃ©rature cible dÃ©jÃ  atteinte aujourd'hui
      - **Action** : La tempÃ©rature se rÃ©initialisera automatiquement
      - **Impact** : EmpÃªche une chauffe supplÃ©mentaire
      {% else %}
      âœ… **TempÃ©rature atteinte** : Non (OK - besoin de chauffer)
      {% endif %}

      {% if deadband %}
      ### â±ï¸ **DEADBAND** â³
      - **Ã‰tat** : Temporisation de sÃ©curitÃ© en cours
      - **Action** : Attendre quelques secondes/minutes
      - **Impact** : Retarde temporairement le prochain dÃ©marrage
      {% else %}
      âœ… **Deadband** : Inactif (OK)
      {% endif %}

      {% if appareil %}
      ### âš¡ **APPAREIL PRIORITAIRE** âŒ
      - **Ã‰tat** : {% if lave_linge %}ğŸ”µ Lave-linge actif{% elif lave_vaisselle %}ğŸ”µ Lave-vaisselle actif{% else %}Appareil actif{% endif %}
      - **Action** : Attendre la fin du cycle (redÃ©marrage auto aprÃ¨s 30s)
      - **Impact** : ArrÃªt immÃ©diat ou blocage du dÃ©marrage
      - **Seuil dÃ©tection** : > {{ states('input_number.cumulus_seuil_appareil_actif_w') | int }}W
      {% else %}
      âœ… **Appareils prioritaires** : Aucun actif (OK)
      {% endif %}

      ---

      ### â˜€ï¸ CONDITIONS MODE PV

      {% if not fenetre_pv %}
      â° **FenÃªtre PV** : Hors fenÃªtre ({{ states('input_datetime.cumulus_plage_pv_debut') }}-{{ states('input_datetime.cumulus_plage_pv_fin') }})
      {% else %}
      âœ… **FenÃªtre PV** : Dans la fenÃªtre ({{ states('input_datetime.cumulus_plage_pv_debut') }}-{{ states('input_datetime.cumulus_plage_pv_fin') }})
      {% endif %}

      {% if pv <= seuil_pv %}
      âš ï¸ **Puissance PV effective** : Insuffisante ({{ pv | int }}W < {{ seuil_pv | int }}W)
      {% else %}
      âœ… **Puissance PV effective** : Suffisante ({{ pv | int }}W > {{ seuil_pv | int }}W)
      {% endif %}

      **DÃ©tails PV :**
      - PV brut : {{ states('sensor.cumulus_pv_power_w') }}W
      - Î± APS : {{ states('input_number.cumulus_alpha_aps') }}
      - Capacity factor : {{ (states('sensor.cumulus_capacity_factor') | float * 100) | round(0) }}%
      - PV effectif : {{ pv | int }}W

      {% if soc < (seuil_soc - 0.5) %}
      âš ï¸ **Batterie SOC** : Trop bas ({{ soc | int }}% < {{ seuil_soc | int }}%)
      {% else %}
      âœ… **Batterie SOC** : OK ({{ soc | int }}% â‰¥ {{ seuil_soc | int }}%)
      {% endif %}

      ---

      ### ğŸŒ™ CONDITIONS MODE HEURES CREUSES

      {% if not en_hc %}
      â° **Heures creuses** : Hors pÃ©riode HC ({{ states('input_datetime.cumulus_heures_creuses_debut') }}-{{ states('input_datetime.cumulus_heures_creuses_fin') }})
      {% else %}
      âœ… **Heures creuses** : Dans la pÃ©riode HC ({{ states('input_datetime.cumulus_heures_creuses_debut') }}-{{ states('input_datetime.cumulus_heures_creuses_fin') }})
      {% endif %}

      {% if not autoriser_hc %}
      âŒ **Autorisation HC manuelle** : DÃ©sactivÃ©e
      {% else %}
      âœ… **Autorisation HC manuelle** : ActivÃ©e
      {% endif %}

      {% if not logique_hc %}
      âš ï¸ **Logique HC intelligente** : Non validÃ©e (pas urgent ET mÃ©tÃ©o OK demain)
      {% else %}
      âœ… **Logique HC intelligente** : ValidÃ©e (urgent OU mÃ©tÃ©o dÃ©favorable)
      {% endif %}

      ---

      ### ğŸ†˜ MODE OVERRIDE

      {% if override %}
      ### ğŸš€ **OVERRIDE ACTIF** ğŸ”¥
      - **Ã‰tat** : DÃ©marrage forcÃ© immÃ©diat
      - **Action** : Le cumulus devrait dÃ©marrer si contacteur disponible
      - **Impact** : Court-circuite TOUTES les conditions (sauf interdit)
      {% else %}
      ğŸ’¤ **Override** : Inactif (fonctionnement normal)
      {% endif %}

      ---

      ### ğŸ“‹ RÃ‰SUMÃ‰ ACTIONS POSSIBLES

      {% if cumulus_on %}
      âœ… Le cumulus fonctionne - aucune action nÃ©cessaire
      {% elif nb_blocages == 0 and not cumulus_on %}
      ğŸ’¡ **Aucun blocage dÃ©tectÃ©** - Le cumulus attend :
      - â˜€ï¸ Production PV suffisante dans la fenÃªtre PV
      - ğŸŒ™ Heures creuses avec logique intelligente validÃ©e
      - ğŸš€ Activation manuelle du mode Override
      {% else %}
      ğŸ”§ **Actions pour dÃ©bloquer** :
      {% if interdit %}
      1. âŒ DÃ©sactiver "Mode Interdit"
      {% endif %}
      {% if vacances %}
      2. âŒ DÃ©sactiver "Mode Vacances"
      {% endif %}
      {% if verrou %}
      3. â° Attendre le reset automatique Ã  08:10
      {% endif %}
      {% if temp_atteinte %}
      4. â° Attendre que la tempÃ©rature baisse
      {% endif %}
      {% if appareil %}
      5. â³ Attendre la fin du cycle de l'appareil
      {% endif %}
      {% if deadband %}
      6. â³ Attendre la fin de la temporisation
      {% endif %}
      {% endif %}

  # ==================== INDICATEURS INTELLIGENTS ==================== #
  - type: custom:mushroom-title-card
    title: "ğŸ§  Logique Intelligente"
    subtitle: ""

  - type: entities
    entities:
      - entity: binary_sensor.cumulus_meteo_favorable_aujourdhui
        name: MÃ©tÃ©o favorable aujourd'hui
        icon: mdi:weather-sunny
      - entity: binary_sensor.cumulus_meteo_favorable_demain
        name: MÃ©tÃ©o favorable demain
        icon: mdi:calendar-today
      - entity: binary_sensor.cumulus_besoin_chauffe_urgente
        name: Besoin chauffe urgente
        icon: mdi:alert-circle
      - entity: binary_sensor.cumulus_autoriser_chauffe_hc_intelligente
        name: HC autorisÃ©e (logique)
        icon: mdi:brain
      - type: divider
      - entity: binary_sensor.cumulus_chauffe_reelle
        name: Chauffe rÃ©elle dÃ©tectÃ©e
        icon: mdi:fire
      - entity: binary_sensor.cumulus_fini_par_import
        name: Fin dÃ©tectÃ©e (import)
        icon: mdi:check-circle
      - entity: binary_sensor.cumulus_deadband_actif
        name: Deadband actif
        icon: mdi:timer-sand
