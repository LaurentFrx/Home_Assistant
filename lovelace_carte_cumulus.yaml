###############################################################################
# CARTE LOVELACE CUMULUS â€” Design moderne et complet
# Ã€ intÃ©grer dans votre dashboard Lovelace
###############################################################################

type: vertical-stack
cards:
  # ==================== EN-TÃŠTE PRINCIPAL ==================== #
  - type: custom:mushroom-title-card
    title: "ğŸ’§ Gestion Intelligente du Cumulus"
    subtitle: "Ballon {{ states('input_number.cumulus_capacite_litres') | int }}L â€¢ {{ states('input_number.cumulus_nb_personnes') | int }} personne(s)"

  # ==================== STATUT EN TEMPS RÃ‰EL ==================== #
  - type: custom:mushroom-chips-card
    chips:
      - type: template
        entity: binary_sensor.cumulus_chauffe_reelle
        icon: mdi:fire
        icon_color: >
          {% if is_state('binary_sensor.cumulus_chauffe_reelle', 'on') %}
            red
          {% else %}
            grey
          {% endif %}
        content: >
          {% if is_state('binary_sensor.cumulus_chauffe_reelle', 'on') %}
            ğŸ”¥ Chauffe en cours
          {% else %}
            ğŸ’¤ Repos
          {% endif %}

      - type: template
        entity: sensor.cumulus_temperature_estimee
        icon: mdi:thermometer
        icon_color: >
          {% set temp = states('sensor.cumulus_temperature_estimee') | float(0) %}
          {% if temp >= 50 %}
            red
          {% elif temp >= 35 %}
            orange
          {% else %}
            blue
          {% endif %}
        content: "{{ states('sensor.cumulus_temperature_estimee') }}Â°C"

      - type: template
        entity: sensor.cumulus_litres_disponibles_estimes
        icon: mdi:water
        icon_color: >
          {% set litres = states('sensor.cumulus_litres_disponibles_estimes') | float(0) %}
          {% set capacite = states('input_number.cumulus_capacite_litres') | float(300) %}
          {% set ratio = (litres / capacite * 100) | int %}
          {% if ratio >= 70 %}
            green
          {% elif ratio >= 40 %}
            orange
          {% else %}
            red
          {% endif %}
        content: "{{ states('sensor.cumulus_litres_disponibles_estimes') }}L"

      - type: template
        entity: sensor.cumulus_heures_depuis_derniere_chauffe
        icon: mdi:clock-outline
        icon_color: >
          {% set heures = states('sensor.cumulus_heures_depuis_derniere_chauffe') | float(0) %}
          {% if heures >= 50 %}
            red
          {% elif heures >= 36 %}
            orange
          {% else %}
            green
          {% endif %}
        content: "{{ states('sensor.cumulus_heures_depuis_derniere_chauffe') }}h"

  # ==================== JAUGE TEMPÃ‰RATURE ==================== #
  - type: gauge
    entity: sensor.cumulus_temperature_estimee
    name: TempÃ©rature estimÃ©e de l'eau
    min: 20
    max: 60
    severity:
      green: 50
      yellow: 35
      red: 20
    needle: true

  # ==================== GRAPHIQUE HISTORIQUE ==================== #
  - type: custom:mini-graph-card
    name: Historique tempÃ©rature et production
    hours_to_show: 48
    points_per_hour: 2
    line_width: 3
    animate: true
    entities:
      - entity: sensor.cumulus_temperature_estimee
        name: TempÃ©rature eau
        color: "#FF5733"
        show_state: true
        show_indicator: true
      - entity: sensor.cumulus_pv_power_w
        name: Production PV
        color: "#FFC300"
        show_state: true
        y_axis: secondary
      - entity: sensor.cumulus_import_reseau_w
        name: Import rÃ©seau
        color: "#3498DB"
        show_state: true
        y_axis: secondary

  # ==================== MÃ‰TÃ‰O & PRÃ‰VISIONS ==================== #
  - type: horizontal-stack
    cards:
      - type: custom:mushroom-entity-card
        entity: sensor.cumulus_solcast_forecast_today
        name: PrÃ©vision Aujourd'hui
        icon: mdi:weather-sunny
        icon_color: >
          {% if is_state('binary_sensor.cumulus_meteo_favorable_aujourdhui', 'on') %}
            amber
          {% else %}
            grey
          {% endif %}
        primary_info: name
        secondary_info: state

      - type: custom:mushroom-entity-card
        entity: sensor.cumulus_solcast_forecast_tomorrow
        name: PrÃ©vision Demain
        icon: mdi:weather-sunny-alert
        icon_color: >
          {% if is_state('binary_sensor.cumulus_meteo_favorable_demain', 'on') %}
            amber
          {% else %}
            grey
          {% endif %}
        primary_info: name
        secondary_info: state

  # ==================== CONTRÃ”LES RAPIDES ==================== #
  - type: custom:mushroom-title-card
    title: "ğŸ›ï¸ ContrÃ´les"
    subtitle: ""

  - type: horizontal-stack
    cards:
      - type: custom:mushroom-entity-card
        entity: input_boolean.cumulus_override
        name: Override Manuel
        icon: mdi:hand-pointing-up
        tap_action:
          action: toggle
        fill_container: false

      - type: custom:mushroom-entity-card
        entity: input_boolean.cumulus_interdit
        name: Interdit
        icon: mdi:cancel
        tap_action:
          action: toggle
        fill_container: false

      - type: custom:mushroom-entity-card
        entity: input_boolean.cumulus_vacances
        name: Vacances
        icon: mdi:beach
        tap_action:
          action: toggle
        fill_container: false

  - type: horizontal-stack
    cards:
      - type: custom:mushroom-entity-card
        entity: input_boolean.cumulus_autoriser_hc
        name: Autoriser HC
        icon: mdi:clock-time-eight
        tap_action:
          action: toggle
        fill_container: false

      - type: custom:mushroom-entity-card
        entity: binary_sensor.cumulus_besoin_chauffe_urgente
        name: Besoin urgent
        icon: mdi:alert-circle
        icon_color: >
          {% if is_state('binary_sensor.cumulus_besoin_chauffe_urgente', 'on') %}
            red
          {% else %}
            green
          {% endif %}
        tap_action:
          action: none
        fill_container: false

      - type: custom:mushroom-entity-card
        entity: input_boolean.temp_atteinte_aujourdhui
        name: Temp. atteinte
        icon: mdi:thermometer-check
        icon_color: >
          {% if is_state('input_boolean.temp_atteinte_aujourdhui', 'on') %}
            green
          {% else %}
            grey
          {% endif %}
        tap_action:
          action: none
        fill_container: false

  - type: horizontal-stack
    cards:
      - type: custom:mushroom-entity-card
        entity: input_boolean.cumulus_verrou_jour
        name: Verrou journalier
        icon: mdi:calendar-remove
        icon_color: >
          {% if is_state('input_boolean.cumulus_verrou_jour', 'on') %}
            red
          {% else %}
            green
          {% endif %}
        tap_action:
          action: none
        fill_container: false

      - type: custom:mushroom-entity-card
        entity: binary_sensor.cumulus_deadband_actif
        name: Deadband
        icon: mdi:timer-sand
        icon_color: >
          {% if is_state('binary_sensor.cumulus_deadband_actif', 'on') %}
            orange
          {% else %}
            grey
          {% endif %}
        tap_action:
          action: none
        fill_container: false

  # ==================== PLANNING JOURNALIER ==================== #
  - type: custom:mushroom-title-card
    title: "ğŸ“… Planning Journalier"
    subtitle: "Plages horaires de chauffe et Ã©vÃ©nements quotidiens"

  - type: markdown
    content: |
      ### ğŸ• Plages horaires actives

      | PÃ©riode | Horaire | Type | Conditions |
      |---------|---------|------|------------|
      | **ğŸŒ™ Heures Creuses** | {{ states('input_datetime.cumulus_heures_creuses_debut') }} - {{ states('input_datetime.cumulus_heures_creuses_fin') }} | HC RÃ©seau | Logique intelligente |
      | **ğŸ”„ Reset quotidien** | 08:10 | Auto | Verrou + Temp. atteinte |
      | **â˜€ï¸ FenÃªtre PV** | {{ states('input_datetime.cumulus_plage_pv_debut') }} - {{ states('input_datetime.cumulus_plage_pv_fin') }} | Surplus PV | Si PV > seuil |

      ---

      #### Logique HC intelligente active si :
      - âœ… Autorisation HC activÃ©e **ET**
      - ğŸ”´ Besoin urgent (> {{ states('input_number.cumulus_espacement_max_h') }}h) **OU**
      - ğŸŒ§ï¸ MÃ©tÃ©o dÃ©favorable demain (< {{ states('input_number.cumulus_seuil_solcast_bon_kwh') }} kWh)

      ---

      #### Ã‰tat actuel :
      {% if is_state('binary_sensor.cumulus_en_hc', 'on') %}
      ğŸŒ™ **EN HEURES CREUSES** ({{ states('input_datetime.cumulus_heures_creuses_debut') }} - {{ states('input_datetime.cumulus_heures_creuses_fin') }})
      {% elif is_state('binary_sensor.cumulus_fenetre_pv', 'on') %}
      â˜€ï¸ **DANS FENÃŠTRE PV** ({{ states('input_datetime.cumulus_plage_pv_debut') }} - {{ states('input_datetime.cumulus_plage_pv_fin') }})
      {% else %}
      ğŸ’¤ **HORS PÃ‰RIODE DE CHAUFFE**
      {% endif %}

  # ==================== TIMELINE 24H ==================== #
  - type: markdown
    content: |
      ### â° Timeline 24h

      ```
      00:00 â”â”â”â”â”â”â”â”â”â”“
                     â”ƒ ğŸ’¤ Nuit
      03:30 â”â”â”â”â”â”â”â”â”â”«
                     â”ƒ ğŸŒ™ HEURES CREUSES
      08:05 â”â”â”â”â”â”â”â”â”â”«    (si logique intelligente)
                     â”ƒ
      08:10 â”â”â”â”â”â”â”â”â”â•‹â”â” ğŸ”„ RESET QUOTIDIEN
                     â”ƒ    (verrou + temp.atteinte)
      10:20 â”â”â”â”â”â”â”â”â”â”«
                     â”ƒ â˜€ï¸ FENÃŠTRE PV
                     â”ƒ    (si PV > {{ states('input_number.cumulus_seuil_pv_on_w') | int }}W)
      17:50 â”â”â”â”â”â”â”â”â”â”«
                     â”ƒ ğŸ’¤ SoirÃ©e
      00:00 â”â”â”â”â”â”â”â”â”â”›
      ```

      **LÃ©gende** :
      - ğŸŒ™ HC : chauffe rÃ©seau (conditions intelligentes)
      - ğŸ”„ Reset : rÃ©initialisation verrou journalier
      - â˜€ï¸ PV : chauffe sur surplus solaire
      - ğŸ’¤ : aucune chauffe possible

  # ==================== DONNÃ‰ES TECHNIQUES ==================== #
  - type: custom:mushroom-title-card
    title: "ğŸ“Š DonnÃ©es Techniques"
    subtitle: ""

  - type: entities
    entities:
      - entity: sensor.cumulus_import_reseau_w
        name: Import rÃ©seau actuel
        icon: mdi:transmission-tower-import
      - entity: sensor.cumulus_pv_power_w
        name: Production PV
        icon: mdi:solar-power
      - entity: sensor.cumulus_soc_solarbank_pct
        name: Charge batterie
        icon: mdi:battery
      - entity: input_number.cumulus_puissance_w
        name: Puissance cumulus
        icon: mdi:lightning-bolt
      - type: divider
      - entity: sensor.cumulus_seuil_import_limiteur_w
        name: Seuil limiteur import
        icon: mdi:flash-alert
      - entity: sensor.cumulus_seuil_fin_chauffe_w
        name: Seuil fin de chauffe
        icon: mdi:flash-triangle-outline
      - type: divider
      - entity: input_datetime.cumulus_derniere_chauffe_complete
        name: DerniÃ¨re chauffe complÃ¨te
        icon: mdi:calendar-clock

  # ==================== CONFIGURATION ==================== #
  - type: custom:mushroom-title-card
    title: "âš™ï¸ Configuration"
    subtitle: ""

  - type: entities
    title: "ğŸ  ParamÃ¨tres gÃ©nÃ©raux"
    entities:
      - entity: input_number.cumulus_nb_personnes
        name: Nombre de personnes
        icon: mdi:account-multiple
      - entity: input_number.cumulus_capacite_litres
        name: CapacitÃ© du ballon
        icon: mdi:water-boiler
      - entity: input_number.cumulus_puissance_w
        name: Puissance cumulus
        icon: mdi:lightning-bolt
      - entity: input_number.cumulus_espacement_max_h
        name: Espacement maxi
        icon: mdi:timer-sand

  - type: entities
    title: "âš¡ ParamÃ¨tres PV et dÃ©marrage"
    entities:
      - entity: input_number.cumulus_seuil_pv_on_w
        name: Seuil PV dÃ©marrage
        icon: mdi:white-balance-sunny
      - entity: input_number.cumulus_on_delay_s
        name: DÃ©lai confirmation ON
        icon: mdi:timer-play
      - entity: input_number.cumulus_deadband_s
        name: Deadband global
        icon: mdi:progress-clock
      - entity: input_number.cumulus_mini_deadband_no_delay_s
        name: Mini-deadband no_delay
        icon: mdi:timer-outline
      - entity: input_number.cumulus_seuil_solcast_bon_kwh
        name: Seuil "bonne journÃ©e"
        icon: mdi:weather-sunny

  - type: entities
    title: "ğŸ”‹ ParamÃ¨tres batterie (SOC)"
    entities:
      - entity: input_number.cumulus_soc_start_pct
        name: SOC mini dÃ©marrage
        icon: mdi:battery-70
      - entity: input_number.cumulus_soc_stop_pct
        name: SOC arrÃªt sÃ©curitÃ©
        icon: mdi:battery-alert
      - entity: input_number.cumulus_solarbank_max_w
        name: Puissance max Solarbank
        icon: mdi:battery-charging-100
      - entity: input_number.cumulus_aps_max_w
        name: Puissance max APS
        icon: mdi:solar-power

  - type: entities
    title: "ğŸ“Š ParamÃ¨tres import rÃ©seau"
    entities:
      - entity: input_number.cumulus_talon_maison_w
        name: Talon maison
        icon: mdi:home-lightning-bolt
      - entity: input_number.cumulus_marge_import_w
        name: Marge import (limiteur)
        icon: mdi:flash-alert
      - entity: input_number.cumulus_marge_fin_import_w
        name: Marge fin import
        icon: mdi:flash-triangle-outline

  # ==================== FENÃŠTRES HORAIRES ==================== #
  - type: custom:mushroom-title-card
    title: "ğŸ• FenÃªtres Horaires"
    subtitle: ""

  - type: entities
    entities:
      - entity: input_datetime.cumulus_plage_pv_debut
        name: FenÃªtre PV - DÃ©but
        icon: mdi:weather-sunny
      - entity: input_datetime.cumulus_plage_pv_fin
        name: FenÃªtre PV - Fin
        icon: mdi:weather-sunset
      - type: divider
      - entity: input_datetime.cumulus_heures_creuses_debut
        name: Heures creuses - DÃ©but
        icon: mdi:clock-start
      - entity: input_datetime.cumulus_heures_creuses_fin
        name: Heures creuses - Fin
        icon: mdi:clock-end
      - type: divider
      - entity: binary_sensor.cumulus_fenetre_pv
        name: Dans fenÃªtre PV
        icon: mdi:sun-clock
      - entity: binary_sensor.cumulus_en_hc
        name: En heures creuses
        icon: mdi:clock-time-eight-outline

  # ==================== INDICATEURS INTELLIGENTS ==================== #
  - type: custom:mushroom-title-card
    title: "ğŸ§  Logique Intelligente"
    subtitle: ""

  - type: entities
    entities:
      - entity: binary_sensor.cumulus_meteo_favorable_aujourdhui
        name: MÃ©tÃ©o favorable aujourd'hui
        icon: mdi:weather-sunny
      - entity: binary_sensor.cumulus_meteo_favorable_demain
        name: MÃ©tÃ©o favorable demain
        icon: mdi:calendar-today
      - entity: binary_sensor.cumulus_besoin_chauffe_urgente
        name: Besoin chauffe urgente
        icon: mdi:alert-circle
      - entity: binary_sensor.cumulus_autoriser_chauffe_hc_intelligente
        name: HC autorisÃ©e (logique)
        icon: mdi:brain
      - type: divider
      - entity: binary_sensor.cumulus_chauffe_reelle
        name: Chauffe rÃ©elle dÃ©tectÃ©e
        icon: mdi:fire
      - entity: binary_sensor.cumulus_fini_par_import
        name: Fin dÃ©tectÃ©e (import)
        icon: mdi:check-circle
      - entity: binary_sensor.cumulus_deadband_actif
        name: Deadband actif
        icon: mdi:timer-sand
