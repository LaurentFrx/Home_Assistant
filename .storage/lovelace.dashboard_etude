{
  "version": 1,
  "minor_version": 1,
  "key": "lovelace.dashboard_etude",
  "data": {
    "config": {
      "custom": "mushroom-card",
      "views": [
        {
          "icon": "mdi:home-lightning-bolt",
          "visible": [
            {
              "user": "65f9557d9a4e4b3ca7469ddd356031a8"
            }
          ],
          "button_card_templates": {
            "ce_num_setting": {
              "variables": {
                "lock_entity": "input_boolean.cumulus_reglages_lock",
                "accent": "#3b82f6",
                "icon": "mdi:tune",
                "name": ""
              },
              "triggers_update": "all",
              "show_icon": true,
              "icon": "[[[ return variables.icon ]]]",
              "show_name": true,
              "name": "[[[ return variables.name || entity.attributes.friendly_name ]]]",
              "show_state": false,
              "styles": {
                "card": [
                  {
                    "padding": "10px"
                  },
                  {
                    "border-radius": "16px"
                  },
                  {
                    "border": "[[[ return `1px solid color-mix(in srgb, ${variables.accent} 45%, transparent)` ]]]\n"
                  },
                  {
                    "background": "[[[ return `linear-gradient(135deg, color-mix(in srgb, ${variables.accent} 18%, transparent) 0%, transparent 60%)` ]]]\n"
                  }
                ],
                "icon": [
                  {
                    "color": "[[[ return variables.accent ]]]"
                  }
                ],
                "grid": [
                  {
                    "grid-template-areas": "'i n v' 'bar bar bar' 'moins plus plus'"
                  },
                  {
                    "grid-template-columns": "24px 1fr auto"
                  },
                  {
                    "grid-template-rows": "auto 8px auto"
                  },
                  {
                    "row-gap": "6px"
                  }
                ],
                "name": [
                  {
                    "align-self": "center"
                  },
                  {
                    "font-weight": 600
                  }
                ],
                "custom_fields": {
                  "v": [
                    {
                      "align-self": "center"
                    },
                    {
                      "justify-self": "end"
                    },
                    {
                      "font-weight": 700
                    }
                  ],
                  "bar": [
                    {
                      "height": "6px"
                    },
                    {
                      "border-radius": "6px"
                    },
                    {
                      "background": "[[[\n  const a = entity.attributes;\n  const min = Number(a.min ?? 0), max = Number(a.max ?? 100);\n  const v = Math.min(max, Math.max(min, Number(entity.state) || 0));\n  const pct = ((v - min) * 100) / (max - min || 1);\n  return `linear-gradient(to right, ${variables.accent} ${pct}%, var(--ha-card-background) ${pct}%)`;\n]]]\n"
                    }
                  ]
                }
              },
              "custom_fields": {
                "v": "[[[\n  const u = entity.attributes.unit_of_measurement || '';\n  const v = Number(entity.state) || 0;\n  return `${Math.round(v)} ${u}`;\n]]]\n",
                "bar": "",
                "moins": {
                  "card": {
                    "type": "custom:button-card",
                    "icon": "mdi:minus",
                    "tap_action": {
                      "action": "call-service",
                      "service": "input_number.set_value",
                      "service_data": {
                        "entity_id": "[[[ return entity.entity_id ]]]",
                        "value": "[[[\n  const a = entity.attributes;\n  const val = Number(entity.state)||0;\n  const step = Number(a.step)||1;\n  const min = Number(a.min ?? -Infinity);\n  return Math.max(min, val - step);\n]]]\n"
                      }
                    },
                    "hold_action": {
                      "action": "call-service",
                      "service": "input_number.set_value",
                      "service_data": {
                        "entity_id": "[[[ return entity.entity_id ]]]",
                        "value": "[[[\n  const a = entity.attributes;\n  const val = Number(entity.state)||0;\n  const step = Number(a.step)||1;\n  const min = Number(a.min ?? -Infinity);\n  return Math.max(min, val - step*5);\n]]]\n"
                      }
                    },
                    "styles": {
                      "card": [
                        {
                          "padding": "6px"
                        },
                        {
                          "border-radius": "12px"
                        },
                        {
                          "box-shadow": "none"
                        },
                        {
                          "pointer-events": "[[[ return (states[variables.lock_entity]?.state === 'on') ? 'none' : 'auto'; ]]]\n"
                        },
                        {
                          "opacity": "[[[ return (states[variables.lock_entity]?.state === 'on') ? 0.6 : 1; ]]]\n"
                        }
                      ]
                    }
                  }
                },
                "plus": {
                  "card": {
                    "type": "custom:button-card",
                    "icon": "mdi:plus",
                    "tap_action": {
                      "action": "call-service",
                      "service": "input_number.set_value",
                      "service_data": {
                        "entity_id": "[[[ return entity.entity_id ]]]",
                        "value": "[[[\n  const a = entity.attributes;\n  const val = Number(entity.state)||0;\n  const step = Number(a.step)||1;\n  const max = Number(a.max ?? Infinity);\n  return Math.min(max, val + step);\n]]]\n"
                      }
                    },
                    "hold_action": {
                      "action": "call-service",
                      "service": "input_number.set_value",
                      "service_data": {
                        "entity_id": "[[[ return entity.entity_id ]]]",
                        "value": "[[[\n  const a = entity.attributes;\n  const val = Number(entity.state)||0;\n  const step = Number(a.step)||1;\n  const max = Number(a.max ?? Infinity);\n  return Math.min(max, val + step*5);\n]]]\n"
                      }
                    },
                    "styles": {
                      "card": [
                        {
                          "padding": "6px"
                        },
                        {
                          "border-radius": "12px"
                        },
                        {
                          "box-shadow": "none"
                        },
                        {
                          "pointer-events": "[[[ return (states[variables.lock_entity]?.state === 'on') ? 'none' : 'auto'; ]]]\n"
                        },
                        {
                          "opacity": "[[[ return (states[variables.lock_entity]?.state === 'on') ? 0.6 : 1; ]]]\n"
                        }
                      ]
                    }
                  }
                }
              }
            }
          },
          "badges": [
            {
              "type": "entity",
              "show_name": true,
              "show_state": false,
              "show_icon": true,
              "entity": "switch.ordi_moniteur",
              "name": "Hi-fi & écran",
              "icon": "mdi:monitor-speaker",
              "color": "light-green",
              "tap_action": {
                "action": "toggle"
              },
              "show_entity_picture": false
            },
            {
              "type": "entity",
              "show_name": true,
              "show_state": false,
              "show_icon": true,
              "show_entity_picture": true,
              "name": "Atelier",
              "icon": "mdi:lightbulb",
              "tap_action": {
                "action": "toggle"
              },
              "entity": "switch.0x08ddebfffed9ed45"
            },
            {
              "type": "entity",
              "show_name": true,
              "show_state": false,
              "show_icon": true,
              "entity": "switch.shellypro1_ece334ee1b64",
              "tap_action": {
                "action": "toggle"
              },
              "name": "Cumulus",
              "show_entity_picture": false
            }
          ],
          "cards": [
            {
              "type": "custom:vertical-stack-in-card",
              "cards": [
                {
                  "type": "grid",
                  "square": false,
                  "columns": 4,
                  "cards": [
                    {
                      "type": "custom:mushroom-person-card",
                      "entity": "person.laurent",
                      "layout": "vertical",
                      "primary_info": "none",
                      "secondary_info": "state",
                      "icon_type": "entity-picture"
                    },
                    {
                      "show_name": true,
                      "show_icon": true,
                      "type": "button",
                      "icon": "mdi:power-plug",
                      "tap_action": {
                        "action": "toggle"
                      },
                      "entity": "switch.chargeur_laurent",
                      "name": "Chargeur",
                      "icon_height": "24px",
                      "card_mod": {
                        "style": "ha-card {\n  font-size: 12px !important;\n}\n"
                      }
                    },
                    {
                      "type": "gauge",
                      "entity": "sensor.iphone_laurent_battery_level",
                      "name": "16 Pro",
                      "severity": {
                        "green": 50,
                        "yellow": 20,
                        "red": 0
                      }
                    },
                    {
                      "type": "gauge",
                      "entity": "sensor.ipad_pro_battery_level",
                      "severity": {
                        "green": 50,
                        "yellow": 20,
                        "red": 0
                      },
                      "name": "iPad Pro"
                    }
                  ]
                },
                {
                  "type": "grid",
                  "square": false,
                  "columns": 4,
                  "cards": [
                    {
                      "type": "custom:mushroom-person-card",
                      "entity": "person.isabelle",
                      "layout": "vertical",
                      "primary_info": "none",
                      "secondary_info": "state",
                      "icon_type": "entity-picture"
                    },
                    {
                      "type": "button",
                      "show_name": true,
                      "icon": "mdi:power-plug",
                      "tap_action": {
                        "action": "toggle"
                      },
                      "entity": "switch.chargeur_isa",
                      "name": "Chargeur",
                      "icon_height": "24px",
                      "card_mod": {
                        "style": "ha-card {\n  font-size: 12px !important;\n}\n"
                      }
                    },
                    {
                      "type": "gauge",
                      "entity": "sensor.iphone_isa_battery_level",
                      "name": "iPhone",
                      "severity": {
                        "green": 50,
                        "yellow": 20,
                        "red": 0
                      }
                    },
                    {
                      "type": "gauge",
                      "entity": "sensor.ipad_de_isabelle_battery_level",
                      "severity": {
                        "green": 50,
                        "yellow": 20,
                        "red": 0
                      },
                      "name": "iPad Air"
                    }
                  ]
                }
              ]
            },
            {
              "type": "custom:layout-card",
              "layout_type": "grid",
              "layout": {
                "grid-template-columns": "1fr 56px 56px 56px",
                "column-gap": "8px",
                "row-gap": "2px"
              },
              "cards": [
                {
                  "type": "custom:button-card",
                  "entity": "cover.wifi_parents",
                  "name": "Parents",
                  "show_state": false,
                  "show_icon": true,
                  "custom_fields": {
                    "bar": "[[[\n  const a = entity?.attributes || {};\n  const raw = (a.current_position ?? a.position ?? null);\n  let openPct;\n  if (raw === null || raw === undefined) {\n    openPct = (entity?.state === 'open') ? 100\n             : (entity?.state === 'closed') ? 0\n             : 0;\n  } else {\n    openPct = Number(raw);\n  }\n  const pctClosed = Math.max(0, Math.min(100, isFinite(openPct) ? (100 - openPct) : 0));\n  return `\n    <div style=\"height:3px;width:100%;background:var(--ha-card-background,#e6e9ef);border-radius:3px;overflow:hidden\">\n      <div style=\"height:100%;width:${pctClosed}%;background:linear-gradient(90deg,#06b6d4,#22c55e)\"></div>\n    </div>`;\n]]]\n"
                  },
                  "styles": {
                    "card": [
                      {
                        "min-height": "44px"
                      },
                      {
                        "border-radius": "12px"
                      },
                      {
                        "padding": "4px 6px 6px"
                      },
                      {
                        "background": "linear-gradient(135deg, rgba(6,182,212,.10), rgba(6,182,212,.05))"
                      },
                      {
                        "box-shadow": "0 1px 6px rgba(0,0,0,.10)"
                      }
                    ],
                    "grid": [
                      {
                        "grid-template-areas": "\"i n\" \"bar bar\""
                      },
                      {
                        "grid-template-columns": "32px 1fr"
                      },
                      {
                        "grid-template-rows": "auto 3px"
                      },
                      {
                        "row-gap": "2px"
                      }
                    ],
                    "name": [
                      {
                        "align-self": "center"
                      },
                      {
                        "font-weight": 600
                      },
                      {
                        "font-size": ".90rem"
                      },
                      {
                        "line-height": 1.05
                      }
                    ],
                    "icon": [
                      {
                        "width": "22px"
                      },
                      {
                        "color": "#06b6d4"
                      }
                    ],
                    "custom_fields": {
                      "bar": [
                        {
                          "grid-area": "bar"
                        },
                        {
                          "align-self": "end"
                        }
                      ]
                    }
                  },
                  "tap_action": {
                    "action": "none"
                  },
                  "triggers_update": "all"
                },
                {
                  "type": "custom:button-card",
                  "entity": "cover.wifi_parents",
                  "icon": "mdi:arrow-up",
                  "show_name": false,
                  "show_state": false,
                  "show_icon": true,
                  "styles": {
                    "card": [
                      {
                        "min-height": "44px"
                      },
                      {
                        "padding": 0
                      },
                      {
                        "display": "grid"
                      },
                      {
                        "place-items": "center"
                      },
                      {
                        "border-radius": "12px"
                      },
                      {
                        "background": "linear-gradient(135deg, rgba(34,197,94,.14), rgba(6,182,212,.08))"
                      },
                      {
                        "box-shadow": "0 1px 5px rgba(0,0,0,.10)"
                      }
                    ],
                    "icon": [
                      {
                        "color": "rgba(34,197,94,.95)"
                      },
                      {
                        "width": "20px"
                      }
                    ]
                  },
                  "tap_action": {
                    "action": "call-service",
                    "service": "cover.open_cover",
                    "data": {
                      "entity_id": "cover.wifi_parents"
                    }
                  }
                },
                {
                  "type": "custom:button-card",
                  "entity": "cover.wifi_parents",
                  "icon": "mdi:stop",
                  "show_name": false,
                  "show_state": false,
                  "show_icon": true,
                  "styles": {
                    "card": [
                      {
                        "min-height": "44px"
                      },
                      {
                        "padding": 0
                      },
                      {
                        "display": "grid"
                      },
                      {
                        "place-items": "center"
                      },
                      {
                        "border-radius": "12px"
                      },
                      {
                        "background": "linear-gradient(135deg, rgba(148,163,184,.16), rgba(6,182,212,.08))"
                      },
                      {
                        "box-shadow": "0 1px 5px rgba(0,0,0,.10)"
                      }
                    ],
                    "icon": [
                      {
                        "color": "rgba(100,116,139,.95)"
                      },
                      {
                        "width": "18px"
                      }
                    ]
                  },
                  "tap_action": {
                    "action": "call-service",
                    "service": "cover.stop_cover",
                    "data": {
                      "entity_id": "cover.wifi_parents"
                    }
                  }
                },
                {
                  "type": "custom:button-card",
                  "entity": "cover.wifi_parents",
                  "icon": "mdi:arrow-down",
                  "show_name": false,
                  "show_state": false,
                  "show_icon": true,
                  "styles": {
                    "card": [
                      {
                        "min-height": "44px"
                      },
                      {
                        "padding": 0
                      },
                      {
                        "display": "grid"
                      },
                      {
                        "place-items": "center"
                      },
                      {
                        "border-radius": "12px"
                      },
                      {
                        "background": "linear-gradient(135deg, rgba(239,68,68,.14), rgba(6,182,212,.08))"
                      },
                      {
                        "box-shadow": "0 1px 5px rgba(0,0,0,.10)"
                      }
                    ],
                    "icon": [
                      {
                        "color": "rgba(239,68,68,.95)"
                      },
                      {
                        "width": "20px"
                      }
                    ]
                  },
                  "tap_action": {
                    "action": "call-service",
                    "service": "cover.close_cover",
                    "data": {
                      "entity_id": "cover.wifi_parents"
                    }
                  }
                },
                {
                  "type": "custom:button-card",
                  "entity": "cover.wifi_ch_amis",
                  "name": "Ch. d’amis",
                  "show_state": false,
                  "show_icon": true,
                  "custom_fields": {
                    "bar": "[[[\n  const a = entity?.attributes || {};\n  const raw = (a.current_position ?? a.position ?? null);\n  let openPct;\n  if (raw === null || raw === undefined) {\n    openPct = (entity?.state === 'open') ? 100\n             : (entity?.state === 'closed') ? 0\n             : 0;\n  } else {\n    openPct = Number(raw);\n  }\n  const pctClosed = Math.max(0, Math.min(100, isFinite(openPct) ? (100 - openPct) : 0));\n  return `\n    <div style=\"height:3px;width:100%;background:var(--ha-card-background,#e6e9ef);border-radius:3px;overflow:hidden\">\n      <div style=\"height:100%;width:${pctClosed}%;background:linear-gradient(90deg,#06b6d4,#22c55e)\"></div>\n    </div>`;\n]]]\n"
                  },
                  "styles": {
                    "card": [
                      {
                        "min-height": "44px"
                      },
                      {
                        "border-radius": "12px"
                      },
                      {
                        "padding": "4px 6px 6px"
                      },
                      {
                        "background": "linear-gradient(135deg, rgba(6,182,212,.10), rgba(6,182,212,.05))"
                      },
                      {
                        "box-shadow": "0 1px 6px rgba(0,0,0,.10)"
                      }
                    ],
                    "grid": [
                      {
                        "grid-template-areas": "\"i n\" \"bar bar\""
                      },
                      {
                        "grid-template-columns": "32px 1fr"
                      },
                      {
                        "grid-template-rows": "auto 3px"
                      },
                      {
                        "row-gap": "2px"
                      }
                    ],
                    "name": [
                      {
                        "align-self": "center"
                      },
                      {
                        "font-weight": 600
                      },
                      {
                        "font-size": ".90rem"
                      },
                      {
                        "line-height": 1.05
                      }
                    ],
                    "icon": [
                      {
                        "width": "22px"
                      },
                      {
                        "color": "#06b6d4"
                      }
                    ],
                    "custom_fields": {
                      "bar": [
                        {
                          "grid-area": "bar"
                        },
                        {
                          "align-self": "end"
                        }
                      ]
                    }
                  },
                  "tap_action": {
                    "action": "none"
                  },
                  "triggers_update": "all"
                },
                {
                  "type": "custom:button-card",
                  "entity": "cover.wifi_ch_amis",
                  "icon": "mdi:arrow-up",
                  "show_name": false,
                  "show_state": false,
                  "show_icon": true,
                  "styles": {
                    "card": [
                      {
                        "min-height": "44px"
                      },
                      {
                        "padding": 0
                      },
                      {
                        "display": "grid"
                      },
                      {
                        "place-items": "center"
                      },
                      {
                        "border-radius": "12px"
                      },
                      {
                        "background": "linear-gradient(135deg, rgba(34,197,94,.14), rgba(6,182,212,.08))"
                      },
                      {
                        "box-shadow": "0 1px 5px rgba(0,0,0,.10)"
                      }
                    ],
                    "icon": [
                      {
                        "color": "rgba(34,197,94,.95)"
                      },
                      {
                        "width": "20px"
                      }
                    ]
                  },
                  "tap_action": {
                    "action": "call-service",
                    "service": "cover.open_cover",
                    "data": {
                      "entity_id": "cover.wifi_ch_amis"
                    }
                  }
                },
                {
                  "type": "custom:button-card",
                  "entity": "cover.wifi_ch_amis",
                  "icon": "mdi:stop",
                  "show_name": false,
                  "show_state": false,
                  "show_icon": true,
                  "styles": {
                    "card": [
                      {
                        "min-height": "44px"
                      },
                      {
                        "padding": 0
                      },
                      {
                        "display": "grid"
                      },
                      {
                        "place-items": "center"
                      },
                      {
                        "border-radius": "12px"
                      },
                      {
                        "background": "linear-gradient(135deg, rgba(148,163,184,.16), rgba(6,182,212,.08))"
                      },
                      {
                        "box-shadow": "0 1px 5px rgba(0,0,0,.10)"
                      }
                    ],
                    "icon": [
                      {
                        "color": "rgba(100,116,139,.95)"
                      },
                      {
                        "width": "18px"
                      }
                    ]
                  },
                  "tap_action": {
                    "action": "call-service",
                    "service": "cover.stop_cover",
                    "data": {
                      "entity_id": "cover.wifi_ch_amis"
                    }
                  }
                },
                {
                  "type": "custom:button-card",
                  "entity": "cover.wifi_ch_amis",
                  "icon": "mdi:arrow-down",
                  "show_name": false,
                  "show_state": false,
                  "show_icon": true,
                  "styles": {
                    "card": [
                      {
                        "min-height": "44px"
                      },
                      {
                        "padding": 0
                      },
                      {
                        "display": "grid"
                      },
                      {
                        "place-items": "center"
                      },
                      {
                        "border-radius": "12px"
                      },
                      {
                        "background": "linear-gradient(135deg, rgba(239,68,68,.14), rgba(6,182,212,.08))"
                      },
                      {
                        "box-shadow": "0 1px 5px rgba(0,0,0,.10)"
                      }
                    ],
                    "icon": [
                      {
                        "color": "rgba(239,68,68,.95)"
                      },
                      {
                        "width": "20px"
                      }
                    ]
                  },
                  "tap_action": {
                    "action": "call-service",
                    "service": "cover.close_cover",
                    "data": {
                      "entity_id": "cover.wifi_ch_amis"
                    }
                  }
                },
                {
                  "type": "custom:button-card",
                  "entity": "cover.wifi_salon",
                  "name": "Salon",
                  "show_state": false,
                  "show_icon": true,
                  "custom_fields": {
                    "bar": "[[[\n  const a = entity?.attributes || {};\n  const raw = (a.current_position ?? a.position ?? null);\n  let openPct;\n  if (raw === null || raw === undefined) {\n    openPct = (entity?.state === 'open') ? 100\n             : (entity?.state === 'closed') ? 0\n             : 0;\n  } else {\n    openPct = Number(raw);\n  }\n  const pctClosed = Math.max(0, Math.min(100, isFinite(openPct) ? (100 - openPct) : 0));\n  return `\n    <div style=\"height:3px;width:100%;background:var(--ha-card-background,#e6e9ef);border-radius:3px;overflow:hidden\">\n      <div style=\"height:100%;width:${pctClosed}%;background:linear-gradient(90deg,#6366f1,#22c55e)\"></div>\n    </div>`;\n]]]\n"
                  },
                  "styles": {
                    "card": [
                      {
                        "min-height": "44px"
                      },
                      {
                        "border-radius": "12px"
                      },
                      {
                        "padding": "4px 6px 6px"
                      },
                      {
                        "background": "linear-gradient(135deg, rgba(99,102,241,.12), rgba(6,182,212,.06))"
                      },
                      {
                        "box-shadow": "0 1px 6px rgba(0,0,0,.10)"
                      }
                    ],
                    "grid": [
                      {
                        "grid-template-areas": "\"i n\" \"bar bar\""
                      },
                      {
                        "grid-template-columns": "32px 1fr"
                      },
                      {
                        "grid-template-rows": "auto 3px"
                      },
                      {
                        "row-gap": "2px"
                      }
                    ],
                    "name": [
                      {
                        "align-self": "center"
                      },
                      {
                        "font-weight": 600
                      },
                      {
                        "font-size": ".90rem"
                      },
                      {
                        "line-height": 1.05
                      }
                    ],
                    "icon": [
                      {
                        "width": "22px"
                      },
                      {
                        "color": "#6366f1"
                      }
                    ],
                    "custom_fields": {
                      "bar": [
                        {
                          "align-self": "end"
                        }
                      ]
                    }
                  },
                  "tap_action": {
                    "action": "none"
                  },
                  "triggers_update": "all"
                },
                {
                  "type": "custom:button-card",
                  "entity": "cover.wifi_salon",
                  "icon": "mdi:arrow-up",
                  "show_name": false,
                  "show_state": false,
                  "show_icon": true,
                  "styles": {
                    "card": [
                      {
                        "min-height": "44px"
                      },
                      {
                        "padding": 0
                      },
                      {
                        "display": "grid"
                      },
                      {
                        "place-items": "center"
                      },
                      {
                        "border-radius": "12px"
                      },
                      {
                        "background": "linear-gradient(135deg, rgba(34,197,94,.14), rgba(6,182,212,.08))"
                      },
                      {
                        "box-shadow": "0 1px 5px rgba(0,0,0,.10)"
                      }
                    ],
                    "icon": [
                      {
                        "color": "rgba(34,197,94,.95)"
                      },
                      {
                        "width": "20px"
                      }
                    ]
                  },
                  "tap_action": {
                    "action": "call-service",
                    "service": "cover.open_cover",
                    "data": {
                      "entity_id": "cover.wifi_salon"
                    }
                  }
                },
                {
                  "type": "custom:button-card",
                  "entity": "cover.wifi_salon",
                  "icon": "mdi:stop",
                  "show_name": false,
                  "show_state": false,
                  "show_icon": true,
                  "styles": {
                    "card": [
                      {
                        "min-height": "44px"
                      },
                      {
                        "padding": 0
                      },
                      {
                        "display": "grid"
                      },
                      {
                        "place-items": "center"
                      },
                      {
                        "border-radius": "12px"
                      },
                      {
                        "background": "linear-gradient(135deg, rgba(148,163,184,.16), rgba(6,182,212,.08))"
                      },
                      {
                        "box-shadow": "0 1px 5px rgba(0,0,0,.10)"
                      }
                    ],
                    "icon": [
                      {
                        "color": "rgba(100,116,139,.95)"
                      },
                      {
                        "width": "18px"
                      }
                    ]
                  },
                  "tap_action": {
                    "action": "call-service",
                    "service": "cover.stop_cover",
                    "data": {
                      "entity_id": "cover.wifi_salon"
                    }
                  }
                },
                {
                  "type": "custom:button-card",
                  "entity": "cover.wifi_salon",
                  "icon": "mdi:arrow-down",
                  "show_name": false,
                  "show_state": false,
                  "show_icon": true,
                  "styles": {
                    "card": [
                      {
                        "min-height": "44px"
                      },
                      {
                        "padding": 0
                      },
                      {
                        "display": "grid"
                      },
                      {
                        "place-items": "center"
                      },
                      {
                        "border-radius": "12px"
                      },
                      {
                        "background": "linear-gradient(135deg, rgba(239,68,68,.14), rgba(6,182,212,.08))"
                      },
                      {
                        "box-shadow": "0 1px 5px rgba(0,0,0,.10)"
                      }
                    ],
                    "icon": [
                      {
                        "color": "rgba(239,68,68,.95)"
                      },
                      {
                        "width": "20px"
                      }
                    ]
                  },
                  "tap_action": {
                    "action": "call-service",
                    "service": "cover.close_cover",
                    "data": {
                      "entity_id": "cover.wifi_salon"
                    }
                  }
                },
                {
                  "type": "custom:button-card",
                  "entity": "cover.wifi_sam",
                  "name": "Salle à manger",
                  "show_state": false,
                  "show_icon": true,
                  "custom_fields": {
                    "bar": "[[[\n  const a = entity?.attributes || {};\n  const raw = (a.current_position ?? a.position ?? null);\n  let openPct;\n  if (raw === null || raw === undefined) {\n    openPct = (entity?.state === 'open') ? 100\n             : (entity?.state === 'closed') ? 0\n             : 0;\n  } else {\n    openPct = Number(raw);\n  }\n  const pctClosed = Math.max(0, Math.min(100, isFinite(openPct) ? (100 - openPct) : 0));\n  return `\n    <div style=\"height:3px;width:100%;background:var(--ha-card-background,#e6e9ef);border-radius:3px;overflow:hidden\">\n      <div style=\"height:100%;width:${pctClosed}%;background:linear-gradient(90deg,#6366f1,#22c55e)\"></div>\n    </div>`;\n]]]\n"
                  },
                  "styles": {
                    "card": [
                      {
                        "min-height": "44px"
                      },
                      {
                        "border-radius": "12px"
                      },
                      {
                        "padding": "4px 6px 6px"
                      },
                      {
                        "background": "linear-gradient(135deg, rgba(99,102,241,.12), rgba(6,182,212,.06))"
                      },
                      {
                        "box-shadow": "0 1px 6px rgba(0,0,0,.10)"
                      }
                    ],
                    "grid": [
                      {
                        "grid-template-areas": "\"i n\" \"bar bar\""
                      },
                      {
                        "grid-template-columns": "32px 1fr"
                      },
                      {
                        "grid-template-rows": "auto 3px"
                      },
                      {
                        "row-gap": "2px"
                      }
                    ],
                    "name": [
                      {
                        "align-self": "center"
                      },
                      {
                        "font-weight": 600
                      },
                      {
                        "font-size": ".90rem"
                      },
                      {
                        "line-height": 1.05
                      }
                    ],
                    "icon": [
                      {
                        "width": "22px"
                      },
                      {
                        "color": "#6366f1"
                      }
                    ],
                    "custom_fields": {
                      "bar": [
                        {
                          "align-self": "end"
                        }
                      ]
                    }
                  },
                  "tap_action": {
                    "action": "none"
                  },
                  "triggers_update": "all"
                },
                {
                  "type": "custom:button-card",
                  "entity": "cover.wifi_sam",
                  "icon": "mdi:arrow-up",
                  "show_name": false,
                  "show_state": false,
                  "show_icon": true,
                  "styles": {
                    "card": [
                      {
                        "min-height": "44px"
                      },
                      {
                        "padding": 0
                      },
                      {
                        "display": "grid"
                      },
                      {
                        "place-items": "center"
                      },
                      {
                        "border-radius": "12px"
                      },
                      {
                        "background": "linear-gradient(135deg, rgba(34,197,94,.14), rgba(6,182,212,.08))"
                      },
                      {
                        "box-shadow": "0 1px 5px rgba(0,0,0,.10)"
                      }
                    ],
                    "icon": [
                      {
                        "color": "rgba(34,197,94,.95)"
                      },
                      {
                        "width": "20px"
                      }
                    ]
                  },
                  "tap_action": {
                    "action": "call-service",
                    "service": "cover.open_cover",
                    "data": {
                      "entity_id": "cover.wifi_sam"
                    }
                  }
                },
                {
                  "type": "custom:button-card",
                  "entity": "cover.wifi_sam",
                  "icon": "mdi:stop",
                  "show_name": false,
                  "show_state": false,
                  "show_icon": true,
                  "styles": {
                    "card": [
                      {
                        "min-height": "44px"
                      },
                      {
                        "padding": 0
                      },
                      {
                        "display": "grid"
                      },
                      {
                        "place-items": "center"
                      },
                      {
                        "border-radius": "12px"
                      },
                      {
                        "background": "linear-gradient(135deg, rgba(148,163,184,.16), rgba(6,182,212,.08))"
                      },
                      {
                        "box-shadow": "0 1px 5px rgba(0,0,0,.10)"
                      }
                    ],
                    "icon": [
                      {
                        "color": "rgba(100,116,139,.95)"
                      },
                      {
                        "width": "18px"
                      }
                    ]
                  },
                  "tap_action": {
                    "action": "call-service",
                    "service": "cover.stop_cover",
                    "data": {
                      "entity_id": "cover.wifi_sam"
                    }
                  }
                },
                {
                  "type": "custom:button-card",
                  "entity": "cover.wifi_sam",
                  "icon": "mdi:arrow-down",
                  "show_name": false,
                  "show_state": false,
                  "show_icon": true,
                  "styles": {
                    "card": [
                      {
                        "min-height": "44px"
                      },
                      {
                        "padding": 0
                      },
                      {
                        "display": "grid"
                      },
                      {
                        "place-items": "center"
                      },
                      {
                        "border-radius": "12px"
                      },
                      {
                        "background": "linear-gradient(135deg, rgba(239,68,68,.14), rgba(6,182,212,.08))"
                      },
                      {
                        "box-shadow": "0 1px 5px rgba(0,0,0,.10)"
                      }
                    ],
                    "icon": [
                      {
                        "color": "rgba(239,68,68,.95)"
                      },
                      {
                        "width": "20px"
                      }
                    ]
                  },
                  "tap_action": {
                    "action": "call-service",
                    "service": "cover.close_cover",
                    "data": {
                      "entity_id": "cover.wifi_sam"
                    }
                  }
                }
              ]
            },
            {
              "type": "horizontal-stack",
              "cards": [
                {
                  "type": "custom:button-card",
                  "show_name": false,
                  "show_state": false,
                  "styles": {
                    "card": [
                      {
                        "padding": "4px"
                      },
                      {
                        "border-radius": "14px"
                      },
                      {
                        "--ring-max": "320px"
                      }
                    ],
                    "grid": [
                      {
                        "grid-template-areas": "\"title\" \"pie\""
                      },
                      {
                        "grid-template-rows": "auto 1fr"
                      },
                      {
                        "grid-template-columns": "1fr"
                      }
                    ],
                    "custom_fields": {
                      "title": [
                        {
                          "justify-self": "start"
                        },
                        {
                          "font-weight": 600
                        },
                        {
                          "font-size": "1rem"
                        },
                        {
                          "padding": "0 2px 2px"
                        }
                      ],
                      "pie": [
                        {
                          "width": "100%"
                        },
                        {
                          "max-width": "var(--ring-max)"
                        },
                        {
                          "aspect-ratio": "1 / 1"
                        },
                        {
                          "margin": "0 auto"
                        },
                        {
                          "justify-self": "center"
                        }
                      ]
                    }
                  },
                  "custom_fields": {
                    "title": "Énergie d’aujourd’hui",
                    "pie": "[[[\n  // Données\n  const idSolar='sensor.energie_autoconsommee_2';\n  const idEDF='sensor.import_edf_quotidien';\n  const idSurplus='sensor.export_daily_2';\n  const v=id=>Number(states[id]?.state)||0;\n  const solar=v(idSolar), edf=v(idEDF), surp=v(idSurplus);\n  const sum = solar+edf+surp;\n\n  // Couleurs\n  const cSolar='#ffd700', cEDF='#0074D9', cSurp='#ff4136';\n  const cGrey = getComputedStyle(document.documentElement).getPropertyValue('--disabled-color') || '#c8c8c8';\n\n  // Géométrie (viewBox fixe -> responsive via width:100%)\n  const S=200, cx=100, cy=100, r=76, stroke=32;   // Ø≈200, ép.=32\n  const C=2*Math.PI*r, gap=2;\n\n  const fmt = x => (x>=1 ? Math.round(x) : Math.round(x*10)/10).toLocaleString('fr-FR');\n\n  // Polices responsives\n  const sizePx = this.offsetWidth || 220;\n  const f=(min,k,max)=>Math.max(min,Math.min(max,sizePx*k));\n  const fsLine = f(12,.045,16);\n\n  const wrap = (svg) => `\n    <div style=\"position:relative;width:100%;height:100%;\">\n      ${svg}\n      <div style=\"position:absolute;inset:0;display:grid;place-items:center;\">\n        <div style=\"text-align:center;line-height:1;display:flex;flex-direction:column;gap:2px;font-size:${fsLine}px\">\n          <div style=\"white-space:nowrap;\"><span style=\"display:inline-block;width:10px;height:10px;border-radius:50%;background:${cSolar};margin-right:6px;\"></span>Solaire <b>${fmt(solar)}</b> kWh</div>\n          <div style=\"white-space:nowrap;\"><span style=\"display:inline-block;width:10px;height:10px;border-radius:50%;background:${cEDF};margin-right:6px;\"></span>EDF <b>${fmt(edf)}</b> kWh</div>\n          <div style=\"white-space:nowrap;\"><span style=\"display:inline-block;width:10px;height:10px;border-radius:50%;background:${cSurp};margin-right:6px;\"></span>Surplus <b>${fmt(surp)}</b> kWh</div>\n        </div>\n      </div>\n    </div>`;\n\n  if (sum <= 0.00001) {\n    const svg = `\n      <svg viewBox=\"0 0 ${S} ${S}\" width=\"100%\" height=\"100%\">\n        <circle cx=\"${cx}\" cy=\"${cy}\" r=\"${r}\" fill=\"none\" stroke=\"white\" stroke-width=\"${stroke}\"></circle>\n        <g transform=\"rotate(-90 ${cx} ${cy})\">\n          <circle cx=\"${cx}\" cy=\"${cy}\" r=\"${r}\" fill=\"none\" stroke=\"${cGrey}\" stroke-width=\"${stroke}\"></circle>\n        </g>\n      </svg>`;\n    return wrap(svg);\n  }\n\n  const total=sum;\n  const len = val => Math.max(C*(val/total)-gap,0);\n  const Lsolar=len(solar), Ledf=len(edf), Lsurp=len(surp);\n  const offEDF  =  C*(solar/total);\n  const offSurp =  offEDF + C*(edf/total);\n\n  const svg = `\n    <svg viewBox=\"0 0 ${S} ${S}\" width=\"100%\" height=\"100%\">\n      <circle cx=\"${cx}\" cy=\"${cy}\" r=\"${r}\" fill=\"none\" stroke=\"white\" stroke-width=\"${stroke}\"></circle>\n      <g transform=\"rotate(-90 ${cx} ${cy})\">\n        <circle cx=\"${cx}\" cy=\"${cy}\" r=\"${r}\" fill=\"none\" stroke=\"${cSolar}\" stroke-width=\"${stroke}\"\n                stroke-dasharray=\"${Lsolar} ${C}\"></circle>\n        <circle cx=\"${cx}\" cy=\"${cy}\" r=\"${r}\" fill=\"none\" stroke=\"${cEDF}\" stroke-width=\"${stroke}\"\n                stroke-dasharray=\"${Ledf} ${C}\" stroke-dashoffset=\"-${offEDF}\"></circle>\n        <circle cx=\"${cx}\" cy=\"${cy}\" r=\"${r}\" fill=\"none\" stroke=\"${cSurp}\" stroke-width=\"${stroke}\"\n                stroke-dasharray=\"${Lsurp} ${C}\" stroke-dashoffset=\"-${offSurp}\"></circle>\n      </g>\n    </svg>`;\n  return wrap(svg);\n]]]\n"
                  }
                },
                {
                  "type": "custom:button-card",
                  "show_name": false,
                  "show_state": false,
                  "styles": {
                    "card": [
                      {
                        "padding": "4px"
                      },
                      {
                        "border-radius": "14px"
                      },
                      {
                        "--ring-max": "320px"
                      }
                    ],
                    "grid": [
                      {
                        "grid-template-areas": "\"title\" \"ring\""
                      },
                      {
                        "grid-template-rows": "auto 1fr"
                      },
                      {
                        "grid-template-columns": "1fr"
                      }
                    ],
                    "custom_fields": {
                      "title": [
                        {
                          "justify-self": "start"
                        },
                        {
                          "font-weight": 600
                        },
                        {
                          "font-size": "1rem"
                        },
                        {
                          "padding": "0 2px 2px"
                        }
                      ],
                      "ring": [
                        {
                          "width": "100%"
                        },
                        {
                          "max-width": "var(--ring-max)"
                        },
                        {
                          "aspect-ratio": "1 / 1"
                        },
                        {
                          "margin": "0 auto"
                        },
                        {
                          "justify-self": "center"
                        }
                      ]
                    }
                  },
                  "custom_fields": {
                    "title": "Batterie",
                    "ring": "[[[\n  const soc = Math.round(Number(states['sensor.solarbank_3_e2700_pro_etat_de_charge']?.state) || 0);\n  const p   = Number(states['sensor.solarbank_3_e2700_pro_puissance_de_charge']?.state) || 0;\n\n  // Seuils\n  const dead = 20;                               // zone morte W\n  const full = soc >= 99;                        // batterie pleine\n  const paused = full && Math.abs(p) <= dead;    // pleine & repos\n\n  const charging = p > dead, discharg = p < -dead;\n\n  // Couleurs\n  const BLUE = 'var(--info-color, #3b82f6)';\n  const GREEN = 'var(--success-color, #16a34a)';\n  const RED   = 'var(--error-color, #ef4444)';\n  const GREY  = 'var(--secondary-text-color)';\n\n  const color = paused ? BLUE : (charging ? GREEN : (discharg ? RED : GREY));\n\n  // Texte / icône\n  const sign  = charging ? '+' : (discharg ? '−' : '');\n  const legend = paused ? 'En pause'\n                        : (charging || discharg) ? `${sign}${Math.round(Math.abs(p))} W` : '0 W';\n  const icon  = paused ? 'mdi:pause-circle'\n                       : (charging ? 'mdi:battery-charging' : (discharg ? 'mdi:battery-arrow-down' : 'mdi:battery'));\n\n  // Géométrie identique au camembert\n  const S=200, cx=100, cy=100, r=76, stroke=32;\n  const C=2*Math.PI*r;\n  const Lcol = Math.max(C * (soc/100), 0);\n  const Lrem = Math.max(C - Lcol, 0);\n\n  // Polices + grandes\n  const sizePx = this.offsetWidth || 240;\n  const f=(min,k,max)=>Math.max(min,Math.min(max,sizePx*k));\n  const fsPct = f(16,.070,26);   // % plus grand\n  const fsSub = f(14,.060,22);   // ligne du bas plus grande\n  const iconSz = f(20,.095,30);  // icône plus grande\n\n  return `\n    <div style=\"position:relative;width:100%;height:100%;\">\n      <svg viewBox=\"0 0 ${S} ${S}\" width=\"100%\" height=\"100%\">\n        <circle cx=\"${cx}\" cy=\"${cy}\" r=\"${r}\" fill=\"none\" stroke=\"white\" stroke-width=\"${stroke}\"></circle>\n        <g transform=\"rotate(-90 ${cx} ${cy})\">\n          <circle cx=\"${cx}\" cy=\"${cy}\" r=\"${r}\" fill=\"none\" stroke=\"${color}\" stroke-width=\"${stroke}\"\n                  stroke-dasharray=\"${Lcol} ${C}\"></circle>\n          <circle cx=\"${cx}\" cy=\"${cy}\" r=\"${r}\" fill=\"none\"\n                  stroke=\"var(--disabled-color)\" stroke-width=\"${stroke}\"\n                  stroke-dasharray=\"${Lrem} ${C}\" stroke-dashoffset=\"-${Lcol}\"></circle>\n        </g>\n      </svg>\n      <div style=\"position:absolute;inset:0;display:grid;place-items:center;\">\n        <div style=\"text-align:center;line-height:1;display:flex;flex-direction:column;gap:3px\">\n          <ha-icon icon=\"${icon}\" style=\"width:${iconSz}px;height:${iconSz}px;color:${color};\"></ha-icon>\n          <div style=\"font-weight:700;font-size:${fsPct}px;\">${soc}%</div>\n          <div style=\"font-size:${fsSub}px;color:${color};\">${legend}</div>\n        </div>\n      </div>\n    </div>\n  `;\n]]]\n"
                  }
                }
              ]
            },
            {
              "type": "custom:button-card",
              "entity": "switch.shellypro1_ece334ee1b64",
              "name": "Cumulus",
              "icon": "mdi:water-boiler",
              "show_state": false,
              "styles": {
                "card": [
                  {
                    "min-height": "52px"
                  },
                  {
                    "border-radius": "12px"
                  },
                  {
                    "padding": "6px 8px"
                  },
                  {
                    "box-shadow": "0 1px 6px rgba(0,0,0,.12)"
                  },
                  {
                    "background": "[[[\n  return (entity?.state === 'on')\n    ? 'linear-gradient(135deg, rgba(239,68,68,.14), rgba(6,182,212,.06))'\n    : 'linear-gradient(135deg, rgba(6,182,212,.10), rgba(6,182,212,.05))';\n]]]\n"
                  }
                ],
                "grid": [
                  {
                    "grid-template-areas": "\"i n\""
                  },
                  {
                    "grid-template-columns": "28px 1fr"
                  }
                ],
                "icon": [
                  {
                    "width": "28px"
                  },
                  {
                    "color": "[[[\n  return (entity?.state === 'on') ? '#ef4444' : '#0ea5e9';\n]]]\n"
                  }
                ],
                "name": [
                  {
                    "align-self": "center"
                  },
                  {
                    "font-weight": 600
                  },
                  {
                    "font-size": ".92rem"
                  }
                ]
              },
              "tap_action": {
                "action": "none"
              },
              "hold_action": {
                "action": "toggle"
              }
            },
            {
              "type": "picture-elements",
              "image": "https://www.monchauffageelectrique.com/wp-content/uploads/2019/06/panneaux-solaires-photovoltaiques.jpg",
              "elements": [
                {
                  "type": "state-label",
                  "entity": "sensor.dashboard_titre_photovoltaique",
                  "style": {
                    "top": "10%",
                    "left": "50%",
                    "transform": "translateX(-50%)",
                    "color": "white",
                    "font-size": "24px",
                    "font-weight": "bold",
                    "text-shadow": "2px 2px 4px rgba(0,0,0,0.8)",
                    "background": "rgba(0,0,0,0.4)",
                    "padding": "6px 12px",
                    "border-radius": "8px"
                  }
                },
                {
                  "type": "custom:button-card",
                  "entity": "sensor.savings_day_eur",
                  "name": "Aujourd’hui",
                  "icon": "mdi:calendar-today",
                  "layout": "icon_state",
                  "show_icon": false,
                  "show_state": true,
                  "state_display": "[[[\n  const v = Number(entity.state);\n  return isNaN(v) ? '—' :\n    v.toLocaleString('fr-FR',{minimumFractionDigits:2, maximumFractionDigits:2}) + ' €';\n]]]\n",
                  "styles": {
                    "card": [
                      {
                        "width": "100px"
                      },
                      {
                        "height": "100px"
                      },
                      {
                        "border-radius": "50%"
                      },
                      {
                        "background": "rgba(33,150,243,0.85)"
                      },
                      {
                        "box-shadow": "0 4px 10px rgba(0,0,0,0.6)"
                      }
                    ],
                    "icon": [
                      {
                        "color": "#ffeb3b"
                      },
                      {
                        "width": "32px"
                      },
                      {
                        "height": "32px"
                      }
                    ],
                    "state": [
                      {
                        "color": "white"
                      },
                      {
                        "font-size": "16px"
                      },
                      {
                        "font-weight": "bold"
                      },
                      {
                        "margin-right": "35px"
                      }
                    ],
                    "name": [
                      {
                        "color": "white"
                      },
                      {
                        "font-size": "16px"
                      },
                      {
                        "margin-bottom": "10px"
                      }
                    ]
                  },
                  "style": {
                    "top": "60%",
                    "left": "14%",
                    "transform": "translate(-50%, -50%)"
                  }
                },
                {
                  "type": "custom:button-card",
                  "entity": "sensor.savings_month_eur",
                  "name": "Mensuel",
                  "icon": "mdi:calendar-month",
                  "layout": "icon_state",
                  "show_icon": false,
                  "show_state": true,
                  "state_display": "[[[\n  const v = Number(entity.state);\n  return isNaN(v) ? '—' :\n    v.toLocaleString('fr-FR',{minimumFractionDigits:2, maximumFractionDigits:2}) + ' €';\n]]]\n",
                  "styles": {
                    "card": [
                      {
                        "width": "100px"
                      },
                      {
                        "height": "100px"
                      },
                      {
                        "border-radius": "50%"
                      },
                      {
                        "background": "rgba(76,175,80,0.85)"
                      },
                      {
                        "box-shadow": "0 4px 10px rgba(0,0,0,0.6)"
                      }
                    ],
                    "icon": [
                      {
                        "color": "white"
                      },
                      {
                        "width": "32px"
                      },
                      {
                        "height": "32px"
                      }
                    ],
                    "state": [
                      {
                        "color": "white"
                      },
                      {
                        "font-size": "16px"
                      },
                      {
                        "font-weight": "bold"
                      },
                      {
                        "margin-right": "35px"
                      }
                    ],
                    "name": [
                      {
                        "color": "white"
                      },
                      {
                        "font-size": "16px"
                      },
                      {
                        "margin-bottom": "10px"
                      }
                    ]
                  },
                  "style": {
                    "top": "60%",
                    "left": "38%",
                    "transform": "translate(-50%, -50%)"
                  }
                },
                {
                  "type": "custom:button-card",
                  "entity": "sensor.savings_total_eur_with_baseline",
                  "name": "Annuel",
                  "icon": "mdi:chart-box-outline",
                  "layout": "icon_state",
                  "show_icon": false,
                  "show_state": true,
                  "state_display": "[[[\n  const v = Number(entity.state);\n  return isNaN(v) ? '—' :\n    v.toLocaleString('fr-FR',{minimumFractionDigits:2, maximumFractionDigits:2}) + ' €';\n]]]\n",
                  "styles": {
                    "card": [
                      {
                        "width": "100px"
                      },
                      {
                        "height": "100px"
                      },
                      {
                        "border-radius": "50%"
                      },
                      {
                        "background": "rgba(255,165,40,0.8)"
                      },
                      {
                        "box-shadow": "0 4px 10px rgba(0,0,0,0.6)"
                      }
                    ],
                    "icon": [
                      {
                        "color": "white"
                      },
                      {
                        "width": "32px"
                      },
                      {
                        "height": "32px"
                      }
                    ],
                    "state": [
                      {
                        "color": "white"
                      },
                      {
                        "font-size": "14px"
                      },
                      {
                        "font-weight": "bold"
                      },
                      {
                        "margin-right": "35px"
                      }
                    ],
                    "name": [
                      {
                        "color": "white"
                      },
                      {
                        "font-size": "16px"
                      },
                      {
                        "margin-top": "0px"
                      },
                      {
                        "margin-bottom": "10px"
                      }
                    ]
                  },
                  "style": {
                    "top": "60%",
                    "left": "62%",
                    "transform": "translate(-50%, -50%)"
                  }
                },
                {
                  "type": "custom:button-card",
                  "entity": "sensor.savings_total_eur_with_baseline",
                  "name": "Total",
                  "icon": "mdi:chart-box-outline",
                  "layout": "icon_state",
                  "show_icon": false,
                  "show_state": true,
                  "state_display": "[[[\n  const v = Number(entity.state);\n  return isNaN(v) ? '—' :\n    v.toLocaleString('fr-FR',{minimumFractionDigits:2, maximumFractionDigits:2}) + ' €';\n]]]\n",
                  "styles": {
                    "card": [
                      {
                        "width": "100px"
                      },
                      {
                        "height": "100px"
                      },
                      {
                        "border-radius": "50%"
                      },
                      {
                        "background": "rgba(244,67,54,0.85)"
                      },
                      {
                        "box-shadow": "0 4px 10px rgba(0,0,0,0.6)"
                      }
                    ],
                    "icon": [
                      {
                        "color": "white"
                      },
                      {
                        "width": "32px"
                      },
                      {
                        "height": "32px"
                      }
                    ],
                    "state": [
                      {
                        "color": "white"
                      },
                      {
                        "font-size": "14px"
                      },
                      {
                        "font-weight": "bold"
                      },
                      {
                        "margin-right": "35px"
                      }
                    ],
                    "name": [
                      {
                        "color": "white"
                      },
                      {
                        "font-size": "16px"
                      },
                      {
                        "margin-top": "0px"
                      },
                      {
                        "margin-bottom": "10px"
                      }
                    ]
                  },
                  "style": {
                    "top": "60%",
                    "left": "86%",
                    "transform": "translate(-50%, -50%)"
                  }
                }
              ]
            },
            {
              "type": "custom:button-card",
              "variables": {
                "printer_state": "switch.imprimante_epson",
                "c_state": "sensor.epson_et_2870_cyan_ink_cached",
                "y_state": "sensor.epson_et_2870_yellow_ink_cached",
                "m_state": "sensor.epson_et_2870_magenta_ink_cached",
                "b_state": "sensor.epson_et_2870_black_ink_cached"
              },
              "triggers_update": [
                "switch.imprimante_epson",
                "sensor.epson_et_2870_black_ink_cached",
                "sensor.epson_et_2870_cyan_ink_cached",
                "sensor.epson_et_2870_magenta_ink_cached",
                "sensor.epson_et_2870_yellow_ink_cached"
              ],
              "show_name": false,
              "show_state": false,
              "show_icon": false,
              "styles": {
                "card": [
                  {
                    "padding": "3px"
                  },
                  {
                    "border-radius": "14px"
                  },
                  {
                    "background": "linear-gradient(135deg, rgba(6,182,212,.10), rgba(6,182,212,.05))"
                  },
                  {
                    "box-shadow": "0 2px 10px rgba(0,0,0,.12)"
                  },
                  {
                    "overflow": "hidden"
                  }
                ],
                "grid": [
                  {
                    "grid-template-areas": "\"haut bas\""
                  },
                  {
                    "grid-template-columns": "4fr 5fr"
                  },
                  {
                    "grid-template-rows": "100%"
                  }
                ],
                "custom_fields": {
                  "haut": [
                    {
                      "filter": "opacity(100%)"
                    },
                    {
                      "overflow": "visible"
                    }
                  ],
                  "bas": [
                    {
                      "filter": "opacity(100%)"
                    },
                    {
                      "overflow": "visible"
                    }
                  ]
                }
              },
              "custom_fields": {
                "haut": {
                  "card": {
                    "type": "custom:mushroom-entity-card",
                    "entity": "[[[ return variables.printer_state ]]]",
                    "tap_action": {
                      "action": "toggle"
                    },
                    "icon": "mdi:printer",
                    "card_mod": {
                      "style": "ha-card {\n  padding: 0 !important;\n  padding-bottom: 1px !important;\n  text-align: left !important;\n  border: none !important;\n  box-shadow: none !important;\n  background: transparent !important;\n}\n"
                    }
                  }
                },
                "bas": {
                  "card": {
                    "type": "grid",
                    "columns": 4,
                    "square": false,
                    "cards": [
                      {
                        "type": "custom:button-card",
                        "entity": "[[[ return variables.b_state ]]]",
                        "show_name": false,
                        "show_state": true,
                        "show_label": false,
                        "show_icon": false,
                        "size": "100%",
                        "styles": {
                          "grid": [
                            {
                              "grid-template-areas": "\"s\""
                            },
                            {
                              "grid-template-columns": "100%"
                            },
                            {
                              "grid-template-rows": "100%"
                            }
                          ],
                          "state": [
                            {
                              "font-size": "1rem"
                            },
                            {
                              "font-weight": 800
                            },
                            {
                              "color": "var(--primary-text-color)"
                            },
                            {
                              "text-shadow": "0 1px 0 rgba(255,255,255,.6), 0 0 2px rgba(0,0,0,.28)"
                            }
                          ],
                          "card": [
                            {
                              "height": "3rem"
                            },
                            {
                              "border-radius": "14px"
                            },
                            {
                              "box-shadow": "inset 0 0 0 1px rgba(255,255,255,.25), 0 2px 8px rgba(0,0,0,.10)"
                            },
                            {
                              "background": "[[[\n  const v = Math.max(0, Math.min(100, Number(states[variables.b_state].state)||0));\n  const fill = `linear-gradient(to top,\n    rgba(150,150,150,.55) 0%,\n    rgba(150,150,150,.55) ${v}%,\n    rgba(150,150,150,.06) ${v}%,\n    rgba(150,150,150,.06) 100%)`;\n  const track = 'linear-gradient(180deg, rgba(255,255,255,.45), rgba(255,255,255,.18))';\n  const gloss = 'linear-gradient(180deg, rgba(255,255,255,.18) 0%, rgba(255,255,255,0) 40%)';\n  const theme = 'linear-gradient(135deg, rgba(148,163,184,.20), rgba(6,182,212,.10))';\n  return `${gloss}, ${fill}, ${track}, ${theme}`;\n]]]\n"
                            }
                          ]
                        },
                        "state_display": "[[[ return Math.round(Number(states[variables.b_state].state)) + states[variables.b_state].attributes.unit_of_measurement; ]]]\n"
                      },
                      {
                        "type": "custom:button-card",
                        "entity": "[[[ return variables.c_state ]]]",
                        "show_name": false,
                        "show_state": true,
                        "show_label": false,
                        "show_icon": false,
                        "size": "100%",
                        "styles": {
                          "grid": [
                            {
                              "grid-template-areas": "\"s\""
                            },
                            {
                              "grid-template-columns": "100%"
                            },
                            {
                              "grid-template-rows": "100%"
                            }
                          ],
                          "state": [
                            {
                              "font-size": "1rem"
                            },
                            {
                              "font-weight": 800
                            },
                            {
                              "color": "darkcyan"
                            },
                            {
                              "text-shadow": "0 1px 0 rgba(255,255,255,.6), 0 0 2px rgba(0,0,0,.28)"
                            }
                          ],
                          "card": [
                            {
                              "height": "3rem"
                            },
                            {
                              "border-radius": "14px"
                            },
                            {
                              "box-shadow": "inset 0 0 0 1px rgba(255,255,255,.25), 0 2px 8px rgba(0,0,0,.10)"
                            },
                            {
                              "background": "[[[\n  const v = Math.max(0, Math.min(100, Number(states[variables.c_state].state)||0));\n  const fill = `linear-gradient(to top,\n    rgba(0,139,139,.50) 0%,\n    rgba(0,139,139,.50) ${v}%,\n    rgba(0,139,139,.08) ${v}%,\n    rgba(0,139,139,.08) 100%)`;\n  const track = 'linear-gradient(180deg, rgba(255,255,255,.45), rgba(255,255,255,.18))';\n  const gloss = 'linear-gradient(180deg, rgba(255,255,255,.18) 0%, rgba(255,255,255,0) 40%)';\n  const theme = 'linear-gradient(135deg, rgba(6,182,212,.18), rgba(6,182,212,.10))';\n  return `${gloss}, ${fill}, ${track}, ${theme}`;\n]]]\n"
                            }
                          ]
                        },
                        "state_display": "[[[ return Math.round(Number(states[variables.c_state].state)) + states[variables.c_state].attributes.unit_of_measurement; ]]]\n"
                      },
                      {
                        "type": "custom:button-card",
                        "entity": "[[[ return variables.m_state ]]]",
                        "show_name": false,
                        "show_state": true,
                        "show_label": false,
                        "show_icon": false,
                        "size": "100%",
                        "styles": {
                          "grid": [
                            {
                              "grid-template-areas": "\"s\""
                            },
                            {
                              "grid-template-columns": "100%"
                            },
                            {
                              "grid-template-rows": "100%"
                            }
                          ],
                          "state": [
                            {
                              "font-size": "1rem"
                            },
                            {
                              "font-weight": 800
                            },
                            {
                              "color": "magenta"
                            },
                            {
                              "text-shadow": "0 1px 0 rgba(255,255,255,.6), 0 0 2px rgba(0,0,0,.28)"
                            }
                          ],
                          "card": [
                            {
                              "height": "3rem"
                            },
                            {
                              "border-radius": "14px"
                            },
                            {
                              "box-shadow": "inset 0 0 0 1px rgba(255,255,255,.25), 0 2px 8px rgba(0,0,0,.10)"
                            },
                            {
                              "background": "[[[\n  const v = Math.max(0, Math.min(100, Number(states[variables.m_state].state)||0));\n  const fill = `linear-gradient(to top,\n    rgba(255,0,255,.50) 0%,\n    rgba(255,0,255,.50) ${v}%,\n    rgba(255,0,255,.08) ${v}%,\n    rgba(255,0,255,.08) 100%)`;\n  const track = 'linear-gradient(180deg, rgba(255,255,255,.45), rgba(255,255,255,.18))';\n  const gloss = 'linear-gradient(180deg, rgba(255,255,255,.18) 0%, rgba(255,255,255,0) 40%)';\n  const theme = 'linear-gradient(135deg, rgba(236,72,153,.20), rgba(6,182,212,.10))';\n  return `${gloss}, ${fill}, ${track}, ${theme}`;\n]]]\n"
                            }
                          ]
                        },
                        "state_display": "[[[ return Math.round(Number(states[variables.m_state].state)) + states[variables.m_state].attributes.unit_of_measurement; ]]]\n"
                      },
                      {
                        "type": "custom:button-card",
                        "entity": "[[[ return variables.y_state ]]]",
                        "show_name": false,
                        "show_state": true,
                        "show_label": false,
                        "show_icon": false,
                        "size": "100%",
                        "styles": {
                          "grid": [
                            {
                              "grid-template-areas": "\"s\""
                            },
                            {
                              "grid-template-columns": "100%"
                            },
                            {
                              "grid-template-rows": "100%"
                            }
                          ],
                          "state": [
                            {
                              "font-size": "1rem"
                            },
                            {
                              "font-weight": 800
                            },
                            {
                              "color": "darkorange"
                            },
                            {
                              "text-shadow": "0 1px 0 rgba(255,255,255,.6), 0 0 2px rgba(0,0,0,.28)"
                            }
                          ],
                          "card": [
                            {
                              "height": "3rem"
                            },
                            {
                              "border-radius": "14px"
                            },
                            {
                              "box-shadow": "inset 0 0 0 1px rgba(255,255,255,.25), 0 2px 8px rgba(0,0,0,.10)"
                            },
                            {
                              "background": "[[[\n  const v = Math.max(0, Math.min(100, Number(states[variables.y_state].state)||0));\n  const fill = `linear-gradient(to top,\n    rgba(255,140,0,.52) 0%,\n    rgba(255,140,0,.52) ${v}%,\n    rgba(255,140,0,.10) ${v}%,\n    rgba(255,140,0,.10) 100%)`;\n  const track = 'linear-gradient(180deg, rgba(255,255,255,.45), rgba(255,255,255,.18))';\n  const gloss = 'linear-gradient(180deg, rgba(255,255,255,.18) 0%, rgba(255,255,255,0) 40%)';\n  const theme = 'linear-gradient(135deg, rgba(234,179,8,.22), rgba(6,182,212,.10))';\n  return `${gloss}, ${fill}, ${track}, ${theme}`;\n]]]\n"
                            }
                          ]
                        },
                        "state_display": "[[[ return Math.round(Number(states[variables.y_state].state)) + states[variables.y_state].attributes.unit_of_measurement; ]]]\n"
                      }
                    ]
                  }
                }
              }
            },
            {
              "type": "horizontal-stack",
              "cards": [
                {
                  "type": "custom:button-card",
                  "aspect_ratio": "1/1",
                  "show_icon": false,
                  "show_state": false,
                  "show_name": false,
                  "tap_action": {
                    "action": "none"
                  },
                  "hold_action": {
                    "action": "none"
                  },
                  "double_tap_action": {
                    "action": "none"
                  },
                  "variables": {
                    "person": "person.laurent",
                    "battery": "sensor.iphone_laurent_battery_level",
                    "charging": "sensor.iphone_laurent_battery_state",
                    "wifi": "sensor.iphone_laurent_connection_type",
                    "distance": "proximity.home_laurent",
                    "ipad_battery": "sensor.ipad_pro_battery_level",
                    "ipad_charging": "sensor.ipad_pro_battery_state",
                    "charger": "switch.chargeur_laurent",
                    "avatar_min": 50,
                    "avatar_max": 133,
                    "avatar_pct": 0.33,
                    "ring_home": "#22c55e",
                    "ring_away": "#ef4444",
                    "ring_unknown": "#94a3b8"
                  },
                  "triggers_update": [
                    "[[[ return variables.person ]]]",
                    "[[[ return variables.battery ]]]",
                    "[[[ return variables.charging ]]]",
                    "[[[ return variables.ipad_battery ]]]",
                    "[[[ return variables.ipad_charging ]]]",
                    "[[[ return variables.wifi ]]]",
                    "[[[ return variables.distance ]]]",
                    "[[[ return variables.charger ]]]"
                  ],
                  "styles": {
                    "card": [
                      {
                        "border-radius": "14px"
                      },
                      {
                        "box-shadow": "0 4px 14px rgba(0,0,0,.10)"
                      },
                      {
                        "background": "linear-gradient(135deg, rgba(6,182,212,.16), rgba(6,182,212,.06))\n"
                      },
                      {
                        "padding": "10px 12px 10px 4px"
                      }
                    ],
                    "grid": [
                      {
                        "grid-template-areas": "\"status status\" \"avatar avatar\" \"batt batt\" \"ipad ipad\" \"wifi dist\""
                      },
                      {
                        "grid-template-columns": "1fr 1fr"
                      },
                      {
                        "grid-template-rows": "auto 1fr auto auto auto"
                      },
                      {
                        "row-gap": "6px"
                      }
                    ],
                    "custom_fields": {
                      "status": [
                        {
                          "justify-self": "end"
                        },
                        {
                          "align-self": "start"
                        }
                      ],
                      "avatar": [
                        {
                          "justify-self": "start"
                        },
                        {
                          "align-self": "start"
                        },
                        {
                          "margin-top": "-40px"
                        },
                        {
                          "margin-left": "10px"
                        }
                      ],
                      "batt": [
                        {
                          "justify-self": "start"
                        },
                        {
                          "align-self": "end"
                        }
                      ],
                      "ipad": [
                        {
                          "justify-self": "start"
                        },
                        {
                          "align-self": "start"
                        }
                      ],
                      "wifi": [
                        {
                          "justify-self": "start"
                        },
                        {
                          "align-self": "start"
                        }
                      ],
                      "dist": [
                        {
                          "justify-self": "end"
                        },
                        {
                          "align-self": "end"
                        },
                        {
                          "margin-bottom": "2px"
                        }
                      ]
                    }
                  },
                  "custom_fields": {
                    "status": {
                      "card": {
                        "type": "custom:button-card",
                        "entity": "[[[ return variables.charger ]]]",
                        "icon": "mdi:power-plug",
                        "show_state": false,
                        "show_label": false,
                        "show_name": true,
                        "name": "[[[ return states[variables.charger]?.attributes?.friendly_name || \"Chargeur\" ]]]",
                        "tap_action": {
                          "action": "call-service",
                          "service": "homeassistant.toggle",
                          "service_data": {
                            "entity_id": "[[[ return variables.charger ]]]"
                          }
                        },
                        "hold_action": {
                          "action": "more-info"
                        },
                        "styles": {
                          "card": [
                            {
                              "padding": "2px 6px 4px"
                            },
                            {
                              "border-radius": "12px"
                            },
                            {
                              "background": "rgba(0,0,0,.05)"
                            },
                            {
                              "box-shadow": "none"
                            }
                          ],
                          "grid": [
                            {
                              "grid-template-areas": "\"i\" \"n\""
                            },
                            {
                              "grid-template-rows": "auto auto"
                            },
                            {
                              "grid-template-columns": "auto"
                            },
                            {
                              "row-gap": "2px"
                            }
                          ],
                          "icon": [
                            {
                              "color": "[[[\n  const st = states[variables.charger]?.state;\n  return st==='on' ? '#22c55e' : (st==='off' ? '#94a3b8' : '#ef4444');\n]]]\n"
                            },
                            {
                              "width": "[[[\n  const ha = this.shadowRoot?.host?.shadowRoot?.querySelector('ha-card') || this;\n  const w  = Math.max(180, ha?.getBoundingClientRect?.().width || 300);\n  return Math.round(Math.min(40, Math.max(24, w*0.07))) + 'px';\n]]]\n"
                            },
                            {
                              "height": "[[[\n  const ha = this.shadowRoot?.host?.shadowRoot?.querySelector('ha-card') || this;\n  const w  = Math.max(180, ha?.getBoundingClientRect?.().width || 300);\n  return Math.round(Math.min(40, Math.max(24, w*0.07))) + 'px';\n]]]\n"
                            }
                          ],
                          "name": [
                            {
                              "font-size": "[[[\n  const ha = this.shadowRoot?.host?.shadowRoot?.querySelector('ha-card') || this;\n  const w  = Math.max(180, ha?.getBoundingClientRect?.().width || 300);\n  return Math.round(Math.min(16, Math.max(11, w*0.04))) + 'px';\n]]]\n"
                            },
                            {
                              "color": "var(--secondary-text-color)"
                            },
                            {
                              "line-height": 1
                            },
                            {
                              "text-align": "center"
                            },
                            {
                              "white-space": "nowrap"
                            },
                            {
                              "overflow": "hidden"
                            },
                            {
                              "text-overflow": "ellipsis"
                            }
                          ]
                        }
                      }
                    },
                    "avatar": "[[[\n  const min = Number(variables.avatar_min)||53;\n  const max = Number(variables.avatar_max)||132;\n  const pct = Number(variables.avatar_pct)||0.33;\n  const ha  = this.shadowRoot.querySelector('ha-card');\n  const w   = Math.max(1, ha?.getBoundingClientRect?.().width || this?.offsetWidth || 300);\n  const size  = Math.round(Math.min(max, Math.max(min, w * pct)));\n  const ringW = Math.max(4, Math.round(size * 0.06));\n  const st   = states[variables.person]?.state ?? 'unknown';\n  const ring = st === 'home' ? variables.ring_home\n             : (st === 'not_home' ? variables.ring_away : variables.ring_unknown);\n  let pic = states[variables.person]?.attributes?.entity_picture || '';\n  if (pic.includes('/128x128')) pic = pic.replace('/128x128','/512x512');\n  const bust = pic ? ((pic.includes('?')?'&':'?')+'v='+(Date.now()%1e7)) : '';\n  const base = `width:${size}px;height:${size}px;border-radius:50%;\n                border:${ringW}px solid ${ring};\n                box-shadow: inset 0 0 0 3px rgba(255,255,255,.85), 0 3px 8px rgba(0,0,0,.12);`;\n  return pic\n    ? `<div style=\"${base} background:url('${pic}${bust}') center/cover no-repeat;\"></div>`\n    : `<div style=\"${base} display:flex;align-items:center;justify-content:center;background:rgba(255,255,255,.92);\">\n         <ha-icon icon=\"mdi:account\" style=\"--mdc-icon-size:${Math.round(size*0.6)}px;color:rgba(0,0,0,.55)\"></ha-icon>\n       </div>`;\n]]]\n",
                    "batt": "[[[\n  const ha = this.shadowRoot.querySelector('ha-card');\n  const w  = Math.max(180, ha?.getBoundingClientRect?.().width || this?.offsetWidth || 300);\n  const fsText   = Math.round(Math.min(24, Math.max(14, w * 0.068)));\n  const phoneIco = Math.round(Math.min(28, Math.max(18, w * 0.045)));\n  const lvl = Number(states[variables.battery]?.state);\n  const s   = (states[variables.charging]?.state || '').toLowerCase();\n  const charging = /(charging|ac power|plugged|full)/.test(s) && !/not/.test(s);\n  const step = isNaN(lvl) ? 0 : Math.min(100, Math.max(0, Math.round(lvl/10)*10));\n  const ic   = charging ? `mdi:battery-charging-${step || 10}` : (step===100 ? 'mdi:battery' : `mdi:battery-${step || 10}`);\n  const txt  = isNaN(lvl) ? '—' : `${lvl}%`;\n  const glow = charging ? 'filter: drop-shadow(0 0 6px #ef4444) drop-shadow(0 0 12px #dc2626);' : '';\n  return `<div style=\"display:flex;gap:10px;align-items:center;font-weight:700;\n                      font-size:${fsText}px;white-space:nowrap\">\n            <ha-icon icon=\"mdi:cellphone\" style=\"--mdc-icon-size:${phoneIco}px;opacity:.9\"></ha-icon>\n            <ha-icon icon=\"${ic}\" style=\"--mdc-icon-size:${Math.max(18, Math.round(fsText*0.9))}px;${glow}\"></ha-icon>\n            <span>iPhone ${txt}</span>\n          </div>`;\n]]]\n",
                    "ipad": "[[[\n  const ha = this.shadowRoot.querySelector('ha-card');\n  const w  = Math.max(180, ha?.getBoundingClientRect?.().width || this?.offsetWidth || 300);\n  const fsText    = Math.round(Math.min(23, Math.max(14, w * 0.062)));\n  const tabletIco = Math.round(Math.min(40, Math.max(26, w * 0.065)));\n  const lvl = Number(states[variables.ipad_battery]?.state);\n  const s   = (states[variables.ipad_charging]?.state || '').toLowerCase();\n  const charging = /(charging|ac power|plugged|full)/.test(s) && !/not/.test(s);\n  const step = isNaN(lvl) ? 0 : Math.min(100, Math.max(0, Math.round(lvl/10)*10));\n  const ic   = charging ? `mdi:battery-charging-${step || 10}` : (step===100 ? 'mdi:battery' : `mdi:battery-${step || 10}`);\n  const txt  = isNaN(lvl) ? '—' : `${lvl}%`;\n  const glow = charging ? 'filter: drop-shadow(0 0 6px #ef4444) drop-shadow(0 0 12px #dc2626);' : '';\n  return `<div style=\"display:flex;gap:10px;align-items:center;font-weight:700;\n                      font-size:${fsText}px;white-space:nowrap;opacity:.95\">\n            <ha-icon icon=\"mdi:tablet\" style=\"--mdc-icon-size:${tabletIco}px\"></ha-icon>\n            <ha-icon icon=\"${ic}\" style=\"--mdc-icon-size:${Math.max(18, Math.round(fsText*0.9))}px;${glow}\"></ha-icon>\n            <span>iPad ${txt}</span>\n          </div>`;\n]]]\n",
                    "wifi": "[[[\n  const ha = this.shadowRoot.querySelector('ha-card');\n  const w  = Math.max(180, ha?.getBoundingClientRect?.().width || this?.offsetWidth || 300);\n  const fs = Math.round(Math.min(18, Math.max(12, w * 0.048)));\n  const t = (states[variables.wifi]?.state || '').toLowerCase();\n  const isWifi = t.includes('wifi') || t.includes('wi-fi');\n  const label  = isWifi ? 'Wi-Fi' : (t ? 'Cellulaire' : 'Cellulaire');\n  const ic     = isWifi ? 'mdi:wifi' : 'mdi:signal-cellular-3';\n  return `<div style=\"display:flex;gap:6px;align-items:center;opacity:.9;\n                      font-size:${fs}px;white-space:nowrap\">\n            <ha-icon icon=\"${ic}\" style=\"--mdc-icon-size:${Math.max(18, fs)}px\"></ha-icon>\n            <span>${label}</span>\n          </div>`;\n]]]\n",
                    "dist": "[[[\n  const ha = this.shadowRoot.querySelector('ha-card');\n  const w  = Math.max(180, ha?.getBoundingClientRect?.().width || this?.offsetWidth || 300);\n  const fs = Math.round(Math.min(20, Math.max(12, w * 0.055)));\n  let km = Number(states[variables.distance]?.state);\n  if (isNaN(km)) km = 0;\n  km = Math.round(km*10)/10;\n  if (Math.abs(km) < 0.05) km = 0;\n  return `<div style=\"display:flex;gap:6px;align-items:center;font-weight:800;\n                      font-size:${fs}px;white-space:nowrap\">\n            <ha-icon icon=\"mdi:map-marker-distance\" style=\"--mdc-icon-size:${Math.max(18, fs)}px\"></ha-icon>\n            <span style=\"font-variant-numeric:tabular-nums\">${km} km</span>\n          </div>`;\n]]]\n"
                  }
                },
                {
                  "type": "custom:button-card",
                  "aspect_ratio": "1/1",
                  "show_icon": false,
                  "show_state": false,
                  "show_name": false,
                  "tap_action": {
                    "action": "more-info"
                  },
                  "variables": {
                    "person": "person.isabelle",
                    "battery": "sensor.iphone_isa_battery_level",
                    "charging": "sensor.iphone_isa_battery_state",
                    "wifi": "sensor.iphone_isa_connection_type",
                    "distance": "proximity.home_isa",
                    "avatar_min": 50,
                    "avatar_max": 132,
                    "avatar_pct": 0.33,
                    "ring_home": "#22c55e",
                    "ring_away": "#ef4444",
                    "ring_unknown": "#94a3b8"
                  },
                  "triggers_update": [
                    "[[[ return variables.person ]]]",
                    "[[[ return variables.battery ]]]",
                    "[[[ return variables.charging ]]]",
                    "[[[ return variables.wifi ]]]",
                    "[[[ return variables.distance ]]]"
                  ],
                  "styles": {
                    "card": [
                      {
                        "border-radius": "14px"
                      },
                      {
                        "box-shadow": "0 4px 14px rgba(0,0,0,.10)"
                      },
                      {
                        "background": "linear-gradient(135deg, rgba(6,182,212,.16), rgba(6,182,212,.06))\n"
                      },
                      {
                        "padding": "10px 12px 10px 4px"
                      }
                    ],
                    "grid": [
                      {
                        "grid-template-areas": "\"status status\" \"avatar avatar\" \"batt   batt\" \"wifi   dist\""
                      },
                      {
                        "grid-template-columns": "1fr 1fr"
                      },
                      {
                        "grid-template-rows": "auto 1fr auto auto"
                      },
                      {
                        "row-gap": "6px"
                      }
                    ],
                    "custom_fields": {
                      "status": [
                        {
                          "justify-self": "end"
                        },
                        {
                          "align-self": "start"
                        }
                      ],
                      "avatar": [
                        {
                          "justify-self": "start"
                        },
                        {
                          "align-self": "start"
                        },
                        {
                          "margin-top": "-6px"
                        },
                        {
                          "margin-left": "-2px"
                        }
                      ],
                      "batt": [
                        {
                          "justify-self": "start"
                        },
                        {
                          "align-self": "end"
                        }
                      ],
                      "wifi": [
                        {
                          "justify-self": "start"
                        },
                        {
                          "align-self": "start"
                        }
                      ],
                      "dist": [
                        {
                          "justify-self": "end"
                        },
                        {
                          "align-self": "end"
                        },
                        {
                          "margin-bottom": "2px"
                        }
                      ]
                    }
                  },
                  "custom_fields": {
                    "status": "[[[\n  const ha = this.shadowRoot.querySelector('ha-card');\n  const w  = Math.max(180, ha?.getBoundingClientRect?.().width || this?.offsetWidth || 300);\n  const fs = Math.round(Math.min(16, Math.max(12, w * 0.04)));\n  const st  = states[variables.person]?.state ?? 'unknown';\n  const txt = st === 'home' ? 'Maison' : (st === 'not_home' ? 'Absent' : st);\n  const ic  = st === 'home' ? 'mdi:home'\n             : (st === 'not_home' ? 'mdi:map-marker-off' : 'mdi:map-marker-radius');\n  return `<div style=\"display:flex;gap:6px;align-items:center;\n                      color:var(--secondary-text-color);font-size:${fs}px;white-space:nowrap\">\n            <ha-icon icon=\"${ic}\" style=\"--mdc-icon-size:${fs}px\"></ha-icon>\n            <span>${txt}</span>\n          </div>`;\n]]]\n",
                    "avatar": "[[[\n  const min = Number(variables.avatar_min)||72;\n  const max = Number(variables.avatar_max)||132;\n  const pct = Number(variables.avatar_pct)||0.34;\n  const ha  = this.shadowRoot.querySelector('ha-card');\n  const w   = Math.max(1, ha?.getBoundingClientRect?.().width || this?.offsetWidth || 300);\n  const size  = Math.round(Math.min(max, Math.max(min, w * pct)));\n  const ringW = Math.max(4, Math.round(size * 0.06));\n  const st   = states[variables.person]?.state ?? 'unknown';\n  const ring = st === 'home' ? variables.ring_home\n             : (st === 'not_home' ? variables.ring_away : variables.ring_unknown);\n  let pic = states[variables.person]?.attributes?.entity_picture || '';\n  if (pic.includes('/128x128')) pic = pic.replace('/128x128','/512x512');\n  const bust = pic ? ((pic.includes('?')?'&':'?')+'v='+(Date.now()%1e7)) : '';\n  const base = `width:${size}px;height:${size}px;border-radius:50%;\n                border:${ringW}px solid ${ring};\n                box-shadow: inset 0 0 0 3px rgba(255,255,255,.85), 0 3px 8px rgba(0,0,0,.12);`;\n  return pic\n    ? `<div style=\"${base} background:url('${pic}${bust}') center/cover no-repeat;\"></div>`\n    : `<div style=\"${base} display:flex;align-items:center;justify-content:center;background:rgba(255,255,255,.92);\">\n         <ha-icon icon=\"mdi:account\" style=\"--mdc-icon-size:${Math.round(size*0.6)}px;color:rgba(0,0,0,.55)\"></ha-icon>\n       </div>`;\n]]]\n",
                    "batt": "[[[\n  const ha = this.shadowRoot.querySelector('ha-card');\n  const w  = Math.max(180, ha?.getBoundingClientRect?.().width || this?.offsetWidth || 300);\n  const fs = Math.round(Math.min(20, Math.max(12, w * 0.055)));\n  const lvl = Number(states[variables.battery]?.state);\n  const st  = (states[variables.charging]?.state || '').toLowerCase();\n  const charging = ['charging','en charge','ac power','plugged','full'].some(x=>st.includes(x));\n  const step = isNaN(lvl) ? 0 : Math.min(100, Math.max(0, Math.round(lvl/10)*10));\n  const ic   = charging ? `mdi:battery-charging-${step || 10}`\n                        : (step===100 ? 'mdi:battery' : `mdi:battery-${step || 10}`);\n  const txt  = isNaN(lvl) ? '—' : `${lvl}%`;\n  return `<div style=\"display:flex;gap:6px;align-items:center;font-weight:700;\n                      font-size:${fs}px;white-space:nowrap\">\n            <ha-icon icon=\"${ic}\" style=\"--mdc-icon-size:${Math.max(18, fs)}px\"></ha-icon>\n            <span>${txt} Batterie</span>\n          </div>`;\n]]]\n",
                    "wifi": "[[[\n  const ha = this.shadowRoot.querySelector('ha-card');\n  const w  = Math.max(180, ha?.getBoundingClientRect?.().width || this?.offsetWidth || 300);\n  const fs = Math.round(Math.min(18, Math.max(12, w * 0.048)));\n  const t = (states[variables.wifi]?.state || '').toLowerCase();\n  const isWifi = t.includes('wifi') || t.includes('wi-fi');\n  const label  = isWifi ? 'Wi-Fi' : (t ? 'Cellulaire' : 'Cellulaire');\n  const ic     = isWifi ? 'mdi:wifi' : 'mdi:signal-cellular-3';\n  return `<div style=\"display:flex;gap:6px;align-items:center;opacity:.9;\n                      font-size:${fs}px;white-space:nowrap\">\n            <ha-icon icon=\"${ic}\" style=\"--mdc-icon-size:${Math.max(18, fs)}px\"></ha-icon>\n            <span>${label}</span>\n          </div>`;\n]]]\n",
                    "dist": "[[[\n  const ha = this.shadowRoot.querySelector('ha-card');\n  const w  = Math.max(180, ha?.getBoundingClientRect?.().width || this?.offsetWidth || 300);\n  const fs = Math.round(Math.min(20, Math.max(12, w * 0.055)));  // même taille que batterie\n  let km = Number(states[variables.distance]?.state);\n  if (isNaN(km)) km = 0;\n  km = Math.round(km*10)/10;\n  if (Math.abs(km) < 0.05) km = 0;\n  return `<div style=\"display:flex;gap:6px;align-items:center;font-weight:800;\n                      font-size:${fs}px;white-space:nowrap\">\n            <ha-icon icon=\"mdi:map-marker-distance\" style=\"--mdc-icon-size:${Math.max(18, fs)}px\"></ha-icon>\n            <span style=\"font-variant-numeric:tabular-nums\">${km} km</span>\n          </div>`;\n]]]\n"
                  }
                }
              ]
            },
            {
              "type": "horizontal-stack",
              "cards": [
                {
                  "type": "custom:button-card",
                  "name": "Solcast aujourd’hui — points",
                  "show_state": false,
                  "show_label": true,
                  "label": "[[[\n  const s = hass.states['sensor.solcast_today_series_w'];\n  let arr = s?.attributes?.series;\n  if (typeof arr === 'string') { try { arr = JSON.parse(arr); } catch(e){ arr = []; } }\n  return `points: ${Array.isArray(arr) ? arr.length : 0}`;\n]]]\n"
                },
                {
                  "type": "custom:button-card",
                  "name": "Solcast demain — points",
                  "show_state": false,
                  "show_label": true,
                  "label": "[[[\n  const s = hass.states['sensor.solcast_tomorrow_as_today_series_w'];\n  let arr = s?.attributes?.series;\n  if (typeof arr === 'string') { try { arr = JSON.parse(arr); } catch(e){ arr = []; } }\n  return `points: ${Array.isArray(arr) ? arr.length : 0}`;\n]]]\n"
                }
              ]
            },
            {
              "type": "custom:apexcharts-card",
              "header": {
                "show": true,
                "title": "PV — Réel (SB+APS) vs Solcast (aujourd’hui)"
              },
              "graph_span": "16h",
              "span": {
                "start": "day",
                "offset": "+350m"
              },
              "now": {
                "show": true,
                "color": "#60a5fa"
              },
              "apex_config": {
                "stroke": {
                  "curve": "straight",
                  "dashArray": [
                    0,
                    0,
                    6
                  ]
                },
                "markers": {
                  "size": 0
                }
              },
              "yaxis": [
                {
                  "min": 0
                }
              ],
              "all_series_config": {
                "stroke_width": 2
              },
              "series": [
                {
                  "name": "Réel (W)",
                  "entity": "sensor.pv_total_entree_sb_aps_w",
                  "type": "area",
                  "extend_to": false,
                  "group_by": {
                    "duration": "5min",
                    "func": "avg",
                    "fill": "null"
                  },
                  "show": {
                    "in_header": false,
                    "legend_value": false
                  }
                },
                {
                  "name": "Solcast (W)",
                  "entity": "sensor.solcast_today_series_w",
                  "type": "line",
                  "extend_to": false,
                  "show": {
                    "in_header": false,
                    "legend_value": false
                  },
                  "data_generator": "return (hass.states['sensor.solcast_today_series_w']?.attributes?.series) || [];\n"
                },
                {
                  "name": "Solcast demain (W)",
                  "entity": "sensor.solcast_tomorrow_as_today_series_w",
                  "type": "line",
                  "extend_to": false,
                  "show": {
                    "in_header": false,
                    "legend_value": false
                  },
                  "data_generator": "return (hass.states['sensor.solcast_tomorrow_as_today_series_w']?.attributes?.series) || [];\n"
                }
              ]
            },
            {
              "type": "custom:apexcharts-card",
              "header": {
                "show": true,
                "title": "PV — Réel (SB+APS) vs Solcast (aujourd’hui)",
                "show_states": true,
                "colorize_states": true
              },
              "graph_span": "16h",
              "span": {
                "start": "day",
                "offset": "+350m"
              },
              "now": {
                "show": true,
                "color": "#60a5fa"
              },
              "apex_config": {
                "xaxis": {
                  "type": "datetime",
                  "labels": {
                    "datetimeUTC": false
                  },
                  "min": "[[[ const pad = 30*60*1000, day = 24*3600*1000;\n    const sun = hass.states[\"sun.sun\"]?.attributes || {};\n    const now = new Date();\n    const sameDay = d => d && d.getDate()===now.getDate()\n                        && d.getMonth()===now.getMonth()\n                        && d.getFullYear()===now.getFullYear();\n    const nr = sun.next_rising ? new Date(sun.next_rising) : null;\n    const rise = nr ? (sameDay(nr) ? nr : new Date(nr.getTime()-day))\n                    : new Date(now.getFullYear(), now.getMonth(), now.getDate(), 6,0,0);\n    return rise.getTime() - pad;\n]]]",
                  "max": "[[[ const pad = 30*60*1000, day = 24*3600*1000;\n    const sun = hass.states[\"sun.sun\"]?.attributes || {};\n    const now = new Date();\n    const sameDay = d => d && d.getDate()===now.getDate()\n                        && d.getMonth()===now.getMonth()\n                        && d.getFullYear()===now.getFullYear();\n    const ns = sun.next_setting ? new Date(sun.next_setting) : null;\n    const set = ns ? (sameDay(ns) ? ns : new Date(ns.getTime()-day))\n                   : new Date(now.getFullYear(), now.getMonth(), now.getDate(), 21,0,0);\n    return set.getTime() + pad;\n]]]"
                },
                "markers": {
                  "size": 0
                }
              },
              "yaxis": [
                {
                  "min": 0
                }
              ],
              "all_series_config": {
                "stroke_width": 2
              },
              "series": [
                {
                  "name": "",
                  "entity": "sun.sun",
                  "type": "line",
                  "color": "#9ca3af",
                  "stroke_width": 2,
                  "show": {
                    "in_chart": true,
                    "in_header": false,
                    "in_legend": false,
                    "legend_value": false
                  },
                  "data_generator": "// Fenêtre fixe (heure locale) : 05:50 → 21:50 const base = new Date(); base.setHours(0,0,0,0); const startMs = new Date(base.getFullYear(), base.getMonth(), base.getDate(), 5,50,0,0).getTime(); const endMs   = new Date(base.getFullYear(), base.getMonth(), base.getDate(), 21,50,0,0).getTime();\n// Source + compat : detailedForecast | detailed_forecast | forecasts | detailed | detailedHour | timeseries const ent = entity ?? hass.states['sensor.solcast_pv_forecast_previsions_pour_aujourd_hui']; const A = ent?.attributes || {}; let rows = A.detailedForecast || A.detailed_forecast || A.forecasts || A.detailed || A.detailedHour || A.timeseries || [];\n// Certains intégrateurs renvoient l'attribut \"series\" sous forme de chaîne JSON if (typeof rows === 'string') { try { rows = JSON.parse(rows); } catch(e) { rows = []; } } if (!Array.isArray(rows) || !rows.length) return [];\nconst out = []; for (const p of rows) {\n  const ms = new Date(p.period_end || p.period_start || p.time || p.datetime).getTime();\n  if (!Number.isFinite(ms) || ms < startMs || ms > endMs) continue;\n\n// Valeur + conversion kW→W si besoin\n  let v = Number(p.pv_estimate90 ?? p.pv_estimate ?? p.pv_estimate10 ?? p.pv ?? p.value ?? p.power ?? 0);\n  if (!Number.isFinite(v)) continue;\n  if (v > 0 && v <= 50) v *= 1000;\n\n  out.push([ms, Math.round(v)]);\n}\nout.sort((a,b)=>a[0]-b[0]); return out;\n"
                },
                {
                  "name": "Réel (W)",
                  "entity": "sensor.pv_total_entree_sb_aps_w",
                  "type": "area",
                  "extend_to": false,
                  "group_by": {
                    "duration": "5min",
                    "func": "avg",
                    "fill": "null"
                  },
                  "show": {
                    "in_header": false,
                    "legend_value": false
                  }
                },
                {
                  "name": "Solcast (W)",
                  "entity": "sensor.solcast_pv_forecast_previsions_pour_aujourd_hui",
                  "type": "line",
                  "unit": "W",
                  "show": {
                    "in_header": false,
                    "legend_value": false
                  },
                  "data_generator": "// Fenêtre 05:50 → 21:50 (heure locale) const base = new Date(); base.setHours(0,0,0,0); const startMs = new Date(base.getFullYear(), base.getMonth(), base.getDate(), 5, 50, 0, 0).getTime(); const endMs   = new Date(base.getFullYear(), base.getMonth(), base.getDate(), 21, 50, 0, 0).getTime();\n// Récupère la source et privilégie 'detailedForecast' const ent = entity ?? hass.states['sensor.solcast_pv_forecast_previsions_pour_aujourd_hui']; const a = ent?.attributes || {}; let rows = a.detailedForecast || a.forecasts || a.detailed || a.detailedHour || a.timeseries || [];\nif (typeof rows === 'string') { try { rows = JSON.parse(rows); } catch(e) { rows = []; } } if (!Array.isArray(rows) || rows.length === 0) return [];\nconst out = []; for (const p of rows) {\n  const ms = new Date(p.period_end || p.period_start || p.time || p.datetime).getTime();\n  if (!Number.isFinite(ms) || ms < startMs || ms > endMs) continue;\n\n  // Choix de la valeur + conversion kW→W si besoin\n  let v = Number(\n    p.pv_estimate90 ?? p.pv_estimate ?? p.pv_estimate10 ?? p.pv ?? p.value ?? p.power ?? 0\n  );\n  if (!Number.isFinite(v)) continue;\n  if (v > 0 && v <= 50) v *= 1000;\n\n  out.push([ms, Math.round(v)]);\n}\nout.sort((a,b)=>a[0]-b[0]); return out;\n"
                },
                {
                  "name": "Réel (kWh)",
                  "entity": "sensor.pv_total_day_kwh",
                  "unit": "kWh",
                  "show": {
                    "in_chart": false,
                    "in_header": true,
                    "name_in_header": true
                  },
                  "transform": "return Math.round((Number(x)||0)*10)/10;"
                },
                {
                  "name": "Solcast (kWh)",
                  "entity": "sensor.solcast_pv_forecast_previsions_pour_aujourd_hui",
                  "unit": "kWh",
                  "show": {
                    "in_chart": false,
                    "in_header": true,
                    "name_in_header": true
                  },
                  "transform": "return Math.round((Number(x)||0)*10)/10;"
                }
              ]
            }
          ],
          "type": "custom:masonry-layout"
        },
        {
          "visible": [
            {
              "user": "65f9557d9a4e4b3ca7469ddd356031a8"
            }
          ],
          "icon": "mdi:home-thermometer",
          "badges": [
            {
              "type": "entity",
              "show_name": false,
              "show_state": true,
              "show_icon": true,
              "entity": "sensor.thermo_ext_temperature",
              "show_entity_picture": true,
              "name": "Ouest",
              "state_content": [
                "name",
                "state"
              ]
            },
            {
              "type": "entity",
              "show_name": false,
              "show_state": true,
              "show_icon": true,
              "entity": "sensor.thermo_velos_temperature",
              "name": "Vélos",
              "icon": "mdi:bike",
              "show_entity_picture": false,
              "state_content": [
                "name",
                "state"
              ]
            }
          ],
          "cards": [
            {
              "type": "custom:clock-weather-card",
              "entity": "weather.sanguinet",
              "time_format": 24,
              "hide_clock": true,
              "date_pattern": "ccc d LLL",
              "show_humidity": true,
              "humidity_sensor": "sensor.thermo_ext_humidity"
            },
            {
              "type": "vertical-stack",
              "cards": [
                {
                  "type": "custom:simple-thermostat",
                  "card_mod": {
                    "style": "ha-card {\n  --st-font-size-xl: 24px;\n  --st-font-size-m: 18px;\n  --st-font-size-title: 20px;\n  --st-font-size-sensors: 18px;\n  --st-spacing: 2px;\n}\n.mode-item {\n  --border-radius: 20px;\n}\n"
                  },
                  "header": {
                    "name": "Séjour",
                    "icon": "mdi:sofa"
                  },
                  "entity": "climate.daikin_split_salon_room_temperature",
                  "hide": {
                    "temperature": true,
                    "state": true
                  },
                  "layout": {
                    "mode": {
                      "headings": false
                    }
                  },
                  "step_size": 0.5,
                  "decimals": 1,
                  "sensors": [
                    {
                      "entity": "sensor.thermo_salon_temperature",
                      "icon": "mdi:home-thermometer-outline",
                      "name": "Température"
                    },
                    {
                      "entity": "sensor.thermo_salon_humidity",
                      "icon": "mdi:water",
                      "name": "Humidité"
                    }
                  ],
                  "control": {
                    "fan": {
                      "quiet": {
                        "name": "Silence"
                      }
                    },
                    "hvac": {
                      "off": {
                        "name": null,
                        "icon": "mdi:power"
                      },
                      "heat": {
                        "name": null,
                        "icon": "mdi:fire"
                      },
                      "cool": {
                        "name": null
                      },
                      "heat_cool": false,
                      "dry": false,
                      "fan_only": false
                    }
                  }
                }
              ]
            },
            {
              "type": "custom:mushroom-chips-card",
              "alignment": "end",
              "chips": [
                {
                  "type": "template",
                  "entity": "input_boolean.sdb_reveil_enable",
                  "icon": "{{ 'mdi:shower-head' if is_state('input_boolean.sdb_reveil_enable','on')\n   else 'mdi:shower' }}",
                  "content": "Réveil SDB",
                  "icon_color": "{{ 'green' if is_state('input_boolean.sdb_reveil_enable','on') else 'grey' }}",
                  "tap_action": {
                    "action": "toggle"
                  },
                  "hold_action": {
                    "action": "more-info"
                  }
                },
                {
                  "type": "template",
                  "entity": "binary_sensor.sdb_sonde_temperature_dispo",
                  "icon": "{{ 'mdi:thermometer' if is_state('binary_sensor.sdb_sonde_temperature_dispo','on')\n   else 'mdi:thermometer-off' if is_state('binary_sensor.sdb_sonde_temperature_dispo','off')\n   else 'mdi:help-circle' }}",
                  "content": "{{ 'Sonde OK' if is_state('binary_sensor.sdb_sonde_temperature_dispo','on')\n   else 'Sonde ?' if states('binary_sensor.sdb_sonde_temperature_dispo') in ['unknown','unavailable']\n   else 'Sonde OFF' }}",
                  "icon_color": "{% set s = states('binary_sensor.sdb_sonde_temperature_dispo') %} {{ 'green' if s in ['on','true'] else 'amber' if s in ['unknown','unavailable'] else 'red' }}",
                  "tap_action": {
                    "action": "more-info"
                  }
                },
                {
                  "type": "template",
                  "entity": "binary_sensor.sdb_consigne_confirmee",
                  "icon": "{% set s = states('binary_sensor.sdb_consigne_confirmee') %} {{ 'mdi:check-circle' if s in ['on','true']\n   else 'mdi:progress-clock' if s in ['unknown','unavailable'] else 'mdi:alert-circle' }}",
                  "content": "{{ 'Consigne OK' if is_state('binary_sensor.sdb_consigne_confirmee','on')\n   else 'Consigne ?' if states('binary_sensor.sdb_consigne_confirmee') in ['unknown','unavailable']\n   else 'Consigne NOK' }}",
                  "icon_color": "{% set s = states('binary_sensor.sdb_consigne_confirmee') %} {{ 'green' if s in ['on','true'] else 'amber' if s in ['unknown','unavailable'] else 'red' }}",
                  "tap_action": {
                    "action": "more-info"
                  }
                },
                {
                  "type": "template",
                  "icon": "mdi:thermometer-water",
                  "content": "{% set ce = states('input_text.sdb_entity_climate') %} {% set cur = state_attr(ce, 'current_temperature') %} {% set sp  = state_attr(ce, 'temperature') %} {% if cur is number and sp is number %}\n  {{ cur | round(1) }}° → {{ sp | round(1) }}°\n{% elif cur is number %}\n  {{ cur | round(1) }}° → —\n{% elif sp is number %}\n  — → {{ sp | round(1) }}°\n{% else %}\n  — → —\n{% endif %}",
                  "tap_action": {
                    "action": "more-info"
                  },
                  "icon_color": "{% set ce = states('input_text.sdb_entity_climate') %} {% set cur = state_attr(ce, 'current_temperature') %} {{ 'blue' if cur is number else 'grey' }}"
                }
              ],
              "card_mod": {
                "style": "ha-card {\n  border-radius: 16px;\n  padding: 10px;\n  box-shadow: 0 2px 8px rgba(0,0,0,.12);\n  background: linear-gradient(135deg, rgba(148,163,184,.16), rgba(6,182,212,.06));\n}\n"
              }
            },
            {
              "type": "custom:vertical-stack-in-card",
              "cards": [
                {
                  "type": "custom:mod-card",
                  "style": "ha-card {\n  margin: 1px 1px !important;\n  padding: 1px !important;\n}\n",
                  "card": {
                    "type": "custom:mushroom-climate-card",
                    "entity": "climate.thermostat_sdb",
                    "tap_action": {
                      "action": "none"
                    },
                    "hold_action": {
                      "action": "more-info"
                    },
                    "double_tap_action": {
                      "action": "none"
                    },
                    "show_temperature_control": true,
                    "hvac_modes": [
                      "heat",
                      "off"
                    ],
                    "layout": "horizontal",
                    "icon": "mdi:shower",
                    "secondary_info": "none",
                    "name": "Salle de Bain"
                  }
                },
                {
                  "type": "custom:mod-card",
                  "style": "ha-card {\n  margin: 1px 1px !important;\n  padding: 1px !important;\n}\n/* optionnel : réduire l’espacement entre les tuiles du grid */\nha-card > .card-content {\n  display: grid;\n  grid-gap: 1px !important;\n}\n",
                  "card": {
                    "type": "grid",
                    "square": false,
                    "columns": 2,
                    "cards": [
                      {
                        "type": "custom:mod-card",
                        "style": "ha-card {\n  margin: 1px !important;\n  padding: 1px !important;\n}\n",
                        "card": {
                          "type": "custom:mushroom-entity-card",
                          "entity": "sensor.thermo_sdb_temperature",
                          "primary_info": "state",
                          "secondary_info": "none",
                          "name": "Temperature",
                          "icon_color": "green"
                        }
                      },
                      {
                        "type": "custom:mod-card",
                        "style": "ha-card {\n  margin: 1px !important;\n  padding: 1px !important;\n}\n",
                        "card": {
                          "type": "custom:mushroom-entity-card",
                          "entity": "sensor.thermo_sdb_humidity",
                          "primary_info": "state",
                          "secondary_info": "none",
                          "name": "Humidity",
                          "icon_color": "blue"
                        }
                      }
                    ]
                  }
                }
              ]
            },
            {
              "type": "custom:vertical-stack-in-card",
              "cards": [
                {
                  "type": "custom:mushroom-climate-card",
                  "entity": "climate.bureau",
                  "tap_action": {
                    "action": "none"
                  },
                  "hold_action": {
                    "action": "more-info"
                  },
                  "double_tap_action": {
                    "action": "none"
                  },
                  "show_temperature_control": true,
                  "hvac_modes": [
                    "heat",
                    "off",
                    "cool"
                  ],
                  "layout": "horizontal",
                  "icon": "mdi:desktop-classic",
                  "secondary_info": "none"
                },
                {
                  "type": "grid",
                  "square": false,
                  "columns": 2,
                  "cards": [
                    {
                      "type": "custom:mushroom-entity-card",
                      "entity": "sensor.bureau_temperature",
                      "primary_info": "state",
                      "secondary_info": "none",
                      "name": "Temperature",
                      "icon_color": "green"
                    },
                    {
                      "type": "custom:mushroom-entity-card",
                      "entity": "sensor.bureau_humidite",
                      "primary_info": "state",
                      "secondary_info": false,
                      "name": "Humidity",
                      "icon_color": "blue"
                    }
                  ]
                }
              ]
            },
            {
              "type": "custom:vertical-stack-in-card",
              "cards": [
                {
                  "type": "custom:mushroom-climate-card",
                  "entity": "climate.amis",
                  "tap_action": {
                    "action": "none"
                  },
                  "hold_action": {
                    "action": "more-info"
                  },
                  "double_tap_action": {
                    "action": "none"
                  },
                  "show_temperature_control": true,
                  "hvac_modes": [
                    "heat",
                    "off",
                    "cool"
                  ],
                  "layout": "horizontal",
                  "icon": "mdi:bed-king-outline",
                  "secondary_info": "none"
                },
                {
                  "type": "grid",
                  "square": false,
                  "columns": 2,
                  "cards": [
                    {
                      "type": "custom:mushroom-entity-card",
                      "entity": "sensor.amis_temperature",
                      "primary_info": "state",
                      "secondary_info": "none",
                      "name": "Temperature",
                      "icon_color": "green"
                    },
                    {
                      "type": "custom:mushroom-entity-card",
                      "entity": "sensor.amis_humidite",
                      "primary_info": "state",
                      "secondary_info": "none",
                      "name": "Humidity",
                      "icon_color": "blue"
                    }
                  ]
                }
              ]
            },
            {
              "type": "custom:vertical-stack-in-card",
              "cards": [
                {
                  "type": "custom:mushroom-climate-card",
                  "entity": "climate.parents",
                  "tap_action": {
                    "action": "none"
                  },
                  "hold_action": {
                    "action": "more-info"
                  },
                  "double_tap_action": {
                    "action": "none"
                  },
                  "show_temperature_control": true,
                  "hvac_modes": [
                    "heat",
                    "off",
                    "cool"
                  ],
                  "layout": "horizontal",
                  "icon": "mdi:bed-king",
                  "secondary_info": "none"
                },
                {
                  "type": "grid",
                  "square": false,
                  "columns": 2,
                  "cards": [
                    {
                      "type": "custom:mushroom-entity-card",
                      "entity": "sensor.parents_temperature",
                      "primary_info": "state",
                      "secondary_info": "none",
                      "name": "Temperature",
                      "icon_color": "green"
                    },
                    {
                      "type": "custom:mushroom-entity-card",
                      "entity": "sensor.amis_humidite",
                      "primary_info": "state",
                      "secondary_info": "none",
                      "name": "Humidity",
                      "icon_color": "blue"
                    }
                  ]
                }
              ]
            },
            {
              "type": "custom:scheduler-card",
              "include": [
                "calendar.fictif_test",
                "calendar.planning_cours_isa",
                "calendar.wakawarider_gmail_com",
                "climate",
                "climate.amis",
                "climate.bureau",
                "climate.daikin",
                "climate.parents",
                "climate.thermo_garage",
                "climate.thermostat_sdb"
              ],
              "exclude": []
            },
            {
              "type": "custom:vertical-stack-in-card",
              "cards": [
                {
                  "type": "custom:mushroom-climate-card",
                  "entity": "climate.thermo_garage",
                  "name": "Garage",
                  "tap_action": {
                    "action": "none"
                  },
                  "hold_action": {
                    "action": "more-info"
                  },
                  "double_tap_action": {
                    "action": "none"
                  },
                  "show_temperature_control": true,
                  "hvac_modes": [
                    "heat",
                    "off",
                    "cool"
                  ],
                  "layout": "horizontal",
                  "icon": "mdi:garage-variant",
                  "secondary_info": "none",
                  "collapsible_controls": true
                },
                {
                  "type": "grid",
                  "square": false,
                  "columns": 2,
                  "cards": [
                    {
                      "type": "custom:mushroom-entity-card",
                      "entity": "sensor.thermo_garage_temperature",
                      "primary_info": "state",
                      "secondary_info": "none",
                      "name": "Temperature",
                      "icon_color": "green"
                    },
                    {
                      "type": "custom:mushroom-entity-card",
                      "entity": "sensor.thermo_garage_humidity",
                      "primary_info": "state",
                      "secondary_info": false,
                      "name": "Humidity",
                      "icon_color": "blue"
                    }
                  ]
                }
              ]
            },
            {
              "type": "custom:simple-thermostat",
              "entity": "climate.daikin_split_salon_room_temperature",
              "header": {
                "name": "Séjour",
                "icon": "mdi:sofa"
              },
              "decimals": 1,
              "step_size": 0.5,
              "sensors": [
                {
                  "entity": "sensor.thermo_salon_temperature",
                  "name": "Température",
                  "icon": "mdi:home-thermometer-outline"
                },
                {
                  "entity": "sensor.thermo_salon_humidity",
                  "name": "Humidité",
                  "icon": "mdi:water"
                }
              ],
              "hide": {
                "state": true
              },
              "layout": {
                "step": "row",
                "mode": {
                  "headings": false
                }
              },
              "control": {
                "hvac": {
                  "off": {
                    "icon": "mdi:power"
                  },
                  "heat": {
                    "icon": "mdi:fire"
                  },
                  "cool": {
                    "icon": "mdi:snowflake"
                  }
                },
                "fan": {
                  "1": {
                    "icon": "mdi:numeric-1-circle"
                  },
                  "2": {
                    "icon": "mdi:numeric-2-circle"
                  },
                  "Auto": {
                    "name": "Auto",
                    "icon": "mdi:autorenew"
                  },
                  "Silence": {
                    "name": "Silence",
                    "icon": "mdi:volume-off"
                  }
                }
              },
              "card_mod": {
                "style": "ha-card {\n  border-radius: 16px;\n  padding: 6px 10px;\n  box-shadow: 0 2px 10px rgba(0,0,0,.10);\n  --st-font-size-xl: 22px;\n  --st-font-size-title: 16px;\n  --st-font-size-sensors: 14px;\n  --st-spacing: 4px;\n  background: linear-gradient(135deg, rgba(148,163,184,.10), rgba(148,163,184,.05));\n}\n.stepper {\n  --mdc-icon-size: 22px;\n  border-radius: 12px;\n  background: var(--ha-card-background);\n  box-shadow: 0 1px 6px rgba(0,0,0,.10);\n  padding: 2px 6px;\n}\n.modes .mode-item[active] {\n  background: rgba(34,197,94,.12);\n  border-radius: 12px;\n}\n"
              }
            },
            {
              "type": "custom:mushroom-chips-card",
              "alignment": "end",
              "chips": [
                {
                  "type": "template",
                  "entity": "input_boolean.sdb_reveil_enable",
                  "icon": "{{ 'mdi:shower-head' if is_state('input_boolean.sdb_reveil_enable','on') else 'mdi:shower' }}",
                  "content": "Réveil SDB",
                  "icon_color": "{{ 'green' if is_state('input_boolean.sdb_reveil_enable','on') else 'grey' }}",
                  "tap_action": {
                    "action": "toggle"
                  },
                  "hold_action": {
                    "action": "more-info"
                  }
                },
                {
                  "type": "template",
                  "entity": "binary_sensor.sdb_sonde_temperature_dispo",
                  "icon": "{% set ce = states('input_text.sdb_entity_climate') %} {% set ts = states('input_text.sdb_temp_sensor') %} {% set cur = (states(ts) | float(default=None)) if (ts and states.get(ts)) else state_attr(ce, 'current_temperature') %} {{ 'mdi:thermometer' if cur is number else 'mdi:thermometer-off' if is_state('binary_sensor.sdb_sonde_temperature_dispo','off') else 'mdi:help-circle' }}",
                  "content": "{% set ce = states('input_text.sdb_entity_climate') %} {% set ts = states('input_text.sdb_temp_sensor') %} {% set cur = (states(ts) | float(default=None)) if (ts and states.get(ts)) else state_attr(ce, 'current_temperature') %} {{ 'Sonde OK' if cur is number\n   else 'Sonde ?' if states('binary_sensor.sdb_sonde_temperature_dispo') in ['unknown','unavailable']\n   else 'Sonde OFF' }}",
                  "icon_color": "{% set ce = states('input_text.sdb_entity_climate') %} {% set ts = states('input_text.sdb_temp_sensor') %} {% set cur = (states(ts) | float(default=None)) if (ts and states.get(ts)) else state_attr(ce, 'current_temperature') %} {{ 'green' if cur is number else 'amber' if states('binary_sensor.sdb_sonde_temperature_dispo') in ['unknown','unavailable'] else 'red' }}",
                  "tap_action": {
                    "action": "more-info"
                  }
                },
                {
                  "type": "template",
                  "entity": "binary_sensor.sdb_consigne_confirmee",
                  "icon": "{% set s = states('binary_sensor.sdb_consigne_confirmee') %} {{ 'mdi:check-circle' if s in ['on','true'] else 'mdi:progress-clock' if s in ['unknown','unavailable'] else 'mdi:alert-circle' }}",
                  "content": "{{ 'Consigne OK' if is_state('binary_sensor.sdb_consigne_confirmee','on')\n   else 'Consigne ?' if states('binary_sensor.sdb_consigne_confirmee') in ['unknown','unavailable']\n   else 'Consigne NOK' }}",
                  "icon_color": "{% set s = states('binary_sensor.sdb_consigne_confirmee') %} {{ 'green' if s in ['on','true'] else 'amber' if s in ['unknown','unavailable'] else 'red' }}",
                  "tap_action": {
                    "action": "more-info"
                  }
                },
                {
                  "type": "template",
                  "icon": "mdi:thermometer-water",
                  "content": "{% set ce = states('input_text.sdb_entity_climate') %} {% set ts = states('input_text.sdb_temp_sensor') %} {% set cur = (states(ts) | float(default=None)) if (ts and states.get(ts)) else state_attr(ce, 'current_temperature') %} {% set sp  = state_attr(ce, 'temperature') %} {% if cur is number and sp is number %}\n  {{ cur | round(1) }}° → {{ sp | round(1) }}°\n{% elif cur is number %}\n  {{ cur | round(1) }}° → —\n{% elif sp is number %}\n  — → {{ sp | round(1) }}°\n{% else %}\n  — → —\n{% endif %}",
                  "tap_action": {
                    "action": "more-info"
                  },
                  "icon_color": "{% set ce = states('input_text.sdb_entity_climate') %} {% set ts = states('input_text.sdb_temp_sensor') %} {% set cur = (states(ts) | float(default=None)) if (ts and states.get(ts)) else state_attr(ce, 'current_temperature') %} {{ 'blue' if cur is number else 'grey' }}"
                }
              ],
              "card_mod": {
                "style": "ha-card {\n  border-radius: 16px;\n  padding: 10px;\n  box-shadow: 0 2px 8px rgba(0,0,0,.12);\n  background: linear-gradient(135deg, rgba(148,163,184,.16), rgba(6,182,212,.06));\n}\n"
              }
            }
          ]
        },
        {
          "type": "custom:masonry-layout",
          "view_layout": {
            "column": 2
          },
          "path": "cumulus",
          "title": "Cumulus",
          "icon": "mdi:water-boiler",
          "cards": [
            {
              "type": "custom:button-card",
              "entity": "[[[ const e = states['input_text.cumulus_entity_contacteur']?.state;\n    return (e && states[e]) ? e : 'switch.shellypro1_ece334ee1b64'; ]]]",
              "name": "Cumulus",
              "show_icon": false,
              "show_state": false,
              "label": "[[[\n  const swOn  = entity?.state === 'on';\n  const imp   = Number(states['sensor.cumulus_import_reseau_w']?.state) || 0;\n  const seuil = Number(states['sensor.cumulus_seuil_fin_chauffe_w']?.state) || 0;\n  const HYS_W = 50;\n\n  const bsFast = states['binary_sensor.cumulus_chauffe_reelle_instant'];\n  const bsStd  = states['binary_sensor.cumulus_chauffe_reelle'];\n  const heating = bsFast ? (bsFast.state === 'on')\n                 : bsStd ? (bsStd.state === 'on')\n                         : (swOn && (imp > (seuil + HYS_W)));\n\n  if (!swOn) return 'ARRÊTÉ';\n  return heating ? 'EN CHAUFFE' : 'PRÊT';\n]]]",
              "custom_fields": {
                "power": {
                  "card": {
                    "type": "custom:button-card",
                    "entity": "[[[ const e = states['input_text.cumulus_entity_contacteur']?.state;\n    return (e && states[e]) ? e : 'switch.shellypro1_ece334ee1b64'; ]]]",
                    "icon": "mdi:power",
                    "show_name": false,
                    "show_state": false,
                    "tap_action": {
                      "action": "call-service",
                      "confirmation": {
                        "text": "Confirmer"
                      },
                      "service": "homeassistant.toggle",
                      "service_data": {
                        "entity_id": "[[[ const e = states['input_text.cumulus_entity_contacteur']?.state;\n    return (e && states[e]) ? e : 'switch.shellypro1_ece334ee1b64'; ]]]"
                      }
                    },
                    "hold_action": {
                      "action": "call-service",
                      "service": "input_boolean.toggle",
                      "target": {
                        "entity_id": "input_boolean.cumulus_interdit"
                      }
                    },
                    "confirmation": {
                      "text": "Confirmer"
                    },
                    "double_tap_action": "none",
                    "styles": {
                      "card": [
                        {
                          "box-shadow": "none"
                        },
                        {
                          "padding": 0
                        },
                        {
                          "border-radius": "999px"
                        },
                        {
                          "background": "none"
                        },
                        {
                          "border": "none"
                        },
                        {
                          "width": "48px"
                        },
                        {
                          "height": "48px"
                        }
                      ],
                      "icon": [
                        {
                          "width": "34px"
                        },
                        {
                          "color": "[[[\n  const swOn  = entity?.state === 'on';\n  const inter = states['input_boolean.cumulus_interdit']?.state === 'on';\n  const db    = (states['binary_sensor.cumulus_deadband_actif']?.state === 'on')\n             || (states['timer.cumulus_deadband_ui']?.state === 'active');\n  if (inter) return '#ef4444';   // verrou\n  if (db)    return '#f59e0b';   // temporisation (icône seulement)\n  return swOn ? '#22c55e' : '#9ca3af';\n]]]"
                        }
                      ]
                    }
                  }
                },
                "led": "[[[\n  const swOn = entity?.state === 'on';\n  const bsFast = states['binary_sensor.cumulus_chauffe_reelle_instant'];\n  const bsStd  = states['binary_sensor.cumulus_chauffe_reelle'];\n  let heating = false;\n  if (bsFast) heating = bsFast.state === 'on';\n  else if (bsStd) heating = bsStd.state === 'on';\n  else {\n    const imp   = Number(states['sensor.cumulus_import_reseau_w']?.state) || 0;\n    const seuil = Number(states['sensor.cumulus_seuil_fin_chauffe_w']?.state) || 0;\n    const HYS_W = 50;\n    heating = swOn && (imp > (seuil + HYS_W));\n  }\n  // LED = éteint / rouge / vert\n  let style = 'width:40px;height:40px;border-radius:50%;';\n  if (!swOn) {\n    style += 'background:rgba(148,163,184,.14);border:1px solid rgba(148,163,184,.35);box-shadow:none;';\n  } else if (heating) {\n    style += 'background:#ef4444;box-shadow:0 0 0 6px rgba(239,68,68,.25), 0 0 18px rgba(239,68,68,.85);';\n  } else {\n    style += 'background:#22c55e;box-shadow:0 0 12px rgba(34,197,94,.60);';\n  }\n  return `<div style=\"${style}\"></div>`;\n]]]",
                "last": "[[[\n  const ok  = v => v && v !== 'unknown' && v !== 'unavailable' && String(v).trim() !== '';\n  const get = id => ok(states[id]?.state) ? states[id].state : null;\n  const parseDT = (s) => {\n    if (!ok(s)) return null;\n    if (/^\\d+$/.test(String(s))) { const n = Number(s); return new Date(n < 2e10 ? n*1000 : n); }\n    const t = String(s).replace('T',' ').trim();\n    const parts = t.split(' ');\n    if (parts.length === 2 && /^\\d{4}-\\d{2}-\\d{2}$/.test(parts[0])) {\n      const [Y,M,D] = parts[0].split('-').map(Number);\n      const [h,m,ss] = parts[1].split(':').map(x => Number(x)||0);\n      return new Date(Y,(M||1)-1,D||1,h||0,m||0,ss||0);\n    }\n    const d = new Date(s); return isNaN(d) ? null : d;\n  };\n  const fmtHM = d => d.toLocaleTimeString('fr-FR',{hour:'2-digit',minute:'2-digit'});\n\n  const endStr = get('input_datetime.cumulus_last_full_heat_end')\n              || get('sensor.cumulus_last_full_heat_end')\n              || get('sensor.cumulus_last_full_heat_fin')\n              || get('sensor.cumulus_last_full_heat_end_time');\n  const end = parseDT(endStr);\n  if (!end) return 'Dernière chauffe complète : —';\n\n  const now  = new Date();\n  const today= now.toDateString();\n  const yest = new Date(now); yest.setDate(now.getDate()-1);\n\n  const when = (end.toDateString() === today)\n    ? `aujourd’hui à ${fmtHM(end)}`\n    : (end.toDateString() === yest.toDateString())\n      ? `hier à ${fmtHM(end)}`\n      : `le ${end.toLocaleDateString('fr-FR',{day:'2-digit',month:'2-digit'})} à ${fmtHM(end)}`;\n\n  return `Dernière chauffe complète : ${when}`;\n]]]",
                "lock": "[[[\n  const inter = states['input_boolean.cumulus_interdit']?.state === 'on';\n  if (!inter) return '';\n  return `<ha-icon icon=\"mdi:lock-alert\" style=\"width:18px;height:18px;color:#ef4444\"></ha-icon>`;\n]]]\n"
              },
              "styles": {
                "card": [
                  {
                    "border-radius": "16px"
                  },
                  {
                    "padding": "8px"
                  },
                  {
                    "min-height": "76px"
                  },
                  {
                    "box-shadow": "0 2px 8px rgba(0,0,0,.10)"
                  },
                  {
                    "border": "1px solid rgba(0,0,0,.06)"
                  },
                  {
                    "border-left": "[[[\n  const inter = states['input_boolean.cumulus_interdit']?.state === 'on';\n  return inter ? '4px solid #ef4444' : '1px solid rgba(0,0,0,.06)';\n]]]\n"
                  },
                  {
                    "background": "[[[\n  const base = 'linear-gradient(135deg, rgba(30,58,138,.16), rgba(124,58,237,.12))';\n  const glow = 'radial-gradient(120% 140% at 0% 0%, rgba(191,219,254,.10) 0%, rgba(255,255,255,0) 60%)';\n  return `${base}, ${glow}`;\n]]]"
                  }
                ],
                "grid": [
                  {
                    "grid-template-areas": "\"power n   led\"\n\"power l   led\"\n\"power last led\"\n"
                  },
                  {
                    "grid-template-columns": "52px 1fr 52px"
                  },
                  {
                    "grid-template-rows": "min-content min-content min-content"
                  },
                  {
                    "row-gap": 0
                  },
                  {
                    "align-items": "center"
                  },
                  {
                    "align-content": "center"
                  }
                ],
                "name": [
                  {
                    "justify-self": "center"
                  },
                  {
                    "align-self": "end"
                  },
                  {
                    "font-weight": 800
                  },
                  {
                    "font-size": "2.6rem"
                  },
                  {
                    "line-height": 1.05
                  },
                  {
                    "letter-spacing": "0.1px"
                  },
                  {
                    "margin": 0
                  }
                ],
                "label": [
                  {
                    "justify-self": "center"
                  },
                  {
                    "align-self": "start"
                  },
                  {
                    "margin": 0
                  },
                  {
                    "font-weight": 700
                  },
                  {
                    "font-size": "0.9rem"
                  },
                  {
                    "opacity": 0.92
                  }
                ],
                "custom_fields": {
                  "power": [
                    {
                      "justify-self": "start"
                    },
                    {
                      "pointer-events": "auto"
                    }
                  ],
                  "led": [
                    {
                      "justify-self": "end"
                    },
                    {
                      "pointer-events": "none"
                    }
                  ],
                  "last": [
                    {
                      "grid-area": "last"
                    },
                    {
                      "justify-self": "center"
                    },
                    {
                      "align-self": "start"
                    },
                    {
                      "margin": "2px 0 0 0"
                    },
                    {
                      "font-weight": 500
                    },
                    {
                      "font-size": ".86rem"
                    },
                    {
                      "color": "#64748b"
                    }
                  ],
                  "lock": [
                    {
                      "position": "absolute"
                    },
                    {
                      "top": "6px"
                    },
                    {
                      "right": "6px"
                    },
                    {
                      "filter": "drop-shadow(0 0 2px rgba(0,0,0,.25))"
                    }
                  ]
                }
              },
              "triggers_update": [
                "binary_sensor.cumulus_chauffe_reelle_instant",
                "binary_sensor.cumulus_chauffe_reelle",
                "sensor.cumulus_import_reseau_w",
                "sensor.cumulus_seuil_fin_chauffe_w",
                "timer.cumulus_deadband_ui",
                "input_boolean.cumulus_interdit",
                "input_text.cumulus_entity_contacteur",
                "input_datetime.cumulus_last_full_heat_end",
                "sensor.cumulus_last_full_heat_end",
                "sensor.cumulus_last_full_heat_fin",
                "sensor.cumulus_last_full_heat_end_time"
              ],
              "update_interval": 1,
              "tap_action": "none",
              "hold_action": "none"
            },
            {
              "type": "custom:button-card",
              "entity": "input_boolean.cumulus_jour_autorise",
              "variables": {
                "force_state": null
              },
              "name": "[[[\n  const f = variables.force_state;\n  const on = (f === 'on') ? true : (f === 'off') ? false : (entity?.state === 'on');\n  return on ? 'Journée autorisée (1 j / 2)' : 'Jour non autorisé (1 j / 2)';\n]]]\n",
              "icon": "[[[\n  const f = variables.force_state;\n  const on = (f === 'on') ? true : (f === 'off') ? false : (entity?.state === 'on');\n  return on ? 'mdi:calendar-check' : 'mdi:calendar-remove';\n]]]\n",
              "show_state": false,
              "styles": {
                "card": [
                  {
                    "border-radius": "16px"
                  },
                  {
                    "padding": "10px"
                  },
                  {
                    "box-shadow": "0 1px 6px rgba(0,0,0,.12)"
                  },
                  {
                    "background": "[[[\n  const f = variables.force_state;\n  const on = (f === 'on') ? true : (f === 'off') ? false : (entity?.state === 'on');\n  return on\n    ? 'linear-gradient(135deg, rgba(34,197,94,.14), rgba(6,182,212,.06))'\n    : 'linear-gradient(135deg, rgba(239,68,68,.14), rgba(6,182,212,.06))';\n]]]\n"
                  }
                ],
                "grid": [
                  {
                    "grid-template-areas": "\"i n\""
                  },
                  {
                    "grid-template-columns": "36px 1fr"
                  }
                ],
                "icon": [
                  {
                    "width": "24px"
                  },
                  {
                    "color": "[[[\n  const f = variables.force_state;\n  const on = (f === 'on') ? true : (f === 'off') ? false : (entity?.state === 'on');\n  return on ? '#22c55e' : '#ef4444';\n]]]\n"
                  }
                ],
                "name": [
                  {
                    "font-weight": 700
                  },
                  {
                    "font-size": ".98rem"
                  }
                ]
              },
              "tap_action": {
                "action": "toggle",
                "confirmation": {
                  "text": "Confirmer"
                }
              },
              "hold_action": {
                "action": "more-info"
              }
            },
            {
              "type": "custom:button-card",
              "entity": "binary_sensor.cumulus_skip_hc_tonight",
              "variables": {
                "force_skip": null,
                "force_jour_ok": null,
                "force_verrou": null,
                "force_interdit": null,
                "force_vacances": null,
                "force_override": null
              },
              "show_state": false,
              "show_label": true,
              "name": "[[[\n  const isOn = id => states[id]?.state === 'on';\n  const asBool = v => (v===true) ? true : (v===false) ? false : null;\n\n  const jourOK   = (asBool(variables.force_jour_ok)   ?? isOn('input_boolean.cumulus_jour_autorise'));\n  const verrou   = (asBool(variables.force_verrou)    ?? isOn('input_boolean.cumulus_verrou_jour'));\n  const interdit = (asBool(variables.force_interdit)  ?? isOn('input_boolean.cumulus_interdit'));\n  const vac      = (asBool(variables.force_vacances)  ?? isOn('input_boolean.cumulus_vacances'));\n  const override = (asBool(variables.force_override)  ?? isOn('input_boolean.cumulus_solcast_override'));\n\n  let skip = entity?.state === 'on';\n  if (variables.force_skip === 'on')  skip = true;\n  if (variables.force_skip === 'off') skip = false;\n\n  const blocked = (!jourOK) || verrou || interdit || vac || (skip && !override);\n  return blocked ? 'Pas d’heures creuses ce soir' : 'Heures creuses ce soir';\n]]]\n",
              "icon": "[[[\n  const isOn = id => states[id]?.state === 'on';\n  const asBool = v => (v===true) ? true : (v===false) ? false : null;\n\n  const jourOK   = (asBool(variables.force_jour_ok)   ?? isOn('input_boolean.cumulus_jour_autorise'));\n  const verrou   = (asBool(variables.force_verrou)    ?? isOn('input_boolean.cumulus_verrou_jour'));\n  const interdit = (asBool(variables.force_interdit)  ?? isOn('input_boolean.cumulus_interdit'));\n  const vac      = (asBool(variables.force_vacances)  ?? isOn('input_boolean.cumulus_vacances'));\n  const override = (asBool(variables.force_override)  ?? isOn('input_boolean.cumulus_solcast_override'));\n\n  let skip = entity?.state === 'on';\n  if (variables.force_skip === 'on')  skip = true;\n  if (variables.force_skip === 'off') skip = false;\n\n  const blocked = (!jourOK) || verrou || interdit || vac || (skip && !override);\n  return blocked ? 'mdi:calendar-remove' : 'mdi:calendar-check';\n]]]\n",
              "label": "[[[\n  const isOn = id => states[id]?.state === 'on';\n  const asBool = v => (v===true) ? true : (v===false) ? false : null;\n\n  const jourOK   = (asBool(variables.force_jour_ok)   ?? isOn('input_boolean.cumulus_jour_autorise'));\n  const verrou   = (asBool(variables.force_verrou)    ?? isOn('input_boolean.cumulus_verrou_jour'));\n  const interdit = (asBool(variables.force_interdit)  ?? isOn('input_boolean.cumulus_interdit'));\n  const vac      = (asBool(variables.force_vacances)  ?? isOn('input_boolean.cumulus_vacances'));\n  const override = (asBool(variables.force_override)  ?? isOn('input_boolean.cumulus_solcast_override'));\n\n  let skip = entity?.state === 'on';\n  if (variables.force_skip === 'on')  skip = true;\n  if (variables.force_skip === 'off') skip = false;\n\n  // PV forecast\n  const kwh   = Number(states['sensor.solcast_tomorrow_kwh_p90_window']?.state) || 0;\n  const seuil = Number(states['input_number.cumulus_solcast_seuil_kwh']?.state) || 0;\n  const cmp   = (kwh >= seuil) ? '≥' : '<';\n\n  // Motif (si bloqué)\n  let blocked = false, motif = '';\n  if (!jourOK)               { blocked = true; motif = 'Jour non autorisé'; }\n  else if (verrou)           { blocked = true; motif = 'Chauffe du jour terminée'; }\n  else if (interdit)         { blocked = true; motif = 'Interdit'; }\n  else if (vac)              { blocked = true; motif = 'Vacances'; }\n  else if (skip && !override){ blocked = true; motif = `Solcast demain (P90 fenêtre) : ${kwh.toFixed(1)} ${cmp} ${seuil.toFixed(1)} kWh`; }\n\n  if (blocked) {\n    return motif || 'Motif inconnu';\n  } else {\n    // autorisées — on affiche l’info Solcast, et on note override si actif ET que Solcast aurait bloqué\n    const wouldSkipSolcast = (kwh >= seuil);\n    return `Solcast demain (P90 fenêtre) : ${kwh.toFixed(1)} ${cmp} ${seuil.toFixed(1)} kWh`\n           + ((override && wouldSkipSolcast) ? ' — override actif' : '');\n  }\n]]]\n",
              "styles": {
                "card": [
                  {
                    "border-radius": "16px"
                  },
                  {
                    "padding": "10px"
                  },
                  {
                    "box-shadow": "0 1px 6px rgba(0,0,0,.12)"
                  },
                  {
                    "background": "[[[\n  const isOn = id => states[id]?.state === 'on';\n  const asBool = v => (v===true) ? true : (v===false) ? false : null;\n\n  const jourOK   = (asBool(variables.force_jour_ok)   ?? isOn('input_boolean.cumulus_jour_autorise'));\n  const verrou   = (asBool(variables.force_verrou)    ?? isOn('input_boolean.cumulus_verrou_jour'));\n  const interdit = (asBool(variables.force_interdit)  ?? isOn('input_boolean.cumulus_interdit'));\n  const vac      = (asBool(variables.force_vacances)  ?? isOn('input_boolean.cumulus_vacances'));\n  const override = (asBool(variables.force_override)  ?? isOn('input_boolean.cumulus_solcast_override'));\n\n  let skip = entity?.state === 'on';\n  if (variables.force_skip === 'on')  skip = true;\n  if (variables.force_skip === 'off') skip = false;\n\n  const blocked = (!jourOK) || verrou || interdit || vac || (skip && !override);\n  return blocked\n    ? 'linear-gradient(135deg, rgba(239,68,68,.14), rgba(6,182,212,.06))'\n    : 'linear-gradient(135deg, rgba(34,197,94,.14), rgba(6,182,212,.06))';\n]]]\n"
                  }
                ],
                "grid": [
                  {
                    "grid-template-areas": "\"i n\" \"i l\""
                  },
                  {
                    "grid-template-columns": "36px 1fr"
                  },
                  {
                    "row-gap": "2px"
                  }
                ],
                "icon": [
                  {
                    "width": "24px"
                  },
                  {
                    "color": "[[[\n  const isOn = id => states[id]?.state === 'on';\n  const asBool = v => (v===true) ? true : (v===false) ? false : null;\n\n  const jourOK   = (asBool(variables.force_jour_ok)   ?? isOn('input_boolean.cumulus_jour_autorise'));\n  const verrou   = (asBool(variables.force_verrou)    ?? isOn('input_boolean.cumulus_verrou_jour'));\n  const interdit = (asBool(variables.force_interdit)  ?? isOn('input_boolean.cumulus_interdit'));\n  const vac      = (asBool(variables.force_vacances)  ?? isOn('input_boolean.cumulus_vacances'));\n  const override = (asBool(variables.force_override)  ?? isOn('input_boolean.cumulus_solcast_override'));\n\n  let skip = entity?.state === 'on';\n  if (variables.force_skip === 'on')  skip = true;\n  if (variables.force_skip === 'off') skip = false;\n\n  const blocked = (!jourOK) || verrou || interdit || vac || (skip && !override);\n  return blocked ? '#ef4444' : '#22c55e';\n]]]\n"
                  }
                ],
                "name": [
                  {
                    "font-weight": 800
                  },
                  {
                    "font-size": "1.05rem"
                  },
                  {
                    "line-height": 1.15
                  }
                ],
                "label": [
                  {
                    "white-space": "normal"
                  },
                  {
                    "line-height": 1.2
                  },
                  {
                    "opacity": 0.95
                  },
                  {
                    "font-size": ".86rem"
                  }
                ]
              },
              "triggers_update": [
                "binary_sensor.cumulus_skip_hc_tonight",
                "input_boolean.cumulus_jour_autorise",
                "input_boolean.cumulus_verrou_jour",
                "input_boolean.cumulus_interdit",
                "input_boolean.cumulus_vacances",
                "input_boolean.cumulus_solcast_override",
                "sensor.solcast_tomorrow_kwh_p90_window",
                "input_number.cumulus_solcast_seuil_kwh"
              ]
            },
            {
              "square": false,
              "type": "grid",
              "cards": [
                {
                  "type": "custom:button-card",
                  "entity": "input_number.cumulus_soc_start_pct",
                  "name": "Minimum (PV)",
                  "icon": "mdi:battery-50",
                  "show_state": true,
                  "state_display": "[[[\n  const v = Number(entity?.state);\n  return isFinite(v) ? `${v.toFixed(0)} %` : (entity?.state || '');\n]]]\n",
                  "styles": {
                    "card": [
                      {
                        "border-radius": "16px"
                      },
                      {
                        "padding": "10px"
                      },
                      {
                        "background": "linear-gradient(135deg, rgba(34,197,94,.10), rgba(6,182,212,.05))"
                      },
                      {
                        "box-shadow": "0 1px 6px rgba(0,0,0,.12)"
                      }
                    ],
                    "grid": [
                      {
                        "grid-template-areas": "\"i n\" \"s s\""
                      },
                      {
                        "grid-template-columns": "36px 1fr"
                      }
                    ],
                    "icon": [
                      {
                        "color": "#22c55e"
                      },
                      {
                        "width": "24px"
                      }
                    ],
                    "name": [
                      {
                        "font-weight": 600
                      }
                    ]
                  }
                },
                {
                  "type": "custom:button-card",
                  "entity": "input_number.cumulus_soc_stop_pct",
                  "name": "Sécurité (coupure)",
                  "icon": "mdi:battery-alert-variant-outline",
                  "show_state": true,
                  "state_display": "[[[\n  const v = Number(entity?.state);\n  return isFinite(v) ? `${v.toFixed(0)} %` : (entity?.state || '');\n]]]\n",
                  "styles": {
                    "card": [
                      {
                        "border-radius": "16px"
                      },
                      {
                        "padding": "10px"
                      },
                      {
                        "background": "linear-gradient(135deg, rgba(239,68,68,.10), rgba(6,182,212,.05))"
                      },
                      {
                        "box-shadow": "0 1px 6px rgba(0,0,0,.12)"
                      }
                    ],
                    "grid": [
                      {
                        "grid-template-areas": "\"i n\" \"s s\""
                      },
                      {
                        "grid-template-columns": "36px 1fr"
                      }
                    ],
                    "icon": [
                      {
                        "color": "#ef4444"
                      },
                      {
                        "width": "24px"
                      }
                    ],
                    "name": [
                      {
                        "font-weight": 600
                      }
                    ]
                  }
                }
              ],
              "title": "Charge de la Batterie",
              "columns": 2
            },
            {
              "type": "custom:button-card",
              "entity": "sensor.cumulus_soc_solarbank_pct",
              "name": "[[[\n  const soc = Number(entity?.state) || 0;\n  const start = Number(states['input_number.cumulus_soc_start_pct']?.state) || 0;\n  const stop  = Number(states['input_number.cumulus_soc_stop_pct']?.state)  || 0;\n  return `Charge batterie : ${Math.round(soc)} % · Début ≥ ${Math.round(start)} % · Arrêt < ${Math.round(stop)} %`;\n]]]\n",
              "icon": "[[[\n  const soc = Number(entity?.state) || 0;\n  return soc >= 60 ? 'mdi:battery-high' : soc >= 30 ? 'mdi:battery-medium' : 'mdi:battery-low';\n]]]\n",
              "show_state": false,
              "styles": {
                "card": [
                  {
                    "border-radius": "16px"
                  },
                  {
                    "padding": "10px"
                  },
                  {
                    "box-shadow": "0 1px 6px rgba(0,0,0,.12)"
                  },
                  {
                    "background": "[[[\n  const soc = Number(entity?.state) || 0;\n  return soc >= 60\n    ? 'linear-gradient(135deg, rgba(34,197,94,.14), rgba(6,182,212,.06))'\n    : soc >= 30\n      ? 'linear-gradient(135deg, rgba(245,158,11,.14), rgba(6,182,212,.06))'\n      : 'linear-gradient(135deg, rgba(239,68,68,.14), rgba(6,182,212,.06))';\n]]]\n"
                  }
                ],
                "grid": [
                  {
                    "grid-template-areas": "\"i n\""
                  },
                  {
                    "grid-template-columns": "36px 1fr"
                  }
                ],
                "icon": [
                  {
                    "width": "24px"
                  },
                  {
                    "color": "[[[\n  const soc = Number(entity?.state) || 0;\n  return soc >= 60 ? '#22c55e' : soc >= 30 ? '#f59e0b' : '#ef4444';\n]]]\n"
                  }
                ],
                "name": [
                  {
                    "font-weight": 700
                  },
                  {
                    "font-size": ".98rem"
                  }
                ]
              }
            },
            {
              "square": false,
              "type": "grid",
              "cards": [
                {
                  "type": "custom:button-card",
                  "entity": "binary_sensor.cumulus_en_hc",
                  "name": "[[[\n  return (entity?.state === 'on') ? 'Heures Creuses' : 'Heures Pleines';\n]]]\n",
                  "icon": "[[[\n  return (entity?.state === 'on') ? 'mdi:clock-time-three' : 'mdi:clock-outline';\n]]]\n",
                  "show_state": false,
                  "styles": {
                    "card": [
                      {
                        "border-radius": "16px"
                      },
                      {
                        "padding": "10px"
                      },
                      {
                        "box-shadow": "0 1px 6px rgba(0,0,0,.12)"
                      },
                      {
                        "background": "[[[\n  const on = entity?.state === 'on';\n  return on\n    ? 'linear-gradient(135deg, rgba(34,197,94,.14), rgba(6,182,212,.06))'\n    : 'linear-gradient(135deg, rgba(245,158,11,.14), rgba(6,182,212,.06))';\n]]]\n"
                      }
                    ],
                    "grid": [
                      {
                        "grid-template-areas": "\"i n\""
                      },
                      {
                        "grid-template-columns": "36px 1fr"
                      }
                    ],
                    "icon": [
                      {
                        "width": "24px"
                      },
                      {
                        "color": "[[[\n  return (entity?.state === 'on') ? '#22c55e' : '#f59e0b';\n]]]\n"
                      }
                    ],
                    "name": [
                      {
                        "font-weight": 700
                      },
                      {
                        "font-size": ".98rem"
                      }
                    ]
                  }
                },
                {
                  "type": "custom:button-card",
                  "entity": "binary_sensor.cumulus_fenetre_pv",
                  "name": "[[[\n  return (entity?.state === 'on') ? 'En fenêtre PV' : 'Hors fenêtre PV';\n]]]\n",
                  "icon": "[[[\n  return (entity?.state === 'on') ? 'mdi:weather-sunny' : 'mdi:weather-sunny-off';\n]]]\n",
                  "show_state": false,
                  "styles": {
                    "card": [
                      {
                        "border-radius": "16px"
                      },
                      {
                        "padding": "10px"
                      },
                      {
                        "box-shadow": "0 1px 6px rgba(0,0,0,.12)"
                      },
                      {
                        "background": "[[[\n  const on = entity?.state === 'on';\n  return on\n    ? 'linear-gradient(135deg, rgba(245,158,11,.12), rgba(6,182,212,.06))'\n    : 'linear-gradient(135deg, rgba(156,163,175,.10), rgba(6,182,212,.04))';\n]]]\n"
                      }
                    ],
                    "grid": [
                      {
                        "grid-template-areas": "\"i n\""
                      },
                      {
                        "grid-template-columns": "36px 1fr"
                      }
                    ],
                    "icon": [
                      {
                        "width": "24px"
                      },
                      {
                        "color": "[[[\n  return (entity?.state === 'on') ? '#f59e0b' : '#9ca3af';\n]]]\n"
                      }
                    ],
                    "name": [
                      {
                        "font-weight": 700
                      },
                      {
                        "font-size": ".98rem"
                      }
                    ]
                  }
                }
              ],
              "columns": 2
            },
            {
              "type": "custom:button-card",
              "entity": "input_boolean.cumulus_vacances",
              "name": "[[[\n  const on = entity?.state === 'on';\n  return on ? 'Mode vacances : activé' : 'Mode vacances : désactivé';\n]]]\n",
              "icon": "mdi:beach",
              "show_state": false,
              "styles": {
                "card": [
                  {
                    "border-radius": "16px"
                  },
                  {
                    "padding": "10px"
                  },
                  {
                    "box-shadow": "0 1px 6px rgba(0,0,0,.12)"
                  },
                  {
                    "background": "[[[\n  return (entity?.state === 'on')\n    ? 'linear-gradient(135deg, rgba(14,165,233,.14), rgba(6,182,212,.06))'\n    : 'linear-gradient(135deg, rgba(156,163,175,.10), rgba(6,182,212,.04))';\n]]]\n"
                  }
                ],
                "grid": [
                  {
                    "grid-template-areas": "\"i n\""
                  },
                  {
                    "grid-template-columns": "36px 1fr"
                  }
                ],
                "icon": [
                  {
                    "width": "24px"
                  },
                  {
                    "color": "[[[\n  // Bleu si ON, gris si OFF\n  return (entity?.state === 'on') ? '#0ea5e9' : '#9ca3af';\n]]]\n"
                  }
                ],
                "name": [
                  {
                    "font-weight": 700
                  },
                  {
                    "font-size": ".98rem"
                  }
                ]
              },
              "tap_action": {
                "action": "toggle",
                "confirmation": {
                  "text": "Confirmer"
                }
              },
              "hold_action": {
                "action": "more-info"
              }
            },
            {
              "type": "custom:button-card",
              "entity": "input_number.cumulus_solcast_seuil_kwh",
              "name": "Seuil prévision solaire (P90)",
              "icon": "mdi:tune-variant",
              "show_state": true,
              "state_display": "[[[\n  const v = Number(entity?.state);\n  return isFinite(v) ? `${v.toFixed(1)} kWh` : (entity?.state || '');\n]]]\n",
              "styles": {
                "card": [
                  {
                    "border-radius": "16px"
                  },
                  {
                    "padding": "10px"
                  },
                  {
                    "background": "linear-gradient(135deg, rgba(6,182,212,.08), rgba(107,114,128,.04))"
                  },
                  {
                    "box-shadow": "0 1px 6px rgba(0,0,0,.12)"
                  }
                ],
                "grid": [
                  {
                    "grid-template-areas": "\"i n\" \"s s\""
                  },
                  {
                    "grid-template-columns": "36px 1fr"
                  }
                ],
                "icon": [
                  {
                    "width": "24px"
                  },
                  {
                    "color": "#06b6d4"
                  }
                ],
                "name": [
                  {
                    "font-weight": 600
                  }
                ]
              }
            },
            {
              "type": "custom:button-card",
              "entity": "input_number.cumulus_talon_w",
              "name": "Consommation de base",
              "icon": "mdi:waves",
              "show_state": true,
              "state_display": "[[[\n  const v = Number(entity?.state);\n  return isFinite(v) ? `${v.toFixed(0)} W` : (entity?.state || '');\n]]]\n",
              "styles": {
                "card": [
                  {
                    "border-radius": "16px"
                  },
                  {
                    "padding": "10px"
                  },
                  {
                    "background": "linear-gradient(135deg, rgba(6,182,212,.08), rgba(107,114,128,.04))"
                  },
                  {
                    "box-shadow": "0 1px 6px rgba(0,0,0,.12)"
                  }
                ],
                "grid": [
                  {
                    "grid-template-areas": "\"i n\" \"s s\""
                  },
                  {
                    "grid-template-columns": "36px 1fr"
                  }
                ],
                "icon": [
                  {
                    "color": "#94a3b8"
                  },
                  {
                    "width": "24px"
                  }
                ],
                "name": [
                  {
                    "font-weight": 600
                  }
                ]
              }
            },
            {
              "type": "custom:button-card",
              "entity": "input_number.cumulus_on_delay_s",
              "name": "Délai d'enclenchement (ON)",
              "icon": "mdi:timer-play",
              "show_state": true,
              "state_display": "[[[\n  const v = Number(entity?.state);\n  return isFinite(v) ? `${v.toFixed(0)} s` : (entity?.state || '');\n]]]\n",
              "styles": {
                "card": [
                  {
                    "border-radius": "16px"
                  },
                  {
                    "padding": "10px"
                  },
                  {
                    "background": "linear-gradient(135deg, rgba(245,158,11,.10), rgba(6,182,212,.05))"
                  },
                  {
                    "box-shadow": "0 1px 6px rgba(0,0,0,.12)"
                  }
                ],
                "grid": [
                  {
                    "grid-template-areas": "\"i n\" \"s s\""
                  },
                  {
                    "grid-template-columns": "36px 1fr"
                  }
                ],
                "icon": [
                  {
                    "color": "#f59e0b"
                  },
                  {
                    "width": "24px"
                  }
                ],
                "name": [
                  {
                    "font-weight": 600
                  }
                ]
              }
            },
            {
              "type": "custom:button-card",
              "entity": "input_number.cumulus_deadband_s",
              "name": "Temporisation (après chauffe)",
              "icon": "mdi:timer-sand",
              "show_state": true,
              "state_display": "[[[\n  const v = Number(entity?.state);\n  return isFinite(v) ? `${v.toFixed(0)} s` : (entity?.state || '');\n]]]\n",
              "styles": {
                "card": [
                  {
                    "border-radius": "16px"
                  },
                  {
                    "padding": "10px"
                  },
                  {
                    "background": "linear-gradient(135deg, rgba(168,85,247,.10), rgba(6,182,212,.05))"
                  },
                  {
                    "box-shadow": "0 1px 6px rgba(0,0,0,.12)"
                  }
                ],
                "grid": [
                  {
                    "grid-template-areas": "\"i n\" \"s s\""
                  },
                  {
                    "grid-template-columns": "36px 1fr"
                  }
                ],
                "icon": [
                  {
                    "color": "#a855f7"
                  },
                  {
                    "width": "24px"
                  }
                ],
                "name": [
                  {
                    "font-weight": 600
                  }
                ]
              }
            },
            {
              "square": false,
              "type": "grid",
              "cards": [
                {
                  "type": "custom:button-card",
                  "entity": "input_datetime.cumulus_heures_creuses_debut",
                  "name": "Début",
                  "icon": "mdi:clock-start",
                  "show_state": true,
                  "state_display": "[[[ const s=(entity&&entity.state)?entity.state:''; return s ? s.slice(0,5) : '--:--'; ]]]\n",
                  "styles": {
                    "card": [
                      {
                        "border-radius": "16px"
                      },
                      {
                        "padding": "10px"
                      },
                      {
                        "background": "linear-gradient(135deg, rgba(14,165,233,.10), rgba(6,182,212,.04))"
                      },
                      {
                        "box-shadow": "0 1px 6px rgba(0,0,0,.12)"
                      }
                    ],
                    "grid": [
                      {
                        "grid-template-areas": "\"i n\" \"s s\""
                      },
                      {
                        "grid-template-columns": "36px 1fr"
                      },
                      {
                        "row-gap": "4px"
                      }
                    ],
                    "icon": [
                      {
                        "color": "#0ea5e9"
                      },
                      {
                        "width": "24px"
                      }
                    ],
                    "name": [
                      {
                        "font-weight": 600
                      }
                    ]
                  }
                },
                {
                  "type": "custom:button-card",
                  "entity": "input_datetime.cumulus_heures_creuses_fin",
                  "name": "Fin",
                  "icon": "mdi:clock-end",
                  "show_state": true,
                  "state_display": "[[[ const s=(entity&&entity.state)?entity.state:''; return s ? s.slice(0,5) : '--:--'; ]]]\n",
                  "styles": {
                    "card": [
                      {
                        "border-radius": "16px"
                      },
                      {
                        "padding": "10px"
                      },
                      {
                        "background": "linear-gradient(135deg, rgba(14,165,233,.10), rgba(6,182,212,.04))"
                      },
                      {
                        "box-shadow": "0 1px 6px rgba(0,0,0,.12)"
                      }
                    ],
                    "grid": [
                      {
                        "grid-template-areas": "\"i n\" \"s s\""
                      },
                      {
                        "grid-template-columns": "36px 1fr"
                      },
                      {
                        "row-gap": "4px"
                      }
                    ],
                    "icon": [
                      {
                        "color": "#0ea5e9"
                      },
                      {
                        "width": "24px"
                      }
                    ],
                    "name": [
                      {
                        "font-weight": 600
                      }
                    ]
                  }
                }
              ],
              "columns": 2,
              "title": "Fenêtre Chauffe Nocturne"
            },
            {
              "square": false,
              "type": "grid",
              "cards": [
                {
                  "type": "custom:button-card",
                  "entity": "input_datetime.cumulus_plage_pv_debut",
                  "name": "Début",
                  "icon": "mdi:weather-sunset-up",
                  "show_state": true,
                  "state_display": "[[[ const s=(entity&&entity.state)?entity.state:''; return s ? s.slice(0,5) : '--:--'; ]]]\n",
                  "styles": {
                    "card": [
                      {
                        "border-radius": "16px"
                      },
                      {
                        "padding": "10px"
                      },
                      {
                        "background": "linear-gradient(135deg, rgba(6,182,212,.10), rgba(6,182,212,.04))"
                      },
                      {
                        "box-shadow": "0 1px 6px rgba(0,0,0,.12)"
                      }
                    ],
                    "grid": [
                      {
                        "grid-template-areas": "\"i n\" \"s s\""
                      },
                      {
                        "grid-template-columns": "36px 1fr"
                      },
                      {
                        "row-gap": "4px"
                      }
                    ],
                    "icon": [
                      {
                        "color": "#06b6d4"
                      },
                      {
                        "width": "24px"
                      }
                    ],
                    "name": [
                      {
                        "font-weight": 600
                      }
                    ]
                  }
                },
                {
                  "type": "custom:button-card",
                  "entity": "input_datetime.cumulus_plage_pv_fin",
                  "name": "Fin",
                  "icon": "mdi:weather-sunset-down",
                  "show_state": true,
                  "state_display": "[[[ const s=(entity&&entity.state)?entity.state:''; return s ? s.slice(0,5) : '--:--'; ]]]\n",
                  "styles": {
                    "card": [
                      {
                        "border-radius": "16px"
                      },
                      {
                        "padding": "10px"
                      },
                      {
                        "background": "linear-gradient(135deg, rgba(6,182,212,.10), rgba(6,182,212,.04))"
                      },
                      {
                        "box-shadow": "0 1px 6px rgba(0,0,0,.12)"
                      }
                    ],
                    "grid": [
                      {
                        "grid-template-areas": "\"i n\" \"s s\""
                      },
                      {
                        "grid-template-columns": "36px 1fr"
                      },
                      {
                        "row-gap": "4px"
                      }
                    ],
                    "icon": [
                      {
                        "color": "#06b6d4"
                      },
                      {
                        "width": "24px"
                      }
                    ],
                    "name": [
                      {
                        "font-weight": 600
                      }
                    ]
                  }
                }
              ],
              "columns": 2,
              "title": "Fenêtre Chauffe Photovoltaïque"
            },
            {
              "square": false,
              "type": "grid",
              "title": "Actions Manuelles",
              "cards": [
                {
                  "type": "custom:button-card",
                  "entity": "input_boolean.cumulus_solcast_override",
                  "name": "[[[\n  const on = entity?.state === 'on';\n  return on ? 'Forçage heures creuses ce soir : activé'\n            : 'Forçage heures creuses ce soir : désactivé';\n]]]\n",
                  "icon": "mdi:shield-off-outline",
                  "show_state": false,
                  "styles": {
                    "card": [
                      {
                        "border-radius": "16px"
                      },
                      {
                        "padding": "10px"
                      },
                      {
                        "box-shadow": "0 1px 6px rgba(0,0,0,.12)"
                      },
                      {
                        "background": "[[[\n  return (entity?.state === 'on')\n    ? 'linear-gradient(135deg, rgba(34,197,94,.14), rgba(6,182,212,.06))'\n    : 'linear-gradient(135deg, rgba(156,163,175,.10), rgba(6,182,212,.04))';\n]]]\n"
                      }
                    ],
                    "grid": [
                      {
                        "grid-template-areas": "\"i n\""
                      },
                      {
                        "grid-template-columns": "36px 1fr"
                      }
                    ],
                    "icon": [
                      {
                        "width": "24px"
                      },
                      {
                        "color": "[[[\n  return (entity?.state === 'on') ? '#22c55e' : '#9ca3af';\n]]]\n"
                      }
                    ],
                    "name": [
                      {
                        "font-weight": 700
                      },
                      {
                        "font-size": ".98rem"
                      }
                    ]
                  },
                  "tap_action": {
                    "action": "toggle",
                    "confirmation": {
                      "text": "Confirmer"
                    }
                  },
                  "hold_action": {
                    "action": "more-info"
                  }
                },
                {
                  "type": "custom:button-card",
                  "entity": "input_boolean.cumulus_boost",
                  "name": "[[[\n  const on = entity?.state === 'on';\n  return on ? 'Boost anti-légionelle : actif'\n            : 'Boost anti-légionelle : inactif';\n]]]\n",
                  "icon": "mdi:thermometer-high",
                  "show_state": false,
                  "styles": {
                    "card": [
                      {
                        "border-radius": "16px"
                      },
                      {
                        "padding": "10px"
                      },
                      {
                        "box-shadow": "0 1px 6px rgba(0,0,0,.12)"
                      },
                      {
                        "background": "[[[\n  return (entity?.state === 'on')\n    ? 'linear-gradient(135deg, rgba(245,158,11,.14), rgba(6,182,212,.06))'\n    : 'linear-gradient(135deg, rgba(156,163,175,.10), rgba(6,182,212,.04))';\n]]]\n"
                      }
                    ],
                    "grid": [
                      {
                        "grid-template-areas": "\"i n\""
                      },
                      {
                        "grid-template-columns": "36px 1fr"
                      }
                    ],
                    "icon": [
                      {
                        "width": "24px"
                      },
                      {
                        "color": "[[[\n  return (entity?.state === 'on') ? '#f59e0b' : '#9ca3af';\n]]]\n"
                      }
                    ],
                    "name": [
                      {
                        "font-weight": 700
                      },
                      {
                        "font-size": ".98rem"
                      }
                    ]
                  },
                  "tap_action": {
                    "action": "toggle",
                    "confirmation": {
                      "text": "Confirmer"
                    }
                  },
                  "hold_action": {
                    "action": "more-info"
                  }
                }
              ],
              "columns": 1
            },
            {
              "type": "custom:button-card",
              "name": "Demarrage PV — Diagnostic",
              "icon": "mdi:bug",
              "show_state": false,
              "show_label": true,
              "triggers_update": [
                "sensor.cumulus_pv_power_w",
                "input_number.cumulus_seuil_pv_on_w",
                "binary_sensor.cumulus_fenetre_pv",
                "input_boolean.cumulus_verrou_jour",
                "input_boolean.cumulus_jour_autorise",
                "input_boolean.cumulus_vacances",
                "sensor.cumulus_soc_solarbank_pct",
                "input_number.cumulus_soc_min_pv_pct",
                "binary_sensor.cumulus_deadband_actif"
              ],
              "label": "[[[\n  const s     = states;\n  const pv    = Number(s['sensor.cumulus_pv_power_w']?.state) || 0;\n  const seuil = Number(s['input_number.cumulus_seuil_pv_on_w']?.state) || 100;\n  const fen   = s['binary_sensor.cumulus_fenetre_pv']?.state === 'on';\n  const verrou= s['input_boolean.cumulus_verrou_jour']?.state === 'on';\n  const jourH = s['input_boolean.cumulus_jour_autorise'];\n  const jour  = jourH ? (jourH.state === 'on') : true; // si helper absent, on ne bloque pas\n  const vac   = s['input_boolean.cumulus_vacances']?.state === 'on';\n  const soc   = Number(s['sensor.cumulus_soc_solarbank_pct']?.state) || 0;\n  const socMin= Number(s['input_number.cumulus_soc_min_pv_pct']?.state) || 25;\n  const dead  = s['binary_sensor.cumulus_deadband_actif']?.state === 'on';\n\n  const reasons = [];\n  if (dead)  reasons.push('temporisation active');\n  if (!fen)  reasons.push('hors fenetre PV');\n  if (verrou)reasons.push('verrou jour actif');\n  if (!jour) reasons.push('jour non autorise (1j/2)');\n  if (vac)   reasons.push('mode vacances actif');\n  if (pv < seuil) reasons.push('PV ' + pv + ' < seuil ' + seuil);\n  if (soc < (socMin - 0.5)) reasons.push('SOC ' + soc + '% < min ' + socMin + '% -0.5');\n\n  const header = (reasons.length === 0)\n    ? 'OK - conditions reunies'\n    : 'BLOQUE - ' + reasons[0];\n\n  const lines = [\n    header,\n    'PV ' + pv + ' / seuil ' + seuil + ' - fenetre: ' + (fen ? 'oui' : 'non'),\n    'verrou: ' + (verrou ? 'ON' : 'off') + ' - jour OK: ' + (jour ? 'oui' : 'non') + (jourH ? '' : ' (helper absent)'),\n    'vacances: ' + (vac ? 'ON' : 'off'),\n    'SOC ' + soc + '% / min ' + socMin + '%'\n  ];\n  return lines.join('\\n');\n]]]\n",
              "tap_action": {
                "action": "none"
              },
              "styles": {
                "card": [
                  {
                    "border-radius": "16px"
                  },
                  {
                    "padding": "10px"
                  },
                  {
                    "box-shadow": "0 1px 6px rgba(0,0,0,.12)"
                  }
                ],
                "name": [
                  {
                    "font-weight": 600
                  }
                ],
                "label": [
                  {
                    "white-space": "pre-line"
                  }
                ]
              }
            },
            {
              "type": "custom:button-card",
              "name": "Temporisation (état)",
              "icon": "mdi:timer-sand",
              "show_label": true,
              "label": "[[[\n  const t = states['timer.cumulus_deadband_ui'];\n  const rem = t?.attributes?.remaining || '—';\n  return `état: ${t?.state} • restant: ${rem}`;\n]]]\n",
              "triggers_update": [
                "timer.cumulus_deadband_ui"
              ],
              "update_interval": 1,
              "tap_action": "none"
            }
          ]
        },
        {
          "title": "Plan",
          "path": "plan",
          "icon": "mdi:floor-plan",
          "cards": [
            {
              "type": "picture-elements",
              "image": "/local/Plan/IMG_RDC3.jpg",
              "elements": [
                {
                  "type": "state-label",
                  "entity": "sensor.thermo_salon_temperature",
                  "style": {
                    "top": "33%",
                    "left": "48%",
                    "color": "rgb(207,238,0)",
                    "font-weight": "bold",
                    "font-size": "24px"
                  }
                },
                {
                  "type": "state-label",
                  "entity": "sensor.thermo_garage_temperature",
                  "style": {
                    "left": "80%",
                    "top": "73%",
                    "color": "rgb(207,238,0)",
                    "font-weight": "bold",
                    "font-size": "24px"
                  }
                },
                {
                  "type": "state-label",
                  "entity": "sensor.daikin_split_salon_climatecontrol_outdoor_temperature",
                  "style": {
                    "top": "88%",
                    "left": "30%",
                    "color": "rgb(0,238,207)",
                    "font-weight": "bold",
                    "font-size": "24px"
                  },
                  "tap_action": {
                    "action": "perform-action",
                    "perform_action": "climate.set_hvac_mode",
                    "target": {
                      "entity_id": "climate.daikin_split_salon_room_temperature"
                    },
                    "data": {}
                  }
                },
                {
                  "type": "state-icon",
                  "icon": "mdi:air-filter",
                  "title": "DAIKIN",
                  "style": {
                    "left": "40%",
                    "top": "12%"
                  },
                  "entity": "sensor.daikin_split_salon_climatecontrol_outdoor_temperature"
                },
                {
                  "type": "state-icon",
                  "style": {
                    "left": "78%",
                    "top": "65%"
                  },
                  "icon": "mdi:lightbulb",
                  "entity": "switch.0x08ddebfffed9ed45",
                  "tap_action": {
                    "action": "toggle"
                  }
                }
              ]
            }
          ]
        },
        {
          "title": "Planning",
          "path": "planning",
          "icon": "mdi:notebook-multiple",
          "type": "panel",
          "cards": [
            {
              "type": "custom:week-planner-card",
              "title": "",
              "class": "col-12",
              "hideWeekend": false,
              "calendars": [
                {
                  "entity": "calendar.planning_cours_isa",
                  "color": "#e6c229"
                },
                {
                  "entity": "calendar.jours_feries_en_france",
                  "color": "#1a8fe3"
                },
                {
                  "entity": "calendar.vacances_scolaires",
                  "color": "#d11149"
                },
                {
                  "entity": "calendar.wakawarider_gmail_com",
                  "color": "rgb(0,238,234)"
                }
              ],
              "weather": {
                "entity": "weather.sanguinet",
                "showTemperature": true,
                "showLowTemperature": true
              },
              "startingDay": "today",
              "startingDayOffset": 0,
              "days": 15,
              "noCardBackground": true,
              "eventBackground": "rgba(0, 0, 0, .75)",
              "compact": false,
              "updateInterval": 300,
              "texts": {
                "today": "Aujourdhui",
                "tomorrow": "Demain",
                "noEvents": "",
                "fullDay": ""
              },
              "card_mod": {
                "style": "ha-card {\n  margin-top: 1px;\n  }\n.none {\n  background-color: green !important;\n  opacity: .3\n  }\n.event.past {\n  opacity: .7;\n}\n"
              }
            }
          ],
          "theme": "ios-dark-mode-blue-red"
        }
      ],
      "title": "Laurent"
    }
  }
}