###############################################################################
# CUMULUS - CORRECTIFS AUTOMATISATION DATE
# v2025-10-25-fix-date-auto
#
# PROBL√àME R√âSOLU :
# Le sensor "besoin urgent" s'affichait en permanence car input_datetime
# n'√©tait jamais initialis√© ou contenait une mauvaise ann√©e.
#
# SOLUTIONS AJOUT√âES :
# 1. Auto-initialisation au d√©marrage de HA si jamais configur√©
# 2. Mise √† jour automatique apr√®s chaque fin de chauffe compl√®te
# 3. Protection contre les dates invalides (ann√©e < 2025)
# 4. Automation de maintenance hebdomadaire
#
# √Ä INT√âGRER DANS VOTRE CONFIGURATION :
# - Option A : Copier dans packages/cumulus_automations.yaml
# - Option B : Copier dans automations.yaml avec prefix cumulus_
# - Option C : Fusionner avec votre fichier cumulus.yaml existant
###############################################################################

automation:
  # ========================================================================
  # 1. INITIALISATION AUTOMATIQUE AU D√âMARRAGE
  # ========================================================================
  - id: cumulus_init_derniere_chauffe_au_demarrage
    alias: "Cumulus ‚Äî Init derni√®re chauffe au d√©marrage"
    description: >-
      Initialise automatiquement input_datetime.cumulus_derniere_chauffe_complete
      au d√©marrage de Home Assistant s'il n'a jamais √©t√© configur√©.
      √âvite l'affichage permanent de "besoin urgent" apr√®s installation.
    mode: single
    trigger:
      - platform: homeassistant
        event: start
    condition:
      # Seulement si le timestamp est invalide (none, 0, ou ann√©e < 2025)
      - condition: template
        value_template: >-
          {% set last_ts = state_attr('input_datetime.cumulus_derniere_chauffe_complete', 'timestamp') %}
          {% if last_ts is none or last_ts == 0 %}
            true
          {% else %}
            {% set last_year = (last_ts | timestamp_custom('%Y')) | int %}
            {{ last_year < 2025 }}
          {% endif %}
    action:
      - service: input_datetime.set_datetime
        target:
          entity_id: input_datetime.cumulus_derniere_chauffe_complete
        data:
          datetime: "{{ now().strftime('%Y-%m-%d %H:%M:%S') }}"
      - service: system_log.write
        data:
          message: "Cumulus : Initialisation automatique de derniere_chauffe_complete √† {{ now().strftime('%Y-%m-%d %H:%M:%S') }}"
          level: info

  # ========================================================================
  # 2. MISE √Ä JOUR AUTOMATIQUE APR√àS FIN DE CHAUFFE COMPL√àTE
  # ========================================================================
  - id: cumulus_maj_derniere_chauffe_apres_fin
    alias: "Cumulus ‚Äî MAJ derni√®re chauffe apr√®s fin"
    description: >-
      Met √† jour automatiquement la date de derni√®re chauffe compl√®te
      quand le syst√®me d√©tecte qu'une chauffe s'est termin√©e avec
      temp√©rature max atteinte (thermostat coup√©).
    mode: restart
    trigger:
      # Trigger quand chauffe_reelle passe √† OFF apr√®s avoir √©t√© ON
      - platform: state
        entity_id: binary_sensor.cumulus_chauffe_reelle
        from: "on"
        to: "off"
        for:
          seconds: 120
    condition:
      # V√©rifier que la temp√©rature a √©t√© atteinte (verrou jour activ√©)
      - condition: state
        entity_id: input_boolean.cumulus_verrou_jour
        state: "on"
    action:
      # Enregistrer l'heure de fin de chauffe
      - service: input_datetime.set_datetime
        target:
          entity_id: input_datetime.cumulus_derniere_chauffe_complete
        data:
          datetime: "{{ now().strftime('%Y-%m-%d %H:%M:%S') }}"
      - service: system_log.write
        data:
          message: "Cumulus : Chauffe compl√®te d√©tect√©e, mise √† jour de derniere_chauffe_complete"
          level: info

  # ========================================================================
  # 3. PROTECTION CONTRE DATES INVALIDES
  # ========================================================================
  - id: cumulus_protection_date_invalide
    alias: "Cumulus ‚Äî Protection date invalide"
    description: >-
      D√©tecte et corrige automatiquement si la date de derni√®re chauffe
      est dans le pass√© lointain (> 30 jours) ou dans le futur.
      √âvite les calculs aberrants du sensor heures_depuis_derniere_chauffe.
    mode: single
    trigger:
      # V√©rification toutes les heures
      - platform: time_pattern
        hours: "/1"
    condition:
      - condition: template
        value_template: >-
          {% set last_ts = state_attr('input_datetime.cumulus_derniere_chauffe_complete', 'timestamp') %}
          {% if last_ts is none or last_ts == 0 %}
            true
          {% else %}
            {% set now_ts = now().timestamp() %}
            {% set diff_hours = ((now_ts - last_ts) / 3600) %}
            {# Date invalide si > 30 jours dans le pass√© OU dans le futur #}
            {{ diff_hours > 720 or diff_hours < 0 }}
          {% endif %}
    action:
      - service: input_datetime.set_datetime
        target:
          entity_id: input_datetime.cumulus_derniere_chauffe_complete
        data:
          datetime: "{{ (now() - timedelta(hours=24)).strftime('%Y-%m-%d %H:%M:%S') }}"
      - service: persistent_notification.create
        data:
          title: "‚ö†Ô∏è Cumulus - Date corrig√©e"
          message: >-
            La date de derni√®re chauffe √©tait invalide (> 30 jours).
            Elle a √©t√© r√©initialis√©e √† hier ({{ (now() - timedelta(hours=24)).strftime('%d/%m/%Y %H:%M') }}).

            Ancien timestamp : {{ state_attr('input_datetime.cumulus_derniere_chauffe_complete', 'timestamp') }}
          notification_id: cumulus_date_invalide

  # ========================================================================
  # 4. MAINTENANCE HEBDOMADAIRE - V√âRIFICATION
  # ========================================================================
  - id: cumulus_maintenance_hebdomadaire_date
    alias: "Cumulus ‚Äî Maintenance hebdo date"
    description: >-
      V√©rification hebdomadaire que la date de derni√®re chauffe est coh√©rente.
      Notifie si aucune chauffe n'a eu lieu depuis 7 jours.
    mode: single
    trigger:
      # Tous les dimanches √† 12h
      - platform: time
        at: "12:00:00"
    condition:
      - condition: time
        weekday:
          - sun
    action:
      - service: system_log.write
        data:
          message: >-
            Cumulus : Maintenance hebdomadaire -
            Derni√®re chauffe : {{ states('input_datetime.cumulus_derniere_chauffe_complete') }},
            Heures √©coul√©es : {{ states('sensor.cumulus_heures_depuis_derniere_chauffe') }}h,
            Besoin urgent : {{ states('binary_sensor.cumulus_besoin_chauffe_urgente') }}
          level: info
      # Notification si pas de chauffe depuis 7 jours
      - condition: template
        value_template: >-
          {{ states('sensor.cumulus_heures_depuis_derniere_chauffe') | float(0) > 168 }}
      - service: persistent_notification.create
        data:
          title: "‚ÑπÔ∏è Cumulus - Maintenance"
          message: >-
            Aucune chauffe compl√®te depuis {{ (states('sensor.cumulus_heures_depuis_derniere_chauffe') | float(0) / 24) | round(1) }} jours.

            Derni√®re chauffe : {{ states('input_datetime.cumulus_derniere_chauffe_complete') }}

            V√©rifiez :
            - Le cumulus fonctionne-t-il normalement ?
            - Y a-t-il eu suffisamment de soleil ?
            - Les heures creuses sont-elles activ√©es si n√©cessaire ?
          notification_id: cumulus_maintenance

  # ========================================================================
  # 5. CORRECTION AUTOMATIQUE SI "BESOIN URGENT" ANORMAL
  # ========================================================================
  - id: cumulus_correction_besoin_urgent_anormal
    alias: "Cumulus ‚Äî Correction besoin urgent anormal"
    description: >-
      Si "besoin urgent" reste actif pendant plus de 2 heures ET que
      heures_depuis_derniere_chauffe > 1000h (= date invalide),
      alors r√©initialiser automatiquement la date.
    mode: restart
    trigger:
      - platform: state
        entity_id: binary_sensor.cumulus_besoin_chauffe_urgente
        to: "on"
        for:
          hours: 2
    condition:
      # Seulement si les heures calcul√©es sont aberrantes (> 1000h = 41 jours)
      - condition: template
        value_template: >-
          {{ states('sensor.cumulus_heures_depuis_derniere_chauffe') | float(0) > 1000 }}
    action:
      - service: input_datetime.set_datetime
        target:
          entity_id: input_datetime.cumulus_derniere_chauffe_complete
        data:
          datetime: "{{ (now() - timedelta(hours=12)).strftime('%Y-%m-%d %H:%M:%S') }}"
      - service: persistent_notification.create
        data:
          title: "üîß Cumulus - Correction automatique"
          message: >-
            "Besoin urgent" √©tait actif de mani√®re anormale
            ({{ states('sensor.cumulus_heures_depuis_derniere_chauffe') }}h calcul√©es).

            La date de derni√®re chauffe a √©t√© automatiquement corrig√©e √† :
            {{ (now() - timedelta(hours=12)).strftime('%d/%m/%Y %H:%M') }}

            Cela peut arriver apr√®s :
            - Une restauration de sauvegarde
            - Un changement d'ann√©e
            - Une erreur d'horloge syst√®me
          notification_id: cumulus_correction_auto
      - service: system_log.write
        data:
          message: "Cumulus : Correction automatique de besoin urgent anormal ({{ states('sensor.cumulus_heures_depuis_derniere_chauffe') }}h)"
          level: warning

###############################################################################
# SCRIPT HELPER (OPTIONNEL)
###############################################################################
# Ce script peut √™tre appel√© manuellement pour forcer la mise √† jour

script:
  cumulus_reset_derniere_chauffe:
    alias: "Cumulus ‚Äî Reset derni√®re chauffe"
    description: "R√©initialise manuellement la date de derni√®re chauffe √† maintenant"
    mode: single
    sequence:
      - service: input_datetime.set_datetime
        target:
          entity_id: input_datetime.cumulus_derniere_chauffe_complete
        data:
          datetime: "{{ now().strftime('%Y-%m-%d %H:%M:%S') }}"
      - service: persistent_notification.create
        data:
          title: "‚úÖ Cumulus - Date r√©initialis√©e"
          message: >-
            La date de derni√®re chauffe a √©t√© r√©initialis√©e √† :
            {{ now().strftime('%d/%m/%Y %H:%M:%S') }}

            Le message "besoin urgent" devrait dispara√Ætre dans quelques secondes.
          notification_id: cumulus_reset_ok

###############################################################################
# INSTRUCTIONS D'INSTALLATION
###############################################################################
#
# √âTAPE 1 : Choisir la m√©thode d'int√©gration
#
# M√©thode A : Package s√©par√© (RECOMMAND√â)
# - Copiez ce fichier dans : config/packages/cumulus_automations.yaml
# - Red√©marrez Home Assistant
#
# M√©thode B : Int√©gration dans automations.yaml
# - Copiez la section automation: dans votre automations.yaml
# - Rechargez les automations (pas besoin de red√©marrer)
#
# M√©thode C : Fusion avec cumulus.yaml existant
# - Ajoutez la section automation: √† la fin de votre cumulus.yaml
# - Rechargez le package
#
# √âTAPE 2 : Tester l'initialisation
# - Allez dans Developer Tools ‚Üí Services
# - Ex√©cutez : script.cumulus_reset_derniere_chauffe
# - V√©rifiez que "besoin urgent" dispara√Æt
#
# √âTAPE 3 : V√©rifier les automations
# - Allez dans Param√®tres ‚Üí Automations et Sc√®nes
# - Cherchez "Cumulus"
# - V√©rifiez que les 5 automations sont pr√©sentes et activ√©es
#
###############################################################################
