"""
Script de diagnostic Cumulus v2 - Identification des entitÃ©s

Ce script permet d'identifier automatiquement les bonnes entitÃ©s dans votre installation.
Ã€ exÃ©cuter dans Developer Tools > Template
"""

# â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
# RECHERCHE AUTOMATIQUE DES ENTITÃ‰S
# â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

{# 1. CONTACTEUR CUMULUS (SWITCH) #}
{% set switches_shelly = states.switch | selectattr('entity_id', 'search', 'shelly') | map(attribute='entity_id') | list %}
{% set switches_cumulus = states.switch | selectattr('entity_id', 'search', 'cumulus') | map(attribute='entity_id') | list %}
{% set switches_water = states.switch | selectattr('entity_id', 'search', 'water|boiler|chauffe') | map(attribute='entity_id') | list %}

â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
ğŸ”Œ CONTACTEUR CUMULUS
â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

Switches Shelly trouvÃ©s:
{% for switch in switches_shelly %}
  âœ“ {{ switch }}
{% else %}
  âŒ Aucun switch Shelly trouvÃ©
{% endfor %}

Switches Cumulus trouvÃ©s:
{% for switch in switches_cumulus %}
  âœ“ {{ switch }}
{% else %}
  âŒ Aucun switch Cumulus trouvÃ©
{% endfor %}

Autres switches eau/chauffe-eau:
{% for switch in switches_water %}
  âœ“ {{ switch }}
{% else %}
  âŒ Aucun trouvÃ©
{% endfor %}

â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
ğŸ“Š IMPORT RÃ‰SEAU (GRID IMPORT)
â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

{% set import_sensors = states.sensor | selectattr('entity_id', 'search', 'import|grid|linky') | map(attribute='entity_id') | list %}
{% for sensor in import_sensors %}
  âœ“ {{ sensor }} = {{ states(sensor) }}
{% else %}
  âŒ Aucun capteur d'import trouvÃ©
{% endfor %}

â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
â˜€ï¸ PRODUCTION SOLAIRE APS
â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

{% set aps_sensors = states.sensor | selectattr('entity_id', 'search', 'aps|solar|pv') | map(attribute='entity_id') | list %}
{% for sensor in aps_sensors %}
  âœ“ {{ sensor }} = {{ states(sensor) }}
{% else %}
  âŒ Aucun capteur APS trouvÃ©
{% endfor %}

â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
ğŸ”‹ Ã‰TAT DE CHARGE SOLARBANK (SOC)
â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

{% set soc_sensors = states.sensor | selectattr('entity_id', 'search', 'solarbank|battery|soc|charge') | map(attribute='entity_id') | list %}
{% for sensor in soc_sensors %}
  âœ“ {{ sensor }} = {{ states(sensor) }}
{% else %}
  âŒ Aucun capteur SOC trouvÃ©
{% endfor %}

â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
âš¡ PRODUCTION PV TOTALE
â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

{% set pv_total_sensors = states.sensor | selectattr('entity_id', 'search', 'pv_total|solar_total|production_total') | map(attribute='entity_id') | list %}
{% for sensor in pv_total_sensors %}
  âœ“ {{ sensor }} = {{ states(sensor) }}
{% else %}
  âŒ Aucun capteur PV total trouvÃ©
{% endfor %}

â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
ğŸ“‹ RÃ‰SUMÃ‰ - ENTITÃ‰S Ã€ REMPLACER
â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

Dans les fichiers /config/packages/cumulus/*.yaml, remplacer:

switch.shellypro1_ece334ee1b64 â†’ {{ switches_shelly[0] if switches_shelly else '??? (Ã  identifier)' }}
sensor.smart_meter_grid_import â†’ {{ (import_sensors | selectattr('contains', 'power') | first) if import_sensors else '??? (Ã  identifier)' }}
sensor.aps_power_w â†’ {{ (aps_sensors | selectattr('contains', 'power') | first) if aps_sensors else '??? (Ã  identifier)' }}
sensor.system_sanguinet_etat_de_charge_du_sb â†’ {{ (soc_sensors | first) if soc_sensors else '??? (Ã  identifier)' }}
sensor.pv_total_entree_sb_aps_w â†’ {{ (pv_total_sensors | first) if pv_total_sensors else '??? (Ã  identifier)' }}
