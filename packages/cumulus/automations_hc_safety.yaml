# ‚ïî‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïó
# ‚ïë CUMULUS INTELLIGENT - AUTOMATIONS HC & S√âCURIT√âS                           ‚ïë
# ‚ïë Gestion heures creuses et protections syst√®me                              ‚ïë
# ‚ïö‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïù

automation:
  # ‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê
  # ‚îÇ HEURES CREUSES - D√âMARRAGE INTELLIGENT                                  ‚îÇ
  # ‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò
  - id: cumulus_demarrage_hc_intelligent
    alias: "Cumulus - D√©marrage HC intelligent"
    description: "D√©marre en heures creuses si besoin"
    mode: single

    trigger:
      # D√©but des heures creuses
      - platform: state
        entity_id: binary_sensor.cumulus_heures_creuses
        to: 'on'
        id: debut_hc

      # Check p√©riodique pendant HC
      - platform: time_pattern
        minutes: "/30"
        id: check_periodique

      # Temp√©rature critique
      - platform: numeric_state
        entity_id: sensor.cumulus_temperature_estimee
        below: 40
        id: temperature_critique

    condition:
      - condition: and
        conditions:
          # En heures creuses
          - condition: state
            entity_id: binary_sensor.cumulus_heures_creuses
            state: 'on'

          # Cumulus OFF
          - condition: state
            entity_id: switch.shellypro1_ece334ee1b64
            state: 'off'

          # Pas en mode vacances
          - condition: state
            entity_id: input_boolean.cumulus_mode_vacances
            state: 'off'

          # Temp√©rature insuffisante OU urgence
          - condition: or
            conditions:
              # Besoin normal
              - condition: template
                value_template: >
                  {% set temp = states('sensor.cumulus_temperature_estimee') | float(45) %}
                  {% set target = states('input_number.cumulus_temperature_cible_hc') | float(52) %}
                  {{ temp < target }}

              # Urgence : tr√®s froid ou pas de chauffe r√©cente
              - condition: template
                value_template: >
                  {% set temp = states('sensor.cumulus_temperature_estimee') | float(45) %}
                  {% set hours = states('sensor.cumulus_heures_depuis_derniere_chauffe') | float(0) %}
                  {{ temp < 35 or hours > 48 }}

          # Respect espacement minimal (sauf urgence)
          - condition: or
            conditions:
              - condition: template
                value_template: >
                  {% set hours = states('sensor.cumulus_heures_depuis_derniere_chauffe') | float(0) %}
                  {% set min_spacing = states('input_number.cumulus_espacement_minimal_heures') | float(24) %}
                  {{ hours >= min_spacing }}

              # Override si critique
              - condition: numeric_state
                entity_id: sensor.cumulus_temperature_estimee
                below: 35

    action:
      # D√©terminer l'urgence
      - variables:
          is_urgent: >
            {{ states('sensor.cumulus_temperature_estimee') | float(45) < 35 }}
          reason: >
            {% if trigger.id == 'temperature_critique' %}
              Temp√©rature critique
            {% elif trigger.id == 'debut_hc' %}
              D√©but heures creuses
            {% else %}
              Check p√©riodique HC
            {% endif %}

      # Log avec contexte
      - service: logbook.log
        data:
          name: "Cumulus HC"
          message: >
            D√©marrage HC {{ '(URGENT)' if is_urgent else '' }}
            Raison: {{ reason }} |
            Temp√©rature: {{ states('sensor.cumulus_temperature_estimee') }}¬∞C |
            Derni√®re chauffe: il y a {{ states('sensor.cumulus_heures_depuis_derniere_chauffe') }}h
          entity_id: switch.shellypro1_ece334ee1b64
          domain: automation

      # Notification si urgent
      - choose:
          - conditions:
              - condition: template
                value_template: "{{ is_urgent }}"
              - condition: state
                entity_id: input_boolean.cumulus_notifications_actives
                state: 'on'
            sequence:
              - service: notify.notify
                data:
                  title: "‚ö†Ô∏è Cumulus - Chauffe urgente"
                  message: >
                    D√©marrage urgent en HC.
                    Temp√©rature: {{ states('sensor.cumulus_temperature_estimee') }}¬∞C
                    Risque l√©gionelle si < 35¬∞C !

      # D√©marrer le cumulus
      - service: switch.turn_on
        target:
          entity_id: switch.shellypro1_ece334ee1b64

      # Timer de chauffe HC (g√©n√©ralement plus long)
      - service: timer.start
        target:
          entity_id: timer.cumulus_timer_chauffe
        data:
          duration: >
            {% set temp = states('sensor.cumulus_temperature_estimee') | float(45) %}
            {% set target = states('input_number.cumulus_temperature_cible_hc') | float(52) %}
            {% set delta = target - temp %}
            {% set minutes = (delta * 4.5) | round(0) %}
            {{ '{:02d}:{:02d}:00'.format((minutes // 60), (minutes % 60)) }}

      # Incr√©menter compteur
      - service: counter.increment
        target:
          entity_id: counter.cumulus_chauffes_jour

  # ‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê
  # ‚îÇ HEURES CREUSES - ARR√äT                                                  ‚îÇ
  # ‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò
  - id: cumulus_arret_hc
    alias: "Cumulus - Arr√™t HC"
    description: "Arr√™te √† la fin des heures creuses ou temp√©rature atteinte"
    mode: single

    trigger:
      # Fin heures creuses
      - platform: state
        entity_id: binary_sensor.cumulus_heures_creuses
        to: 'off'
        id: fin_hc

      # Temp√©rature atteinte
      - platform: numeric_state
        entity_id: sensor.cumulus_temperature_estimee
        above: input_number.cumulus_temperature_cible_hc
        for:
          minutes: 2
        id: temperature_ok

      # Timer expir√©
      - platform: event
        event_type: timer.finished
        event_data:
          entity_id: timer.cumulus_timer_chauffe
        id: timer_expire

    condition:
      - condition: state
        entity_id: switch.shellypro1_ece334ee1b64
        state: 'on'
      - condition: state
        entity_id: sensor.cumulus_mode_actif
        state: 'HC'

    action:
      # Log arr√™t
      - service: logbook.log
        data:
          name: "Cumulus HC"
          message: >
            Arr√™t HC -
            {% if trigger.id == 'fin_hc' %}Fin heures creuses
            {% elif trigger.id == 'temperature_ok' %}Temp√©rature atteinte ({{ states('sensor.cumulus_temperature_estimee') }}¬∞C)
            {% elif trigger.id == 'timer_expire' %}Timer expir√©
            {% else %}Autre{% endif %}
          entity_id: switch.shellypro1_ece334ee1b64

      # Arr√™ter cumulus
      - service: switch.turn_off
        target:
          entity_id: switch.shellypro1_ece334ee1b64

      # Annuler timer
      - service: timer.cancel
        target:
          entity_id: timer.cumulus_timer_chauffe

  # ‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê
  # ‚îÇ S√âCURIT√â - ANTI-L√âGIONELLE                                              ‚îÇ
  # ‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò
  - id: cumulus_securite_anti_legionelle
    alias: "Cumulus - S√©curit√© anti-l√©gionelle"
    description: "Force une chauffe si temp√©rature trop basse trop longtemps"
    mode: single

    trigger:
      # Check quotidien √† 14h
      - platform: time
        at: "14:00:00"

      # Temp√©rature tr√®s basse
      - platform: numeric_state
        entity_id: sensor.cumulus_temperature_estimee
        below: 35
        for:
          hours: 2

    condition:
      - condition: or
        conditions:
          # Temp√©rature dangereuse
          - condition: numeric_state
            entity_id: sensor.cumulus_temperature_estimee
            below: 35

          # Pas de chauffe depuis 72h
          - condition: numeric_state
            entity_id: sensor.cumulus_heures_depuis_derniere_chauffe
            above: 72

    action:
      # Notification critique
      - service: notify.notify
        data:
          title: "üö® ALERTE CUMULUS"
          message: >
            RISQUE L√âGIONELLE !
            Temp√©rature: {{ states('sensor.cumulus_temperature_estimee') }}¬∞C
            Derni√®re chauffe: il y a {{ states('sensor.cumulus_heures_depuis_derniere_chauffe') }}h
            Chauffe forc√©e en cours...
          data:
            priority: high
            tag: cumulus_critical

      # Log critique
      - service: logbook.log
        data:
          name: "CUMULUS ALERTE"
          message: "Chauffe anti-l√©gionelle forc√©e - Temp√©rature critique"
          entity_id: switch.shellypro1_ece334ee1b64
          domain: automation

      # Forcer chauffe imm√©diate (override tout)
      - service: switch.turn_on
        target:
          entity_id: switch.shellypro1_ece334ee1b64

      # Timer long pour chauffe compl√®te
      - service: timer.start
        target:
          entity_id: timer.cumulus_timer_chauffe
        data:
          duration: "03:00:00"  # 3h pour mont√©e √† 60¬∞C garantie

      # D√©sactiver mode vacances si actif
      - service: input_boolean.turn_off
        target:
          entity_id: input_boolean.cumulus_mode_vacances

  # ‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê
  # ‚îÇ S√âCURIT√â - PROTECTION SURCHAUFFE                                        ‚îÇ
  # ‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò
  - id: cumulus_protection_surchauffe
    alias: "Cumulus - Protection surchauffe"
    description: "Arr√™te si temp√©rature excessive ou dur√©e anormale"
    mode: single

    trigger:
      # Temp√©rature excessive (estimation)
      - platform: numeric_state
        entity_id: sensor.cumulus_temperature_estimee
        above: 65
        id: temperature_excessive

      # Dur√©e chauffe anormale
      - platform: state
        entity_id: switch.shellypro1_ece334ee1b64
        to: 'on'
        for:
          hours: 4
        id: duree_excessive

    condition:
      - condition: state
        entity_id: switch.shellypro1_ece334ee1b64
        state: 'on'

    action:
      # Alerte
      - service: notify.notify
        data:
          title: "‚ö†Ô∏è Cumulus - Surchauffe"
          message: >
            Protection activ√©e!
            {% if trigger.id == 'temperature_excessive' %}
            Temp√©rature excessive: {{ states('sensor.cumulus_temperature_estimee') }}¬∞C
            {% else %}
            Dur√©e chauffe anormale: > 4 heures
            {% endif %}

      # Log
      - service: logbook.log
        data:
          name: "Cumulus S√©curit√©"
          message: >
            ARR√äT S√âCURIT√â -
            {% if trigger.id == 'temperature_excessive' %}Temp√©rature > 65¬∞C
            {% else %}Dur√©e > 4h{% endif %}
          entity_id: switch.shellypro1_ece334ee1b64
          domain: automation

      # Arr√™t imm√©diat
      - service: switch.turn_off
        target:
          entity_id: switch.shellypro1_ece334ee1b64

      # Deadband de s√©curit√©
      - service: input_boolean.turn_on
        target:
          entity_id: input_boolean.cumulus_verrou_deadband
      - service: timer.start
        target:
          entity_id: timer.cumulus_timer_deadband
        data:
          duration: "01:00:00"  # 1h de cooldown

  # ‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê
  # ‚îÇ RESET QUOTIDIEN                                                         ‚îÇ
  # ‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò
  - id: cumulus_reset_quotidien
    alias: "Cumulus - Reset quotidien"
    description: "R√©initialise compteurs et verrous chaque jour"
    mode: single

    trigger:
      - platform: time
        at: "00:00:01"

    action:
      # Reset compteur journalier
      - service: counter.reset
        target:
          entity_id: counter.cumulus_chauffes_jour

      # Reset verrou quotidien si plus de 24h
      - condition: numeric_state
        entity_id: sensor.cumulus_heures_depuis_derniere_chauffe
        above: 24
      - service: input_boolean.turn_off
        target:
          entity_id: input_boolean.cumulus_verrou_chauffe_quotidienne

      # Log
      - service: logbook.log
        data:
          name: "Cumulus"
          message: "Reset quotidien effectu√©"

  # ‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê
  # ‚îÇ MODE VACANCES                                                           ‚îÇ
  # ‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò
  - id: cumulus_mode_vacances
    alias: "Cumulus - Gestion mode vacances"
    description: "Arr√™te tout en mode vacances"
    mode: restart

    trigger:
      - platform: state
        entity_id: input_boolean.cumulus_mode_vacances
        to: 'on'

    action:
      # Notification
      - service: notify.notify
        data:
          title: "üèñÔ∏è Cumulus - Mode vacances"
          message: >
            Mode vacances activ√©.
            Le cumulus est d√©sactiv√©.
            N'oubliez pas de le r√©activer √† votre retour !

      # Arr√™ter si en chauffe
      - condition: state
        entity_id: switch.shellypro1_ece334ee1b64
        state: 'on'
      - service: switch.turn_off
        target:
          entity_id: switch.shellypro1_ece334ee1b64

      # Log
      - service: logbook.log
        data:
          name: "Cumulus"
          message: "Mode vacances activ√© - Syst√®me en pause"

  # ‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê
  # ‚îÇ RETOUR DE VACANCES                                                      ‚îÇ
  # ‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò
  - id: cumulus_retour_vacances
    alias: "Cumulus - Retour de vacances"
    description: "R√©active et force une chauffe au retour"
    mode: single

    trigger:
      - platform: state
        entity_id: input_boolean.cumulus_mode_vacances
        to: 'off'

    action:
      # Notification
      - service: notify.notify
        data:
          title: "üè† Cumulus - Retour maison"
          message: >
            Bon retour !
            Lancement d'une chauffe compl√®te.
            Eau chaude disponible dans ~2h30.

      # Forcer une chauffe imm√©diate
      - service: switch.turn_on
        target:
          entity_id: switch.shellypro1_ece334ee1b64

      # Timer chauffe compl√®te
      - service: timer.start
        target:
          entity_id: timer.cumulus_timer_chauffe
        data:
          duration: "02:30:00"

      # Log
      - service: logbook.log
        data:
          name: "Cumulus"
          message: "Retour de vacances - Chauffe forc√©e"

# ‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê
# ‚îÇ SCRIPTS UTILITAIRES                                                     ‚îÇ
# ‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò
script:
  # Test complet du syst√®me
  cumulus_test_systeme:
    alias: "Test syst√®me cumulus"
    sequence:
      - service: logbook.log
        data:
          name: "Test Cumulus"
          message: "D√©marrage test syst√®me..."

      # V√©rifier tous les sensors
      - service: homeassistant.update_entity
        target:
          entity_id:
            - sensor.cumulus_temperature_estimee
            - sensor.cumulus_puissance_disponible_w
            - sensor.cumulus_score_sante

      # Flash contacteur (on/off rapide)
      - service: switch.turn_on
        target:
          entity_id: switch.shellypro1_ece334ee1b64
      - delay: "00:00:02"
      - service: switch.turn_off
        target:
          entity_id: switch.shellypro1_ece334ee1b64

      - service: notify.notify
        data:
          title: "Test Cumulus"
          message: >
            Test termin√©!
            Sant√©: {{ states('sensor.cumulus_score_sante') }}%
            Temp: {{ states('sensor.cumulus_temperature_estimee') }}¬∞C
            Coh√©rence: {{ states('binary_sensor.cumulus_coherence_ok') }}

  # Reset tous les verrous
  cumulus_reset_verrous:
    alias: "Reset verrous cumulus"
    sequence:
      - service: input_boolean.turn_off
        target:
          entity_id:
            - input_boolean.cumulus_verrou_deadband
            - input_boolean.cumulus_verrou_chauffe_quotidienne

      - service: timer.cancel
        target:
          entity_id:
            - timer.cumulus_timer_deadband

      - service: logbook.log
        data:
          name: "Cumulus"
          message: "Tous les verrous r√©initialis√©s"

  # Export statistiques
  cumulus_export_stats:
    alias: "Export stats cumulus"
    sequence:
      - service: notify.notify
        data:
          title: "üìä Stats Cumulus"
          message: >
            STATISTIQUES MENSUELLES

            Chauffes: {{ states('counter.cumulus_chauffes_mois') }}
            Consommation: {{ states('sensor.cumulus_kwh_mois') }} kWh
            Co√ªt estim√©: {{ states('sensor.cumulus_cout_mois') }}‚Ç¨

            R√©partition:
            - PV: {{ states('sensor.cumulus_pourcentage_pv') }}%
            - HC: {{ states('sensor.cumulus_pourcentage_hc') }}%
            - Force: {{ states('sensor.cumulus_pourcentage_force') }}%

            Temp√©rature moyenne: {{ states('sensor.cumulus_temperature_moyenne') }}¬∞C
            Autonomie solaire: {{ states('sensor.cumulus_autonomie_solaire') }}%
