###############################################################################
# Package Git Sync - Synchronisation automatique Git
# Remplace l'add-on Git Pull buguÃ©
#
# FonctionnalitÃ©s :
# - Pull automatique au dÃ©marrage de HA (aprÃ¨s 60s)
# - Pull pÃ©riodique toutes les 10 minutes
# - VÃ©rification de config avant redÃ©marrage
# - Rollback automatique en cas d'erreur
# - Monitoring et notifications
#
# Auteur : Claude Code CLI
# Date : 2025-11-19
###############################################################################

###############################################################################
# Shell Commands
###############################################################################
shell_command:
  # Commande principale de synchronisation Git
  git_sync: "/config/scripts/git_sync.sh"

  # Commande pour vÃ©rifier manuellement les mises Ã  jour sans les appliquer
  git_check_updates: "cd /config && git fetch origin main && git rev-list HEAD..origin/main --count"

  # Commande pour voir les derniÃ¨res lignes du log
  git_sync_view_log: "tail -n 50 /config/git_sync.log"

###############################################################################
# Input Boolean - ContrÃ´le de la synchronisation automatique
###############################################################################
input_boolean:
  git_sync_auto_enabled:
    name: "Synchronisation Git automatique"
    icon: mdi:git
    initial: true

  git_sync_notify_enabled:
    name: "Notifications Git Sync"
    icon: mdi:bell
    initial: true

###############################################################################
# Sensors
###############################################################################
sensor:
  # Sensor pour afficher la date de derniÃ¨re synchronisation
  - platform: command_line
    name: "Git DerniÃ¨re Synchronisation"
    command: "grep 'Synchronisation terminÃ©e avec succÃ¨s' /config/git_sync.log 2>/dev/null | tail -1 | grep -oP '\\[\\K[^\\]]+' | head -1 || echo 'Jamais'"
    scan_interval: 300  # Mise Ã  jour toutes les 5 minutes

  # Sensor pour afficher le statut de la derniÃ¨re sync
  - platform: command_line
    name: "Git Statut DerniÃ¨re Sync"
    command: >
      if grep -q 'Synchronisation terminÃ©e avec succÃ¨s' /config/git_sync.log 2>/dev/null | tail -1; then
        echo 'SuccÃ¨s'
      elif grep -q 'Configuration invalide aprÃ¨s le pull' /config/git_sync.log 2>/dev/null | tail -1; then
        echo 'Erreur config'
      elif grep -q 'Ã‰chec du pull Git' /config/git_sync.log 2>/dev/null | tail -1; then
        echo 'Erreur pull'
      elif grep -q 'Pas de connectivitÃ© rÃ©seau' /config/git_sync.log 2>/dev/null | tail -1; then
        echo 'Pas de rÃ©seau'
      elif grep -q 'Aucune mise Ã  jour' /config/git_sync.log 2>/dev/null | tail -1; then
        echo 'Ã€ jour'
      else
        echo 'Inconnu'
      fi
    scan_interval: 300

  # Sensor pour le commit actuel
  - platform: command_line
    name: "Git Commit Actuel"
    command: "cd /config && git rev-parse --short HEAD"
    scan_interval: 600

  # Sensor pour compter les commits en retard
  - platform: command_line
    name: "Git Commits en Retard"
    command: "cd /config && git fetch origin main 2>/dev/null && git rev-list HEAD..origin/main --count || echo '0'"
    scan_interval: 600

###############################################################################
# Binary Sensors
###############################################################################
binary_sensor:
  # Indique si des mises Ã  jour sont disponibles
  - platform: template
    sensors:
      git_updates_available:
        friendly_name: "Mises Ã  jour Git disponibles"
        device_class: update
        value_template: >
          {{ states('sensor.git_commits_en_retard') | int(0) > 0 }}
        icon_template: >
          {% if states('sensor.git_commits_en_retard') | int(0) > 0 %}
            mdi:source-pull
          {% else %}
            mdi:check-circle
          {% endif %}

###############################################################################
# Automations
###############################################################################
automation:
  #############################################################################
  # Synchronisation au dÃ©marrage de Home Assistant
  #############################################################################
  - id: git_sync_on_startup
    alias: "Git Sync - Synchronisation au dÃ©marrage"
    description: "Pull automatique au boot de Home Assistant (aprÃ¨s 60s de dÃ©lai)"
    mode: single
    max_exceeded: silent
    trigger:
      - platform: homeassistant
        event: start
    condition:
      - condition: state
        entity_id: input_boolean.git_sync_auto_enabled
        state: "on"
    action:
      # Attendre 60 secondes pour laisser HA dÃ©marrer complÃ¨tement
      - delay:
          seconds: 60

      # Log du dÃ©but de sync
      - service: system_log.write
        data:
          message: "Git Sync - DÃ©marrage de la synchronisation au boot"
          level: info

      # ExÃ©cuter le script de synchronisation
      - service: shell_command.git_sync

      # Attendre un peu pour laisser le script s'exÃ©cuter
      - delay:
          seconds: 5

      # Notification optionnelle
      - condition: state
        entity_id: input_boolean.git_sync_notify_enabled
        state: "on"

      - service: persistent_notification.create
        data:
          title: "Git Sync - DÃ©marrage"
          message: >
            Synchronisation Git exÃ©cutÃ©e au dÃ©marrage.
            Statut : {{ states('sensor.git_statut_derniere_sync') }}
            Consultez /config/git_sync.log pour les dÃ©tails.
          notification_id: git_sync_startup

  #############################################################################
  # Synchronisation pÃ©riodique (toutes les 10 minutes)
  #############################################################################
  - id: git_sync_periodic
    alias: "Git Sync - Synchronisation pÃ©riodique"
    description: "Pull automatique toutes les 10 minutes"
    mode: single
    max_exceeded: silent
    trigger:
      - platform: time_pattern
        minutes: "/10"  # Toutes les 10 minutes
    condition:
      - condition: state
        entity_id: input_boolean.git_sync_auto_enabled
        state: "on"
    action:
      # ExÃ©cuter le script de synchronisation
      - service: shell_command.git_sync

  #############################################################################
  # Notification en cas d'erreur de synchronisation
  #############################################################################
  - id: git_sync_error_notification
    alias: "Git Sync - Notification d'erreur"
    description: "Envoie une notification si la synchronisation Ã©choue"
    mode: single
    trigger:
      - platform: state
        entity_id: sensor.git_statut_derniere_sync
        to:
          - "Erreur config"
          - "Erreur pull"
    condition:
      - condition: state
        entity_id: input_boolean.git_sync_notify_enabled
        state: "on"
    action:
      - service: persistent_notification.create
        data:
          title: "âš ï¸ Git Sync - Erreur"
          message: >
            La synchronisation Git a Ã©chouÃ© !

            Statut : {{ states('sensor.git_statut_derniere_sync') }}
            DerniÃ¨re sync : {{ states('sensor.git_derniere_synchronisation') }}

            Consultez les logs avec :
            ssh root@192.168.1.29 -p 22222
            tail -n 100 /config/git_sync.log
          notification_id: git_sync_error

  #############################################################################
  # Notification quand des mises Ã  jour sont disponibles
  #############################################################################
  - id: git_sync_updates_available
    alias: "Git Sync - Mises Ã  jour disponibles"
    description: "Notification quand des commits sont disponibles"
    mode: single
    trigger:
      - platform: state
        entity_id: binary_sensor.git_updates_available
        to: "on"
        for:
          minutes: 2
    condition:
      - condition: state
        entity_id: input_boolean.git_sync_notify_enabled
        state: "on"
      - condition: state
        entity_id: input_boolean.git_sync_auto_enabled
        state: "off"  # Notification uniquement si sync auto dÃ©sactivÃ©e
    action:
      - service: persistent_notification.create
        data:
          title: "ðŸ”” Git Sync - Mises Ã  jour disponibles"
          message: >
            {{ states('sensor.git_commits_en_retard') }} nouveau(x) commit(s) disponible(s).

            Activez la synchronisation automatique ou lancez manuellement :
            ParamÃ¨tres > DÃ©veloppeur > Services > shell_command.git_sync
          notification_id: git_sync_updates

###############################################################################
# Scripts
###############################################################################
script:
  #############################################################################
  # Script pour forcer une synchronisation manuelle
  #############################################################################
  git_sync_manual:
    alias: "Git Sync - Synchronisation manuelle"
    description: "Force une synchronisation Git immÃ©diatement"
    mode: single
    sequence:
      - service: system_log.write
        data:
          message: "Git Sync - Synchronisation manuelle dÃ©clenchÃ©e"
          level: info

      - service: shell_command.git_sync

      - delay:
          seconds: 5

      - service: persistent_notification.create
        data:
          title: "Git Sync - Synchronisation manuelle"
          message: >
            Synchronisation manuelle terminÃ©e.
            Statut : {{ states('sensor.git_statut_derniere_sync') }}

            Consultez /config/git_sync.log pour les dÃ©tails.
          notification_id: git_sync_manual

  #############################################################################
  # Script pour afficher les logs
  #############################################################################
  git_sync_show_logs:
    alias: "Git Sync - Afficher les logs"
    description: "Affiche les 50 derniÃ¨res lignes du log"
    mode: single
    sequence:
      - service: shell_command.git_sync_view_log

      - service: persistent_notification.create
        data:
          title: "Git Sync - Logs"
          message: >
            Consultez les logs complets via SSH :

            ssh root@192.168.1.29 -p 22222
            tail -f /config/git_sync.log

            ou

            cat /config/git_sync.log
          notification_id: git_sync_logs
