###############################################################################
# CUMULUS ‚Äî v2025-10-03a
#
# Changements majeurs par rapport aux versions ant√©rieures :
# - Seuil PV par d√©faut = 100 W (input_number.cumulus_seuil_pv_on_w)
# - Automation "ce_on_pv_simple" durcie : d√©clenchement au-dessus du seuil avec
#   d√©lai configurable ; re-v√©rification du seuil avant ON
# - Condition SOC avec marge ‚àí0,5 pt
# - binaire cumulus_chauffe_reelle en template (pilot√© par variations de mesures)
# - Limiteur d‚Äôimport : OFF si import > seuil (talon+marge) pendant ‚â• 8 s
# - Sp√©cial ‚Äúno_delay‚Äù : mini-deadband post-ON = 5 s (sinon deadband = 100 s)
# - Ajouts d√©tect. fin par import (seuil = talon + marge_fin_import)
#
# R√®gles inviolables :
# - NE JAMAIS renommer les entit√©s de l‚Äôutilisateur.
# - Contactor via input_text.cumulus_entity_contacteur (fallback fourni).
# - Diffs minimaux, logique inchang√©e hormis corrections ci-dessus.
###############################################################################

# ============================= ENTIT√âS PARAM√âTRABLES ======================= #
input_text:
  cumulus_entity_import_w:
    name: ENTIT√â - Import r√©seau (W)
    icon: mdi:transmission-tower-import
    # ‚Üê remplace si besoin par l'ID r√©el du capteur d'import r√©seau
    initial: sensor.smart_meter_grid_import

  cumulus_entity_contacteur:
    name: ENTIT√â - Contacteur cumulus (switch)
    icon: mdi:water-boiler
    # ‚Üê remplace si besoin, ceci est le fallback historique
    initial: switch.shellypro1_ece334ee1b64

  cumulus_entity_soc_solarbank:
    name: ENTIT√â - SOC Solarbank (%)
    icon: mdi:battery
    # ‚Üê capteur SOC SB r√©el chez toi
    initial: sensor.system_sanguinet_etat_de_charge_du_sb

  cumulus_entity_solcast_today:
    name: ENTIT√â - Pr√©vision Solcast aujourd'hui (kWh)
    icon: mdi:weather-sunny-alert
    # ‚Üê capteur pr√©vision solaire du jour
    initial: sensor.solcast_pv_forecast_previsions_pour_aujourd_hui

  cumulus_entity_solcast_tomorrow:
    name: ENTIT√â - Pr√©vision Solcast demain (kWh)
    icon: mdi:weather-sunny
    # ‚Üê capteur pr√©vision solaire lendemain
    initial: sensor.solcast_pv_forecast_previsions_pour_demain

  cumulus_entity_lave_linge_power:
    name: ENTIT√â - Puissance lave-linge (W)
    icon: mdi:washing-machine
    # ‚Üê capteur puissance lave-linge
    initial: sensor.lave_linge_power

  cumulus_entity_lave_vaisselle_power:
    name: ENTIT√â - Puissance lave-vaisselle (W)
    icon: mdi:dishwasher
    # ‚Üê capteur puissance lave-vaisselle
    initial: sensor.lave_vaisselle_power

# ============================ AIDES / R√âGLAGES ============================ #
input_number:
  cumulus_seuil_pv_on_w:
    name: Seuil PV pour d√©marrage (W)
    min: 0
    max: 5000
    step: 10
    mode: slider
    unit_of_measurement: W
    icon: mdi:white-balance-sunny
    initial: 100

  cumulus_on_delay_s:
    name: D√©lai de confirmation ON (s)
    min: 0
    max: 300
    step: 1
    mode: slider
    unit_of_measurement: s
    icon: mdi:timer-play
    initial: 10

  cumulus_deadband_s:
    name: Deadband global apr√®s changement (s)
    min: 0
    max: 600
    step: 5
    unit_of_measurement: s
    icon: mdi:progress-clock
    initial: 100

  cumulus_mini_deadband_no_delay_s:
    name: Mini-deadband sp√©cial no_delay (s)
    min: 0
    max: 60
    step: 1
    unit_of_measurement: s
    icon: mdi:timer-outline
    initial: 5

  cumulus_talon_maison_w:
    name: Talon maison (W)
    min: 0
    max: 1000
    step: 10
    unit_of_measurement: W
    icon: mdi:home-lightning-bolt
    initial: 300

  cumulus_marge_import_w:
    name: Marge import (limiteur) (W)
    min: 0
    max: 3000
    step: 10
    unit_of_measurement: W
    icon: mdi:flash-alert
    initial: 1800

  cumulus_marge_fin_import_w:
    name: Marge de fin (import) (W)
    min: 0
    max: 1000
    step: 10
    unit_of_measurement: W
    icon: mdi:flash-triangle-outline
    initial: 150

  cumulus_solarbank_max_w:
    name: Puissance max Solarbank (W)
    min: 0
    max: 2000
    step: 10
    unit_of_measurement: W
    icon: mdi:battery-charging-100
    initial: 1200

  cumulus_aps_max_w:
    name: Puissance max APS (W)
    min: 0
    max: 2000
    step: 10
    unit_of_measurement: W
    icon: mdi:solar-power
    initial: 960

  cumulus_soc_start_pct:
    name: SOC mini d√©marrage (%)
    min: 0
    max: 100
    step: 0.5
    unit_of_measurement: "%"
    icon: mdi:battery-70
    initial: 25

  cumulus_soc_stop_pct:
    name: SOC arr√™t s√©curit√© (%)
    min: 0
    max: 100
    step: 0.5
    unit_of_measurement: "%"
    icon: mdi:battery-alert-variant-outline
    initial: 15

  cumulus_puissance_w:
    name: Puissance cumulus (W)
    min: 0
    max: 5000
    step: 10
    unit_of_measurement: W
    icon: mdi:lightning-bolt
    initial: 2950

  cumulus_espacement_max_h:
    name: Espacement maxi entre chauffes (h)
    min: 24
    max: 72
    step: 1
    unit_of_measurement: h
    icon: mdi:timer-sand
    initial: 50

  cumulus_seuil_solcast_bon_kwh:
    name: Seuil Solcast "bonne journ√©e" (kWh)
    min: 0
    max: 50
    step: 0.5
    unit_of_measurement: kWh
    icon: mdi:white-balance-sunny
    initial: 8

  cumulus_nb_personnes:
    name: Nombre de personnes au foyer
    min: 1
    max: 10
    step: 1
    icon: mdi:account-multiple
    initial: 2

  cumulus_capacite_litres:
    name: Capacit√© du ballon (L)
    min: 50
    max: 500
    step: 10
    unit_of_measurement: L
    icon: mdi:water-boiler
    initial: 300

  cumulus_seuil_appareil_actif_w:
    name: Seuil appareil actif (W)
    min: 5
    max: 100
    step: 5
    unit_of_measurement: W
    icon: mdi:flash-outline
    initial: 10

input_boolean:
  cumulus_interdit:
    name: Interdit (s√©curit√©/maintenance)
    icon: mdi:hand-back-right-off

  cumulus_vacances:
    name: Vacances (pas de chauffe)
    icon: mdi:beach

  cumulus_verrou_jour:
    name: Verrou journ√©e (1/2)
    icon: mdi:calendar-remove

  cumulus_override:
    name: Override manuel autoriser ON
    icon: mdi:hand-pointing-up

  temp_atteinte_aujourdhui:
    name: Temp√©rature atteinte aujourd'hui
    icon: mdi:thermometer-check

  cumulus_autoriser_hc:
    name: Autoriser chauffes en heures creuses
    icon: mdi:clock-time-eight
    initial: true

# Fen√™tres horaires
input_datetime:
  cumulus_plage_pv_debut:
    name: Fen√™tre PV - d√©but
    has_date: false
    has_time: true
    initial: "10:20:00"
  cumulus_plage_pv_fin:
    name: Fen√™tre PV - fin
    has_date: false
    has_time: true
    initial: "17:50:00"

  cumulus_heures_creuses_debut:
    name: Heures creuses - d√©but
    has_date: false
    has_time: true
    initial: "03:30:00"
  cumulus_heures_creuses_fin:
    name: Heures creuses - fin
    has_date: false
    has_time: true
    initial: "08:05:00"

  cumulus_derniere_chauffe_complete:
    name: Derni√®re chauffe compl√®te
    has_date: true
    has_time: true

timer:
  cumulus_deadband_ui:
    name: Temporisation UI (deadband)
    # Dur√©e dynamique d√©finie dans automations via input_number.cumulus_deadband_s

# ================================ TEMPLATES ================================ #

template:

  # ------------------------------- SENSORS -------------------------------- #
  - sensor:

      - name: "cumulus_import_reseau_w"
        unique_id: cumulus_import_reseau_w
        unit_of_measurement: "W"
        device_class: power
        state_class: measurement
        state: >-
          {% set e = states('input_text.cumulus_entity_import_w') %}
          {{ states(e) | float(0) }}

      - name: "cumulus_soc_solarbank_pct"
        unique_id: cumulus_soc_solarbank_pct
        unit_of_measurement: "%"
        device_class: battery
        state_class: measurement
        state: >-
          {% set e = states('input_text.cumulus_entity_soc_solarbank') %}
          {{ states(e) | float(0) }}

      - name: "cumulus_pv_power_w"
        unique_id: cumulus_pv_power_w
        unit_of_measurement: "W"
        device_class: power
        state_class: measurement
        # PV r√©el = capteur proxy SB+APS si dispo, sinon 0
        state: >-
          {% set pv = states('sensor.pv_total_entree_sb_aps_w') | float(0) %}
          {{ pv }}

      - name: "cumulus_seuil_import_limiteur_w"
        unique_id: cumulus_seuil_import_limiteur_w
        unit_of_measurement: "W"
        device_class: power
        state: >-
          {{ (states('input_number.cumulus_talon_maison_w')|float(300))
            + (states('input_number.cumulus_marge_import_w')|float(1100)) }}

      - name: "cumulus_import_min_si_chauffe_w"
        unique_id: cumulus_import_min_si_chauffe_w
        unit_of_measurement: "W"
        device_class: power
        # Quand la chauffe se termine, l'import retombe ‚âà au talon.
        state: >-
          {{ states('input_number.cumulus_talon_maison_w') | float(300) }}

      - name: "cumulus_seuil_fin_chauffe_w"
        unique_id: cumulus_seuil_fin_chauffe_w
        unit_of_measurement: "W"
        device_class: power
        # Seuil = import_min_si_chauffe + marge de fin
        state: >-
          {{ (states('sensor.cumulus_import_min_si_chauffe_w')|float(0))
             + (states('input_number.cumulus_marge_fin_import_w')|float(150)) }}

      # Journal (timestamps) ‚Äì supprim√©s (auto-r√©f√©rentiels = invalides)
      # Ces sensors n√©cessiteraient une autre approche (ex: helpers via UI ou scripts)

      - name: "cumulus_solcast_forecast_today"
        unique_id: cumulus_solcast_forecast_today
        unit_of_measurement: "kWh"
        device_class: energy
        state: >-
          {% set e = states('input_text.cumulus_entity_solcast_today') %}
          {{ states(e) | float(0) }}

      - name: "cumulus_solcast_forecast_tomorrow"
        unique_id: cumulus_solcast_forecast_tomorrow
        unit_of_measurement: "kWh"
        device_class: energy
        state: >-
          {% set e = states('input_text.cumulus_entity_solcast_tomorrow') %}
          {{ states(e) | float(0) }}

      - name: "cumulus_heures_depuis_derniere_chauffe"
        unique_id: cumulus_heures_depuis_derniere_chauffe
        unit_of_measurement: "h"
        icon: mdi:clock-outline
        state: >-
          {% set last_ts = state_attr('input_datetime.cumulus_derniere_chauffe_complete', 'timestamp') %}
          {% if last_ts %}
            {{ ((now().timestamp() - last_ts) / 3600) | round(1) }}
          {% else %}
            999
          {% endif %}

      - name: "cumulus_temperature_estimee"
        unique_id: cumulus_temperature_estimee
        unit_of_measurement: "¬∞C"
        device_class: temperature
        icon: mdi:thermometer-water
        # Mod√®le simple : 58¬∞C apr√®s chauffe, perd ~0.3¬∞C/h, mini 20¬∞C
        state: >-
          {% set heures = states('sensor.cumulus_heures_depuis_derniere_chauffe') | float(999) %}
          {% if heures >= 999 %}
            20
          {% else %}
            {% set temp = 58 - (heures * 0.3) %}
            {{ [temp, 20] | max | round(1) }}
          {% endif %}

      - name: "cumulus_litres_disponibles_estimes"
        unique_id: cumulus_litres_disponibles_estimes
        unit_of_measurement: "L"
        icon: mdi:water
        # Proportion lin√©aire selon temp√©rature (58¬∞C = 100%, 20¬∞C = 0%)
        state: >-
          {% set temp = states('sensor.cumulus_temperature_estimee') | float(20) %}
          {% set capacite = states('input_number.cumulus_capacite_litres') | float(300) %}
          {% set ratio = ((temp - 20) / 38) | float(0) %}
          {{ (capacite * ratio) | round(0) }}

  # --------------------------- BINARY SENSORS ----------------------------- #
  - binary_sensor:

      - name: "cumulus_lave_linge_actif"
        unique_id: cumulus_lave_linge_actif
        device_class: running
        icon: mdi:washing-machine
        state: >-
          {% set entity = states('input_text.cumulus_entity_lave_linge_power') %}
          {% set power = states(entity) | float(0) %}
          {% set seuil = states('input_number.cumulus_seuil_appareil_actif_w') | float(10) %}
          {{ power > seuil }}

      - name: "cumulus_lave_vaisselle_actif"
        unique_id: cumulus_lave_vaisselle_actif
        device_class: running
        icon: mdi:dishwasher
        state: >-
          {% set entity = states('input_text.cumulus_entity_lave_vaisselle_power') %}
          {% set power = states(entity) | float(0) %}
          {% set seuil = states('input_number.cumulus_seuil_appareil_actif_w') | float(10) %}
          {{ power > seuil }}

      - name: "cumulus_appareil_en_cours"
        unique_id: cumulus_appareil_en_cours
        icon: mdi:home-lightning-bolt-outline
        state: >-
          {{ is_state('binary_sensor.cumulus_lave_linge_actif', 'on')
             or is_state('binary_sensor.cumulus_lave_vaisselle_actif', 'on') }}

      - name: "cumulus_fenetre_pv"
        unique_id: cumulus_fenetre_pv
        state: >-
          {% set d = states('input_datetime.cumulus_plage_pv_debut') %}
          {% set f = states('input_datetime.cumulus_plage_pv_fin') %}
          {% set nowt = now().strftime('%H:%M:%S') %}
          {{ d <= nowt <= f }}

      - name: "cumulus_en_hc"
        unique_id: cumulus_en_hc
        state: >-
          {% set d = states('input_datetime.cumulus_heures_creuses_debut') %}
          {% set f = states('input_datetime.cumulus_heures_creuses_fin') %}
          {% set nowt = now().strftime('%H:%M:%S') %}
          {{ d <= nowt <= f }}

      - name: "cumulus_deadband_actif"
        unique_id: cumulus_deadband_actif
        state: >-
          {{ is_state('timer.cumulus_deadband_ui', 'active') }}

      - name: "cumulus_chauffe_reelle"
        unique_id: cumulus_chauffe_reelle
        # "vrai" si import > seuil_fin + hyst√©r√©sis ET contacteur ON
        state: >-
          {% set sw_id = states('input_text.cumulus_entity_contacteur') | string %}
          {% if sw_id not in ['unknown', 'unavailable', ''] %}
            {% set sw = is_state(sw_id, 'on') %}
            {% set imp = states('sensor.cumulus_import_reseau_w') | float(0) %}
            {% set seuil = states('sensor.cumulus_seuil_fin_chauffe_w') | float(0) %}
            {% set HYS = 50 %}
            {{ sw and (imp > (seuil + HYS)) }}
          {% else %}
            false
          {% endif %}

      - name: "cumulus_fini_par_import"
        unique_id: cumulus_fini_par_import
        # fin d√©tect√©e quand contacteur ON mais import <= seuil_fin
        state: >-
          {% set sw_id = states('input_text.cumulus_entity_contacteur') | string %}
          {% if sw_id not in ['unknown', 'unavailable', ''] %}
            {% set sw = is_state(sw_id, 'on') %}
            {% set imp = states('sensor.cumulus_import_reseau_w') | float(0) %}
            {% set seuil = states('sensor.cumulus_seuil_fin_chauffe_w') | float(0) %}
            {{ sw and (imp <= seuil) }}
          {% else %}
            false
          {% endif %}

      - name: "cumulus_on_hc_prevu"
        unique_id: cumulus_on_hc_prevu
        # simplifi√© : ON pr√©vu si en HC et non interdit/vacances/verrou
        state: >-
          {{ is_state('binary_sensor.cumulus_en_hc','on')
             and is_state('input_boolean.cumulus_interdit','off')
             and is_state('input_boolean.cumulus_vacances','off')
             and is_state('input_boolean.cumulus_verrou_jour','off') }}

      - name: "cumulus_besoin_chauffe_urgente"
        unique_id: cumulus_besoin_chauffe_urgente
        # Besoin urgent si heures √©coul√©es > espacement max
        state: >-
          {% set heures = states('sensor.cumulus_heures_depuis_derniere_chauffe') | float(0) %}
          {% set max_h = states('input_number.cumulus_espacement_max_h') | float(50) %}
          {{ heures >= max_h }}

      - name: "cumulus_meteo_favorable_aujourdhui"
        unique_id: cumulus_meteo_favorable_aujourdhui
        state: >-
          {% set today = states('sensor.cumulus_solcast_forecast_today') | float(0) %}
          {% set seuil = states('input_number.cumulus_seuil_solcast_bon_kwh') | float(8) %}
          {{ today >= seuil }}

      - name: "cumulus_meteo_favorable_demain"
        unique_id: cumulus_meteo_favorable_demain
        state: >-
          {% set tomorrow = states('sensor.cumulus_solcast_forecast_tomorrow') | float(0) %}
          {% set seuil = states('input_number.cumulus_seuil_solcast_bon_kwh') | float(8) %}
          {{ tomorrow >= seuil }}

      - name: "cumulus_autoriser_chauffe_hc_intelligente"
        unique_id: cumulus_autoriser_chauffe_hc_intelligente
        # Autorise HC seulement si :
        # - Autorisation manuelle HC active
        # - ET (besoin urgent OU m√©t√©o d√©favorable demain)
        state: >-
          {% set autoriser = is_state('input_boolean.cumulus_autoriser_hc', 'on') %}
          {% set urgent = is_state('binary_sensor.cumulus_besoin_chauffe_urgente', 'on') %}
          {% set mauvais_demain = is_state('binary_sensor.cumulus_meteo_favorable_demain', 'off') %}
          {{ autoriser and (urgent or mauvais_demain) }}

# ================================ AUTOMATIONS ============================== #
automation:

  # 1) D√©marrage PV simple
  - id: ce_on_pv_simple
    alias: Cumulus ‚Äî ON sur PV (simple)
    description: "D√©marre quand la prod PV d√©passe le seuil pendant cumulus_on_delay_s."
    trigger:
      # On d√©clenche quand PV > seuil (utilise un gabarit pour pouvoir lire l'input_number)
      - platform: template
        value_template: >-
          {{ states('sensor.cumulus_pv_power_w')|float(0)
             > states('input_number.cumulus_seuil_pv_on_w')|float(100) }}
        for:
          seconds: >-
            {{ states('input_number.cumulus_on_delay_s')|int(0) }}
    condition:
      - condition: or
        conditions:
          - condition: state
            entity_id: input_boolean.cumulus_override
            state: "on"
          - condition: and
            conditions:
              - condition: template
                value_template: >-
                  {{ states('sensor.cumulus_pv_power_w')|float(0)
                     > states('input_number.cumulus_seuil_pv_on_w')|float(100) }}
              - condition: state
                entity_id: binary_sensor.cumulus_fenetre_pv
                state: "on"
              - condition: state
                entity_id: input_boolean.cumulus_interdit
                state: "off"
              - condition: state
                entity_id: input_boolean.cumulus_vacances
                state: "off"
              - condition: state
                entity_id: input_boolean.cumulus_verrou_jour
                state: "off"
              - condition: state
                entity_id: binary_sensor.cumulus_appareil_en_cours
                state: "off"
              - condition: template
                # SOC ‚â• start - 0,5 pt
                value_template: >-
                  {% set soc = states('sensor.cumulus_soc_solarbank_pct')|float(0) %}
                  {{
                    soc
                    >= (states('input_number.cumulus_soc_start_pct')|float(25) - 0.5)
                  }}
    action:
      - variables:
          sw_id: "{{ states('input_text.cumulus_entity_contacteur') }}"
          threshold_w: >-
            {{ states('input_number.cumulus_seuil_pv_on_w')|float(100) }}
          db_s: >-
            {% set delay = states('input_number.cumulus_on_delay_s')|int(0) %}
            {{ (states('input_number.cumulus_mini_deadband_no_delay_s')|int(5))
               if delay <= 0
               else (states('input_number.cumulus_deadband_s')|int(100)) }}
      - if:
          # Abandonne le d√©marrage si la production est retomb√©e sous le seuil
          # pendant le d√©lai de confirmation.
          - condition: template
            value_template: >-
              {{ states('sensor.cumulus_pv_power_w')|float(0)
                 <= (threshold_w | float(100)) }}
        then:
          - stop: "PV repasse sous le seuil avant l'action"
      - choose:
          - conditions:
              - condition: template
                value_template: "{{ is_state(sw_id, 'off') }}"
              - condition: template
                value_template: >-
                  {{ states('sensor.cumulus_pv_power_w')|float(0)
                     > (threshold_w | float(100)) }}
            sequence:
              - service: switch.turn_on
                target:
                  entity_id: "{{ sw_id }}"
              - service: timer.start
                target:
                  entity_id: timer.cumulus_deadband_ui
                data:
                  duration:
                    seconds: "{{ db_s|int }}"
        default: []
    mode: single

  # 2) Limiteur d'import : coupe si import trop haut pendant ‚â•8 s
  - id: cumulus_limiteur_import
    alias: Cumulus ‚Äî Limiteur d'import
    trigger:
      - platform: template
        value_template: >-
          {{ states('sensor.cumulus_import_reseau_w')|float(0)
             > states('sensor.cumulus_seuil_import_limiteur_w')|float(0) }}
        for:
          seconds: 8
    condition:
      - condition: state
        entity_id: binary_sensor.cumulus_chauffe_reelle
        state: "on"
      - condition: state
        entity_id: input_boolean.cumulus_interdit
        state: "off"
    action:
      - variables:
          sw_id: "{{ states('input_text.cumulus_entity_contacteur') }}"
          db_s: >-
            {{ (states('input_number.cumulus_mini_deadband_no_delay_s')|int(5))
               if (states('input_number.cumulus_on_delay_s')|int(0)) <= 0
               else (states('input_number.cumulus_deadband_s')|int(100)) }}
      - service: switch.turn_off
        target:
          entity_id: "{{ sw_id }}"
      - service: timer.start
        target:
          entity_id: timer.cumulus_deadband_ui
        data:
          duration:
            seconds: "{{ db_s|int }}"
    mode: restart

  # 3) S√©curit√© SOC bas : OFF si SOC < stop (%) pendant 10 s
  - id: cumulus_securite_soc_bas
    alias: Cumulus ‚Äî S√©curit√© SOC bas
    trigger:
      - platform: template
        value_template: >-
          {% set soc = states('sensor.cumulus_soc_solarbank_pct')|float(0) %}
          {{
            soc
            < states('input_number.cumulus_soc_stop_pct')|float(15)
          }}
        for:
          seconds: 10
    action:
      - variables:
          sw_id: "{{ states('input_text.cumulus_entity_contacteur') }}"
          db_s: >-
            {{ (states('input_number.cumulus_mini_deadband_no_delay_s')|int(5))
               if (states('input_number.cumulus_on_delay_s')|int(0)) <= 0
               else (states('input_number.cumulus_deadband_s')|int(100)) }}
      - service: switch.turn_off
        target:
          entity_id: "{{ sw_id }}"
      - service: timer.start
        target:
          entity_id: timer.cumulus_deadband_ui
        data:
          duration:
            seconds: "{{ db_s|int }}"
    mode: restart

  # 4) D√©tection fin de chauffe par import
  - id: cumulus_fin_detectee_par_import
    alias: Cumulus ‚Äî Fin d√©tect√©e par import (OFF + verrou + tag du jour)
    trigger:
      - platform: state
        entity_id: binary_sensor.cumulus_fini_par_import
        to: "on"
        for:
          seconds: 5
    condition:
      - condition: state
        entity_id: input_boolean.cumulus_interdit
        state: "off"
    action:
      - variables:
          sw_id: "{{ states('input_text.cumulus_entity_contacteur') }}"
      - if:
          - condition: template
            value_template: "{{ is_state(sw_id, 'on') }}"
        then:
          - service: switch.turn_off
            target:
              entity_id: "{{ sw_id }}"
      - service: input_boolean.turn_on
        target:
          entity_id: input_boolean.cumulus_verrou_jour
      - service: input_boolean.turn_on
        target:
          entity_id: input_boolean.temp_atteinte_aujourdhui
      - service: input_datetime.set_datetime
        target:
          entity_id: input_datetime.cumulus_derniere_chauffe_complete
        data:
          datetime: "{{ now().isoformat() }}"
    mode: restart

  # 5) ON au d√©but des HC si pr√©vu (LOGIQUE INTELLIGENTE)
  - id: cumulus_on_debut_hc_si_prevu
    alias: Cumulus ‚Äî ON d√©but HC si pr√©vu (intelligent)
    trigger:
      - platform: state
        entity_id: binary_sensor.cumulus_en_hc
        to: "on"
    condition:
      - condition: or
        conditions:
          - condition: state
            entity_id: input_boolean.cumulus_override
            state: "on"
          - condition: and
            conditions:
              - condition: state
                entity_id: input_boolean.cumulus_interdit
                state: "off"
              - condition: state
                entity_id: input_boolean.cumulus_vacances
                state: "off"
              - condition: state
                entity_id: input_boolean.cumulus_verrou_jour
                state: "off"
              - condition: state
                entity_id: binary_sensor.cumulus_autoriser_chauffe_hc_intelligente
                state: "on"
    action:
      - variables:
          sw_id: "{{ states('input_text.cumulus_entity_contacteur') }}"
          db_s: >-
            {{ (states('input_number.cumulus_mini_deadband_no_delay_s')|int(5))
               if (states('input_number.cumulus_on_delay_s')|int(0)) <= 0
               else (states('input_number.cumulus_deadband_s')|int(100)) }}
      - service: switch.turn_on
        target:
          entity_id: "{{ sw_id }}"
      - service: timer.start
        target:
          entity_id: timer.cumulus_deadband_ui
        data:
          duration:
            seconds: "{{ db_s|int }}"
    mode: single

  # 6) OFF √† la fin des HC
  - id: cumulus_off_fin_hc
    alias: Cumulus ‚Äî OFF fin HC
    trigger:
      - platform: state
        entity_id: binary_sensor.cumulus_en_hc
        to: "off"
    action:
      - variables:
          sw_id: "{{ states('input_text.cumulus_entity_contacteur') }}"
      - service: switch.turn_off
        target:
          entity_id: "{{ sw_id }}"
    mode: single

  # 7) Reset du tag "temp atteinte" chaque jour (apr√®s fin HC)
  - id: cumulus_reset_daily_flags
    alias: Cumulus ‚Äî Reset journalier (apr√®s HC)
    trigger:
      - platform: time
        at: "08:10:00"
    action:
      - service: input_boolean.turn_off
        target:
          entity_id: input_boolean.temp_atteinte_aujourdhui
      - service: input_boolean.turn_off
        target:
          entity_id: input_boolean.cumulus_verrou_jour
    mode: single

  # 8) Notification : Pas de chauffe depuis 48h
  - id: cumulus_alerte_pas_chauffe_48h
    alias: Cumulus ‚Äî Alerte pas de chauffe 48h
    trigger:
      - platform: numeric_state
        entity_id: sensor.cumulus_heures_depuis_derniere_chauffe
        above: 48
    condition:
      - condition: state
        entity_id: input_boolean.cumulus_vacances
        state: "off"
    action:
      - service: persistent_notification.create
        data:
          title: "‚ö†Ô∏è Cumulus - Alerte"
          message: >
            Le cumulus n'a pas chauff√© depuis {{ states('sensor.cumulus_heures_depuis_derniere_chauffe') }}h.
            Temp√©rature estim√©e : {{ states('sensor.cumulus_temperature_estimee') }}¬∞C
            Eau chaude disponible : {{ states('sensor.cumulus_litres_disponibles_estimes') }}L
          notification_id: cumulus_alerte_48h
    mode: single

  # 9) Notification : Besoin chauffe urgente
  - id: cumulus_alerte_besoin_urgent
    alias: Cumulus ‚Äî Alerte besoin urgent
    trigger:
      - platform: state
        entity_id: binary_sensor.cumulus_besoin_chauffe_urgente
        to: "on"
        for:
          hours: 1
    condition:
      - condition: state
        entity_id: input_boolean.cumulus_vacances
        state: "off"
    action:
      - service: persistent_notification.create
        data:
          title: "üî¥ Cumulus - Chauffe urgente n√©cessaire"
          message: >
            Le d√©lai maximum de {{ states('input_number.cumulus_espacement_max_h') }}h est d√©pass√©.
            Derni√®re chauffe : {{ states('input_datetime.cumulus_derniere_chauffe_complete') }}
            Temp√©rature estim√©e : {{ states('sensor.cumulus_temperature_estimee') }}¬∞C

            Action recommand√©e : activer l'override manuel si n√©cessaire.
          notification_id: cumulus_alerte_urgent
    mode: single

  # 10) Notification : Import anormal pendant chauffe PV
  - id: cumulus_alerte_import_anormal
    alias: Cumulus ‚Äî Alerte import anormal
    trigger:
      - platform: numeric_state
        entity_id: sensor.cumulus_import_reseau_w
        above: 1500
        for:
          minutes: 5
    condition:
      - condition: state
        entity_id: binary_sensor.cumulus_chauffe_reelle
        state: "on"
      - condition: state
        entity_id: binary_sensor.cumulus_fenetre_pv
        state: "on"
    action:
      - service: persistent_notification.create
        data:
          title: "‚ö†Ô∏è Cumulus - Import √©lev√©"
          message: >
            Import r√©seau √©lev√© ({{ states('sensor.cumulus_import_reseau_w') }}W) pendant chauffe PV.
            Production PV : {{ states('sensor.cumulus_pv_power_w') }}W
            SOC batterie : {{ states('sensor.cumulus_soc_solarbank_pct') }}%
          notification_id: cumulus_import_anormal
    mode: single

  # 11) Notification : Chauffe compl√®te termin√©e
  - id: cumulus_notification_chauffe_complete
    alias: Cumulus ‚Äî Notification chauffe compl√®te
    trigger:
      - platform: state
        entity_id: input_boolean.temp_atteinte_aujourdhui
        to: "on"
    action:
      - service: persistent_notification.create
        data:
          title: "‚úÖ Cumulus - Chauffe termin√©e"
          message: >
            Chauffe compl√®te termin√©e √† {{ now().strftime('%H:%M') }}.
            Temp√©rature : 58¬∞C (estim√©e)
            Capacit√© disponible : {{ states('input_number.cumulus_capacite_litres') }}L
          notification_id: cumulus_chauffe_ok
    mode: single

  # 12) Arr√™t cumulus si appareil d√©marre
  - id: cumulus_arret_si_appareil_demarre
    alias: Cumulus ‚Äî Arr√™t si appareil d√©marre
    trigger:
      - platform: state
        entity_id: binary_sensor.cumulus_appareil_en_cours
        to: "on"
    condition:
      - condition: state
        entity_id: binary_sensor.cumulus_chauffe_reelle
        state: "on"
    action:
      - variables:
          sw_id: "{{ states('input_text.cumulus_entity_contacteur') }}"
          appareil_actif: >-
            {% if is_state('binary_sensor.cumulus_lave_linge_actif', 'on') %}
              Lave-linge
            {% elif is_state('binary_sensor.cumulus_lave_vaisselle_actif', 'on') %}
              Lave-vaisselle
            {% else %}
              Un appareil
            {% endif %}
      - service: switch.turn_off
        target:
          entity_id: "{{ sw_id }}"
      - service: input_boolean.turn_on
        target:
          entity_id: input_boolean.cumulus_verrou_jour
      - service: persistent_notification.create
        data:
          title: "‚ö†Ô∏è Cumulus - Arr√™t prioritaire"
          message: >
            {{ appareil_actif }} a d√©marr√©.
            Le cumulus a √©t√© arr√™t√© pour √©viter la surcharge.
          notification_id: cumulus_arret_appareil
    mode: single

  # 13) Red√©marrage cumulus si appareil s'arr√™te
  - id: cumulus_redemarrage_si_appareil_arrete
    alias: Cumulus ‚Äî Red√©marrage si appareil s'arr√™te
    trigger:
      - platform: state
        entity_id: binary_sensor.cumulus_appareil_en_cours
        to: "off"
        for:
          seconds: 30
    condition:
      - condition: state
        entity_id: input_boolean.cumulus_verrou_jour
        state: "on"
      - condition: state
        entity_id: input_boolean.temp_atteinte_aujourdhui
        state: "off"
      - condition: state
        entity_id: input_boolean.cumulus_interdit
        state: "off"
      - condition: state
        entity_id: input_boolean.cumulus_vacances
        state: "off"
      - condition: state
        entity_id: binary_sensor.cumulus_fenetre_pv
        state: "on"
    action:
      - service: input_boolean.turn_off
        target:
          entity_id: input_boolean.cumulus_verrou_jour
      - service: persistent_notification.create
        data:
          title: "üîÑ Cumulus - Verrou lev√©"
          message: >
            Les appareils se sont arr√™t√©s.
            Le verrou journalier a √©t√© lev√©, le cumulus peut red√©marrer si les conditions PV sont r√©unies.
          notification_id: cumulus_verrou_leve
    mode: single

