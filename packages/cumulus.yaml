###############################################################################
# CUMULUS — ROUTEUR SOLAIRE v2025-10-16a (PRODUCTION READY)
#
# Package complet pour pilotage intelligent cumulus électrique
# Maximise autoconsommation PV tout en garantissant eau chaude quotidienne
#
# CORRECTIFS v2025-10-16a :
# - ✅ FIX CRITIQUE : Détection fin de chauffe UNIVERSELLE
#   → Détecte fin de chauffe PV, HC ET manuelle (app Shelly)
#   → Fonctionne même si switch éteint avant fin de chauffe
#   → Durée minimale réduite à 60s (au lieu de 180s)
# - ✅ FIX : Automation "OFF fin HC" simplifiée
#   → Laisse l'automation universelle gérer la détection température max
#   → Évite conflit entre automations
# - ✅ NEW : Automation "Détection chauffe externe"
#   → Notifie les démarrages manuels via app Shelly
#   → Permet suivi des chauffes externes
# - ✅ Production solaire totale = APS × 2
# - ✅ Puissance disponible = 1200W (SB) + APS (si SOC ≥ 10%)
# - ✅ SolarBank délivre 1200W fixes de 10% à 100% SOC
###############################################################################

# ============================= ENTITÉS PARAMÉTRABLES ======================= #
input_text:
  cumulus_entity_import_w:
    name: "ENTITÉ - Import réseau (W)"
    icon: mdi:transmission-tower-import
    initial: sensor.smart_meter_grid_import

  cumulus_entity_contacteur:
    name: "ENTITÉ - Contacteur cumulus (switch)"
    icon: mdi:water-boiler
    initial: switch.shellypro1_ece334ee1b64

  cumulus_entity_soc_solarbank:
    name: "ENTITÉ - SOC Solarbank (%)"
    icon: mdi:battery
    initial: sensor.system_sanguinet_etat_de_charge_du_sb

  cumulus_entity_pv_total:
    name: "ENTITÉ - PV total SB+APS (W)"
    icon: mdi:solar-power
    initial: sensor.pv_total_entree_sb_aps_w

  cumulus_entity_solcast_today:
    name: "ENTITÉ - Prévision Solcast aujourd'hui (kWh)"
    icon: mdi:weather-sunny-alert
    initial: sensor.solcast_pv_forecast_previsions_pour_aujourd_hui

  cumulus_entity_solcast_tomorrow:
    name: "ENTITÉ - Prévision Solcast demain (kWh)"
    icon: mdi:weather-sunny
    initial: sensor.solcast_pv_forecast_previsions_pour_demain

  cumulus_entity_lave_linge_power:
    name: "ENTITÉ - Puissance lave-linge (W)"
    icon: mdi:washing-machine
    initial: sensor.lave_linge_power

  cumulus_entity_lave_vaisselle_power:
    name: "ENTITÉ - Puissance lave-vaisselle (W)"
    icon: mdi:dishwasher
    initial: sensor.lave_vaisselle_power

# ============================ AIDES / RÉGLAGES ============================ #
input_number:
  cumulus_seuil_pv_statique_w:
    name: "Seuil PV statique pour démarrage (W)"
    min: 0
    max: 5000
    step: 10
    mode: slider
    unit_of_measurement: W
    icon: mdi:white-balance-sunny
    initial: 100

  cumulus_on_delay_s:
    name: "Délai de confirmation ON (s)"
    min: 0
    max: 300
    step: 1
    mode: slider
    unit_of_measurement: s
    icon: mdi:timer-play
    initial: 10

  cumulus_deadband_min:
    name: "Deadband entre tentatives (min)"
    min: 1
    max: 30
    step: 1
    unit_of_measurement: min
    icon: mdi:progress-clock
    initial: 5

  cumulus_talon_maison_w:
    name: "Talon maison (W)"
    min: 0
    max: 1000
    step: 10
    unit_of_measurement: W
    icon: mdi:home-lightning-bolt
    initial: 300

  cumulus_marge_import_w:
    name: "Marge import limiteur (W)"
    min: 0
    max: 3000
    step: 10
    unit_of_measurement: W
    icon: mdi:flash-alert
    initial: 100

  cumulus_solarbank_max_w:
    name: "Puissance max Solarbank (W)"
    min: 0
    max: 2000
    step: 10
    unit_of_measurement: W
    icon: mdi:battery-charging-100
    initial: 1200

  cumulus_aps_max_w:
    name: "Puissance max APS (W)"
    min: 0
    max: 2000
    step: 10
    unit_of_measurement: W
    icon: mdi:solar-power
    initial: 960

  cumulus_soc_min_pct:
    name: "SOC mini démarrage (%)"
    min: 0
    max: 100
    step: 0.5
    unit_of_measurement: "%"
    icon: mdi:battery-70
    initial: 10

  cumulus_soc_stop_pct:
    name: "SOC arrêt sécurité (%)"
    min: 0
    max: 100
    step: 0.5
    unit_of_measurement: "%"
    icon: mdi:battery-alert-variant-outline
    initial: 5

  cumulus_puissance_w:
    name: "Puissance cumulus (W)"
    min: 0
    max: 5000
    step: 10
    unit_of_measurement: W
    icon: mdi:lightning-bolt
    initial: 3000

  cumulus_espacement_max_h:
    name: "Espacement maxi entre chauffes (h)"
    min: 24
    max: 72
    step: 1
    unit_of_measurement: h
    icon: mdi:timer-sand
    initial: 50

  cumulus_seuil_solcast_bon_kwh:
    name: "Seuil Solcast bonne journée (kWh)"
    min: 0
    max: 50
    step: 0.5
    unit_of_measurement: kWh
    icon: mdi:white-balance-sunny
    initial: 8

  cumulus_nb_personnes:
    name: "Nombre de personnes au foyer"
    min: 1
    max: 10
    step: 1
    icon: mdi:account-multiple
    initial: 2

  cumulus_capacite_litres:
    name: "Capacité du ballon (L)"
    min: 50
    max: 500
    step: 10
    unit_of_measurement: L
    icon: mdi:water-boiler
    initial: 300

  cumulus_seuil_appareil_actif_w:
    name: "Seuil appareil actif (W)"
    min: 5
    max: 100
    step: 5
    unit_of_measurement: W
    icon: mdi:flash-outline
    initial: 10

  cumulus_import_demarrage_max_w:
    name: "Import max autorisé au démarrage (W)"
    min: 0
    max: 2000
    step: 50
    mode: slider
    unit_of_measurement: W
    icon: mdi:transmission-tower-import
    initial: 800

  # ========== Caractéristiques techniques constructeur ==========
  cumulus_temperature_max_c:
    name: "Température maximale (°C)"
    min: 50
    max: 75
    step: 1
    initial: 65
    unit_of_measurement: "°C"
    icon: mdi:thermometer-high

  cumulus_temperature_ambiante_c:
    name: "Température ambiante moyenne (°C)"
    min: 10
    max: 30
    step: 1
    initial: 20
    unit_of_measurement: "°C"
    icon: mdi:thermometer

  cumulus_constante_refroidissement:
    name: "Constante de refroidissement (1/h)"
    min: 0.002
    max: 0.030
    step: 0.0005
    initial: 0.0075
    icon: mdi:thermometer-lines

  cumulus_consommation_entretien_kwh:
    name: "Consommation d'entretien (kWh/24h)"
    min: 0
    max: 5
    step: 0.01
    initial: 2.41
    unit_of_measurement: "kWh"
    icon: mdi:lightning-bolt-outline

  cumulus_temps_chauffe_complet_h:
    name: "Temps de chauffe complet (h)"
    min: 3
    max: 10
    step: 0.01
    initial: 6.23
    unit_of_measurement: "h"
    icon: mdi:timer

  cumulus_capacite_mitigee_40c_litres:
    name: "Capacité eau mitigée 40°C (L)"
    min: 300
    max: 700
    step: 1
    initial: 559
    unit_of_measurement: "L"
    icon: mdi:water-thermometer

  cumulus_marge_secu_pv:
    name: "Marge sécurité PV dynamique"
    min: 1.0
    max: 2.0
    step: 0.05
    initial: 1.2
    icon: mdi:shield-check

input_boolean:
  cumulus_interdit_depart:
    name: "Interdit départ (sécurité/maintenance)"
    icon: mdi:hand-back-right-off

  cumulus_mode_vacances:
    name: "Mode vacances (pas de chauffe)"
    icon: mdi:beach

  cumulus_verrou_jour:
    name: "Verrou jour (température max atteinte)"
    icon: mdi:lock-check

  cumulus_override:
    name: "Forçage manuel"
    icon: mdi:hand-pointing-up

  cumulus_temp_atteinte_aujourdhui:
    name: "Température atteinte aujourd'hui"
    icon: mdi:thermometer-check

  cumulus_autoriser_hc:
    name: "Autoriser chauffes en heures creuses"
    icon: mdi:clock-time-eight
    initial: true

input_datetime:
  cumulus_plage_pv_debut:
    name: "Fenêtre PV - début"
    has_date: false
    has_time: true
    initial: "10:20:00"

  cumulus_plage_pv_fin:
    name: "Fenêtre PV - fin"
    has_date: false
    has_time: true
    initial: "17:50:00"

  cumulus_heures_creuses_debut:
    name: "Heures creuses - début"
    has_date: false
    has_time: true
    initial: "03:30:00"

  cumulus_heures_creuses_fin:
    name: "Heures creuses - fin"
    has_date: false
    has_time: true
    initial: "08:05:00"

  cumulus_derniere_chauffe_complete:
    name: "Dernière chauffe complète"
    has_date: true
    has_time: true

  cumulus_debut_chauffe_actuelle:
    name: "Début chauffe actuelle"
    has_date: true
    has_time: true

input_text:
  cumulus_raison_deadband:
    name: "Raison du dernier deadband"
    icon: mdi:timer-alert-outline
    max: 255
    initial: "Aucun"

  cumulus_historique_chauffes:
    name: "Historique des 10 dernières chauffes"
    icon: mdi:history
    max: 255
    initial: "[]"

timer:
  cumulus_deadband_ui:
    name: "Temporisation deadband"
    duration: "00:05:00"

# ================================ TEMPLATES ================================ #
template:
  # ------------------------------- SENSORS --------------------------------- #
  - sensor:
      # ========== PROXY SENSORS (lecture entités configurables) ==========
      - name: "cumulus_import_reseau_w"
        unique_id: cumulus_import_reseau_w
        unit_of_measurement: "W"
        device_class: power
        state_class: measurement
        state: >-
          {% set e = states('input_text.cumulus_entity_import_w') %}
          {% if e in ['unknown', 'unavailable', ''] %}
            0
          {% else %}
            {{ states(e) | float(0) }}
          {% endif %}

      - name: "cumulus_soc_solarbank_pct"
        unique_id: cumulus_soc_solarbank_pct
        unit_of_measurement: "%"
        device_class: battery
        state_class: measurement
        state: >-
          {% set e = states('input_text.cumulus_entity_soc_solarbank') %}
          {% if e in ['unknown', 'unavailable', ''] %}
            0
          {% else %}
            {{ states(e) | float(0) }}
          {% endif %}

      - name: "cumulus_pv_power_w"
        unique_id: cumulus_pv_power_w
        unit_of_measurement: "W"
        device_class: power
        state_class: measurement
        state: >-
          {% set e = states('input_text.cumulus_entity_pv_total') %}
          {% if e in ['unknown', 'unavailable', ''] %}
            0
          {% else %}
            {{ states(e) | float(0) }}
          {% endif %}

      - name: "cumulus_solcast_forecast_today"
        unique_id: cumulus_solcast_forecast_today
        unit_of_measurement: "kWh"
        device_class: energy
        state: >-
          {% set e = states('input_text.cumulus_entity_solcast_today') %}
          {% if e in ['unknown', 'unavailable', ''] %}
            0
          {% else %}
            {{ states(e) | float(0) }}
          {% endif %}

      - name: "cumulus_solcast_forecast_tomorrow"
        unique_id: cumulus_solcast_forecast_tomorrow
        unit_of_measurement: "kWh"
        device_class: energy
        state: >-
          {% set e = states('input_text.cumulus_entity_solcast_tomorrow') %}
          {% if e in ['unknown', 'unavailable', ''] %}
            0
          {% else %}
            {{ states(e) | float(0) }}
          {% endif %}

      # ========== CONSOMMATION CUMULUS (formule universelle) ==========
      - name: "cumulus_consommation_reelle_w"
        unique_id: cumulus_consommation_reelle_w
        unit_of_measurement: "W"
        device_class: power
        state_class: measurement
        icon: mdi:lightning-bolt-circle
        state: >-
          {% set sw_id = states('input_text.cumulus_entity_contacteur') %}
          {% if sw_id in ['', 'unknown', 'unavailable'] or states(sw_id) not in ['on', 'off'] %}
            0
          {% elif states(sw_id) == 'off' %}
            0
          {% else %}
            {# Formule universelle : Conso_cumulus = (Import + PV_total) - Talon #}
            {% set import_w = states('sensor.cumulus_import_reseau_w') | float(0) %}
            {% set pv_total_w = states('sensor.cumulus_pv_power_w') | float(0) %}
            {% set talon = states('input_number.cumulus_talon_maison_w') | float(300) %}
            {% set conso_cumulus = (import_w + pv_total_w) - talon %}
            {# Borner entre 0 et puissance max #}
            {% set puissance_max = states('input_number.cumulus_puissance_w') | float(3000) %}
            {{ [[0, conso_cumulus] | max, puissance_max] | min | round(0) }}
          {% endif %}
        attributes:
          import_w: "{{ states('sensor.cumulus_import_reseau_w') }}"
          pv_total_w: "{{ states('sensor.cumulus_pv_power_w') }}"
          talon_w: "{{ states('input_number.cumulus_talon_maison_w') }}"
          formule: "Conso = (Import + PV_total) - Talon"
          explication: >-
            Fonctionne avec toute répartition SB/APS.
            Gère automatiquement export (import négatif).

      # ========== RÉPARTITION SOURCES TEMPS RÉEL ==========
      - name: "cumulus_repartition_sources"
        unique_id: cumulus_repartition_sources
        icon: mdi:chart-donut
        state: >-
          {% if is_state('binary_sensor.cumulus_chauffe_reelle', 'off') %}
            Arrêt
          {% else %}
            {% set conso = states('sensor.cumulus_consommation_reelle_w') | float(0) %}
            {% set import_w = states('sensor.cumulus_import_reseau_w') | float(0) %}
            {% set pv_w = states('sensor.cumulus_pv_power_w') | float(0) %}
            {% set talon = states('input_number.cumulus_talon_maison_w') | float(300) %}
            {% set pv_vers_cumulus = [0, (pv_w - talon)] | max %}
            {% if import_w < 0 %}
              PV:{{ pv_vers_cumulus|round }}W ({{ ((pv_vers_cumulus/conso)*100)|round if conso > 0 else 0 }}%), Export:{{ (-import_w)|round }}W
            {% else %}
              PV:{{ pv_vers_cumulus|round }}W ({{ ((pv_vers_cumulus/conso)*100)|round if conso > 0 else 0 }}%), Reseau:{{ import_w|round }}W ({{ ((import_w/conso)*100)|round if conso > 0 else 0 }}%)
            {% endif %}
          {% endif %}
        attributes:
          consommation_cumulus_w: "{{ states('sensor.cumulus_consommation_reelle_w') }}"
          contribution_pv_w: >-
            {% if is_state('binary_sensor.cumulus_chauffe_reelle', 'on') %}
              {% set pv = states('sensor.cumulus_pv_power_w') | float(0) %}
              {% set talon = states('input_number.cumulus_talon_maison_w') | float(300) %}
              {{ [0, (pv - talon)] | max | round(0) }}
            {% else %}
              0
            {% endif %}
          contribution_reseau_w: >-
            {% if is_state('binary_sensor.cumulus_chauffe_reelle', 'on') %}
              {{ [0, states('sensor.cumulus_import_reseau_w') | float(0)] | max | round(0) }}
            {% else %}
              0
            {% endif %}
          export_w: >-
            {% if is_state('binary_sensor.cumulus_chauffe_reelle', 'on') %}
              {{ [0, -(states('sensor.cumulus_import_reseau_w') | float(0))] | max | round(0) }}
            {% else %}
              0
            {% endif %}
          autonomie_pv_pct: >-
            {% if is_state('binary_sensor.cumulus_chauffe_reelle', 'on') %}
              {% set conso = states('sensor.cumulus_consommation_reelle_w') | float(1) %}
              {% set pv = states('sensor.cumulus_pv_power_w') | float(0) %}
              {% set talon = states('input_number.cumulus_talon_maison_w') | float(300) %}
              {% set pv_vers_cumulus = [0, (pv - talon)] | max %}
              {{ ((pv_vers_cumulus / conso) * 100) | round(0) if conso > 0 else 0 }}
            {% else %}
              0
            {% endif %}

      # ========== SEUILS & CALCULS ==========
      - name: "cumulus_seuil_import_limiteur_w"
        unique_id: cumulus_seuil_import_limiteur_w
        unit_of_measurement: "W"
        device_class: power
        state_class: measurement
        icon: mdi:speedometer
        state: >-
          {% set import_max = states('input_number.cumulus_import_demarrage_max_w') | float(800) %}
          {% set marge_securite = 300 %}
          {{ (import_max + marge_securite) | int }}
        attributes:
          calcul: "Import max autorisé + 300W de marge sécurité"
          detail: >-
            Si import_max = 800W, seuil limiteur = 1100W.
            Le limiteur coupe si import > 1100W pendant 4 secondes.

      - name: "cumulus_heures_depuis_derniere_chauffe"
        unique_id: cumulus_heures_depuis_derniere_chauffe
        unit_of_measurement: "h"
        icon: mdi:clock-outline
        state: >-
          {% set last_ts = state_attr('input_datetime.cumulus_derniere_chauffe_complete', 'timestamp') %}
          {% if last_ts is none or last_ts == 0 %}
            999
          {% else %}
            {{ ((now().timestamp() - last_ts) / 3600) | round(1) }}
          {% endif %}

      # ========== MODÈLE THERMIQUE (Newton) ==========
      - name: "cumulus_temperature_physique_c"
        unique_id: cumulus_temperature_physique_c
        unit_of_measurement: "°C"
        device_class: temperature
        icon: mdi:thermometer-water
        state: >-
          {% set heures = states('sensor.cumulus_heures_depuis_derniere_chauffe') | float(999) %}
          {% set T_max = states('input_number.cumulus_temperature_max_c') | float(65) %}
          {% set T_amb = states('input_number.cumulus_temperature_ambiante_c') | float(20) %}
          {% set K_h = states('input_number.cumulus_constante_refroidissement') | float(0.0075) %}
          {% if heures >= 999 %}
            {{ T_amb }}
          {% else %}
            {% set delta_T = T_max - T_amb %}
            {% set exp_term = 2.718281828459 ** (-K_h * heures) %}
            {% set temp = T_amb + (delta_T * exp_term) %}
            {{ [temp, T_amb] | max | round(1) }}
          {% endif %}

      - name: "cumulus_eau_chaude_disponible_40c_litres"
        unique_id: cumulus_eau_chaude_disponible_40c_litres
        unit_of_measurement: "L"
        icon: mdi:water-thermometer
        state: >-
          {% set T_ballon = states('sensor.cumulus_temperature_physique_c') | float(20) %}
          {% set T_froide = 15 %}
          {% set T_usage = 40 %}
          {% set capacite_brute = states('input_number.cumulus_capacite_litres') | float(300) %}
          {% set capacite_max_40c = states('input_number.cumulus_capacite_mitigee_40c_litres') | float(559) %}
          {% if T_ballon <= T_froide %}
            0
          {% elif T_ballon >= T_usage %}
            {{ capacite_max_40c | round(0) }}
          {% else %}
            {% set ratio = (T_ballon - T_froide) / (T_usage - T_froide) %}
            {{ (capacite_brute * ratio) | round(0) }}
          {% endif %}

      - name: "cumulus_energie_restante_wh"
        unique_id: cumulus_energie_restante_wh
        unit_of_measurement: "Wh"
        device_class: energy
        icon: mdi:lightning-bolt-circle
        state: >-
          {% set T_actuelle = states('sensor.cumulus_temperature_physique_c') | float(20) %}
          {% set T_cible = states('input_number.cumulus_temperature_max_c') | float(65) %}
          {% set puissance_w = states('input_number.cumulus_puissance_w') | float(3000) %}
          {% set temps_chauffe_complet_h = states('input_number.cumulus_temps_chauffe_complet_h') | float(6.23) %}
          {% set delta_T_actuel = T_cible - T_actuelle %}
          {% set delta_T_max = T_cible - 15 %}
          {% if delta_T_actuel <= 0 or delta_T_max <= 0 %}
            0
          {% else %}
            {% set ratio_chauffe = [0, [delta_T_actuel / delta_T_max, 1] | min] | max %}
            {% set energie_complete_wh = puissance_w * temps_chauffe_complet_h %}
            {{ (energie_complete_wh * ratio_chauffe) | round(0) }}
          {% endif %}

      - name: "cumulus_temps_chauffe_necessaire_h"
        unique_id: cumulus_temps_chauffe_necessaire_h
        unit_of_measurement: "h"
        icon: mdi:clock-time-four
        state: >-
          {% set T_actuelle = states('sensor.cumulus_temperature_physique_c') | float(20) %}
          {% set T_cible = states('input_number.cumulus_temperature_max_c') | float(65) %}
          {% set temps_total = states('input_number.cumulus_temps_chauffe_complet_h') | float(6.23) %}
          {% set delta_T = T_cible - T_actuelle %}
          {% set delta_max = T_cible - 15 %}
          {% if delta_T <= 0 or delta_max <= 0 %}
            0
          {% else %}
            {% set ratio = [0, [delta_T / delta_max, 1] | min] | max %}
            {{ (temps_total * ratio) | round(1) }}
          {% endif %}

      - name: "cumulus_fenetre_pv_restante_corrigee_h"
        unique_id: cumulus_fenetre_pv_restante_corrigee_h
        unit_of_measurement: "h"
        icon: mdi:timer-sand
        state: >-
          {% set debut = states('input_datetime.cumulus_plage_pv_debut') %}
          {% set fin = states('input_datetime.cumulus_plage_pv_fin') %}
          {% if debut in ['unknown', 'unavailable', ''] or fin in ['unknown', 'unavailable', ''] %}
            0
          {% else %}
            {% set h_now = now().hour + now().minute/60 + now().second/3600 %}
            {% set h_debut = debut.split(':')[0]|int + debut.split(':')[1]|int/60 + debut.split(':')[2]|int/3600 %}
            {% set h_fin = fin.split(':')[0]|int + fin.split(':')[1]|int/60 + fin.split(':')[2]|int/3600 %}
            {% if h_debut <= h_fin %}
              {% if h_now < h_debut or h_now >= h_fin %}
                0
              {% else %}
                {{ (h_fin - h_now) | round(2) }}
              {% endif %}
            {% else %}
              {% if h_now >= h_debut %}
                {{ (24 - h_now + h_fin) | round(2) }}
              {% elif h_now < h_fin %}
                {{ (h_fin - h_now) | round(2) }}
              {% else %}
                0
              {% endif %}
            {% endif %}
          {% endif %}

      # ========== PRODUCTION APS SEULE ==========
      - name: "cumulus_production_aps_w"
        unique_id: cumulus_production_aps_w
        unit_of_measurement: "W"
        device_class: power
        state_class: measurement
        icon: mdi:solar-panel
        state: >-
          {% set pv_total = states('sensor.cumulus_pv_power_w') | float(0) %}
          {% set sb_max = states('input_number.cumulus_solarbank_max_w') | float(1200) %}
          {% if pv_total > sb_max %}
            {{ (pv_total - sb_max) | round(0) }}
          {% else %}
            {{ pv_total | round(0) }}
          {% endif %}
        attributes:
          pv_total_w: "{{ states('sensor.cumulus_pv_power_w') }}"
          explication: >-
            Si PV_total < 1200W : APS = PV_total (SB charge, seul APS alimente)
            Si PV_total > 1200W : APS = PV_total - 1200W (SB à fond + surplus APS)

      # ========== PRODUCTION SOLAIRE TOTALE (APS × 2) ==========
      - name: "cumulus_production_solaire_totale_w"
        unique_id: cumulus_production_solaire_totale_w
        unit_of_measurement: "W"
        device_class: power
        state_class: measurement
        icon: mdi:solar-power-variant
        state: >-
          {% set aps = states('sensor.cumulus_production_aps_w') | float(0) %}
          {{ (aps * 2) | round(0) }}
        attributes:
          production_aps_w: "{{ states('sensor.cumulus_production_aps_w') }}"
          formule: "Production totale = APS × 2"
          explication: >-
            Les deux groupes de panneaux (APS et SB) ont la même puissance.
            Production totale = Production APS × 2

      # ========== PUISSANCE DISPONIBLE POUR CUMULUS ==========
      - name: "cumulus_puissance_disponible_w"
        unique_id: cumulus_puissance_disponible_w
        unit_of_measurement: "W"
        device_class: power
        state_class: measurement
        icon: mdi:lightning-bolt-circle
        state: >-
          {% set aps = states('sensor.cumulus_production_aps_w') | float(0) %}
          {% set soc = states('sensor.cumulus_soc_solarbank_pct') | float(0) %}
          {% set soc_min = states('input_number.cumulus_soc_min_pct') | float(10) %}
          {% set sb_max = states('input_number.cumulus_solarbank_max_w') | float(1200) %}
          {% if soc >= soc_min %}
            {{ (sb_max + aps) | round(0) }}
          {% else %}
            {{ aps | round(0) }}
          {% endif %}
        attributes:
          pv_total_w: "{{ states('sensor.cumulus_pv_power_w') }}"
          production_aps_w: "{{ states('sensor.cumulus_production_aps_w') }}"
          production_solaire_totale_w: "{{ states('sensor.cumulus_production_solaire_totale_w') }}"
          solarbank_disponible_w: >-
            {% set soc = states('sensor.cumulus_soc_solarbank_pct') | float(0) %}
            {% set soc_min = states('input_number.cumulus_soc_min_pct') | float(10) %}
            {% if soc >= soc_min %}
              {{ states('input_number.cumulus_solarbank_max_w') }}
            {% else %}
              0
            {% endif %}
          soc_pct: "{{ states('sensor.cumulus_soc_solarbank_pct') }}"
          formule: >-
            Si SOC ≥ 10% : Disponible = 1200W (SB) + APS
            Si SOC < 10% : Disponible = APS seul
          explication: >-
            SolarBank délivre 1200W fixes de 10% à 100% SOC.
            Batterie (1200W) + Production APS actuelle.

      - name: "cumulus_seuil_pv_dynamique_w"
        unique_id: cumulus_seuil_pv_dynamique_w
        unit_of_measurement: "W"
        device_class: power
        state_class: measurement
        icon: mdi:solar-power-variant-outline
        state: >-
          {% set conso_cumulus = states('input_number.cumulus_puissance_w') | float(3000) %}
          {% set talon = states('input_number.cumulus_talon_maison_w') | float(300) %}
          {% set import_max = states('input_number.cumulus_import_demarrage_max_w') | float(800) %}
          {{ ((conso_cumulus + talon) - import_max) | int }}
        attributes:
          calcul: >-
            Seuil = (Puissance cumulus + Talon maison) - Import max autorisé
          detail: >-
            Avec cumulus 3000W, talon 300W, import max 800W:
            Seuil = (3000 + 300) - 800 = 2500W
          import_max_autorise_w: "{{ states('input_number.cumulus_import_demarrage_max_w') }}"
          ancien_mode: "Logique dynamique basée sur fenêtre PV désactivée"

      - name: "cumulus_besoin_journalier_litres"
        unique_id: cumulus_besoin_journalier_litres
        unit_of_measurement: "L"
        icon: mdi:account-water
        state: >-
          {% set nb_pers = states('input_number.cumulus_nb_personnes') | int(2) %}
          {{ (nb_pers * 50) | round(0) }}

      # ========== ÉTAT DEADBAND ==========
      - name: "cumulus_etat_deadband"
        unique_id: cumulus_etat_deadband
        icon: mdi:timer-sand
        state: >-
          {% if is_state('timer.cumulus_deadband_ui', 'active') %}
            {% set remaining = state_attr('timer.cumulus_deadband_ui', 'remaining') %}
            {% if remaining %}
              Actif ({{ remaining }})
            {% else %}
              Actif
            {% endif %}
          {% else %}
            Inactif
          {% endif %}
        attributes:
          raison: "{{ states('input_text.cumulus_raison_deadband') }}"
          timer_state: "{{ states('timer.cumulus_deadband_ui') }}"
          temps_restant: "{{ state_attr('timer.cumulus_deadband_ui', 'remaining') }}"
          fin_prevue: "{{ state_attr('timer.cumulus_deadband_ui', 'finishes_at') }}"
          dernier_evenement: >-
            {% if is_state('timer.cumulus_deadband_ui', 'active') %}
              Deadband actif - Raison: {{ states('input_text.cumulus_raison_deadband') }}
            {% else %}
              Deadband inactif - Démarrage autorisé
            {% endif %}

      # ========== DURÉE CHAUFFE ACTUELLE ==========
      - name: "cumulus_duree_chauffe_actuelle"
        unique_id: cumulus_duree_chauffe_actuelle
        unit_of_measurement: "min"
        icon: mdi:timer-outline
        state: >-
          {% if is_state('binary_sensor.cumulus_chauffe_reelle', 'on') %}
            {% set debut_ts = state_attr('input_datetime.cumulus_debut_chauffe_actuelle', 'timestamp') %}
            {% if debut_ts is not none and debut_ts > 0 %}
              {{ ((now().timestamp() - debut_ts) / 60) | round(0) }}
            {% else %}
              0
            {% endif %}
          {% else %}
            0
          {% endif %}
        attributes:
          debut_chauffe: >-
            {% if is_state('binary_sensor.cumulus_chauffe_reelle', 'on') %}
              {{ states('input_datetime.cumulus_debut_chauffe_actuelle') }}
            {% else %}
              -
            {% endif %}
          consommation_w: "{{ states('sensor.cumulus_consommation_reelle_w') }}"
          autonomie_pv_pct: "{{ state_attr('sensor.cumulus_repartition_sources', 'autonomie_pv_pct') }}"
          dernier_evenement: >-
            {% if is_state('binary_sensor.cumulus_chauffe_reelle', 'on') %}
              Chauffe en cours depuis {{ states('sensor.cumulus_duree_chauffe_actuelle') }} minutes
            {% else %}
              Aucune chauffe en cours
            {% endif %}

      # ========== SANTÉ SYSTÈME (MONITORING PROACTIF) ==========
      - name: "cumulus_sante_systeme"
        unique_id: cumulus_sante_systeme
        unit_of_measurement: "%"
        icon: mdi:heart-pulse
        state: >-
          {% set score = namespace(value=100) %}

          {# 1. ENTITÉS VALIDES (25 points) #}
          {% set entites_ok = is_state('binary_sensor.cumulus_entites_ok', 'on') %}
          {% if not entites_ok %}
            {% set score.value = score.value - 25 %}
          {% endif %}

          {# 2. COHÉRENCE MESURES (25 points) #}
          {% set sw_id = states('input_text.cumulus_entity_contacteur') %}
          {% if sw_id not in ['', 'unknown', 'unavailable'] %}
            {% set sw_on = is_state(sw_id, 'on') %}
            {% set conso = states('sensor.cumulus_consommation_reelle_w') | float(0) %}
            {% if sw_on and conso < 100 %}
              {# Anomalie: switch ON mais conso faible #}
              {% set score.value = score.value - 25 %}
            {% elif not sw_on and conso > 500 %}
              {# Anomalie: switch OFF mais conso élevée #}
              {% set score.value = score.value - 25 %}
            {% endif %}
          {% endif %}

          {# 3. ESPACEMENT CHAUFFES (25 points) #}
          {% set heures_depuis = states('sensor.cumulus_heures_depuis_derniere_chauffe') | float(999) %}
          {% set max_h = states('input_number.cumulus_espacement_max_h') | float(50) %}
          {% if heures_depuis >= max_h %}
            {# Besoin urgent - système en alerte #}
            {% set score.value = score.value - 25 %}
          {% elif heures_depuis >= (max_h * 0.8) %}
            {# Approche du besoin urgent - pénalité partielle #}
            {% set score.value = score.value - 10 %}
          {% endif %}

          {# 4. ÉTAT FONCTIONNEL (25 points) #}
          {% if is_state('input_boolean.cumulus_interdit_depart', 'on') %}
            {# Système désactivé manuellement #}
            {% set score.value = score.value - 15 %}
          {% endif %}
          {% if is_state('input_boolean.cumulus_mode_vacances', 'on') %}
            {# Mode vacances - fonctionnement limité #}
            {% set score.value = score.value - 10 %}
          {% endif %}

          {{ [0, [score.value, 100] | min] | max | round(0) }}
        attributes:
          evaluation_entites: >-
            {% if is_state('binary_sensor.cumulus_entites_ok', 'on') %}
              ✅ Toutes entités valides (25/25 pts)
            {% else %}
              ❌ Entités invalides (0/25 pts) - {{ state_attr('binary_sensor.cumulus_entites_ok', 'entites_critiques_valides') }}
            {% endif %}
          evaluation_coherence: >-
            {% set sw_id = states('input_text.cumulus_entity_contacteur') %}
            {% if sw_id not in ['', 'unknown', 'unavailable'] %}
              {% set sw_on = is_state(sw_id, 'on') %}
              {% set conso = states('sensor.cumulus_consommation_reelle_w') | float(0) %}
              {% if sw_on and conso < 100 %}
                ❌ Anomalie cohérence (0/25 pts) - Switch ON mais conso {{ conso }}W < 100W
              {% elif not sw_on and conso > 500 %}
                ❌ Anomalie cohérence (0/25 pts) - Switch OFF mais conso {{ conso }}W > 500W
              {% else %}
                ✅ Mesures cohérentes (25/25 pts)
              {% endif %}
            {% else %}
              ⚠️ Contacteur non configuré
            {% endif %}
          evaluation_espacement: >-
            {% set heures = states('sensor.cumulus_heures_depuis_derniere_chauffe') | float(999) %}
            {% set max_h = states('input_number.cumulus_espacement_max_h') | float(50) %}
            {% if heures >= max_h %}
              ❌ Besoin urgent (0/25 pts) - {{ heures | round(1) }}h >= {{ max_h }}h
            {% elif heures >= (max_h * 0.8) %}
              ⚠️ Approche urgence (15/25 pts) - {{ heures | round(1) }}h / {{ max_h }}h
            {% else %}
              ✅ Espacement OK (25/25 pts) - {{ heures | round(1) }}h / {{ max_h }}h
            {% endif %}
          evaluation_fonctionnel: >-
            {% set points = 25 %}
            {% if is_state('input_boolean.cumulus_interdit_depart', 'on') %}
              {% set points = points - 15 %}
            {% endif %}
            {% if is_state('input_boolean.cumulus_mode_vacances', 'on') %}
              {% set points = points - 10 %}
            {% endif %}
            {% if points == 25 %}
              ✅ Système opérationnel (25/25 pts)
            {% else %}
              ⚠️ Limitations actives ({{ points }}/25 pts)
            {% endif %}
          niveau_sante: >-
            {% set score = states('sensor.cumulus_sante_systeme') | float(100) %}
            {% if score >= 90 %}
              Excellent
            {% elif score >= 75 %}
              Bon
            {% elif score >= 50 %}
              Moyen
            {% elif score >= 25 %}
              Dégradé
            {% else %}
              Critique
            {% endif %}
          dernier_evenement: >-
            {% set score = states('sensor.cumulus_sante_systeme') | float(100) %}
            {% if score >= 75 %}
              Système en bonne santé ({{ score | round(0) }}%)
            {% elif score >= 50 %}
              Système fonctionnel avec alertes mineures ({{ score | round(0) }}%)
            {% else %}
              ⚠️ Système dégradé - Vérification recommandée ({{ score | round(0) }}%)
            {% endif %}

      # ========== HISTORIQUE CHAUFFES ==========
      - name: "cumulus_historique_chauffes_display"
        unique_id: cumulus_historique_chauffes_display
        icon: mdi:chart-timeline
        state: >-
          {% set hist = states('input_text.cumulus_historique_chauffes') %}
          {% if hist == '[]' or hist in ['unknown', 'unavailable', ''] %}
            Aucun historique
          {% else %}
            {% set chauffes = hist.split('|') %}
            {{ chauffes | length }} chauffes enregistrées
          {% endif %}
        attributes:
          historique_complet: >-
            {% set hist = states('input_text.cumulus_historique_chauffes') %}
            {% if hist == '[]' or hist in ['unknown', 'unavailable', ''] %}
              Aucune chauffe enregistrée
            {% else %}
              {% set chauffes = hist.split('|') %}
              {% set result = [] %}
              {% for chauffe in chauffes[-10:] %}
                {% set result = result + [chauffe] %}
              {% endfor %}
              {{ result | join('\n') }}
            {% endif %}
          derniere_chauffe: >-
            {% set hist = states('input_text.cumulus_historique_chauffes') %}
            {% if hist != '[]' and hist not in ['unknown', 'unavailable', ''] %}
              {% set chauffes = hist.split('|') %}
              {% if chauffes | length > 0 %}
                {{ chauffes[-1] }}
              {% else %}
                -
              {% endif %}
            {% else %}
              -
            {% endif %}
          dernier_evenement: >-
            {% set hist = states('input_text.cumulus_historique_chauffes') %}
            {% if hist == '[]' or hist in ['unknown', 'unavailable', ''] %}
              Aucune chauffe enregistrée dans l'historique
            {% else %}
              Dernière chauffe: {{ state_attr('sensor.cumulus_historique_chauffes_display', 'derniere_chauffe') }}
            {% endif %}

  # --------------------------- BINARY SENSORS ----------------------------- #
  - binary_sensor:
      # ========== PROTECTION unknown/unavailable ==========
      - name: "cumulus_lave_linge_actif"
        unique_id: cumulus_lave_linge_actif
        device_class: running
        icon: mdi:washing-machine
        state: >-
          {% set entity = states('input_text.cumulus_entity_lave_linge_power') %}
          {% if entity in ['', 'unknown', 'unavailable'] %}
            false
          {% else %}
            {% set power_state = states(entity) %}
            {% if power_state in ['unknown', 'unavailable'] %}
              false
            {% else %}
              {% set power = power_state | float(0) %}
              {% set seuil = states('input_number.cumulus_seuil_appareil_actif_w') | float(10) %}
              {{ power > seuil }}
            {% endif %}
          {% endif %}

      - name: "cumulus_lave_vaisselle_actif"
        unique_id: cumulus_lave_vaisselle_actif
        device_class: running
        icon: mdi:dishwasher
        state: >-
          {% set entity = states('input_text.cumulus_entity_lave_vaisselle_power') %}
          {% if entity in ['', 'unknown', 'unavailable'] %}
            false
          {% else %}
            {% set power_state = states(entity) %}
            {% if power_state in ['unknown', 'unavailable'] %}
              false
            {% else %}
              {% set power = power_state | float(0) %}
              {% set seuil = states('input_number.cumulus_seuil_appareil_actif_w') | float(10) %}
              {{ power > seuil }}
            {% endif %}
          {% endif %}

      - name: "cumulus_appareil_prioritaire_actif"
        unique_id: cumulus_appareil_prioritaire_actif
        icon: mdi:home-lightning-bolt-outline
        state: >-
          {{ is_state('binary_sensor.cumulus_lave_linge_actif', 'on')
             or is_state('binary_sensor.cumulus_lave_vaisselle_actif', 'on') }}

      # ========== PROTECTION fenêtres horaires ==========
      - name: "cumulus_fenetre_pv"
        unique_id: cumulus_fenetre_pv
        state: >-
          {% set d = states('input_datetime.cumulus_plage_pv_debut') %}
          {% set f = states('input_datetime.cumulus_plage_pv_fin') %}
          {% if d in ['unknown', 'unavailable', ''] or f in ['unknown', 'unavailable', ''] %}
            false
          {% else %}
            {% set nowt = now().strftime('%H:%M:%S') %}
            {% if d <= f %}
              {{ d <= nowt <= f }}
            {% else %}
              {{ nowt >= d or nowt <= f }}
            {% endif %}
          {% endif %}

      - name: "cumulus_en_hc"
        unique_id: cumulus_en_hc
        state: >-
          {% set d = states('input_datetime.cumulus_heures_creuses_debut') %}
          {% set f = states('input_datetime.cumulus_heures_creuses_fin') %}
          {% if d in ['unknown', 'unavailable', ''] or f in ['unknown', 'unavailable', ''] %}
            false
          {% else %}
            {% set nowt = now().strftime('%H:%M:%S') %}
            {% if d <= f %}
              {{ d <= nowt <= f }}
            {% else %}
              {{ nowt >= d or nowt <= f }}
            {% endif %}
          {% endif %}

      # ========== CHAUFFE RÉELLE basée sur CONSOMMATION ==========
      - name: "cumulus_chauffe_reelle"
        unique_id: cumulus_chauffe_reelle
        device_class: running
        icon: mdi:water-boiler-alert
        state: >-
          {% set sw_id = states('input_text.cumulus_entity_contacteur') | string %}
          {% if sw_id in ['unknown', 'unavailable', ''] %}
            false
          {% else %}
            {% set sw = is_state(sw_id, 'on') %}
            {% set conso = states('sensor.cumulus_consommation_reelle_w') | float(0) %}
            {% set puissance_nominale = states('input_number.cumulus_puissance_w') | float(3000) %}
            {% set seuil_chauffe = puissance_nominale * 0.85 %}
            {{ sw and (conso > seuil_chauffe) }}
          {% endif %}
        attributes:
          consommation_w: "{{ states('sensor.cumulus_consommation_reelle_w') }}"
          seuil_detection_w: "{{ (states('input_number.cumulus_puissance_w') | float(3000) * 0.85) | round(0) }}"
          contacteur_state: >-
            {% set sw_id = states('input_text.cumulus_entity_contacteur') %}
            {{ states(sw_id) if sw_id not in ['', 'unknown', 'unavailable'] else 'unknown' }}
          dernier_evenement: >-
            {% if is_state('binary_sensor.cumulus_chauffe_reelle', 'on') %}
              Chauffe en cours - Consommation {{ states('sensor.cumulus_consommation_reelle_w') }}W
            {% else %}
              Arrêt - {{ states('input_text.cumulus_entity_contacteur') }} = {{ states(states('input_text.cumulus_entity_contacteur')) }}
            {% endif %}

      - name: "cumulus_besoin_chauffe_urgente"
        unique_id: cumulus_besoin_chauffe_urgente
        state: >-
          {% set heures = states('sensor.cumulus_heures_depuis_derniere_chauffe') | float(0) %}
          {% set max_h = states('input_number.cumulus_espacement_max_h') | float(50) %}
          {{ heures >= max_h }}

      - name: "cumulus_meteo_favorable_aujourdhui"
        unique_id: cumulus_meteo_favorable_aujourdhui
        state: >-
          {% set today = states('sensor.cumulus_solcast_forecast_today') | float(0) %}
          {% set seuil = states('input_number.cumulus_seuil_solcast_bon_kwh') | float(8) %}
          {{ today >= seuil }}

      - name: "cumulus_meteo_favorable_demain"
        unique_id: cumulus_meteo_favorable_demain
        state: >-
          {% set tomorrow = states('sensor.cumulus_solcast_forecast_tomorrow') | float(0) %}
          {% set seuil = states('input_number.cumulus_seuil_solcast_bon_kwh') | float(8) %}
          {{ tomorrow >= seuil }}

      - name: "cumulus_autoriser_chauffe_hc_intelligente"
        unique_id: cumulus_autoriser_chauffe_hc_intelligente
        state: >-
          {% set autoriser = is_state('input_boolean.cumulus_autoriser_hc', 'on') %}
          {% set urgent = is_state('binary_sensor.cumulus_besoin_chauffe_urgente', 'on') %}
          {% set mauvais_demain = is_state('binary_sensor.cumulus_meteo_favorable_demain', 'off') %}
          {{ autoriser and (urgent or mauvais_demain) }}

      - name: "cumulus_capacite_suffisante"
        unique_id: cumulus_capacite_suffisante
        icon: mdi:check-circle-outline
        state: >-
          {% set dispo = states('sensor.cumulus_eau_chaude_disponible_40c_litres') | float(0) %}
          {% set besoin = states('sensor.cumulus_besoin_journalier_litres') | float(0) %}
          {{ dispo >= (besoin * 1.2) }}

      - name: "cumulus_temps_suffisant_fenetre_pv"
        unique_id: cumulus_temps_suffisant_fenetre_pv
        icon: mdi:clock-check-outline
        state: >-
          {% set temps_necessaire = states('sensor.cumulus_temps_chauffe_necessaire_h') | float(99) %}
          {% set temps_disponible = states('sensor.cumulus_fenetre_pv_restante_corrigee_h') | float(0) %}
          {{ temps_disponible >= (temps_necessaire * 1.1) }}

      # ========== VALIDATION ENTITÉS CONFIGURABLES ==========
      - name: "cumulus_entites_ok"
        unique_id: cumulus_entites_ok
        icon: mdi:check-network-outline
        device_class: connectivity
        state: >-
          {% set entites_critiques = [
            states('input_text.cumulus_entity_import_w'),
            states('input_text.cumulus_entity_contacteur'),
            states('input_text.cumulus_entity_soc_solarbank'),
            states('input_text.cumulus_entity_pv_total')
          ] %}
          {% set entites_optionnelles = [
            states('input_text.cumulus_entity_solcast_today'),
            states('input_text.cumulus_entity_solcast_tomorrow'),
            states('input_text.cumulus_entity_lave_linge_power'),
            states('input_text.cumulus_entity_lave_vaisselle_power')
          ] %}
          {% set critiques_valides = namespace(count=0) %}
          {% set critiques_total = namespace(count=0) %}
          {% for entity_id in entites_critiques %}
            {% if entity_id not in ['', 'unknown', 'unavailable'] %}
              {% set critiques_total.count = critiques_total.count + 1 %}
              {% set entity_state = states(entity_id) %}
              {% if entity_state not in ['unknown', 'unavailable'] %}
                {% set critiques_valides.count = critiques_valides.count + 1 %}
              {% endif %}
            {% endif %}
          {% endfor %}
          {{ critiques_total.count == 4 and critiques_valides.count == 4 }}
        attributes:
          entites_critiques_valides: >-
            {% set result = [] %}
            {% set entites = [
              ('Import réseau', states('input_text.cumulus_entity_import_w')),
              ('Contacteur', states('input_text.cumulus_entity_contacteur')),
              ('SOC Solarbank', states('input_text.cumulus_entity_soc_solarbank')),
              ('PV total', states('input_text.cumulus_entity_pv_total'))
            ] %}
            {% for nom, entity_id in entites %}
              {% if entity_id not in ['', 'unknown', 'unavailable'] %}
                {% set entity_state = states(entity_id) %}
                {% if entity_state not in ['unknown', 'unavailable'] %}
                  {% set result = result + [nom ~ ': ✅ OK'] %}
                {% else %}
                  {% set result = result + [nom ~ ': ❌ ' ~ entity_state] %}
                {% endif %}
              {% else %}
                {% set result = result + [nom ~ ': ❌ Non configuré'] %}
              {% endif %}
            {% endfor %}
            {{ result | join(', ') }}
          entites_optionnelles_valides: >-
            {% set result = [] %}
            {% set entites = [
              ('Solcast today', states('input_text.cumulus_entity_solcast_today')),
              ('Solcast tomorrow', states('input_text.cumulus_entity_solcast_tomorrow')),
              ('Lave-linge', states('input_text.cumulus_entity_lave_linge_power')),
              ('Lave-vaisselle', states('input_text.cumulus_entity_lave_vaisselle_power'))
            ] %}
            {% for nom, entity_id in entites %}
              {% if entity_id not in ['', 'unknown', 'unavailable'] %}
                {% set entity_state = states(entity_id) %}
                {% if entity_state not in ['unknown', 'unavailable'] %}
                  {% set result = result + [nom ~ ': ✅'] %}
                {% else %}
                  {% set result = result + [nom ~ ': ⚠️ ' ~ entity_state] %}
                {% endif %}
              {% else %}
                {% set result = result + [nom ~ ': ⚠️ Non configuré'] %}
              {% endif %}
            {% endfor %}
            {{ result | join(', ') }}
          dernier_evenement: >-
            {% if is_state('binary_sensor.cumulus_entites_ok', 'on') %}
              Toutes les entités critiques sont valides
            {% else %}
              ❌ Une ou plusieurs entités critiques sont invalides - Vérifier la configuration
            {% endif %}

      # ========== SOLEIL SUFFISANT ==========
      - name: "cumulus_soleil_suffisant"
        unique_id: cumulus_soleil_suffisant
        icon: mdi:white-balance-sunny
        state: >-
          {% set aps = states('sensor.cumulus_production_aps_w') | float(0) %}
          {% set seuil = states('input_number.cumulus_seuil_pv_statique_w') | float(100) %}
          {{ aps >= seuil }}
        attributes:
          production_aps_w: "{{ states('sensor.cumulus_production_aps_w') }}"
          seuil_w: "{{ states('input_number.cumulus_seuil_pv_statique_w') }}"
          explication: >-
            Vérifie que l'APS produit au moins 100W,
            garantissant qu'il y a du soleil (pas juste la batterie).

