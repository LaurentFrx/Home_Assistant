# ========================================================================
# SCRIPT DE DIAGNOSTIC - Besoin urgent
# ========================================================================
# √Ä ex√©cuter dans Developer Tools ‚Üí Template
# Copiez-collez ce code dans l'√©diteur de template pour diagnostiquer
# ========================================================================

## √âTAPE 1 : V√©rifier l'existence des sensors
{{ "=== SENSORS EXISTANTS ===" }}
sensor.cumulus_heures_depuis_derniere_chauffe existe : {{ states('sensor.cumulus_heures_depuis_derniere_chauffe') }}
binary_sensor.cumulus_besoin_chauffe_urgente existe : {{ states('binary_sensor.cumulus_besoin_chauffe_urgente') }}
input_datetime.cumulus_derniere_chauffe_complete existe : {{ states('input_datetime.cumulus_derniere_chauffe_complete') }}

## √âTAPE 2 : V√©rifier les valeurs actuelles
{{ "=== VALEURS ACTUELLES ===" }}
{% if states('sensor.cumulus_heures_depuis_derniere_chauffe') not in ['unavailable', 'unknown'] %}
Heures depuis derni√®re chauffe : {{ states('sensor.cumulus_heures_depuis_derniere_chauffe') }} h
{% else %}
‚ö†Ô∏è sensor.cumulus_heures_depuis_derniere_chauffe = {{ states('sensor.cumulus_heures_depuis_derniere_chauffe') }}
{% endif %}

{% if states('input_number.cumulus_espacement_max_h') not in ['unavailable', 'unknown'] %}
Espacement max configur√© : {{ states('input_number.cumulus_espacement_max_h') }} h
{% else %}
‚ö†Ô∏è input_number.cumulus_espacement_max_h = {{ states('input_number.cumulus_espacement_max_h') }}
{% endif %}

## √âTAPE 3 : V√©rifier le timestamp
{{ "=== TIMESTAMP DERNI√àRE CHAUFFE ===" }}
{% if states('input_datetime.cumulus_derniere_chauffe_complete') not in ['unavailable', 'unknown'] %}
Date/heure : {{ states('input_datetime.cumulus_derniere_chauffe_complete') }}
Timestamp : {{ state_attr('input_datetime.cumulus_derniere_chauffe_complete', 'timestamp') }}
{% else %}
‚ö†Ô∏è input_datetime.cumulus_derniere_chauffe_complete = {{ states('input_datetime.cumulus_derniere_chauffe_complete') }}
{% endif %}

## √âTAPE 4 : Calculer manuellement
{{ "=== CALCUL MANUEL ===" }}
{% set last_ts = state_attr('input_datetime.cumulus_derniere_chauffe_complete', 'timestamp') %}
{% if last_ts is none or last_ts == 0 %}
‚ö†Ô∏è PROBL√àME : timestamp = {{ last_ts }} (null ou 0)
‚Üí Le sensor retournera 999 heures
{% else %}
Timestamp valide : {{ last_ts }}
Now timestamp : {{ now().timestamp() }}
Diff√©rence : {{ ((now().timestamp() - last_ts) / 3600) | round(1) }} heures
{% endif %}

## √âTAPE 5 : V√©rifier le calcul besoin urgent
{{ "=== BESOIN URGENT CALCUL√â ===" }}
{% set heures = states('sensor.cumulus_heures_depuis_derniere_chauffe') | float(0) %}
{% set max_h = states('input_number.cumulus_espacement_max_h') | float(50) %}
Heures depuis chauffe : {{ heures }}
Espacement max : {{ max_h }}
Comparaison : {{ heures }} >= {{ max_h }} = {{ heures >= max_h }}
{% if heures >= max_h %}
‚Üí BESOIN URGENT = ON ‚ùå
{% else %}
‚Üí BESOIN URGENT = OFF ‚úÖ
{% endif %}

## √âTAPE 6 : √âtat final
{{ "=== √âTAT FINAL ===" }}
binary_sensor.cumulus_besoin_chauffe_urgente = {{ states('binary_sensor.cumulus_besoin_chauffe_urgente') }}

{% if is_state('binary_sensor.cumulus_besoin_chauffe_urgente', 'on') %}
üî¥ BESOIN URGENT ACTIF
{% elif is_state('binary_sensor.cumulus_besoin_chauffe_urgente', 'off') %}
üü¢ PAS DE BESOIN URGENT
{% else %}
‚ö†Ô∏è SENSOR UNAVAILABLE OU INCONNU
{% endif %}

## √âTAPE 7 : V√©rifier les autres sources possibles
{{ "=== AUTRES SENSORS ===" }}
binary_sensor.cumulus_etat_coherent : {{ states('binary_sensor.cumulus_etat_coherent') }}
{% if states('binary_sensor.cumulus_etat_coherent') not in ['unavailable', 'unknown'] %}
  D√©tails : {{ state_attr('binary_sensor.cumulus_etat_coherent', 'details') }}
{% endif %}

input_boolean.cumulus_verrou_jour : {{ states('input_boolean.cumulus_verrou_jour') }}
input_boolean.temp_atteinte_aujourdhui : {{ states('input_boolean.temp_atteinte_aujourdhui') }}

## √âTAPE 8 : Chercher tous les sensors avec "urgent" dans le nom
{{ "=== RECHERCHE SENSORS 'URGENT' ===" }}
{% for state in states.sensor %}
  {% if 'urgent' in state.entity_id.lower() or 'urgent' in state.name.lower() %}
{{ state.entity_id }} = {{ state.state }}
  {% endif %}
{% endfor %}
{% for state in states.binary_sensor %}
  {% if 'urgent' in state.entity_id.lower() or 'urgent' in state.name.lower() %}
{{ state.entity_id }} = {{ state.state }}
  {% endif %}
{% endfor %}

## ========================================================================
## FIN DU DIAGNOSTIC
## ========================================================================
