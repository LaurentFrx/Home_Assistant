# 1) D√©marrage PV automatique avec DOUBLE V√âRIFICATION appareils
- id: cumulus_on_pv_automatique
  alias: "Cumulus ‚Äî ON PV automatique"
  description: "D√©marre si APS > 100W ET puissance totale > seuil dynamique ET aucun appareil actif"
  mode: single
  trigger:
    - platform: template
      value_template: >-
        {% set aps = states('sensor.cumulus_production_aps_w') | float(0) %}
        {% set seuil = states('input_number.cumulus_seuil_pv_statique_w') | float(100) %}
        {{ aps >= seuil }}
      for:
        seconds: "{{ states('input_number.cumulus_on_delay_s')|int(10) }}"
  condition:
    - condition: or
      conditions:
        - condition: state
          entity_id: input_boolean.cumulus_override
          state: "on"
        - condition: and
          conditions:
            # ‚úÖ VALIDATION ENTIT√âS CRITIQUES
            - condition: state
              entity_id: binary_sensor.cumulus_entites_ok
              state: "on"
            - condition: state
              entity_id: binary_sensor.cumulus_fenetre_pv
              state: "on"
            - condition: state
              entity_id: input_boolean.cumulus_interdit_depart
              state: "off"
            - condition: state
              entity_id: input_boolean.cumulus_mode_vacances
              state: "off"
            - condition: state
              entity_id: input_boolean.cumulus_verrou_jour
              state: "off"
            # ‚úÖ TRIPLE V√âRIFICATION des appareils (anti-race condition)
            - condition: state
              entity_id: binary_sensor.cumulus_lave_linge_actif
              state: "off"
            - condition: state
              entity_id: binary_sensor.cumulus_lave_vaisselle_actif
              state: "off"
            - condition: state
              entity_id: binary_sensor.cumulus_appareil_prioritaire_actif
              state: "off"
            - condition: state
              entity_id: timer.cumulus_deadband_ui
              state: "idle"
            - condition: template
              value_template: >-
                {{ states('sensor.cumulus_soc_solarbank_pct')|float(0)
                   >= states('input_number.cumulus_soc_min_pct')|float(10) }}
            - condition: template
              value_template: >-
                {{ states('sensor.cumulus_puissance_disponible_w')|float(0)
                   > states('sensor.cumulus_seuil_pv_dynamique_w')|float(9999) }}
  action:
    - variables:
        sw_id: "{{ states('input_text.cumulus_entity_contacteur') }}"
    - condition: template
      value_template: "{{ sw_id != '' and sw_id not in ['unknown', 'unavailable'] and is_state(sw_id, 'off') }}"
    - service: switch.turn_on
      target:
        entity_id: "{{ sw_id }}"
    - service: input_text.set_value
      target:
        entity_id: input_text.cumulus_raison_deadband
      data:
        value: "D√©marrage PV (anti-flapping)"
    - service: timer.start
      target:
        entity_id: timer.cumulus_deadband_ui
      data:
        duration: "00:{{ states('input_number.cumulus_deadband_min') | int(5) }}:00"
    - service: logbook.log
      data:
        name: "Cumulus D√©marrage PV"
        message: >
          D√©marrage PV. Disponible={{ states('sensor.cumulus_puissance_disponible_w') }}W
          (SB: {{ states('input_number.cumulus_solarbank_max_w') }}W + APS: {{ states('sensor.cumulus_production_aps_w') }}W),
          Seuil={{ states('sensor.cumulus_seuil_pv_dynamique_w') }}W,
          SOC={{ states('sensor.cumulus_soc_solarbank_pct') }}%
        entity_id: "{{ sw_id }}"

# 2) Limiteur import
- id: cumulus_limiteur_import
  alias: "Cumulus ‚Äî Limiteur d'import"
  description: "Arr√™t si import r√©seau > seuil pendant > 4s"
  mode: restart
  trigger:
    - platform: template
      value_template: >-
        {{ states('sensor.cumulus_import_reseau_w')|float(0)
           > states('sensor.cumulus_seuil_import_limiteur_w')|float(9999) }}
      for:
        seconds: 4
  condition:
    - condition: state
      entity_id: binary_sensor.cumulus_chauffe_reelle
      state: "on"
  action:
    - variables:
        sw_id: "{{ states('input_text.cumulus_entity_contacteur') }}"
    - condition: template
      value_template: "{{ sw_id != '' and sw_id not in ['unknown', 'unavailable'] and states(sw_id) == 'on' }}"
    - service: switch.turn_off
      target:
        entity_id: "{{ sw_id }}"
    - service: input_text.set_value
      target:
        entity_id: input_text.cumulus_raison_deadband
      data:
        value: "Import r√©seau > {{ states('sensor.cumulus_seuil_import_limiteur_w') }}W"
    - service: timer.start
      target:
        entity_id: timer.cumulus_deadband_ui
      data:
        duration: "00:{{ states('input_number.cumulus_deadband_min') | int(5) }}:00"
    - service: logbook.log
      data:
        name: "Cumulus Limiteur"
        message: >
          Arr√™t temporaire (import {{ states('sensor.cumulus_import_reseau_w') }}W > seuil).
          PAS de verrou (temp√©rature non atteinte).
        entity_id: "{{ sw_id }}"

# 3) S√©curit√© SOC bas
- id: cumulus_securite_soc_bas
  alias: "Cumulus ‚Äî S√©curit√© SOC bas"
  description: "Arr√™t si SOC < seuil stop pendant > 5s"
  mode: restart
  trigger:
    - platform: template
      value_template: >-
        {{ states('sensor.cumulus_soc_solarbank_pct')|float(100)
           < states('input_number.cumulus_soc_stop_pct')|float(5) }}
      for:
        seconds: 5
  condition:
    - condition: state
      entity_id: binary_sensor.cumulus_chauffe_reelle
      state: "on"
  action:
    - variables:
        sw_id: "{{ states('input_text.cumulus_entity_contacteur') }}"
    - condition: template
      value_template: "{{ sw_id != '' and sw_id not in ['unknown', 'unavailable'] and states(sw_id) == 'on' }}"
    - service: switch.turn_off
      target:
        entity_id: "{{ sw_id }}"
    - service: input_text.set_value
      target:
        entity_id: input_text.cumulus_raison_deadband
      data:
        value: "SOC {{ states('sensor.cumulus_soc_solarbank_pct') }}% < seuil {{ states('input_number.cumulus_soc_stop_pct') }}%"
    - service: timer.start
      target:
        entity_id: timer.cumulus_deadband_ui
      data:
        duration: "00:{{ states('input_number.cumulus_deadband_min') | int(5) }}:00"
    - service: logbook.log
      data:
        name: "Cumulus S√©curit√© SOC"
        message: >
          Arr√™t temporaire (SOC {{ states('sensor.cumulus_soc_solarbank_pct') }}% < seuil).
          PAS de verrou (temp√©rature non atteinte).
        entity_id: "{{ sw_id }}"

# 4) D√©tection fin chauffe UNIVERSELLE (PV, HC, manuelle)
- id: cumulus_fin_chauffe_universelle
  alias: "Cumulus ‚Äî Fin chauffe universelle"
  description: "D√©tecte fin chauffe quelle que soit l'origine (PV/HC/manuelle) et met √† jour le syst√®me"
  mode: restart
  trigger:
    - platform: state
      entity_id: binary_sensor.cumulus_chauffe_reelle
      to: "off"
      for:
        seconds: 60  # ‚úÖ CORRIG√â : 20s ‚Üí 60s pour √©viter faux positifs lors allumage manuel
  condition:
    - condition: state
      entity_id: input_boolean.cumulus_interdit_depart
      state: "off"
    # ‚úÖ S√âCURIT√â : Ne PAS se d√©clencher si override manuel actif
    - condition: state
      entity_id: input_boolean.cumulus_override
      state: "off"
    # ‚úÖ V√©rifier dur√©e minimale de chauffe (120s)
    - condition: template
      value_template: >
        {% if trigger.from_state is not none and trigger.from_state.state == 'on' %}
          {{ (as_timestamp(trigger.to_state.last_changed) - as_timestamp(trigger.from_state.last_changed)) >= 120 }}
        {% else %}
          false
        {% endif %}
  action:
    - variables:
        sw_id: "{{ states('input_text.cumulus_entity_contacteur') }}"
        duree_chauffe_min: >
          {% if trigger.from_state is not none and trigger.from_state.state == 'on' %}
            {{ ((as_timestamp(trigger.to_state.last_changed) - as_timestamp(trigger.from_state.last_changed)) / 60) | round(0) }}
          {% else %}
            0
          {% endif %}
        switch_encore_on: >-
          {{ sw_id != '' and sw_id not in ['unknown', 'unavailable'] and is_state(sw_id, 'on') }}
        conso_w: "{{ states('sensor.cumulus_consommation_reelle_w') | float(0) }}"

    # V√©rifier si temp√©rature max atteinte (thermostat a coup√©)
    - choose:
        - conditions:
            - "{{ switch_encore_on }}"
            - "{{ conso_w < 150 }}"
          sequence:
            # === TEMP√âRATURE MAX ATTEINTE ===
            - service: input_datetime.set_datetime
              target:
                entity_id: input_datetime.cumulus_derniere_chauffe_complete
              data:
                datetime: "{{ now().replace(microsecond=0, tzinfo=None).isoformat() }}"
            - service: input_boolean.turn_on
              target:
                entity_id: input_boolean.cumulus_temp_atteinte_aujourdhui
            - service: input_boolean.turn_on
              target:
                entity_id: input_boolean.cumulus_verrou_jour
            - service: switch.turn_off
              target:
                entity_id: "{{ sw_id }}"
            # === ENREGISTREMENT HISTORIQUE ===
            - variables:
                pv_pct: "{{ state_attr('sensor.cumulus_repartition_sources', 'autonomie_pv_pct') | int(0) }}"
                nouvelle_entree: "{{ now().strftime('%d/%m %H:%M') }} - {{ duree_chauffe_min }}min - {{ pv_pct }}% PV - Compl√®te"
                hist_actuel: "{{ states('input_text.cumulus_historique_chauffes') }}"
            - service: input_text.set_value
              target:
                entity_id: input_text.cumulus_historique_chauffes
              data:
                value: >-
                  {% if hist_actuel in ['[]', '', 'unknown', 'unavailable'] %}
                    {{ nouvelle_entree }}
                  {% else %}
                    {% set chauffes = hist_actuel.split('|') %}
                    {% set nouvelles_chauffes = (chauffes + [nouvelle_entree])[-10:] %}
                    {{ nouvelles_chauffes | join('|') }}
                  {% endif %}
            - service: logbook.log
              data:
                name: "Cumulus Temp√©rature Max"
                message: >
                  Thermostat interne coup√© (temp√©rature max atteinte).
                  Dur√©e : {{ duree_chauffe_min }} min.
                  Conso finale : {{ conso_w }}W.
                  Verrou jour activ√©.
                entity_id: "{{ sw_id }}"
            - service: persistent_notification.create
              data:
                title: "Cumulus - Temp√©rature Max Atteinte"
                message: >
                  Chauffe compl√®te apr√®s {{ duree_chauffe_min }} minutes.

                  Bilan :
                  - {{ state_attr('sensor.cumulus_repartition_sources', 'autonomie_pv_pct') }}% PV
                  - Temp√©rature estim√©e : {{ states('sensor.cumulus_temperature_physique_c') }}¬∞C
                  - Capacit√© 40¬∞C : {{ states('sensor.cumulus_eau_chaude_disponible_40c_litres') }}L

                  Verrou jour activ√© - prochaine chauffe demain.
                notification_id: cumulus_temp_max
      default:
        # Chauffe interrompue (limiteur, appareil, fin HC, etc.) ‚Üí pas de verrou
        - variables:
            pv_pct: "{{ state_attr('sensor.cumulus_repartition_sources', 'autonomie_pv_pct') | int(0) }}"
            nouvelle_entree: "{{ now().strftime('%d/%m %H:%M') }} - {{ duree_chauffe_min }}min - {{ pv_pct }}% PV - Interrompue"
            hist_actuel: "{{ states('input_text.cumulus_historique_chauffes') }}"
        - service: input_text.set_value
          target:
            entity_id: input_text.cumulus_historique_chauffes
          data:
            value: >-
              {% if hist_actuel in ['[]', '', 'unknown', 'unavailable'] %}
                {{ nouvelle_entree }}
              {% else %}
                {% set chauffes = hist_actuel.split('|') %}
                {% set nouvelles_chauffes = (chauffes + [nouvelle_entree])[-10:] %}
                {{ nouvelles_chauffes | join('|') }}
              {% endif %}
        - service: logbook.log
          data:
            name: "Cumulus Fin Chauffe"
            message: >
              Fin de chauffe apr√®s {{ duree_chauffe_min }} min (interruption).
              Temp√©rature non atteinte, pas de verrou.
            entity_id: "{{ sw_id }}"

# 5) Arr√™t si appareil prioritaire d√©marre (SANS verrou)
- id: cumulus_arret_si_appareil_demarre
  alias: "Cumulus ‚Äî Arr√™t si appareil d√©marre"
  description: "Pause temporaire SANS verrou"
  mode: single
  trigger:
    - platform: state
      entity_id: binary_sensor.cumulus_appareil_prioritaire_actif
      to: "on"
  condition:
    - condition: state
      entity_id: binary_sensor.cumulus_chauffe_reelle
      state: "on"
  action:
    - variables:
        sw_id: "{{ states('input_text.cumulus_entity_contacteur') }}"
        appareil_actif: >-
          {% if is_state('binary_sensor.cumulus_lave_linge_actif', 'on') %}
            Lave-linge
          {% elif is_state('binary_sensor.cumulus_lave_vaisselle_actif', 'on') %}
            Lave-vaisselle
          {% else %}
            Un appareil
          {% endif %}
    - condition: template
      value_template: "{{ sw_id != '' and sw_id not in ['unknown', 'unavailable'] and states(sw_id) == 'on' }}"
    - service: switch.turn_off
      target:
        entity_id: "{{ sw_id }}"
    - service: persistent_notification.create
      data:
        title: "Cumulus - Arr√™t Prioritaire"
        message: >
          {{ appareil_actif }} a d√©marr√©.
          Le cumulus a √©t√© arr√™t√© temporairement.
          Red√©marrage automatique apr√®s.
        notification_id: cumulus_arret_appareil
    - service: logbook.log
      data:
        name: "Cumulus Arr√™t Prioritaire"
        message: "Arr√™t temporaire {{ appareil_actif }}. PAS de verrou."
        entity_id: "{{ sw_id }}"

# 6) Arr√™t conso domestique avec DEADBAND
- id: cumulus_arret_si_conso_domestique_elevee
  alias: "Cumulus ‚Äî Arr√™t si conso domestique √©lev√©e"
  description: "Pause si import > talon + marge confort avec deadband anti-flap"
  mode: restart
  trigger:
    - platform: template
      value_template: >-
        {% set import_w = states('sensor.cumulus_import_reseau_w') | float(0) %}
        {% set talon = states('input_number.cumulus_talon_maison_w') | float(300) %}
        {{ import_w > (talon + 200) }}
      for:
        seconds: 10
  condition:
    - condition: state
      entity_id: binary_sensor.cumulus_chauffe_reelle
      state: "on"
  action:
    - variables:
        sw_id: "{{ states('input_text.cumulus_entity_contacteur') }}"
    - condition: template
      value_template: "{{ sw_id != '' and sw_id not in ['unknown', 'unavailable'] and states(sw_id) == 'on' }}"
    - service: switch.turn_off
      target:
        entity_id: "{{ sw_id }}"
    - service: input_text.set_value
      target:
        entity_id: input_text.cumulus_raison_deadband
      data:
        value: "Consommation domestique √©lev√©e (Import {{ states('sensor.cumulus_import_reseau_w') }}W)"
    - service: timer.start
      target:
        entity_id: timer.cumulus_deadband_ui
      data:
        duration: "00:{{ states('input_number.cumulus_deadband_min') | int(5) }}:00"
    - service: logbook.log
      data:
        name: "Cumulus Pause Conso Domestique"
        message: >
          Arr√™t temporaire - import {{ states('sensor.cumulus_import_reseau_w') }}W > talon+200W.
          Maison consomme plus que pr√©vu. PAS de verrou.
          Deadband {{ states('input_number.cumulus_deadband_min') }}min activ√©.
        entity_id: "{{ sw_id }}"

# 7) Red√©marrage quand appareil s'arr√™te - ‚úÖ CORRIG√â v2025-10-13g
- id: cumulus_redemarrage_si_appareil_arrete
  alias: "Cumulus ‚Äî Red√©marrage si appareil s'arr√™te"
  description: "Relance si temp√©rature pas atteinte ET PV OK ET TOUS les appareils sont OFF"
  mode: single
  trigger:
    - platform: state
      entity_id: binary_sensor.cumulus_appareil_prioritaire_actif
      to: "off"
      for:
        seconds: 60  # ‚úÖ Augment√© de 30s √† 60s
  condition:
    # ‚úÖ TRIPLE V√âRIFICATION individuelle de chaque appareil
    - condition: state
      entity_id: binary_sensor.cumulus_lave_linge_actif
      state: "off"
    - condition: state
      entity_id: binary_sensor.cumulus_lave_vaisselle_actif
      state: "off"
    - condition: state
      entity_id: binary_sensor.cumulus_appareil_prioritaire_actif
      state: "off"
    - condition: state
      entity_id: input_boolean.cumulus_temp_atteinte_aujourdhui
      state: "off"
    - condition: state
      entity_id: input_boolean.cumulus_interdit_depart
      state: "off"
    - condition: state
      entity_id: input_boolean.cumulus_mode_vacances
      state: "off"
    - condition: state
      entity_id: binary_sensor.cumulus_fenetre_pv
      state: "on"
    - condition: template
      value_template: >
        {{ states('sensor.cumulus_puissance_disponible_w')|float(0)
           > states('sensor.cumulus_seuil_pv_dynamique_w')|float(9999) }}
  action:
    - service: input_boolean.turn_off
      target:
        entity_id: input_boolean.cumulus_verrou_jour
    - service: logbook.log
      data:
        name: "Cumulus Red√©marrage"
        message: >
          Tous les appareils sont arr√™t√©s depuis 60s. Conditions r√©unies pour red√©marrer.
          V√©rification : Lave-linge=OFF, Lave-vaisselle=OFF, Composite=OFF
        entity_id: input_boolean.cumulus_verrou_jour

# 8) ON d√©but HC (intelligent)
- id: cumulus_on_debut_hc_intelligent
  alias: "Cumulus ‚Äî ON d√©but HC (intelligent)"
  description: "D√©marre en HC si besoin urgent OU m√©t√©o d√©favorable demain"
  mode: single
  trigger:
    - platform: state
      entity_id: binary_sensor.cumulus_en_hc
      to: "on"
  condition:
    - condition: or
      conditions:
        - condition: state
          entity_id: input_boolean.cumulus_override
          state: "on"
        - condition: and
          conditions:
            # ‚úÖ VALIDATION ENTIT√âS CRITIQUES
            - condition: state
              entity_id: binary_sensor.cumulus_entites_ok
              state: "on"
            - condition: state
              entity_id: input_boolean.cumulus_interdit_depart
              state: "off"
            - condition: state
              entity_id: input_boolean.cumulus_mode_vacances
              state: "off"
            - condition: state
              entity_id: input_boolean.cumulus_verrou_jour
              state: "off"
            - condition: state
              entity_id: binary_sensor.cumulus_autoriser_chauffe_hc_intelligente
              state: "on"
  action:
    - variables:
        sw_id: "{{ states('input_text.cumulus_entity_contacteur') }}"
    - condition: template
      value_template: "{{ sw_id != '' and sw_id not in ['unknown', 'unavailable'] and is_state(sw_id, 'off') }}"
    - service: switch.turn_on
      target:
        entity_id: "{{ sw_id }}"
    - service: logbook.log
      data:
        name: "Cumulus D√©marrage HC"
        message: "D√©marrage HC intelligent"
        entity_id: "{{ sw_id }}"

# 9) OFF fin HC (arr√™t forc√© si encore en chauffe)
- id: cumulus_off_fin_hc
  alias: "Cumulus ‚Äî OFF fin HC"
  description: "Arr√™t forc√© √† la fin des HC (l'automation universelle g√®re la d√©tection de temp√©rature max)"
  mode: single
  trigger:
    - platform: state
      entity_id: binary_sensor.cumulus_en_hc
      to: "off"
  action:
    - variables:
        sw_id: "{{ states('input_text.cumulus_entity_contacteur') }}"
    - condition: template
      value_template: "{{ sw_id != '' and sw_id not in ['unknown', 'unavailable'] and states(sw_id) == 'on' }}"
    - service: switch.turn_off
      target:
        entity_id: "{{ sw_id }}"
    - service: logbook.log
      data:
        name: "Cumulus Fin HC"
        message: >
          Arr√™t forc√© fin heures creuses.
          L'automation universelle d√©tectera si temp√©rature max atteinte.
        entity_id: "{{ sw_id }}"

# 9b) D√©sactivation verrou intelligente (23h00)
- id: cumulus_desactivation_verrou_intelligente
  alias: "Cumulus ‚Äî D√©sactivation verrou si m√©t√©o d√©favorable (23h)"
  description: "D√©sactive verrou √† 23h si m√©t√©o d√©favorable demain pour permettre chauffe HC pr√©ventive"
  mode: single
  trigger:
    - platform: time
      at: "23:00:00"
  condition:
    # Seulement si verrou actif + temp√©rature atteinte + m√©t√©o d√©favorable
    - condition: state
      entity_id: input_boolean.cumulus_verrou_jour
      state: "on"
    - condition: state
      entity_id: input_boolean.cumulus_temp_atteinte_aujourdhui
      state: "on"
    - condition: state
      entity_id: binary_sensor.cumulus_meteo_favorable_demain
      state: "off"  # M√©t√©o D√âFAVORABLE
  action:
    - service: input_boolean.turn_off
      target:
        entity_id: input_boolean.cumulus_verrou_jour
    - service: logbook.log
      data:
        name: "Cumulus Verrou D√©sactiv√© (M√©t√©o)"
        message: >
          Verrou d√©sactiv√© √† 23h00 : m√©t√©o d√©favorable demain.
          Chauffe HC pr√©ventive autoris√©e.
          Pr√©vision demain : {{ states('sensor.solcast_pv_forecast_previsions_pour_demain') }} kWh

# 10) Reset flags quotidien + Override
- id: cumulus_reset_daily_et_override
  alias: "Cumulus ‚Äî Reset quotidien & Override"
  mode: single
  trigger:
    - id: daily_reset
      platform: time
      at: "08:10:00"
    - id: override_on
      platform: state
      entity_id: input_boolean.cumulus_override
      to: "on"
  action:
    - choose:
        - conditions:
            - condition: trigger
              id: override_on
          sequence:
            - variables:
                sw_id: "{{ states('input_text.cumulus_entity_contacteur') }}"
            - condition: state
              entity_id: input_boolean.cumulus_override
              state: "on"
            - condition: state
              entity_id: input_boolean.cumulus_interdit_depart
              state: "off"
            - condition: state
              entity_id: input_boolean.cumulus_mode_vacances
              state: "off"
            - condition: template
              value_template: "{{ sw_id != '' and sw_id not in ['unknown', 'unavailable'] and is_state(sw_id,'off') }}"
            - service: switch.turn_on
              target:
                entity_id: "{{ sw_id }}"
        - conditions:
            - condition: trigger
              id: daily_reset
          sequence:
            - service: input_boolean.turn_off
              target:
                entity_id: input_boolean.cumulus_temp_atteinte_aujourdhui
            - service: input_boolean.turn_off
              target:
                entity_id: input_boolean.cumulus_verrou_jour

# 11) Override d√©sactive verrou automatiquement
- id: cumulus_override_desactive_verrou
  alias: "Cumulus ‚Äî Override d√©sactive verrou"
  description: "Permet commande manuelle m√™me si verrou actif"
  mode: single
  trigger:
    - platform: state
      entity_id: input_boolean.cumulus_override
      to: "on"
  condition:
    - condition: state
      entity_id: input_boolean.cumulus_verrou_jour
      state: "on"
  action:
    - service: input_boolean.turn_off
      target:
        entity_id: input_boolean.cumulus_verrou_jour
    - service: persistent_notification.create
      data:
        title: "Cumulus - For√ßage Manuel Activ√©"
        message: >
          Verrou jour d√©sactiv√© automatiquement.
          Vous pouvez commander le cumulus manuellement.
        notification_id: cumulus_override_actif
    - service: logbook.log
      data:
        name: "Cumulus Override"
        message: "Verrou d√©sactiv√© par for√ßage manuel"
        entity_id: input_boolean.cumulus_override

# 12) Notification besoin chauffe urgente
- id: cumulus_alerte_besoin_urgent
  alias: "Cumulus ‚Äî Alerte besoin urgent"
  mode: single
  trigger:
    - platform: state
      entity_id: binary_sensor.cumulus_besoin_chauffe_urgente
      to: "on"
      for:
        hours: 1
  condition:
    - condition: state
      entity_id: input_boolean.cumulus_mode_vacances
      state: "off"
  action:
    - variables:
        derniere_chauffe: >-
          {% set ts = state_attr('input_datetime.cumulus_derniere_chauffe_complete', 'timestamp') %}
          {% if ts is not none and ts > 0 %}
            {{ ts | timestamp_custom('%d/%m %H:%M') }}
          {% else %}
            Jamais
          {% endif %}
    - service: persistent_notification.create
      data:
        title: "Cumulus - Chauffe Urgente"
        message: >
          D√©lai max {{ states('input_number.cumulus_espacement_max_h') }}h d√©pass√©.
          Derni√®re chauffe : {{ derniere_chauffe }}
          Temp√©rature : {{ states('sensor.cumulus_temperature_physique_c') }}¬∞C
        notification_id: cumulus_alerte_urgent

# 13) Log refus d√©marrage
- id: cumulus_log_refus_demarrage
  alias: "Cumulus ‚Äî Log refus d√©marrage"
  description: "Notifie quand PV suffisant mais cumulus ne d√©marre pas"
  mode: single
  trigger:
    - platform: template
      value_template: >-
        {{ states('sensor.cumulus_puissance_disponible_w')|float(0)
           > states('sensor.cumulus_seuil_pv_dynamique_w')|float(9999) }}
      for:
        seconds: 60
  condition:
    - condition: state
      entity_id: binary_sensor.cumulus_chauffe_reelle
      state: "off"
    - condition: state
      entity_id: binary_sensor.cumulus_fenetre_pv
      state: "on"
  action:
    - variables:
        raisons_blocage: >-
          {% set raisons = [] %}
          {% if is_state('input_boolean.cumulus_interdit_depart', 'on') %}
            {% set raisons = raisons + ['Mode INTERDIT'] %}
          {% endif %}
          {% if is_state('input_boolean.cumulus_mode_vacances', 'on') %}
            {% set raisons = raisons + ['Mode VACANCES'] %}
          {% endif %}
          {% if is_state('input_boolean.cumulus_verrou_jour', 'on') %}
            {% set raisons = raisons + ['Verrou jour'] %}
          {% endif %}
          {% if is_state('binary_sensor.cumulus_lave_linge_actif', 'on') %}
            {% set raisons = raisons + ['Lave-linge actif'] %}
          {% endif %}
          {% if is_state('binary_sensor.cumulus_lave_vaisselle_actif', 'on') %}
            {% set raisons = raisons + ['Lave-vaisselle actif'] %}
          {% endif %}
          {% if is_state('binary_sensor.cumulus_appareil_prioritaire_actif', 'on') %}
            {% set raisons = raisons + ['Appareil prioritaire actif'] %}
          {% endif %}
          {% set soc = states('sensor.cumulus_soc_solarbank_pct') | float(0) %}
          {% if soc < 10 %}
            {% set raisons = raisons + ['SOC trop bas (' ~ soc ~ '%)'] %}
          {% endif %}
          {% if is_state('timer.cumulus_deadband_ui', 'active') %}
            {% set raisons = raisons + ['Deadband actif'] %}
          {% endif %}
          {% if not is_state('binary_sensor.cumulus_soleil_suffisant', 'on') %}
            {% set raisons = raisons + ['APS < 100W (pas assez de soleil)'] %}
          {% endif %}
          {{ raisons | join(', ') if raisons | length > 0 else 'Raison inconnue' }}
    - service: persistent_notification.create
      data:
        title: "Cumulus - Refus D√©marrage"
        message: >
          Puissance disponible ({{ states('sensor.cumulus_puissance_disponible_w') }}W) > seuil ({{ states('sensor.cumulus_seuil_pv_dynamique_w') }}W)
          mais cumulus ne d√©marre pas.
          
          Blocage : {{ raisons_blocage }}
        notification_id: cumulus_refus_demarrage
    - service: logbook.log
      data:
        message: "Cumulus refus d√©marrage : {{ raisons_blocage }}"
        name: "Cumulus"

# 14) D√©tection chauffe externe (app Shelly, commande manuelle)
- id: cumulus_detection_chauffe_externe
  alias: "Cumulus ‚Äî D√©tection chauffe externe"
  description: "D√©tecte les d√©marrages manuels via app Shelly ou autres sources externes"
  mode: single
  trigger:
    - platform: state
      entity_id: binary_sensor.cumulus_chauffe_reelle
      to: "on"
      for:
        seconds: 30
  condition:
    # D√©tecte une chauffe qui n'est pas pilot√©e par Home Assistant
    - condition: template
      value_template: >-
        {{ not is_state('binary_sensor.cumulus_fenetre_pv', 'on')
           and not is_state('binary_sensor.cumulus_en_hc', 'on')
           and not is_state('input_boolean.cumulus_override', 'on') }}
  action:
    - service: persistent_notification.create
      data:
        title: "Cumulus - Chauffe Externe D√©tect√©e"
        message: >
          Le cumulus a √©t√© d√©marr√© manuellement (app Shelly ou autre).
          Le syst√®me surveille cette chauffe et mettra √† jour les compteurs automatiquement.
        notification_id: cumulus_chauffe_externe
    - service: logbook.log
      data:
        name: "Cumulus Chauffe Externe"
        message: >
          D√©marrage manuel d√©tect√© (source externe).
          Consommation : {{ states('sensor.cumulus_consommation_reelle_w') }}W
        entity_id: "{{ states('input_text.cumulus_entity_contacteur') }}"

# 15) D√©tection anomalie coh√©rence (switch ON mais conso faible)
- id: cumulus_detection_anomalie_coherence
  alias: "Cumulus ‚Äî D√©tection anomalie coh√©rence"
  description: "Alerte si switch ON mais consommation < 100W pendant 30s (anomalie d√©tection)"
  mode: single
  trigger:
    - platform: template
      value_template: >-
        {% set sw_id = states('input_text.cumulus_entity_contacteur') %}
        {% set sw_on = sw_id not in ['', 'unknown', 'unavailable'] and is_state(sw_id, 'on') %}
        {% set conso = states('sensor.cumulus_consommation_reelle_w') | float(0) %}
        {{ sw_on and conso < 100 }}
      for:
        seconds: 30
  condition:
    - condition: state
      entity_id: input_boolean.cumulus_interdit_depart
      state: "off"
  action:
    - variables:
        sw_id: "{{ states('input_text.cumulus_entity_contacteur') }}"
        conso: "{{ states('sensor.cumulus_consommation_reelle_w') | float(0) }}"
        import_w: "{{ states('sensor.cumulus_import_reseau_w') | float(0) }}"
        pv_w: "{{ states('sensor.cumulus_pv_power_w') | float(0) }}"
    - service: persistent_notification.create
      data:
        title: "‚ö†Ô∏è Cumulus - ANOMALIE D√©tection"
        message: >
          ANOMALIE DE COH√âRENCE D√âTECT√âE !

          Le contacteur est ON mais consommation anormalement faible :
          - Contacteur : {{ states(sw_id) }}
          - Consommation mesur√©e : {{ conso }}W (< 100W)
          - Import r√©seau : {{ import_w }}W
          - Production PV : {{ pv_w }}W

          Causes possibles :
          - D√©faillance contacteur ou relais
          - Probl√®me de mesure
          - Thermostat coup√© imm√©diatement
          - Cumulus d√©j√† √† temp√©rature max

          V√©rification manuelle recommand√©e.
        notification_id: cumulus_anomalie_coherence
    - service: logbook.log
      data:
        name: "‚ö†Ô∏è Cumulus ANOMALIE"
        message: >
          ANOMALIE: Switch ON mais conso {{ conso }}W < 100W pendant 30s.
          Import={{ import_w }}W, PV={{ pv_w }}W
        entity_id: "{{ sw_id }}"

# 16) Alerte entit√© unavailable pendant chauffe
- id: cumulus_alerte_entite_unavailable_chauffe
  alias: "Cumulus ‚Äî Alerte entit√© unavailable pendant chauffe"
  description: "Notifie si une entit√© critique devient unavailable pendant une chauffe"
  mode: single
  trigger:
    - platform: state
      entity_id: binary_sensor.cumulus_entites_ok
      to: "off"
      for:
        seconds: 10
  condition:
    - condition: state
      entity_id: binary_sensor.cumulus_chauffe_reelle
      state: "on"
  action:
    - variables:
        sw_id: "{{ states('input_text.cumulus_entity_contacteur') }}"
        entites_details: "{{ state_attr('binary_sensor.cumulus_entites_ok', 'entites_critiques_valides') }}"
    - service: persistent_notification.create
      data:
        title: "‚ö†Ô∏è Cumulus - Entit√© Unavailable Pendant Chauffe"
        message: >
          Une ou plusieurs entit√©s critiques sont devenues unavailable pendant la chauffe !

          √âtat des entit√©s :
          {{ entites_details }}

          La chauffe continue mais la fiabilit√© des mesures est compromise.
          V√©rifiez la connectivit√© de vos capteurs.
        notification_id: cumulus_entite_unavailable
    - service: logbook.log
      data:
        name: "‚ö†Ô∏è Cumulus Entit√© Unavailable"
        message: >
          Entit√©(s) unavailable pendant chauffe active.
          D√©tails: {{ entites_details }}
        entity_id: "{{ sw_id }}"

# 17) Enregistrement d√©but chauffe
- id: cumulus_enregistrement_debut_chauffe
  alias: "Cumulus ‚Äî Enregistrement d√©but chauffe"
  description: "Enregistre l'heure de d√©but de chauffe pour suivi temps r√©el"
  mode: single
  trigger:
    - platform: state
      entity_id: binary_sensor.cumulus_chauffe_reelle
      to: "on"
  action:
    - service: input_datetime.set_datetime
      target:
        entity_id: input_datetime.cumulus_debut_chauffe_actuelle
      data:
        datetime: "{{ now().replace(microsecond=0, tzinfo=None).isoformat() }}"
    - service: logbook.log
      data:
        name: "Cumulus D√©but Chauffe"
        message: "D√©but de chauffe enregistr√© √† {{ now().strftime('%H:%M:%S') }}"
        entity_id: binary_sensor.cumulus_chauffe_reelle

# 18) Alerte sant√© syst√®me d√©grad√©e
- id: cumulus_alerte_sante_systeme_degradee
  alias: "Cumulus ‚Äî Alerte sant√© syst√®me d√©grad√©e"
  description: "Notifie si score sant√© syst√®me < 70%"
  mode: single
  trigger:
    - platform: numeric_state
      entity_id: sensor.cumulus_sante_systeme
      below: 70
      for:
        minutes: 5
  action:
    - variables:
        score: "{{ states('sensor.cumulus_sante_systeme') | float(0) }}"
        niveau: "{{ state_attr('sensor.cumulus_sante_systeme', 'niveau_sante') }}"
        eval_entites: "{{ state_attr('sensor.cumulus_sante_systeme', 'evaluation_entites') }}"
        eval_coherence: "{{ state_attr('sensor.cumulus_sante_systeme', 'evaluation_coherence') }}"
        eval_espacement: "{{ state_attr('sensor.cumulus_sante_systeme', 'evaluation_espacement') }}"
        eval_fonctionnel: "{{ state_attr('sensor.cumulus_sante_systeme', 'evaluation_fonctionnel') }}"
    - service: persistent_notification.create
      data:
        title: "‚ö†Ô∏è Cumulus - Sant√© Syst√®me D√©grad√©e"
        message: >
          Le score de sant√© du syst√®me est d√©grad√© : {{ score | round(0) }}% ({{ niveau }})

          √âvaluations d√©taill√©es :

          üì° Entit√©s :
          {{ eval_entites }}

          üîç Coh√©rence mesures :
          {{ eval_coherence }}

          ‚è±Ô∏è Espacement chauffes :
          {{ eval_espacement }}

          ‚öôÔ∏è √âtat fonctionnel :
          {{ eval_fonctionnel }}

          Action recommand√©e : V√©rifier la configuration et l'√©tat des capteurs.
        notification_id: cumulus_sante_degradee
    - service: logbook.log
      data:
        name: "‚ö†Ô∏è Cumulus Sant√© D√©grad√©e"
        message: >
          Score sant√© {{ score | round(0) }}% < 70% ({{ niveau }}).
          Entit√©s: {{ eval_entites }}, Coh√©rence: {{ eval_coherence }}
        entity_id: sensor.cumulus_sante_systeme